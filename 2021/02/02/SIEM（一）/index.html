<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;æœç´¢...&quot;,&quot;empty&quot;:&quot;æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}&quot;,&quot;hits_time&quot;:&quot;æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰&quot;,&quot;hits&quot;:&quot;æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}</script>
<meta name="description" content="èƒŒæ™¯â€‹        ç”±äºå·¥ä½œæ¯”è¾ƒå¿™ï¼Œæœ‰æ®µæ—¶é—´æ²¡æœ‰æ›´äº†ï¼Œå¿«åˆ°å¹´åº•äº†ï¼Œå°±å½“æ˜¯æ€»ç»“äº†ã€‚ä»Šå¹´ä¸»è¦ç²¾åŠ›éƒ½æ˜¯åœ¨å›´ç»•ç€å®‰å…¨è¿è¥è¿™ä¸€å—çš„å·¥ä½œï¼Œéšç€å·¥ä½œçš„å¼€å±•å‘ç°è‡ªå·±â€œç»„è£…â€çš„SIEMç”¨èµ·æ¥ä¸æ˜¯å¾ˆâ€œèˆ’æœâ€ã€‚è¿™æ˜¯æˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡ã€ŠWazuh-å¦‚ä½•å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”å‘Šè­¦ã€‹çš„æ–‡ç« ï¼Œå½“æ—¶è§„åˆ’çš„æ•°æ®æµçš„Workflowå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚  â€‹        â€œæ•£è£…â€SIEMä¸»è¦æ˜¯å»ºç«‹åœ¨ELKçš„æ¡†æ¶ä¹‹ä¸Šï¼Œå‘Šè­¦æ¨¡å—åˆ†åˆ«é‡‡ç”¨äº†Wazuh">
<meta property="og:type" content="article">
<meta property="og:title" content="è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰">
<meta property="og:url" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/index.html">
<meta property="og:site_name" content="Canon&#39;s Blog">
<meta property="og:description" content="èƒŒæ™¯â€‹        ç”±äºå·¥ä½œæ¯”è¾ƒå¿™ï¼Œæœ‰æ®µæ—¶é—´æ²¡æœ‰æ›´äº†ï¼Œå¿«åˆ°å¹´åº•äº†ï¼Œå°±å½“æ˜¯æ€»ç»“äº†ã€‚ä»Šå¹´ä¸»è¦ç²¾åŠ›éƒ½æ˜¯åœ¨å›´ç»•ç€å®‰å…¨è¿è¥è¿™ä¸€å—çš„å·¥ä½œï¼Œéšç€å·¥ä½œçš„å¼€å±•å‘ç°è‡ªå·±â€œç»„è£…â€çš„SIEMç”¨èµ·æ¥ä¸æ˜¯å¾ˆâ€œèˆ’æœâ€ã€‚è¿™æ˜¯æˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡ã€ŠWazuh-å¦‚ä½•å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”å‘Šè­¦ã€‹çš„æ–‡ç« ï¼Œå½“æ—¶è§„åˆ’çš„æ•°æ®æµçš„Workflowå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚  â€‹        â€œæ•£è£…â€SIEMä¸»è¦æ˜¯å»ºç«‹åœ¨ELKçš„æ¡†æ¶ä¹‹ä¸Šï¼Œå‘Šè­¦æ¨¡å—åˆ†åˆ«é‡‡ç”¨äº†Wazuh">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/image-20200303215020561.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-v0.2.jpg">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/normalized-04.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/enrichment-0.1.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/add-geo_ip-2.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/add-geo_ip-1.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/hunting-alarm.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/hunting-alert.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat-intelligence.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-1.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-2.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-3.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/blacklist-1.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/update_action-0.1.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-Alarm.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-Alert.png">
<meta property="og:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/login_audit.png">
<meta property="article:published_time" content="2021-02-02T08:55:52.000Z">
<meta property="article:modified_time" content="2023-10-24T02:15:49.000Z">
<meta property="article:author" content="Canon">
<meta property="article:tag" content="SIEM">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/image-20200303215020561.png">


<link rel="canonical" href="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;http:&#x2F;&#x2F;example.com&#x2F;2021&#x2F;02&#x2F;02&#x2F;SIEM%EF%BC%88%E4%B8%80%EF%BC%89&#x2F;&quot;,&quot;path&quot;:&quot;2021&#x2F;02&#x2F;02&#x2F;SIEMï¼ˆä¸€ï¼‰&#x2F;&quot;,&quot;title&quot;:&quot;è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰ | Canon's Blog</title><script src="/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Canon's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%83%8C%E6%99%AF"><span class="nav-number">1.</span> <span class="nav-text">èƒŒæ™¯</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E2%80%9C%E6%95%A3%E8%A3%85%E2%80%9DSIEM-v0-1%E7%9A%84%E4%B8%8D%E8%B6%B3%E4%B8%8E%E6%94%B9%E8%BF%9B%E6%8E%AA%E6%96%BD"><span class="nav-number">2.</span> <span class="nav-text">â€œæ•£è£…â€SIEM v0.1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%95%B0%E6%8D%AE%E6%A0%87%E5%87%86%E5%8C%96"><span class="nav-number">2.1.</span> <span class="nav-text">1. æ•°æ®æ ‡å‡†åŒ–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%91%8A%E8%AD%A6%E4%B8%B0%E5%AF%8C%E5%8C%96"><span class="nav-number">2.2.</span> <span class="nav-text">2. å‘Šè­¦ä¸°å¯ŒåŒ–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E6%8F%90%E5%8D%87%E6%A3%80%E6%B5%8B%E8%83%BD%E5%8A%9B"><span class="nav-number">2.3.</span> <span class="nav-text">3. æå‡æ£€æµ‹èƒ½åŠ›</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%BA%AF%E6%BA%90%E5%88%86%E6%9E%90"><span class="nav-number">2.4.</span> <span class="nav-text">4. æº¯æºåˆ†æ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E5%85%B6%E4%BB%96%E6%94%B9%E8%BF%9B"><span class="nav-number">2.5.</span> <span class="nav-text">5. å…¶ä»–æ”¹è¿›</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E2%80%9C%E8%BF%9B%E5%8C%96%E2%80%9D-%E2%80%9C%E6%95%A3%E8%A3%85%E2%80%9DSIEM-v0-2"><span class="nav-number">3.</span> <span class="nav-text">â€œè¿›åŒ–â€ - â€œæ•£è£…â€SIEM v0.2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Workflow"><span class="nav-number">3.1.</span> <span class="nav-text">1. Workflow</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86"><span class="nav-number">3.2.</span> <span class="nav-text">2. æ•°æ®å¤„ç†</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-Normalized"><span class="nav-number">3.2.1.</span> <span class="nav-text">1. Normalized</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-1-normalized-alert-to-siem"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">1.1 normalized-alert_to_siem</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-1-1-normalized-suricata"><span class="nav-number">3.2.1.1.1.</span> <span class="nav-text">1.1.1 normalized-suricata</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config"><span class="nav-number">3.2.1.1.1.1.</span> <span class="nav-text">Logstash Config</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-1-2-normalized-alert-for-suricata"><span class="nav-number">3.2.1.1.2.</span> <span class="nav-text">1.1.2 normalized-alert_for_suricata</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-1"><span class="nav-number">3.2.1.1.2.1.</span> <span class="nav-text">Logstash Config</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-1-3-normalized-fileinfo-for-suricata"><span class="nav-number">3.2.1.1.3.</span> <span class="nav-text">1.1.3 normalized-fileinfo_for_suricata</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-2"><span class="nav-number">3.2.1.1.3.1.</span> <span class="nav-text">Logstash Config</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-1-4-normalized-flow-for-suricata"><span class="nav-number">3.2.1.1.4.</span> <span class="nav-text">1.1.4 normalized-flow_for_suricata</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-3"><span class="nav-number">3.2.1.1.4.1.</span> <span class="nav-text">Logstash Config</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-1-5-normalized-http-for-suricata"><span class="nav-number">3.2.1.1.5.</span> <span class="nav-text">1.1.5 normalized-http_for_suricata</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-4"><span class="nav-number">3.2.1.1.5.1.</span> <span class="nav-text">Logstash Config</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-1-6-normalized-http-headers-for-suricata"><span class="nav-number">3.2.1.1.6.</span> <span class="nav-text">1.1.6 normalized_http_headers_for_suricata</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-5"><span class="nav-number">3.2.1.1.6.1.</span> <span class="nav-text">Logstash Config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Ruby-Code"><span class="nav-number">3.2.1.1.6.2.</span> <span class="nav-text">Ruby Code</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B"><span class="nav-number">3.2.1.1.6.3.</span> <span class="nav-text">ç¤ºä¾‹</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-1-7-normalized-tls-for-suricata"><span class="nav-number">3.2.1.1.7.</span> <span class="nav-text">1.1.7 normalized-tls_for_suricata</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-6"><span class="nav-number">3.2.1.1.7.1.</span> <span class="nav-text">Logstash Config</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-2-normalized-alarm-from-siem"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">1.2 normalized-alarm_from_siem</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-2-1-normalized-alarm"><span class="nav-number">3.2.1.2.1.</span> <span class="nav-text">1.2.1 normalized-alarm</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-7"><span class="nav-number">3.2.1.2.1.1.</span> <span class="nav-text">Logstash Config</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-Enrichment"><span class="nav-number">3.2.2.</span> <span class="nav-text">2. Enrichment</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-1-enrichment-alert-to-siem"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">2.1 enrichment_alert_to_siem</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-1-1-enrichment-alert-direction-for-suricata"><span class="nav-number">3.2.2.1.1.</span> <span class="nav-text">2.1.1 enrichment-alert_direction_for_suricata</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-8"><span class="nav-number">3.2.2.1.1.1.</span> <span class="nav-text">Logstash Config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Ruby-Code-1"><span class="nav-number">3.2.2.1.1.2.</span> <span class="nav-text">Ruby Code</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-1-2-enrichment-related-domain-for-suricata"><span class="nav-number">3.2.2.1.2.</span> <span class="nav-text">2.1.2 enrichment_related_domain_for_suricata</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-9"><span class="nav-number">3.2.2.1.2.1.</span> <span class="nav-text">Logstash Config</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-1-3-add-geo-private-ip"><span class="nav-number">3.2.2.1.3.</span> <span class="nav-text">2.1.3 add_geo-private_ip</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Conifg"><span class="nav-number">3.2.2.1.3.1.</span> <span class="nav-text">Logstash Conifg</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Yaml"><span class="nav-number">3.2.2.1.3.2.</span> <span class="nav-text">Yaml</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="nav-number">3.2.2.1.3.3.</span> <span class="nav-text">ç¤ºä¾‹</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-1-4-add-geo-public-ip"><span class="nav-number">3.2.2.1.4.</span> <span class="nav-text">2.1.4 add_geo-public_ip</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Conifg-1"><span class="nav-number">3.2.2.1.4.1.</span> <span class="nav-text">Logstash Conifg</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-2-enrichment-alarm-from-siem"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">2.2 enrichment-alarm_from_siem</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2-2-1-enrichment-related-event-id-for-wazuh"><span class="nav-number">3.2.2.2.1.</span> <span class="nav-text">2.2.1 enrichment-related_event_id_for_wazuh</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-10"><span class="nav-number">3.2.2.2.1.1.</span> <span class="nav-text">Logstash Config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Ruby-Code-2"><span class="nav-number">3.2.2.2.1.2.</span> <span class="nav-text">Ruby Code</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-2"><span class="nav-number">3.2.2.2.1.3.</span> <span class="nav-text">ç¤ºä¾‹</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-Threat-Intelligence"><span class="nav-number">3.2.3.</span> <span class="nav-text">3. Threat Intelligence</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-threatIntel-alert-to-siem"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">3.1 threatIntel_alert_to_siem</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-1-1-add-ti-shodan"><span class="nav-number">3.2.3.1.1.</span> <span class="nav-text">3.1.1 add-ti_shodan</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-11"><span class="nav-number">3.2.3.1.1.1.</span> <span class="nav-text">Logstash Config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Ruby-Code-3"><span class="nav-number">3.2.3.1.1.2.</span> <span class="nav-text">Ruby Code</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-threatIntel-alarm-from-siem"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">3.2 threatIntel_alarm_from_siem</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-1-add-ti-tags-from-shodan"><span class="nav-number">3.2.3.2.1.</span> <span class="nav-text">3.2.1 add-ti_tags_from_shodan</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-12"><span class="nav-number">3.2.3.2.1.1.</span> <span class="nav-text">Logstash Config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Ruby-Code-4"><span class="nav-number">3.2.3.2.1.2.</span> <span class="nav-text">Ruby Code</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-3"><span class="nav-number">3.2.3.2.1.3.</span> <span class="nav-text">ç¤ºä¾‹</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-2-2-add-ti-tags"><span class="nav-number">3.2.3.2.2.</span> <span class="nav-text">3.2.2 add-ti_tags</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-13"><span class="nav-number">3.2.3.2.2.1.</span> <span class="nav-text">Logstash Config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Ruby-Code-5"><span class="nav-number">3.2.3.2.2.2.</span> <span class="nav-text">Ruby Code</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B-4"><span class="nav-number">3.2.3.2.2.3.</span> <span class="nav-text">ç¤ºä¾‹</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-Filter"><span class="nav-number">3.2.4.</span> <span class="nav-text">4. Filter</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#4-1-alert-to-siem"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">4.1 alert_to_siem</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-1-filter-ip-from-alert"><span class="nav-number">3.2.4.1.1.</span> <span class="nav-text">4.1.1 filter_ip_from_alert</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-14"><span class="nav-number">3.2.4.1.1.1.</span> <span class="nav-text">Logstash Config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Ruby-Code-6"><span class="nav-number">3.2.4.1.1.2.</span> <span class="nav-text">Ruby Code</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-1-2-filter-sid-from-alert"><span class="nav-number">3.2.4.1.2.</span> <span class="nav-text">4.1.2 filter_sid_from_alert</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-15"><span class="nav-number">3.2.4.1.2.1.</span> <span class="nav-text">Logstash Config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Ruby-Code-7"><span class="nav-number">3.2.4.1.2.2.</span> <span class="nav-text">Ruby Code</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-2-alarm-from-siem"><span class="nav-number">3.2.4.2.</span> <span class="nav-text">4.2 alarm_from_siem</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#4-2-1-update-action-from-alarm"><span class="nav-number">3.2.4.2.1.</span> <span class="nav-text">4.2.1 update_action_from_alarm</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Logstash-Config-16"><span class="nav-number">3.2.4.2.1.1.</span> <span class="nav-text">Logstash Config</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Ruby-Code-8"><span class="nav-number">3.2.4.2.1.2.</span> <span class="nav-text">Ruby Code</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="nav-number">3.2.4.2.1.3.</span> <span class="nav-text">ç¤ºä¾‹ï¼š</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="nav-number">3.3.</span> <span class="nav-text">3. ä»ªè¡¨ç›˜</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SIEM%E7%9A%84%E5%91%8A%E8%AD%A6%E4%BB%AA%E8%A1%A8%E7%9B%98"><span class="nav-number">3.3.1.</span> <span class="nav-text">SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E4%BB%AA%E8%A1%A8%E7%9B%98-%E5%AE%89%E5%85%A8%E6%BA%AF%E6%BA%90"><span class="nav-number">3.3.2.</span> <span class="nav-text">å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜ (å®‰å…¨æº¯æº)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%8F%E6%84%9F%E6%8E%A5%E5%8F%A3%E7%9B%91%E6%8E%A7"><span class="nav-number">3.3.3.</span> <span class="nav-text">æ•æ„Ÿæ¥å£ç›‘æ§</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Canon</p>
  <div class="site-description" itemprop="description">ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-02 16:55:52" itemprop="dateCreated datePublished" datetime="2021-02-02T16:55:52+08:00">2021-02-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-10-24 10:15:49" itemprop="dateModified" datetime="2023-10-24T10:15:49+08:00">2023-10-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SIEM/" itemprop="url" rel="index"><span itemprop="name">SIEM</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>33k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>30 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>â€‹        ç”±äºå·¥ä½œæ¯”è¾ƒå¿™ï¼Œæœ‰æ®µæ—¶é—´æ²¡æœ‰æ›´äº†ï¼Œå¿«åˆ°å¹´åº•äº†ï¼Œå°±å½“æ˜¯æ€»ç»“äº†ã€‚ä»Šå¹´ä¸»è¦ç²¾åŠ›éƒ½æ˜¯åœ¨å›´ç»•ç€å®‰å…¨è¿è¥è¿™ä¸€å—çš„å·¥ä½œï¼Œéšç€å·¥ä½œçš„å¼€å±•å‘ç°è‡ªå·±<strong>â€œç»„è£…â€</strong>çš„SIEMç”¨èµ·æ¥ä¸æ˜¯å¾ˆâ€œ<strong>èˆ’æœ</strong>â€ã€‚è¿™æ˜¯æˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡ã€Š<a target="_blank" rel="noopener" href="https://canon88.github.io/2020/02/25/Wazuh-%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E5%91%8A%E8%AD%A6/"><strong>Wazuh-å¦‚ä½•å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”å‘Šè­¦</strong></a>ã€‹çš„æ–‡ç« ï¼Œå½“æ—¶è§„åˆ’çš„æ•°æ®æµçš„Workflowå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/image-20200303215020561.png" alt="image-20200303215020561"></p>
<p>â€‹        <strong>â€œæ•£è£…â€SIEM</strong>ä¸»è¦æ˜¯å»ºç«‹åœ¨ELKçš„æ¡†æ¶ä¹‹ä¸Šï¼Œå‘Šè­¦æ¨¡å—åˆ†åˆ«é‡‡ç”¨äº†Wazuhä¸Elastalertã€‚æ—©æœŸä¸ºäº†ä½¿Wazuhèƒ½å¤Ÿæ¶ˆè´¹å¼‚æ„æ•°æ®<strong>ï¼ˆWAFã€NTAã€EDRï¼‰</strong>å¹¶è¿›è¡Œå…³è”å‘Šè­¦ï¼Œæˆ‘åœ¨æ•°æ®å…¥åº“ä¹‹å‰åˆ©ç”¨Logstashå¯¹å¼‚æ„æ•°æ®è¿›è¡Œäº†æ ‡å‡†åŒ–ï¼ŒåŒæ—¶Wazuhå¯¹æ ‡å‡†åŒ–åçš„æ•°æ®è¿›è¡Œå…³è”ã€‚ä¾‹å¦‚ï¼šSuricataé€šè¿‡Filebeatå°†å‘Šè­¦äº‹ä»¶å‘å‡ºï¼Œç”±Logstashç»Ÿä¸€è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†å¹¶åŒæ—¶è¾“å‡ºåˆ°Elasticä»¥åŠWazuhã€‚å…¶ä¸­Elasticä¸ºå‘Šè­¦çš„å…ƒæ•°æ®ï¼Œæ¨é€åˆ°Wazuhä¸Šçš„ä¸ºæ ‡å‡†åŒ–åçš„å®‰å…¨äº‹ä»¶ã€‚</p>
<hr>
<h1 id="â€œæ•£è£…â€SIEM-v0-1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½"><a href="#â€œæ•£è£…â€SIEM-v0-1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½" class="headerlink" title="â€œæ•£è£…â€SIEM v0.1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½"></a>â€œæ•£è£…â€SIEM v0.1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½</h1><h2 id="1-æ•°æ®æ ‡å‡†åŒ–"><a href="#1-æ•°æ®æ ‡å‡†åŒ–" class="headerlink" title="1. æ•°æ®æ ‡å‡†åŒ–"></a>1. æ•°æ®æ ‡å‡†åŒ–</h2><p>â€‹        ç”±äºå‰æœŸçš„æ ‡å‡†åŒ–æœªé‡‡ç”¨**<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/ecs/current/ecs-reference.html">ECS</a>**(<strong>Elastic Common Schema</strong>)ï¼Œå¯¼è‡´åæœŸæ²¿ç”¨Elasticç”Ÿæ€çš„æ—¶å€™å‡ºç°äº†ä½¿ç”¨ä¸Šçš„ä¸ä¾¿ã€‚å¤§å®¶éƒ½çŸ¥é“ESåœ¨7.Xçš„ç‰ˆæœ¬æ¨å‡ºäº†SIEMè¿™ä¸ªåŠŸèƒ½ï¼Œå¦‚æœæƒ³ä½¿ç”¨Elastic SIEMè¿›è¡Œåˆ†æçš„è¯ï¼Œé‚£ä¹ˆECSæ˜¯é¦–é€‰ã€‚è¿™é‡Œä¸ºäº†åæœŸä¸å¼€æºç”Ÿæ€æ›´å¥½çš„è¿›è¡Œèåˆï¼Œéœ€è¦å°†åŸå…ˆçš„æ ‡å‡†åŒ–è½¬ä¸ºECSçš„æ ¼å¼ã€‚</p>
<h2 id="2-å‘Šè­¦ä¸°å¯ŒåŒ–"><a href="#2-å‘Šè­¦ä¸°å¯ŒåŒ–" class="headerlink" title="2. å‘Šè­¦ä¸°å¯ŒåŒ–"></a>2. å‘Šè­¦ä¸°å¯ŒåŒ–</h2><p>ä¸ºäº†æ›´æœ‰æ•ˆçš„æå‡å‘Šè­¦è´¨é‡ï¼Œæé«˜å®‰å…¨åˆ†æçš„æ•ˆç‡ã€‚éœ€è¦å¯¹å…¥åº“çš„å®‰å…¨äº‹ä»¶ä»¥åŠäº§ç”Ÿçš„å‘Šè­¦è¿›è¡Œå¿…è¦çš„ä¸°å¯ŒåŒ–ã€‚</p>
<ul>
<li><p>åˆ©ç”¨CMDBå¹³å°çš„æ•°æ®å¯¹å†…éƒ¨èµ„äº§è¿›è¡Œä¸°å¯ŒåŒ–ã€‚ä¾‹å¦‚å¢åŠ ï¼šéƒ¨é—¨ã€ä¸šåŠ¡ã€åº”ç”¨ç±»å‹ã€è´Ÿè´£äººç­‰å­—æ®µã€‚</p>
</li>
<li><p>å¯¹æ¥å¨èƒæƒ…æŠ¥æ•°æ®ï¼ŒSIEMä¼šå¯¹å‘Šè­¦äº‹ä»¶çš„æ”»å‡»IPè¿›è¡Œæƒ…æŠ¥ä¾§æ•°æ®çš„ä¸°å¯ŒåŒ–ï¼›</p>
<ul>
<li>æœ¬åœ°å¨èƒæƒ…æŠ¥ï¼ˆæ›¾ç»æ”»å‡»è¿‡æˆ‘ä»¬çš„IPåœ°å€ï¼‰</li>
<li>ç¬¬ä¸‰æ–¹å¨èƒæƒ…æŠ¥<ul>
<li>å¼€æº</li>
<li>å•†ä¸š</li>
</ul>
</li>
</ul>
</li>
<li><p>æ•æ„Ÿæ¥å£ç›‘æ§ï¼ˆå¦‚ï¼šç™»å½•æ¥å£ã€æ”¯ä»˜æ¥å£ã€é’±åŒ…æ¥å£ï¼‰ã€‚åˆ©ç”¨ç¬¬ä¸‰æ–¹æ•°æ®å¯¹IPåœ°å€è¿›è¡ŒProxyæ ‡è®°ï¼Œä¸ºåæœŸé£æ§çš„ç ”åˆ¤æä¾›ä¸€äº›æ•°æ®æ”¯æ’‘ï¼›</p>
</li>
<li><p>ä¸ºå®‰å…¨äº‹ä»¶å¢åŠ æ–¹å‘ä¸åŒºåŸŸçš„å­—æ®µã€‚ä¾¿äºåˆ†æäººå‘˜ç¬¬ä¸€æ—¶é—´è¯†åˆ«<strong>å†…å¯¹å†…</strong>ä»¥åŠ<strong>å†…å¯¹å¤–</strong>çš„å‘Šè­¦ã€‚ä¹Ÿå¯é’ˆå¯¹æ–¹å‘è¿›è¡Œå‘Šè­¦çº§åˆ«çš„æƒé‡è°ƒæ•´ï¼›</p>
</li>
</ul>
<h2 id="3-æå‡æ£€æµ‹èƒ½åŠ›"><a href="#3-æå‡æ£€æµ‹èƒ½åŠ›" class="headerlink" title="3. æå‡æ£€æµ‹èƒ½åŠ›"></a>3. æå‡æ£€æµ‹èƒ½åŠ›</h2><p>åº•å±‚å®‰å…¨è®¾å¤‡çš„æ£€æµ‹èƒ½åŠ›ä¸å®‰å…¨äº‹ä»¶çš„å¯ä¿¡åº¦ï¼Œæ˜¯ç›´æ¥å½±å“SIEMå‘Šè­¦çš„å…³é”®å› ç´ ã€‚</p>
<ul>
<li>æ¥å…¥Imperva WAFçš„å‘Šè­¦æ•°æ®ï¼Œä¸Suricataè¿›è¡Œè‡ªåŠ¨åŒ–å…³è”ï¼Œå®šæœŸå°†ç»•è¿‡çš„è§„åˆ™â€œç§»æ¤â€åˆ°å‰ç«¯çš„Imperva WAFä¸Šï¼ŒåŠ å¼ºè¾¹ç•Œçš„å®‰å…¨é˜²æŠ¤èƒ½åŠ›ï¼›</li>
<li>â€œæ¶ˆè´¹â€AWS VPC FLOWæ•°æ®ï¼Œå¢åŠ <strong>å†…å¯¹å¤–</strong>çš„å¼‚å¸¸è¿æ¥æ£€æµ‹èƒ½åŠ›ã€‚ç”±äºæ˜¯å››å±‚æ•°æ®èƒ½å¤Ÿè¢«<strong>â€œæ¶ˆè´¹â€</strong>çš„ç»´åº¦å®åœ¨ä¸å¤šã€‚ä¸»è¦å®ç°äº†ä»¥ä¸‹å‡ ç§å‘Šè­¦ï¼š<ul>
<li>å‘¨æœŸæ€§è¿æ¥å‘Šè­¦</li>
<li>å¨èƒæƒ…æŠ¥ç±»å‘Šè­¦</li>
<li>ç«¯å£æ‰«æç±»å‘Šè­¦<ul>
<li>çŸ­æ—¶é—´å†…ï¼Œå†…ç½‘ä¸»æœºè¯·æ±‚ç›¸åŒç›®çš„IPçš„å¤šä¸ªç«¯å£</li>
<li>çŸ­æ—¶é—´å†…ï¼Œå†…ç½‘ä¸»æœºè¯·æ±‚å¤šä¸ªIPçš„ç›¸åŒç›®çš„ç«¯å£</li>
</ul>
</li>
<li>æ•æ„Ÿç«¯å£è¯·æ±‚å‘Šè­¦</li>
</ul>
</li>
</ul>
<h2 id="4-æº¯æºåˆ†æ"><a href="#4-æº¯æºåˆ†æ" class="headerlink" title="4. æº¯æºåˆ†æ"></a>4. æº¯æºåˆ†æ</h2><p>ç›®å‰SIEMäº§ç”Ÿçš„å‘Šè­¦ï¼Œå¹¶ä¸ä¼šæºå¸¦åŸå§‹çš„å®‰å…¨äº‹ä»¶ï¼Œè¿™å¯¹äºåˆ†æå°ä¼™ä¼´æ¥è¯´å¹¶ä¸å‹å¥½ï¼Œç‰¹åˆ«æ˜¯å‘Šè­¦é‡æ¯”è¾ƒå¤šçš„æ—¶å€™ã€‚</p>
<ul>
<li>ç°å·²ä¸ºæ¯ä¸€ä¸ªå‘Šè­¦å¢åŠ äº†**â€Huntingâ€**çš„å­—æ®µï¼Œé€šè¿‡è¯¥å­—æ®µå¯ç›´æ¥æº¯æºåˆ°åº•å±‚çš„å®‰å…¨äº‹ä»¶ï¼›</li>
<li>å¢åŠ äº†æ›´é€‚ç”¨äºå®‰å…¨åˆ†æäººå‘˜ä½¿ç”¨çš„ä»ªè¡¨ç›˜ï¼›</li>
<li>ç¼–å†™äº†ä¸€ä¸ª<strong>è‡ªè®¤ä¸º</strong>æ¯”è¾ƒè´´åˆåˆ†æäººå‘˜ä½¿ç”¨çš„å·¥å…·ï¼š<strong>HappyHunting</strong>ï¼›</li>
</ul>
<h2 id="5-å…¶ä»–æ”¹è¿›"><a href="#5-å…¶ä»–æ”¹è¿›" class="headerlink" title="5. å…¶ä»–æ”¹è¿›"></a>5. å…¶ä»–æ”¹è¿›</h2><ul>
<li><p>è§£å†³äº†SIEMè”åŠ¨CDN WAF APIå“åº”æ—¶é—´è¿‡é•¿ï¼ˆ15-20åˆ†é’Ÿ ğŸ˜…ï¼‰çš„é—®é¢˜ã€‚ç›®å‰ä¸Imperva WAF APIè”åŠ¨å·²åšåˆ°äº†å‡†å®æ—¶ã€‚</p>
</li>
<li><p>ä¼˜åŒ–NTA login_auditä»£ç ï¼Œæå‡NTAæ€§èƒ½ã€‚ä¹‹å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ã€Š**<a target="_blank" rel="noopener" href="https://canon88.github.io/2019/10/24/Suricata+Lua%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E6%83%85%E6%8A%A5%E5%AF%B9%E6%8E%A5/">Suricata + Luaå®ç°æœ¬åœ°æƒ…æŠ¥å¯¹æ¥</a>**ã€‹ï¼Œä¸»è¦åˆ©ç”¨äº†Luaè„šæœ¬å¯¹â€œæ•æ„Ÿâ€æ¥å£è¿›è¡Œç™»å½•å®¡è®¡å¹¶åˆ©ç”¨æƒ…æŠ¥è¿›è¡Œé«˜å±è´¦å·æ£€æµ‹ã€‚ç°å·²å°†è¿™éƒ¨åˆ†åŠŸèƒ½ç§»æ¤åˆ°Logstash + Rubyä¸Šï¼›</p>
</li>
<li><p>ä¹‹å‰çš„è‡ªåŠ¨åŒ–è”åŠ¨è§„åˆ™éƒ½æ˜¯é€šè¿‡æ‰‹åŠ¨ä¿®æ”¹è„šæœ¬è°ƒæ•´<strong>rule.id</strong>æ¥å®ç°ï¼Œè¿™ç§æ–¹å¼åœ¨åˆæœŸè¿˜èƒ½å‹‰å¼ºè¿è¡Œã€‚ä½†åœ¨åæœŸè¿è¡Œä¸­æš´éœ²å‡ºäº†ä¸è¶³ï¼Œæ—¢ä¸ä¾¿äºç®¡ç†ä¹Ÿå¢åŠ äº†ç»´æŠ¤çš„æˆæœ¬ã€‚æ‰€ä»¥ä¸ºäº†ç»´æŠ¤SIEMçš„è§„åˆ™ï¼Œè¿™é‡Œé‡‡ç”¨äº†Redisæ¥è¿›è¡Œè§„åˆ™çš„ç»Ÿä¸€ç®¡ç†ã€‚åæœŸåªéœ€è¦å°†éœ€è¦é˜»æ–­çš„<strong>rule.id</strong>æ¨é€è‡³Rediså³å¯ã€‚åŒæ—¶ä¹Ÿåœ¨è¾“å‡ºçš„å‘Šè­¦ä¸­é€šè¿‡<strong>event.action</strong>å­—æ®µæ ‡å‡†è¯¥å‘Šè­¦çš„å“åº”æ–¹å¼ï¼›</p>
</li>
</ul>
<hr>
<h1 id="â€œè¿›åŒ–â€-â€œæ•£è£…â€SIEM-v0-2"><a href="#â€œè¿›åŒ–â€-â€œæ•£è£…â€SIEM-v0-2" class="headerlink" title="â€œè¿›åŒ–â€ - â€œæ•£è£…â€SIEM v0.2"></a>â€œè¿›åŒ–â€ - â€œæ•£è£…â€SIEM v0.2</h1><h2 id="1-Workflow"><a href="#1-Workflow" class="headerlink" title="1. Workflow"></a>1. Workflow</h2><p>â€‹        è¿™æ˜¯é‡æ–°è°ƒæ•´ä¹‹åçš„<strong>â€œæ•£è£…â€SIEM v0.2</strong>çš„workflowğŸ˜ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ•°æ®æºé‡‡é›†ç«¯è¿™é‡Œå°±ä¸å±•å¼€æ¥è¯´äº†ï¼Œéƒ½æ˜¯ç°æˆçš„å·¥å…·å‘å°±å®Œäº‹å„¿äº†ã€‚ä¸‹é¢ä¸»è¦è¯´ä¸€ä¸‹Logstashä¸­å¯¹æ•°æ®å¤„ç†çš„éƒ¨åˆ†ï¼š</p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-v0.2.jpg" alt="SIEM-v0.2"></p>
<hr>
<h2 id="2-æ•°æ®å¤„ç†"><a href="#2-æ•°æ®å¤„ç†" class="headerlink" title="2. æ•°æ®å¤„ç†"></a>2. æ•°æ®å¤„ç†</h2><h3 id="1-Normalized"><a href="#1-Normalized" class="headerlink" title="1. Normalized"></a>1. Normalized</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/normalized-04.png" alt="image-20201208110506481"></p>
<hr>
<h4 id="1-1-normalized-alert-to-siem"><a href="#1-1-normalized-alert-to-siem" class="headerlink" title="1.1 normalized-alert_to_siem"></a>1.1 normalized-alert_to_siem</h4><p>â€‹        é’ˆå¯¹alertäº‹ä»¶è¿›è¡Œæ ‡å‡†åŒ–ï¼Œä¹Ÿå°±æ˜¯å®‰å…¨è®¾å¤‡å‘å‡ºçš„æ•°æ®ã€‚å‚è€ƒä¸Šå›¾ä¸­è“è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<p>â€‹        å®˜æ–¹å·²æ”¯æŒSuricataæ•°æ®çš„ECSï¼Œæˆ‘ä»¬å¯ç›´æ¥å¯ç”¨filebeatçš„Suricataæ¨¡å—ã€‚<strong>ä½†æ˜¯</strong>ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œé»˜è®¤Suricataçš„æ¨¡å—ä¸­æœ‰ä¸€äº›æ ‡å‡†åŒ–æ˜¯äº¤ç”±Elasticæ¥åšçš„ã€‚ç”±äºæˆ‘ä»¬éœ€è¦åˆ©ç”¨Logstashåšåç»­çš„ETLéƒ¨åˆ†ï¼Œæ‰€ä»¥ç°åœ¨çš„æ•´ä¸ªæ•°æ®æµæ˜¯ï¼š<strong>Filebeat -&gt; Logstash -&gt; Elastic</strong>ã€‚é‚£ä¹ˆï¼Œè¿™ä¸€éƒ¨åˆ†çš„æ ‡å‡†åŒ–ï¼Œéœ€è¦æˆ‘ä»¬åœ¨Logstashå±‚é¢æ¥å®ç°ã€‚å…·ä½“æ¶‰åŠåˆ°çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<h5 id="1-1-1-normalized-suricata"><a href="#1-1-1-normalized-suricata" class="headerlink" title="1.1.1 normalized-suricata"></a>1.1.1 normalized-suricata</h5><p>â€‹    é€šç”¨Suricataäº‹ä»¶æ ‡å‡†åŒ–é…ç½®ã€‚</p>
<ul>
<li>åˆ é™¤ä¸€äº›filebeatè‡ªå¸¦çš„å­—æ®µã€‚</li>
<li>å¢åŠ <code>provider</code>ã€<code>product</code>ã€<code>sensor</code>ç­‰å­—æ®µï¼Œä¸ºäº†åæœŸåŒºåˆ†ä¸åŒçš„æ•°æ®æºç±»å‹ï¼Œï¼ˆä¾‹ï¼š<strong>NTAã€WAFã€EDR</strong>ï¼‰ï¼Œä»¥åŠä¸åŒçš„NTAäº§å“ï¼ˆä¾‹ï¼š<strong>Suricataã€Zeek</strong>ï¼‰</li>
</ul>
<h6 id="Logstash-Config"><a href="#Logstash-Config" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/59_normalized-suricata.conf">normalized-suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">&quot;application&quot;</span>, <span class="string">&quot;type&quot;</span>, <span class="string">&quot;agent&quot;</span>, <span class="string">&quot;@version&quot;</span>, <span class="string">&quot;[event][original]&quot;</span> ]</span><br><span class="line">        add_field =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;provider&quot;</span> =&gt; <span class="string">&quot;Suricata&quot;</span></span><br><span class="line">            <span class="string">&quot;product&quot;</span> =&gt; <span class="string">&quot;IDS&quot;</span></span><br><span class="line">            <span class="string">&quot;sensor&quot;</span> =&gt; <span class="string">&quot;%&#123;[host][name]&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        lowercase =&gt; [ <span class="string">&quot;[network][transport]&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    uuid &#123;</span><br><span class="line">        target =&gt; <span class="string">&quot;[event][id]&quot;</span></span><br><span class="line">        overwrite =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-2-normalized-alert-for-suricata"><a href="#1-1-2-normalized-alert-for-suricata" class="headerlink" title="1.1.2 normalized-alert_for_suricata"></a>1.1.2 normalized-alert_for_suricata</h5><h6 id="Logstash-Config-1"><a href="#Logstash-Config-1" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-alert.conf">normalized-alert_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][category]&quot;</span> =&gt; <span class="string">&quot;[rule][category]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][signature_id]&quot;</span> =&gt; <span class="string">&quot;[rule][id]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][signature]&quot;</span> =&gt; <span class="string">&quot;[rule][name]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][rule]&quot;</span> =&gt; <span class="string">&quot;[rule][description]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            convert =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[rule][id]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            copy =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[rule][category]&quot;</span> =&gt; <span class="string">&quot;message&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [suricata][eve][alert][action] == <span class="string">&quot;blocked&quot;</span> &#123;</span><br><span class="line">            mutate &#123;</span><br><span class="line">                update =&gt; &#123;</span><br><span class="line">                    <span class="string">&quot;[suricata][eve][alert][action]&quot;</span> =&gt; <span class="string">&quot;denied&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [suricata][eve][alert][action] &#123;</span><br><span class="line">            ruby &#123;</span><br><span class="line">                code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                    action = event.get(&#x27;[suricata][eve][alert][action]&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    event_type = event.get(&#x27;[event][type]&#x27;)</span></span><br><span class="line"><span class="string">                    if event_type then</span></span><br><span class="line"><span class="string">                        event_type = event.get(&#x27;[event][type]&#x27;).push(action)</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                        event_type = [action]</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[event][type]&#x27;, event_type)</span></span><br><span class="line"><span class="string">                    event.remove(&#x27;[suricata][eve][alert][action]&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    event.set(&#x27;[event][action]&#x27;, action)</span></span><br><span class="line"><span class="string">                &quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][severity]&quot;</span> =&gt; <span class="string">&quot;[event][severity]&quot;</span> </span><br><span class="line">                <span class="string">&quot;[suricata][eve][payload_printable]&quot;</span> =&gt; <span class="string">&quot;[rule][payload]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_request_body_printable]&quot;</span> =&gt; <span class="string">&quot;[http][request][body][content]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_response_body_printable]&quot;</span> =&gt; <span class="string">&quot;[http][response][body][content]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                rule_id = event.get(&#x27;[rule][id]&#x27;)</span></span><br><span class="line"><span class="string">                rule_name = event.get(&#x27;[rule][name]&#x27;)</span></span><br><span class="line"><span class="string">                event_id = event.get(&#x27;[event][id]&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][rule][id]&#x27;, [rule_id])</span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][rule][name]&#x27;, [rule_name])</span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][event][id]&#x27;, [event_id])</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-3-normalized-fileinfo-for-suricata"><a href="#1-1-3-normalized-fileinfo-for-suricata" class="headerlink" title="1.1.3 normalized-fileinfo_for_suricata"></a>1.1.3 normalized-fileinfo_for_suricata</h5><h6 id="Logstash-Config-2"><a href="#Logstash-Config-2" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-fileinfo.conf">normalized-fileinfo_for_suricatra.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][fileinfo] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][fileinfo][filename]&quot;</span> =&gt; <span class="string">&quot;[file][path]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][fileinfo][size]&quot;</span> =&gt; <span class="string">&quot;[file][size]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-4-normalized-flow-for-suricata"><a href="#1-1-4-normalized-flow-for-suricata" class="headerlink" title="1.1.4 normalized-flow_for_suricata"></a>1.1.4 normalized-flow_for_suricata</h5><h6 id="Logstash-Config-3"><a href="#Logstash-Config-3" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-flow.conf">normalized-flow_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][flow] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123; </span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][pkts_toclient]&quot;</span> =&gt; <span class="string">&quot;[destination][packets]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][pkts_toserver]&quot;</span> =&gt; <span class="string">&quot;[source][packets]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][bytes_toclient]&quot;</span> =&gt; <span class="string">&quot;[destination][bytes]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][bytes_toserver]&quot;</span> =&gt; <span class="string">&quot;[source][bytes]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            init =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                @sb = 0</span></span><br><span class="line"><span class="string">                @sp = 0</span></span><br><span class="line"><span class="string">                @db = 0</span></span><br><span class="line"><span class="string">                @dp = 0</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line"></span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                events = event.to_hash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if events.has_key?(&#x27;source&#x27;) then</span></span><br><span class="line"><span class="string">                    @sb = events[&#x27;source&#x27;].fetch(&#x27;bytes&#x27;, 0)</span></span><br><span class="line"><span class="string">                    @sp = events[&#x27;source&#x27;].fetch(&#x27;packets&#x27;, 0)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if events.has_key?(&#x27;destination&#x27;) then</span></span><br><span class="line"><span class="string">                    @db = events[&#x27;destination&#x27;].fetch(&#x27;bytes&#x27;, 0)</span></span><br><span class="line"><span class="string">                    @dp = events[&#x27;destination&#x27;].fetch(&#x27;packets&#x27;, 0)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if (@sb+@db+@sp+@dp &gt; 0) then</span></span><br><span class="line"><span class="string">                    if (@sb+@db &gt; 0) then</span></span><br><span class="line"><span class="string">                        event.set(&#x27;[network][bytes]&#x27;, @sb+@db)</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                    if (@sp+@dp &gt; 0) then</span></span><br><span class="line"><span class="string">                        event.set(&#x27;[network][packets]&#x27;, @sp+@dp)</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        date &#123;</span><br><span class="line">            match =&gt; [ <span class="string">&quot;[suricata][eve][flow][start]&quot;</span>, <span class="string">&quot;ISO8601&quot;</span> ]</span><br><span class="line">            target =&gt; <span class="string">&quot;[event][start]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        date &#123;</span><br><span class="line">            match =&gt; [ <span class="string">&quot;[suricata][eve][flow][end]&quot;</span>, <span class="string">&quot;ISO8601&quot;</span> ]</span><br><span class="line">            target =&gt; <span class="string">&quot;[event][end]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123; </span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][age]&quot;</span> =&gt; <span class="string">&quot;[event][duration]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            remove_field =&gt; [</span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][start]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][end]&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-5-normalized-http-for-suricata"><a href="#1-1-5-normalized-http-for-suricata" class="headerlink" title="1.1.5 normalized-http_for_suricata"></a>1.1.5 normalized-http_for_suricata</h5><h6 id="Logstash-Config-4"><a href="#Logstash-Config-4" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-http.conf">normalized-http_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][http] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_method]&quot;</span> =&gt; <span class="string">&quot;[http][request][method]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][status]&quot;</span> =&gt; <span class="string">&quot;[http][response][status_code]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][hostname]&quot;</span> =&gt; <span class="string">&quot;[destination][domain]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [destination][domain] and [network][protocol] == <span class="string">&quot;http&quot;</span> &#123;</span><br><span class="line">            mutate &#123;</span><br><span class="line">                copy =&gt; &#123; <span class="string">&quot;[destination][domain]&quot;</span> =&gt; <span class="string">&quot;[url][domain]&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            init =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                @pattern = /(?&lt;path&gt;[^?#]*)(?:\?(?&lt;query&gt;[^#]*))?(?:#(?&lt;fragment&gt;.*))?/</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                url = event.get(&#x27;[suricata][eve][http][url]&#x27;)</span></span><br><span class="line"><span class="string">                res = @pattern.match(url)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if res[&#x27;path&#x27;] then</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[url][path]&#x27;, res[&#x27;path&#x27;])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">                if res[&#x27;query&#x27;] then</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[url][query]&#x27;, res[&#x27;query&#x27;])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">                if res[&#x27;fragment&#x27;] then</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[url][fragment]&#x27;, res[&#x27;fragment&#x27;])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][url]&quot;</span> =&gt; <span class="string">&quot;[url][original]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_refer]&quot;</span> =&gt; <span class="string">&quot;[http][request][referrer]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][length]&quot;</span> =&gt; <span class="string">&quot;[http][response][body][bytes]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_user_agent]&quot;</span> =&gt; <span class="string">&quot;[user_agent][original]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-6-normalized-http-headers-for-suricata"><a href="#1-1-6-normalized-http-headers-for-suricata" class="headerlink" title="1.1.6 normalized_http_headers_for_suricata"></a>1.1.6 normalized_http_headers_for_suricata</h5><p>â€‹        å½“<strong>Suricata</strong>è®¾ç½®<code>dump-all-headers:both</code>æ—¶ï¼Œä¼šå°†HTTPå¤´å…¨éƒ¨è¾“å‡ºã€‚å¯¹äºhttp_auditè¿™ä¸ªéœ€æ±‚è€Œè¨€æ˜¯ä¸ªå¾ˆå¥½çš„åŠŸèƒ½ï¼Œåªä¸è¿‡è¾“å‡ºçš„æ ¼å¼æœ‰ç‚¹å‘ğŸ˜‚ğŸ˜‚ğŸ˜‚ã€‚ä¸ºäº†æ›´æ–¹ä¾¿çš„åœ¨Kibanaä¸Šè¿›è¡Œç­›é€‰ï¼Œæˆ‘å¯¹è¿™éƒ¨åˆ†æ•°æ®è¿›è¡Œäº†æ ‡å‡†åŒ–ã€‚ğŸ˜</p>
<h6 id="Logstash-Config-5"><a href="#Logstash-Config-5" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-http.conf">normalized_http_headers_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][http] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/normalized_http_headers.rb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code"><a href="#Ruby-Code" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/normalized_http_headers.rb">normalized_http_headers_for_suricata.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    request = &#123;&#125;</span><br><span class="line">    response = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    request_headers = event.get(<span class="string">&quot;[suricata][eve][http][request_headers]&quot;</span>)</span><br><span class="line">    response_headers = event.get(<span class="string">&quot;[suricata][eve][http][response_headers]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request_headers <span class="keyword">then</span></span><br><span class="line">        request_headers.each <span class="keyword">do</span> <span class="params">|headers|</span></span><br><span class="line">            name = headers[<span class="string">&#x27;name&#x27;</span>].downcase</span><br><span class="line">            value = headers[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">            request[name] = value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response_headers <span class="keyword">then</span></span><br><span class="line">        response_headers.each <span class="keyword">do</span> <span class="params">|headers|</span></span><br><span class="line">            name = headers[<span class="string">&#x27;name&#x27;</span>].downcase</span><br><span class="line">            value = headers[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">            response[name] = value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.remove(<span class="string">&quot;[suricata][eve][http][request_headers]&quot;</span>)</span><br><span class="line">    event.remove(<span class="string">&quot;[suricata][eve][http][response_headers]&quot;</span>)</span><br><span class="line">    event.set(<span class="string">&quot;[suricata][eve][http][request]&quot;</span>, request)</span><br><span class="line">    event.set(<span class="string">&quot;[suricata][eve][http][response]&quot;</span>, response)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><ul>
<li>æ ‡å‡†åŒ–ä¹‹å‰çš„æ•°æ®ï¼š</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;request_headers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Connection&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;Keep-Alive&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;response_headers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Server&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;NWS_TCloud_S11&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ ‡å‡†åŒ–ä¹‹åçš„æ•°æ®ï¼š</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;http&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;host&quot;</span>: <span class="string">&quot;192.168.199.1:25782&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;connection&quot;</span>: <span class="string">&quot;Close&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;cache-control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;user-agent&quot;</span>: <span class="string">&quot;Microsoft-Windows/10.0 UPnP/1.0&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;accept&quot;</span>: <span class="string">&quot;text/xml, application/xml&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;response&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;ext&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;content-length&quot;</span>: <span class="string">&quot;2645&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;server&quot;</span>: <span class="string">&quot;RT-N56U/3.4.3.9 UPnP/1.1 MiniUPnPd/2.0&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;content-type&quot;</span>: <span class="string">&quot;text/xml; charset=\&quot;utf-8\&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;connection&quot;</span>: <span class="string">&quot;close&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-7-normalized-tls-for-suricata"><a href="#1-1-7-normalized-tls-for-suricata" class="headerlink" title="1.1.7 normalized-tls_for_suricata"></a>1.1.7 normalized-tls_for_suricata</h5><h6 id="Logstash-Config-6"><a href="#Logstash-Config-6" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-tls.conf">normalized-tls_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][tls] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            uppercase =&gt; [</span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span></span><br><span class="line">            ]</span><br><span class="line">            split =&gt; &#123; </span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span> =&gt; <span class="string">&quot;:&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            join =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span> =&gt; <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            copy =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span> =&gt; <span class="string">&quot;[related][hash]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="1-2-normalized-alarm-from-siem"><a href="#1-2-normalized-alarm-from-siem" class="headerlink" title="1.2 normalized-alarm_from_siem"></a>1.2 normalized-alarm_from_siem</h4><p>â€‹        é’ˆå¯¹alarmäº‹ä»¶è¿›è¡Œæ ‡å‡†åŒ–ï¼Œä¹Ÿå°±æ˜¯SIEMå‘å‡ºçš„æ•°æ®ã€‚å‚è€ƒä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<h5 id="1-2-1-normalized-alarm"><a href="#1-2-1-normalized-alarm" class="headerlink" title="1.2.1 normalized-alarm"></a>1.2.1 normalized-alarm</h5><p>â€‹        é€šç”¨alarmäº‹ä»¶æ ‡å‡†åŒ–é…ç½®ã€‚</p>
<h6 id="Logstash-Config-7"><a href="#Logstash-Config-7" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/70_normalized-siem.conf">normalized-alarm.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    date &#123;</span><br><span class="line">        match =&gt; [<span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;ISO8601&quot;</span>]</span><br><span class="line">        target =&gt; <span class="string">&quot;timestamp&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        rename =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;[data][source]&quot;</span> =&gt; <span class="string">&quot;source&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][destination]&quot;</span> =&gt; <span class="string">&quot;destination&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][network]&quot;</span> =&gt; <span class="string">&quot;network&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">&quot;[data][event]&quot;</span> =&gt; <span class="string">&quot;event&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][fileset]&quot;</span> =&gt; <span class="string">&quot;fileset&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">&quot;[data][http]&quot;</span> =&gt; <span class="string">&quot;http&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][url]&quot;</span> =&gt; <span class="string">&quot;url&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][user_agent]&quot;</span> =&gt; <span class="string">&quot;user_agent&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[data][related]&quot;</span> =&gt; <span class="string">&quot;related&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][threat]&quot;</span> =&gt; <span class="string">&quot;threat&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[rule][groups]&quot;</span> =&gt; <span class="string">&quot;[rule][ruleset]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        convert =&gt; &#123;</span><br><span class="line">            <span class="comment">#&quot;[agent][id]&quot; =&gt; &quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[event][severity]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[rule][id]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[related][rule][id]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[network][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[network][packets]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[source][port]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[source][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[source][packets]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[destination][port]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[destination][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[destination][packets]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[http][response][status_code]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[http][response][body][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        remove_field =&gt; [</span><br><span class="line">            <span class="string">&quot;beat&quot;</span>, <span class="string">&quot;input_type&quot;</span>, <span class="string">&quot;tags&quot;</span>, <span class="string">&quot;count&quot;</span>, <span class="string">&quot;@version&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ecs&quot;</span>, <span class="string">&quot;log&quot;</span>, <span class="string">&quot;offset&quot;</span>, <span class="string">&quot;type&quot;</span>, <span class="string">&quot;host&quot;</span>, <span class="string">&quot;predecoder&quot;</span>,</span><br><span class="line">            <span class="string">&quot;decoder&quot;</span>, <span class="string">&quot;[data][rule]&quot;</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        copy =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;[rule][description]&quot;</span> =&gt; <span class="string">&quot;[rule][name]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;previous_output&quot;</span> =&gt; <span class="string">&quot;[related][event][log]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                src_ip = event.get(&#x27;[source][ip]&#x27;)</span></span><br><span class="line"><span class="string">                dst_ip = event.get(&#x27;[destination][ip]&#x27;)</span></span><br><span class="line"><span class="string">                src_port = event.get(&#x27;[source][port]&#x27;).to_s</span></span><br><span class="line"><span class="string">                dst_port = event.get(&#x27;[destination][port]&#x27;).to_s</span></span><br><span class="line"><span class="string">                rule_name = event.get(&#x27;[related][rule][name]&#x27;)[0].to_s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                rule_description = src_ip + &#x27;:&#x27; + src_port + &#x27; -&gt; &#x27; + dst_ip + &#x27;:&#x27; + dst_port + &#x27; -&gt; &#x27; + rule_name</span></span><br><span class="line"><span class="string">                event.set(&#x27;[rule][description]&#x27;, rule_description)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if event.get(&#x27;[related][rule][id]&#x27;) then</span></span><br><span class="line"><span class="string">                    sid = event.get(&#x27;[related][rule][id]&#x27;)[0]</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[rule][uuid]&#x27;, sid)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                event.set(&#x27;[rule][category]&#x27;, &#x27;Frequency&#x27;)</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-Enrichment"><a href="#2-Enrichment" class="headerlink" title="2. Enrichment"></a>2. Enrichment</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/enrichment-0.1.png" alt="image-20201208110506481"></p>
<hr>
<h4 id="2-1-enrichment-alert-to-siem"><a href="#2-1-enrichment-alert-to-siem" class="headerlink" title="2.1 enrichment_alert_to_siem"></a>2.1 enrichment_alert_to_siem</h4><p>â€‹        é’ˆå¯¹alertäº‹ä»¶è¿›è¡Œä¸°å¯ŒåŒ–ï¼Œä¹Ÿå°±æ˜¯å®‰å…¨è®¾å¤‡å‘å‡ºçš„åŸå§‹å®‰å…¨äº‹ä»¶ã€‚å‚è€ƒä¸Šå›¾ä¸­è“è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<h5 id="2-1-1-enrichment-alert-direction-for-suricata"><a href="#2-1-1-enrichment-alert-direction-for-suricata" class="headerlink" title="2.1.1 enrichment-alert_direction_for_suricata"></a>2.1.1 enrichment-alert_direction_for_suricata</h5><p>â€‹        ç”±äºä¸€äº›ç‰¹æ®ŠåŸå› ï¼Œæˆ‘ä¸å¾—ä¸å°†<strong>suricata.yaml</strong>é…ç½®æ–‡ä»¶ä¸­çš„<code>EXTERNAL_NET = any</code>ã€‚è¿™ä¹Ÿå¯¼è‡´äº†éƒ¨åˆ†Suricataå‘Šè­¦çš„è¯¯æŠ¥ï¼Œæ¯•ç«Ÿæ”¾å¼€äº†è§„åˆ™çš„æ–¹å‘è¿™ä¸ªæ”¶æ•›æ¡ä»¶ã€‚æ‰€ä»¥ï¼Œæˆ‘åˆ©ç”¨äº†Logstash åœ¨æ•°æ®å…¥åº“åˆ°SIEMä¹‹å‰åšäº†ä¸€å±‚è¿‡æ»¤ã€‚</p>
<h6 id="Logstash-Config-8"><a href="#Logstash-Config-8" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/72_enrichment-alert_direction.conf">enrichment-alert_direction_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [rule][description] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/add_direction.rb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-1"><a href="#Ruby-Code-1" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/add_direction.rb">enrichment-alert_direction_for_suricata.rb</a></strong><ul>
<li><em>è¿‡æ»¤è§¦å‘è§„åˆ™çš„IPä¸è§„åˆ™æ–¹å‘ä¸åŒ¹é…çš„å®‰å…¨äº‹ä»¶</em></li>
<li><em>å¢åŠ æ–¹å‘ä¸åŒºåŸŸçš„å­—æ®µï¼Œä¾¿äºåˆ†æäººå‘˜ç¬¬ä¸€æ—¶é—´è¯†åˆ«<strong>å†…å¯¹å†…</strong>ä»¥åŠ<strong>å†…å¯¹å¤–</strong>çš„å‘Šè­¦ã€‚</em></li>
</ul>
</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;ipaddr&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> src_ip <span class="keyword">or</span> <span class="keyword">not</span> dst_ip <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    ipaddr_src = IPAddr.new src_ip</span><br><span class="line">    ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Sample: alert http $EXTERNAL_NET any -&gt; $HOME_NET any</span></span><br><span class="line">    rule = event.get(<span class="string">&quot;[rule][description]&quot;</span>)</span><br><span class="line">    src_direction = rule.split(<span class="string">&quot; &quot;</span>)[<span class="number">2</span>]</span><br><span class="line">    dst_direction = rule.split(<span class="string">&quot; &quot;</span>)[<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">    src_private = ipaddr_src.private?()</span><br><span class="line">    dst_private = ipaddr_dst.private?()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> event.get(<span class="string">&quot;provider&quot;</span>) == <span class="string">&quot;Suricata&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> ( src_private ) <span class="keyword">and</span> ( src_direction == <span class="string">&quot;$EXTERNAL_NET&quot;</span> ) <span class="keyword">then</span></span><br><span class="line">            event.cancel</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( dst_private ) <span class="keyword">and</span> ( dst_direction == <span class="string">&quot;$EXTERNAL_NET&quot;</span> ) <span class="keyword">then</span></span><br><span class="line">            event.cancel</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> src_private <span class="keyword">and</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">&quot;outbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;internal&quot;</span></span><br><span class="line">    <span class="keyword">elsif</span> src_private <span class="keyword">and</span> <span class="keyword">not</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">&quot;outbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;internal&quot;</span></span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> src_private <span class="keyword">and</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">&quot;inbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;external&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        direction = <span class="string">&quot;inbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;external&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.set(<span class="string">&quot;[network][direction]&quot;</span>, direction)</span><br><span class="line">    event.set(<span class="string">&quot;[network][zone]&quot;</span>, zone)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-2-enrichment-related-domain-for-suricata"><a href="#2-1-2-enrichment-related-domain-for-suricata" class="headerlink" title="2.1.2 enrichment_related_domain_for_suricata"></a>2.1.2 enrichment_related_domain_for_suricata</h5><p>â€‹        ä¸ºäº†ä¾¿äºåæœŸåšå…³è”åˆ†æï¼Œå¢åŠ äº†æ”»å‡»è€…ä¸åŸŸåçš„å…³è”å­—æ®µã€‚</p>
<h6 id="Logstash-Config-9"><a href="#Logstash-Config-9" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/72_enrichment-related_domain.conf">enrichment_related_domain_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [url][domain] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                source_ip = event.get(&#x27;[source][ip]&#x27;)</span></span><br><span class="line"><span class="string">                url_domain = event.get(&#x27;[url][domain]&#x27;)</span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][domain]&#x27;, [source_ip, url_domain])</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-3-add-geo-private-ip"><a href="#2-1-3-add-geo-private-ip" class="headerlink" title="2.1.3 add_geo-private_ip"></a>2.1.3 add_geo-private_ip</h5><p>â€‹        ä¸ºå†…ç½‘IPå¢åŠ åœ°ç†ä½ç½®æ ‡ç¤ºï¼Œä¸»è¦æ˜¯ä¸ºäº†<strong>Dashboard</strong>å±•ç¤ºçš„æ—¶å€™å¯ä»¥çœ‹åˆ°èµ„äº§åœ¨åœ°å›¾ä¸Šçš„åæ ‡ã€‚<strong>åœ°å›¾ç‚®ï¼ŸBIUBIUBIUï¼Ÿ</strong>ğŸ˜‚ã€‚ç”±äºä¸æ˜¯å¤–ç½‘IPæ²¡åŠæ³•åŠ è½½GeoIPè¿›è¡ŒåŒ¹é…ï¼Œè¿™é‡Œä½¿ç”¨äº†<strong>Translate</strong>è¿™ä¸ªæ’ä»¶æ¥è¿›è¡Œé…ç½®ã€‚</p>
<h6 id="Logstash-Conifg"><a href="#Logstash-Conifg" class="headerlink" title="Logstash Conifg"></a><strong>Logstash Conifg</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/70_enrichment-geo_private_ip.conf">add-geo_private_ip.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_geo.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[source][geo]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_asn.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[source][as]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">&quot;translation_geo&quot;</span>, <span class="string">&quot;translation_as&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_geo.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[destination][geo]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_asn.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[destination][as]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">&quot;translation_geo&quot;</span>, <span class="string">&quot;translation_as&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Yaml"><a href="#Yaml" class="headerlink" title="Yaml"></a><strong>Yaml</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/private_ip_geo.yml">private_ip_geo.yml</a></strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;192.168.199.\d+&#x27;</span><span class="string">:</span> <span class="string">&#x27;&#123;&quot;location&quot;:&#123;&quot;lat&quot;:45.8491,&quot;lon&quot;:-119.7143&#125;,&quot;country_name&quot;:&quot;China&quot;,&quot;country_iso_code&quot;:&quot;CN&quot;,&quot;region_name&quot;:&quot;Jiangsu&quot;,&quot;region_iso_code&quot;:&quot;JS&quot;,&quot;city_name&quot;:&quot;Nanjing&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/private_ip_asn.yml">private_ip_asn.yml</a></strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;192.168.199.\d+&#x27;</span><span class="string">:</span> <span class="string">&#x27;&#123;&quot;number&quot;:4134,&quot;organization.name&quot;:&quot;CHINANET-BACKBONE&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/add-geo_ip-2.png" alt="image-20201209110617996"></p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/add-geo_ip-1.png" alt="image-20201208153642680"></p>
<hr>
<h5 id="2-1-4-add-geo-public-ip"><a href="#2-1-4-add-geo-public-ip" class="headerlink" title="2.1.4 add_geo-public_ip"></a>2.1.4 add_geo-public_ip</h5><p>â€‹    å¤–ç½‘IPå°±æ¯”è¾ƒå¥½æå®šäº†ç›´æ¥åŠ è½½GeoIPæ•°æ®å³å¯ã€‚</p>
<h6 id="Logstash-Conifg-1"><a href="#Logstash-Conifg-1" class="headerlink" title="Logstash Conifg"></a><strong>Logstash Conifg</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/71_enrichment-geo_public_ip.conf">add-geo_public_ip.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> ! [<span class="built_in">source</span>][geo] &#123;</span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[source][geo]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;city_name&quot;</span>, <span class="string">&quot;country_name&quot;</span>, <span class="string">&quot;country_code2&quot;</span>, <span class="string">&quot;region_name&quot;</span>, <span class="string">&quot;region_code&quot;</span>, <span class="string">&quot;location&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-City.mmdb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[source][as]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;autonomous_system_organization&quot;</span>, <span class="string">&quot;autonomous_system_number&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-ASN.mmdb&quot;</span></span><br><span class="line">            default_database_type =&gt; <span class="string">&quot;ASN&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> ! [destination][geo] &#123;</span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[destination][geo]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;city_name&quot;</span>, <span class="string">&quot;country_name&quot;</span>, <span class="string">&quot;country_code2&quot;</span>, <span class="string">&quot;region_name&quot;</span>, <span class="string">&quot;region_code&quot;</span>, <span class="string">&quot;location&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-City.mmdb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[destination][as]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;autonomous_system_organization&quot;</span>, <span class="string">&quot;autonomous_system_number&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-ASN.mmdb&quot;</span></span><br><span class="line">            default_database_type =&gt; <span class="string">&quot;ASN&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][geo][country_code2]&quot;</span>, <span class="string">&quot;[source][geo][country_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][geo][region_code]&quot;</span>, <span class="string">&quot;[source][geo][region_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][as][asn]&quot;</span>, <span class="string">&quot;[source][as][number]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][as][as_org]&quot;</span>, <span class="string">&quot;[source][as][organization.name]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][geo][country_code2]&quot;</span>, <span class="string">&quot;[destination][geo][country_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][geo][region_code]&quot;</span>, <span class="string">&quot;[destination][geo][region_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][as][asn]&quot;</span>, <span class="string">&quot;[destination][as][number]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][as][as_org]&quot;</span>, <span class="string">&quot;[destination][as][organization.name]&quot;</span>]</span><br><span class="line"></span><br><span class="line">        remove_tag =&gt; [ <span class="string">&quot;_geoip_lookup_failure&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="2-2-enrichment-alarm-from-siem"><a href="#2-2-enrichment-alarm-from-siem" class="headerlink" title="2.2 enrichment-alarm_from_siem"></a>2.2 enrichment-alarm_from_siem</h4><p>â€‹        é’ˆå¯¹alarmäº‹ä»¶è¿›è¡Œä¸°å¯ŒåŒ–ï¼Œä¹Ÿå°±æ˜¯SIEMå‘å‡ºçš„æ•°æ®ã€‚ä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<h5 id="2-2-1-enrichment-related-event-id-for-wazuh"><a href="#2-2-1-enrichment-related-event-id-for-wazuh" class="headerlink" title="2.2.1 enrichment-related_event_id_for_wazuh"></a>2.2.1 enrichment-related_event_id_for_wazuh</h5><p>â€‹    ä¸ºSIEMå‘Šè­¦å¢åŠ äº†<strong>Hunting</strong>çš„åŠŸèƒ½ï¼Œé€šè¿‡è¯¥åŠŸèƒ½å¯ç›´æ¥æº¯æºåˆ°è§¦å‘alarmçš„æ‰€æœ‰alertäº‹ä»¶ã€‚</p>
<h6 id="Logstash-Config-10"><a href="#Logstash-Config-10" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-related.conf"><strong>enrichment-related_event_id_for_wazuh.conf</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> and [related][event][<span class="built_in">log</span>] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/add_related_event_id.rb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-2"><a href="#Ruby-Code-2" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/add_related_event_id.rb">enrichment-related_event_id_for_wazuh.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;json&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@pattern</span> = <span class="regexp">/(?:\\n)?\w+ \d+ \d+:\d+:\d+ logstash NORMALIZED\[-\]: /</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    event_id = []</span><br><span class="line">    rule_id = []</span><br><span class="line">    rule_name = []</span><br><span class="line">    event_log = event.get(<span class="string">&#x27;[related][event][log]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    atomic_rules = event_log.split(<span class="variable">@pattern</span>)[<span class="number">1</span> .. -<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> atomic <span class="keyword">in</span> atomic_rules <span class="keyword">do</span></span><br><span class="line">        e_id = JSON.parse(atomic)[<span class="string">&#x27;event&#x27;</span>][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        r_id = JSON.parse(atomic)[<span class="string">&#x27;rule&#x27;</span>][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        r_name = JSON.parse(atomic)[<span class="string">&#x27;rule&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        event_id.push(e_id)</span><br><span class="line">        rule_id.push(r_id)</span><br><span class="line">        rule_name.push(r_name)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    event.set(<span class="string">&#x27;[related][event][id]&#x27;</span>, event_id)</span><br><span class="line">    event.set(<span class="string">&#x27;[related][rule][id]&#x27;</span>, rule_id)</span><br><span class="line">    event.set(<span class="string">&#x27;[related][rule][name]&#x27;</span>, rule_name)</span><br><span class="line">    event.remove(<span class="string">&#x27;[related][event][log]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><p>â€‹        ä»¥ä¸‹æ˜¯ä¸€ä¸ªWazuhèšåˆå‘Šè­¦ï¼Œåˆ†æäººå‘˜é€šè¿‡ç‚¹å‡»<code>threat.hunting.event.id</code>å­—æ®µå³å¯æº¯æºå‡ºè§¦å‘è¯¥èšåˆè§„åˆ™çš„åº•å±‚alertäº‹ä»¶ã€‚</p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/hunting-alarm.png" alt="image-20201204175051910"></p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/hunting-alert.png" alt="image-20201204175244182"></p>
<hr>
<h3 id="3-Threat-Intelligence"><a href="#3-Threat-Intelligence" class="headerlink" title="3. Threat Intelligence"></a>3. Threat Intelligence</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat-intelligence.png" alt="threat-intelligence"></p>
<h4 id="3-1-threatIntel-alert-to-siem"><a href="#3-1-threatIntel-alert-to-siem" class="headerlink" title="3.1 threatIntel_alert_to_siem"></a>3.1 threatIntel_alert_to_siem</h4><p>â€‹        é€šè¿‡LogstashåŠ è½½Rubyè„šæœ¬ï¼Œå°†IoCæ¨é€è‡³Redisã€‚ä¸ºäº†é¿å…é‡å¤æ¨é€ï¼Œæ¯ä¸ªIoCéƒ½ä¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤7å¤©ï¼‰ã€‚å¦‚ä¸Šå›¾ä¸­è“è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†ï¼›</p>
<h5 id="3-1-1-add-ti-shodan"><a href="#3-1-1-add-ti-shodan" class="headerlink" title="3.1.1 add-ti_shodan"></a>3.1.1 add-ti_shodan</h5><p>â€‹        å¯¹äºæ”»å‡»è¿‡æˆ‘ä»¬çš„IPåœ°å€æˆ‘ä»¬éƒ½ä¼šåˆ©ç”¨<strong>Shodan</strong>è¿›è¡Œåå‘æ¢æµ‹ï¼Œæ”¶é›†ä¸€æ³¢æ”»å‡»è€…ï¼ˆè‚‰é¸¡ï¼‰çš„èµ„äº§ä¿¡æ¯ï¼Œç•™ç»™åé¢åˆ†æäººå‘˜ç”¨ã€‚ç”±äºå·²ç»è®¾ç½®äº†IoCè¶…æ—¶æ—¶é—´ï¼Œæ‰€ä»¥åœ¨è¶…æ—¶ä¹‹å‰IoCä¸ä¼šé‡å¤æ¨é€ã€‚å½“ç„¶ï¼Œå•ä¸ªKeyè°ƒç”¨APIé¢‘ç‡è¿˜æ˜¯è¦æ§åˆ¶ä¸€ä¸‹çš„ï¼Œä¸è¿‡ä½ å¯ä»¥é€‰æ‹©å¤šä¸ªKeyå“¦ã€‚<strong>ä½ æ‡‚çš„</strong>ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</p>
<h6 id="Logstash-Config-11"><a href="#Logstash-Config-11" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-ti_shodan.conf">add-ti_shodan.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">&quot;siem_events&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;siem_events&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-ti_shodan.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line"></span><br><span class="line">                <span class="string">&quot;ti_db&quot;</span> =&gt; 1</span><br><span class="line">                <span class="string">&quot;alert_prefix&quot;</span> =&gt; <span class="string">&quot;alert:&quot;</span></span><br><span class="line">                <span class="string">&quot;expire&quot;</span> =&gt; 86400</span><br><span class="line"></span><br><span class="line">                <span class="string">&quot;spider_db&quot;</span> =&gt; 5</span><br><span class="line">                <span class="string">&quot;spider_key&quot;</span> =&gt; <span class="string">&quot;spider:shodan:ioc&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-3"><a href="#Ruby-Code-3" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-ti_shodan.rb">add-ti_shodan.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;json&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;ipaddr&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@expire</span> = params[<span class="string">&quot;expire&quot;</span>]</span><br><span class="line">    <span class="variable">@alert</span> = params[<span class="string">&quot;alert_prefix&quot;</span>]</span><br><span class="line">    <span class="variable">@alarm</span> = params[<span class="string">&quot;alarm_prefix&quot;</span>]</span><br><span class="line">    <span class="variable">@spider_key</span> = params[<span class="string">&quot;spider_key&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># connect to redis</span></span><br><span class="line">    <span class="variable">@ti_redis</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;ti_db&quot;</span>])</span><br><span class="line">    <span class="variable">@spider_redis</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;spider_db&quot;</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        ipaddr_src = IPAddr.new src_ip</span><br><span class="line">        ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line">    <span class="keyword">rescue</span> Exception =&gt; e</span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ipaddr_src.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = src_ip</span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> ipaddr_dst.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = dst_ip</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> [event]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> event.get(<span class="string">&quot;[event][kind]&quot;</span>) == <span class="string">&quot;alert&quot;</span> <span class="keyword">then</span></span><br><span class="line">        alert_ioc = <span class="variable">@alert</span> + ioc</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable">@ti_redis</span>.exists?(alert_ioc) <span class="keyword">then</span></span><br><span class="line">            <span class="variable">@ti_redis</span>.setex(alert_ioc, <span class="variable">@expire</span>, <span class="literal">true</span>)</span><br><span class="line">            <span class="variable">@spider_redis</span>.lpush(<span class="variable">@spider_key</span>, ioc)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="3-2-threatIntel-alarm-from-siem"><a href="#3-2-threatIntel-alarm-from-siem" class="headerlink" title="3.2 threatIntel_alarm_from_siem"></a>3.2 threatIntel_alarm_from_siem</h4><p>â€‹        é€šè¿‡Logstashè¿›è¡Œå¨èƒæƒ…æŠ¥æ•°æ®çš„ä¸°å¯ŒåŒ–ã€‚å¦‚ä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†ï¼›</p>
<h5 id="3-2-1-add-ti-tags-from-shodan"><a href="#3-2-1-add-ti-tags-from-shodan" class="headerlink" title="3.2.1 add-ti_tags_from_shodan"></a>3.2.1 add-ti_tags_from_shodan</h5><p>â€‹        å°†Shodan IoCæƒ…æŠ¥æ•°æ®ä¸°å¯ŒåŒ–è‡³alarmã€‚</p>
<h6 id="Logstash-Config-12"><a href="#Logstash-Config-12" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-ti_shodan.conf">add-ti_tags_from_shodan.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/ti_shodan.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">                <span class="string">&quot;ti_db&quot;</span> =&gt; 1</span><br><span class="line">                <span class="string">&quot;alarm_prefix&quot;</span> =&gt; <span class="string">&quot;alarm:&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-4"><a href="#Ruby-Code-4" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-ti_shodan.rb">add-ti_tags_from_shodan.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;json&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;ipaddr&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@alarm</span> = params[<span class="string">&quot;alarm_prefix&quot;</span>]</span><br><span class="line">    <span class="comment"># connect to redis</span></span><br><span class="line">    <span class="variable">@ti_redis</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;ti_db&quot;</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        ipaddr_src = IPAddr.new src_ip</span><br><span class="line">        ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line">    <span class="keyword">rescue</span> Exception =&gt; e</span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ipaddr_src.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = src_ip</span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> ipaddr_dst.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = dst_ip</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> [event]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    raw_data = <span class="variable">@ti_redis</span>.get(<span class="variable">@alarm</span> + ioc)</span><br><span class="line">    <span class="keyword">if</span> raw_data <span class="keyword">then</span></span><br><span class="line">        data = JSON.parse(raw_data)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">then</span></span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][services]&quot;</span>, data[<span class="string">&quot;services&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][vulns]&quot;</span>, data[<span class="string">&quot;vulns&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][ports]&quot;</span>, data[<span class="string">&quot;ports&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][hostnames]&quot;</span>, data[<span class="string">&quot;hostnames&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][domains]&quot;</span>, data[<span class="string">&quot;domains&quot;</span>])</span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&quot;details&quot;</span>] <span class="keyword">then</span></span><br><span class="line">                details = data[<span class="string">&quot;details&quot;</span>].to_json</span><br><span class="line">                event.set(<span class="string">&quot;[threat][hunting][details]&quot;</span>, details)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hunting&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;vulns&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;CVE-2019-0220&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2019-0197&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2019-0196&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1302&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2019-0211&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2017-15710&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1301&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1283&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1303&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2017-15715&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1333&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-17199&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-11763&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1312&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;domains&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;ports&quot;</span>: [</span><br><span class="line">                <span class="number">8888</span>,</span><br><span class="line">                <span class="number">80</span>,</span><br><span class="line">                <span class="number">8080</span>,</span><br><span class="line">                <span class="number">8090</span>,</span><br><span class="line">                <span class="number">22</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;details&quot;</span>: <span class="string">&quot;&#123;\&quot;tcp\&quot;:[&#123;\&quot;http-simple-new\&quot;:8888,\&quot;Apache httpd\&quot;:\&quot;2.4.29\&quot;&#125;,&#123;\&quot;http\&quot;:80,\&quot;Apache httpd\&quot;:\&quot;2.4.29\&quot;&#125;,&#123;\&quot;http\&quot;:8080,\&quot;Apache httpd\&quot;:\&quot;2.4.29\&quot;&#125;,&#123;\&quot;http-simple-new\&quot;:8090&#125;,&#123;\&quot;ssh\&quot;:22,\&quot;OpenSSH\&quot;:\&quot;7.6p1 Ubuntu-4ubuntu0.3\&quot;&#125;],\&quot;udp\&quot;:[]&#125;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;hostnames&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;services&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;http-simple-new&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ssh&quot;</span>,</span><br><span class="line">                <span class="string">&quot;http&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-1.png" alt="image-20201205151011258"></p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-2.png" alt="image-20201205150744102"></p>
<h5 id="3-2-2-add-ti-tags"><a href="#3-2-2-add-ti-tags" class="headerlink" title="3.2.2 add-ti_tags"></a>3.2.2 add-ti_tags</h5><p>â€‹    è¿™éƒ¨åˆ†é€šå¸¸æ˜¯å¯¹æ¥çš„è‡ªæœ‰æƒ…æŠ¥ï¼ˆ<em>æˆ‘ä»¬ä¼šæ”¶é›†æ”»å‡»è¿‡æˆ‘ä»¬çš„IPï¼Œå»ºç«‹é€‚ç”¨äºè‡ªå·±çš„å†…éƒ¨æƒ…æŠ¥ã€‚</em>ï¼‰ä»¥åŠå¼€æºæƒ…æŠ¥ã€‚åŸåˆ™ä¸ŠSIEMäº§ç”Ÿçš„alarmäº‹ä»¶å¹¶ä¸ä¼šå¾ˆå¤šï¼Œæ‰€ä»¥è¿™è¾¹ç›´æ¥ä»Elasticè·å–äº†æƒ…æŠ¥æ•°æ®è¿›è¡Œå‘Šè­¦çš„ä¸°å¯ŒåŒ–ã€‚å¦‚æœalarmäº‹ä»¶å¾ˆå¤šçš„è¯ï¼Œå»ºè®®ä¹Ÿæ˜¯æ”¾åœ¨Redisæˆ–è€…å†è€ƒè™‘å…¶ä»–æ–¹æ¡ˆã€‚è¿‘æœŸå‡†å¤‡é‡‡è´­å•†ä¸šæƒ…æŠ¥ï¼ŒåæœŸå°†ä¼šæœ‰ä¸€ä¸ªå•†ä¸šæƒ…æŠ¥çš„å¯¹æ¥è¿‡ç¨‹ã€‚</p>
<h6 id="Logstash-Config-13"><a href="#Logstash-Config-13" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-ti_tags.conf">add-ti_tags.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-ti_tags.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;index&quot;</span> =&gt; <span class="string">&quot;ecs-ti-*&quot;</span></span><br><span class="line">                <span class="string">&quot;urls&quot;</span> =&gt; <span class="string">&quot;https://elastic:HelloWorld@127.0.0.1:9200&quot;</span></span><br><span class="line">                <span class="string">&quot;ca&quot;</span> =&gt; <span class="string">&quot;ca.crt&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-5"><a href="#Ruby-Code-5" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/ti_tags.rb">add-ti_tags.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;json&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;elasticsearch&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@urls</span> = params[<span class="string">&quot;urls&quot;</span>]</span><br><span class="line">    <span class="variable">@index</span> = params[<span class="string">&quot;index&quot;</span>]</span><br><span class="line">    <span class="variable">@ca</span> = params[<span class="string">&quot;ca&quot;</span>]</span><br><span class="line">    <span class="variable">@client</span> = Elasticsearch::Client.new <span class="symbol">urls:</span> <span class="variable">@urls</span>, <span class="symbol">transport_options:</span> &#123; <span class="symbol">ssl:</span> &#123; <span class="symbol">ca_file:</span> <span class="variable">@ca</span> &#125; &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    ioc = event.get(<span class="string">&#x27;[source][ip]&#x27;</span>)</span><br><span class="line">    query = &#123;</span><br><span class="line">        <span class="string">&quot;_source&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;includes&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;threat.tags&quot;</span>,</span><br><span class="line">                <span class="string">&quot;threat.provider&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;threat.type&quot;</span>: [</span><br><span class="line">                                <span class="string">&quot;ipv4&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;ip&quot;</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;threat.ioc&quot;</span>: ioc</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;threat.creation_time&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;now-7d&quot;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = <span class="variable">@client</span>.search <span class="symbol">index:</span> <span class="variable">@index</span>, <span class="symbol">body:</span> query.to_json</span><br><span class="line"></span><br><span class="line">    tags = []</span><br><span class="line">    providers = []</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> response[<span class="string">&#x27;hits&#x27;</span>][<span class="string">&#x27;hits&#x27;</span>].empty? <span class="keyword">then</span></span><br><span class="line">        response[<span class="string">&#x27;hits&#x27;</span>][<span class="string">&#x27;hits&#x27;</span>].each <span class="keyword">do</span> <span class="params">|result|</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> providers.<span class="keyword">include</span>?(result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;provider&quot;</span>])</span><br><span class="line">                providers.push(result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;provider&quot;</span>])</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            tags = tags - result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;tags&quot;</span>]</span><br><span class="line">            tags = tags + result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;tags&quot;</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.set(<span class="string">&#x27;[threat][intelligence][tags]&#x27;</span>, tags)</span><br><span class="line">    event.set(<span class="string">&#x27;[threat][intelligence][providers]&#x27;</span>, providers)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-4"><a href="#ç¤ºä¾‹-4" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-3.png" alt="image-20201208144650226"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;intelligence&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;providers&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;NTA&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;WebAttack&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Filter"><a href="#4-Filter" class="headerlink" title="4. Filter"></a>4. Filter</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/blacklist-1.png" alt="image-20201207153152332"></p>
<h4 id="4-1-alert-to-siem"><a href="#4-1-alert-to-siem" class="headerlink" title="4.1 alert_to_siem"></a>4.1 alert_to_siem</h4><h5 id="4-1-1-filter-ip-from-alert"><a href="#4-1-1-filter-ip-from-alert" class="headerlink" title="4.1.1 filter_ip_from_alert"></a>4.1.1 filter_ip_from_alert</h5><p>â€‹        å®é™…ä½¿ç”¨åœºæ™¯ä¸­éœ€è¦å¯¹ä¸€äº›ç™½åå•IPã€ç‰¹å®šç­¾åè§„åˆ™è¿›è¡Œè¿‡æ»¤ã€‚è¿™ä¹ˆåšä¹Ÿæ˜¯ä¸ºäº†ä¿è¯SIEMçš„æ€§èƒ½ä»¥åŠå‘Šè­¦çš„å¯é æ€§ã€‚è¿™éƒ¨åˆ†æ•°æ®ä¾æ—§ä¼šå‘é€åˆ°Elasticä½œä¸ºå†å²æ•°æ®ç•™å­˜ï¼Œä½†ä¸ä¼šè¢«SIEMæ¶ˆè´¹å¹¶äº§ç”Ÿå‘Šè­¦ã€‚</p>
<h6 id="Logstash-Config-14"><a href="#Logstash-Config-14" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><p>â€‹    åˆ©ç”¨<strong>Clone</strong>æ’ä»¶ï¼Œå°†éœ€è¦è¢«SIEMæ¶ˆè´¹çš„æ•°æ®ç»ç”±è„šæœ¬è¿‡æ»¤ã€‚</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-siem_events.conf">filter_ip_from_alert.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">&quot;siem_events&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;siem_events&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-filter_ip.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">                <span class="string">&quot;cdn_db&quot;</span> =&gt; 3</span><br><span class="line">                <span class="string">&quot;scan_db&quot;</span> =&gt; 4</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-6"><a href="#Ruby-Code-6" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-filter_ip.rb">filter_ip_from_alert.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="variable">@cdn_db</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;cdn_db&quot;</span>])</span><br><span class="line">        <span class="variable">@scan_db</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;scan_db&quot;</span>])</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@cdn_db</span>.exists?(src_ip) <span class="params">||</span> <span class="variable">@cdn_db</span>.exists?(dst_ip) <span class="params">||</span> <span class="variable">@scan_db</span>.exists?(src_ip) <span class="params">||</span> <span class="variable">@scan_db</span>.exists?(dst_ip) <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="4-1-2-filter-sid-from-alert"><a href="#4-1-2-filter-sid-from-alert" class="headerlink" title="4.1.2 filter_sid_from_alert"></a>4.1.2 filter_sid_from_alert</h5><h6 id="Logstash-Config-15"><a href="#Logstash-Config-15" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-siem_events.conf">filter_sid_from_alert.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">&quot;siem_events&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;siem_events&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-filter_sid.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">                <span class="string">&quot;sid_db&quot;</span> =&gt; 2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-7"><a href="#Ruby-Code-7" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-filter_sid.rb">filter_sid_from_alert.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@signature_id</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;sid_db&quot;</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    sid = event.get(<span class="string">&quot;[rule][id]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@signature_id</span>.exists?(sid) <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="4-2-alarm-from-siem"><a href="#4-2-alarm-from-siem" class="headerlink" title="4.2 alarm_from_siem"></a>4.2 alarm_from_siem</h4><h5 id="4-2-1-update-action-from-alarm"><a href="#4-2-1-update-action-from-alarm" class="headerlink" title="4.2.1 update_action_from_alarm"></a>4.2.1 update_action_from_alarm</h5><p>â€‹        æ›´æ–°åŒ¹é…åˆ°çš„<code>rule.id</code>äº‹ä»¶ï¼Œå°†<code>event.action</code>å€¼æ›´æ–°ä¸ºï¼š<code>block</code>ã€‚ä¾¿äºåæœŸè¢«SIEMè”åŠ¨æ¨¡å—â€œæ¶ˆè´¹â€ã€‚å¦‚ä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†ã€‚ä¸»è¦æ˜¯ä¸ºäº†é€šè¿‡<code>event.action</code>å­—æ®µæ¥åŒºåˆ†SIEMåšçš„è‡ªåŠ¨åŒ–æ“ä½œã€‚</p>
<h6 id="Logstash-Config-16"><a href="#Logstash-Config-16" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_update-siem_action.conf">update-action_from_alarm.conf</a></strong></li>
</ul>
<p>â€‹    é’ˆå¯¹æŒ‡å®š<code>rule.id</code>äº‹ä»¶ï¼Œå°†<code>allowed</code>å€¼æ›´æ–°ä¸ºï¼š<code>block</code>ã€‚ä¾¿äºåæœŸè¢«è”åŠ¨æ¨¡å—â€œæ¶ˆè´¹â€ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        update =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;[event][action]&quot;</span> =&gt; <span class="string">&quot;allowed&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ruby &#123;</span><br><span class="line">        path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-update_action.rb&quot;</span></span><br><span class="line">        script_params =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">            <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">            <span class="string">&quot;siem_action_db&quot;</span> =&gt; 7</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-8"><a href="#Ruby-Code-8" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-update_action.rb">update_action_from_alarm.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="variable">@siem_action_db</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;siem_action_db&quot;</span>])</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    rule_id = event.get(<span class="string">&quot;[rule][id]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@siem_action_db</span>.exists?(rule_id) <span class="keyword">then</span></span><br><span class="line">        event.set(<span class="string">&quot;[event][action]&quot;</span>, <span class="string">&quot;block&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹ï¼š"><a href="#ç¤ºä¾‹ï¼š" class="headerlink" title="ç¤ºä¾‹ï¼š"></a><strong>ç¤ºä¾‹ï¼š</strong></h6><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/update_action-0.1.png" alt="image-20201207111416997"></p>
<hr>
<h2 id="3-ä»ªè¡¨ç›˜"><a href="#3-ä»ªè¡¨ç›˜" class="headerlink" title="3. ä»ªè¡¨ç›˜"></a>3. ä»ªè¡¨ç›˜</h2><h3 id="SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜"><a href="#SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜" class="headerlink" title="SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜"></a>SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-Alarm.png" alt="SIEM-Alarm"></p>
<h3 id="å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜-å®‰å…¨æº¯æº"><a href="#å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜-å®‰å…¨æº¯æº" class="headerlink" title="å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜ (å®‰å…¨æº¯æº)"></a>å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜ (å®‰å…¨æº¯æº)</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-Alert.png" alt="SIEM Alert"></p>
<h3 id="æ•æ„Ÿæ¥å£ç›‘æ§"><a href="#æ•æ„Ÿæ¥å£ç›‘æ§" class="headerlink" title="æ•æ„Ÿæ¥å£ç›‘æ§"></a>æ•æ„Ÿæ¥å£ç›‘æ§</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/login_audit.png" alt="image-20201214112856076"></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/SIEM/" rel="tag"># SIEM</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/02/02/SIEM%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="prev" title="è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆäºŒï¼‰">
                  <i class="fa fa-chevron-left"></i> è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆäºŒï¼‰
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/03/02/Zeek-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F/" rel="next" title="Zeek - é›†ç¾¤éƒ¨ç½²æ¨¡å¼">
                  Zeek - é›†ç¾¤éƒ¨ç½²æ¨¡å¼ <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>





<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Canon</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">230k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">3:29</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>






  





</body>
</html>
