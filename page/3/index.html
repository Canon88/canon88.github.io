<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Mist&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;post&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:true,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;搜索...&quot;,&quot;empty&quot;:&quot;没有找到任何搜索结果：${query}&quot;,&quot;hits_time&quot;:&quot;找到 ${hits} 个搜索结果（用时 ${time} 毫秒）&quot;,&quot;hits&quot;:&quot;找到 ${hits} 个搜索结果&quot;},&quot;path&quot;:&quot;&#x2F;search.xml&quot;,&quot;localsearch&quot;:{&quot;enable&quot;:true,&quot;trigger&quot;:&quot;auto&quot;,&quot;top_n_per_article&quot;:1,&quot;unescape&quot;:false,&quot;preload&quot;:false}}</script>
<meta name="description" content="一个热爱健身的安全分析师">
<meta property="og:type" content="website">
<meta property="og:title" content="Canon&#39;s Blog">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Canon&#39;s Blog">
<meta property="og:description" content="一个热爱健身的安全分析师">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Canon">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/3/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:true,&quot;isPost&quot;:false,&quot;lang&quot;:&quot;zh-CN&quot;,&quot;comments&quot;:&quot;&quot;,&quot;permalink&quot;:&quot;&quot;,&quot;path&quot;:&quot;page&#x2F;3&#x2F;index.html&quot;,&quot;title&quot;:&quot;&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>Canon's Blog</title><script src="/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Canon's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Canon</p>
  <div class="site-description" itemprop="description">一个热爱健身的安全分析师</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/12/30/Logstash-Event-API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/12/30/Logstash-Event-API/" class="post-title-link" itemprop="url">Logstash Event API</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2019-12-30 15:23:40 / 修改时间：15:32:01" itemprop="dateCreated datePublished" datetime="2019-12-30T15:23:40+08:00">2019-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>398</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>​        由于项目需要, 用到了<code>Ruby</code>对Logstash进行一些定制化的配置。翻遍了整个Logstash的官方文档, 对于Ruby API的介绍就写了两个方法。<code>get</code> 与 <code>set</code> 也是醉了😂, 幸好谷歌一下…</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><ul>
<li>删除事件：cancel</li>
<li>取消删除事件：uncancel</li>
<li>是否删除：cancelled?</li>
<li>是否包含字段：include?</li>
<li>删除字段：remove</li>
<li>事件转字符串：to_s</li>
<li>事件转hash字典（不含metadata字段）：to_hash</li>
<li>事件转hash字典（含metadata字段）：to_hash_with_metadata</li>
<li>事件转json字符串：to_json</li>
<li>增加tag：tag</li>
<li>取事件时间戳：timestamp</li>
</ul>
<p><strong>更多查询官方接口源码:</strong> <a target="_blank" rel="noopener" href="https://github.com/elastic/logstash/blob/master/logstash-core/src/main/java/org/logstash/ext/JrubyEventExtLibrary.java"><strong>JrubyEventExtLibrary.java</strong></a></p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/mvpboss1004/article/details/78070300">Lostash event API详解</a></strong></li>
<li><a target="_blank" rel="noopener" href="https://github.com/elastic/logstash/blob/master/logstash-core/src/main/java/org/logstash/ext/JrubyEventExtLibrary.java"><strong>JrubyEventExtLibrary.java</strong></a></li>
<li><strong><a target="_blank" rel="noopener" href="https://www.rubydoc.info/gems/logstash-event/1.1.5/LogStash/Event#cancel-instance_method">Class: LogStash::Event</a></strong></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/12/30/Logstash-Multiple-Pipelines/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/12/30/Logstash-Multiple-Pipelines/" class="post-title-link" itemprop="url">Logstash Multiple Pipelines</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2019-12-30 15:17:17 / 修改时间：15:21:12" itemprop="dateCreated datePublished" datetime="2019-12-30T15:17:17+08:00">2019-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ELK/" itemprop="url" rel="index"><span itemprop="name">ELK</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>当Logstash要处理的多个input类型时, 最常见的两种解决方案(<strong>不推荐</strong>):</p>
<ol>
<li><p>通过条件判断解决问题</p>
</li>
<li><p>通过多实例解决问题</p>
</li>
</ol>
<p><strong>负面影响:</strong></p>
<ol>
<li><p>条件判断</p>
<ol>
<li>条件地狱。已知的在一个管道中实现多个独立流的方法是使用条件判断。主要方式是在输入部分通过标签标记事件，然后在过滤器中和输出阶段创建条件分支，对贴有不同标签的事件，应用不同的插件集。这种方式虽然可以解决问题，但在实际的使用中却非常的痛苦！下面是一个简单的 demo 片段：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    beats &#123; </span><br><span class="line">        port =&gt; 3444  </span><br><span class="line">        tag =&gt; apache </span><br><span class="line">    &#125;</span><br><span class="line">    tcp &#123; </span><br><span class="line">        port =&gt; 4222</span><br><span class="line">        tag =&gt; firewall</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;apache&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        dissect &#123; ... &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;firewall&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        grok &#123; ... &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;apache&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        elasticsearch &#123; ... &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> <span class="string">&quot;firewall&quot;</span> <span class="keyword">in</span> [tags] &#123;</span><br><span class="line">        tcp &#123; ... &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li>缺乏拥塞管理。Logstash在所有事件和完成所有输出之前不会移动到下一批事件。这意味着，对于上面的管道，如果 TCP 套接字目标不可达，Logstash将不会处理其他批次的事件，这也就意味着 Elasticsearch 将不会接收事件，并且会对 TCP 输入和 Beats 输入施加反压力。</li>
<li>不同的数据流需要以不同的方式处理。如果 TCP - &gt; Grok - &gt; TCP 数据流处理大量的小数据，而 Beats -&gt; Dissect -&gt; ES 数据流中的单个数据体积大但是数量少。那么前一个数据流希望有多个 worker 并行并其每一批次处理更多事件，第二个数据流则期望使用少量的 worker 和每批次处理少量的事件。使用单个管道，无法为单个数据流指定独立的管道配置。</li>
</ol>
</li>
<li><p>多实例</p>
<ol>
<li>需要管理多个实例(通过 init 系统管理多个后台服务)</li>
<li>每个 Logstash 的实例也意味着一个独立的 JVM</li>
<li>需要监视每个 Logstash 实例</li>
</ol>
</li>
</ol>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>​        通过配置多管道(Multiple Pipelines), 解决以上的所有问题。</p>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><p><code>/usr/share/logstash/config/pipelines.yml</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This file is where you define your pipelines. You can define multiple.</span></span><br><span class="line"><span class="comment"># For more information on multiple pipelines, see the documentation:</span></span><br><span class="line"><span class="comment">#   https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html</span></span><br><span class="line"></span><br><span class="line">- pipeline.id: dsiem</span><br><span class="line">  path.config: <span class="string">&quot;/etc/logstash/conf.d_siem/*.conf&quot;</span></span><br><span class="line">  pipeline.workers: 16</span><br><span class="line">  queue.type: persisted</span><br><span class="line">  queue.max_bytes: 300gb</span><br><span class="line"></span><br><span class="line">- pipeline.id: cloudflare</span><br><span class="line">  path.config: <span class="string">&quot;/etc/logstash/conf.d_cf/*.conf&quot;</span></span><br><span class="line">  pipeline.workers: 8</span><br><span class="line">  queue.type: persisted</span><br><span class="line">  queue.max_bytes: 100gb</span><br><span class="line"></span><br><span class="line">- pipeline.id: ti</span><br><span class="line">  path.config: <span class="string">&quot;/etc/logstash/conf.d_ti/*.conf&quot;</span></span><br><span class="line">  pipeline.workers: 8</span><br><span class="line">  queue.type: persisted</span><br><span class="line">  queue.max_bytes: 50gb</span><br></pre></td></tr></table></figure>

<p><code>/etc/supervisord.d/logstash.ini</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[program:logstash]</span><br><span class="line"><span class="built_in">command</span>=/usr/share/logstash/bin/logstash --path.data /lingtian/data/logstash/</span><br><span class="line"><span class="comment">#user=logstash</span></span><br><span class="line">numprocs=1</span><br><span class="line">autostart=<span class="literal">true</span></span><br><span class="line">autorestart=<span class="literal">true</span></span><br><span class="line">startsecs=1</span><br><span class="line">startretries=3</span><br><span class="line">exitcodes=0,2</span><br><span class="line">stopsignal=INT</span><br><span class="line">redirect_stderr=<span class="literal">true</span></span><br><span class="line">stdout_logfile_maxbytes=1MB</span><br><span class="line">stdout_logfile_backups=5</span><br><span class="line">stdout_capture_maxbytes=1MB</span><br><span class="line">stdout_logfile=/lingtian/logs/logstash/logstash.log</span><br></pre></td></tr></table></figure>

<h5 id="加载配置文件"><a href="#加载配置文件" class="headerlink" title="加载配置文件"></a>加载配置文件</h5><p>可通过使用参数, <code>--config.reload.automatic</code> or <code>-r</code> 在配置文件发生更改后自动检测并重新加载配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/logstash -f apache.config --config.reload.automatic</span><br></pre></td></tr></table></figure>

<p>默认3秒检查配置文件, 可以通过使用参数, <code>--config.reload.interval </code>修改秒数。</p>
<p>如果Logstash已经在没有启用自动重载的情况下运行，则可以通过向运行Logstash的进程发送SIGHUP（信号挂起）来强制Logstash重载配置文件并重新启动管道。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">kill</span> -SIGHUP <span class="variable">$logstash_pid</span></span><br></pre></td></tr></table></figure>

<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><p><strong><a target="_blank" rel="noopener" href="https://github.com/elastic/logstash/blob/master/config/pipelines.yml">Pipelines 参数</a></strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/6.7/multiple-pipelines.html">Multiple Pipelines</a></strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/cn/blog/logstash-multiple-pipelines">Introducing Multiple Pipelines in Logstash - 原文</a></strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sparkdev/p/11073980.html">Introducing Multiple Pipelines in Logstash - 中文</a></strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/reloading-config.html">Reloading the Config Fileedit </a></strong></p>
</li>
<li><p><a target="_blank" rel="noopener" href="http://www.51niux.com/?id=205"><strong>Logstash详细记录（五</strong>）</a></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/12/30/Scrapy-%E5%A4%9A%E4%B8%AAitem%E5%AF%B9%E5%BA%94%E4%B8%80%E4%B8%AApipeline/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/12/30/Scrapy-%E5%A4%9A%E4%B8%AAitem%E5%AF%B9%E5%BA%94%E4%B8%80%E4%B8%AApipeline/" class="post-title-link" itemprop="url">Scrapy 多个item对应一个pipeline</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2019-12-30 13:32:30 / 修改时间：14:01:24" itemprop="dateCreated datePublished" datetime="2019-12-30T13:32:30+08:00">2019-12-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spider/" itemprop="url" rel="index"><span itemprop="name">Spider</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>809</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>​        在利用<strong>Scrapy</strong>编写爬虫时,经常会遇到同一个爬虫中包含多个item classes, 并且需要在同一个<code>pipelines.py</code>中根据不同的item classes进行逻辑的处理。</p>
<p>​        <strong>需求:</strong> 数据需要同时发送到ElasticSearch以及Redis, 唯一的区别就是item classes,不同。发送到Redis的数据是标准化之后的数据, 发送到ElasticSearch是原始的数据。</p>
<p>​        <strong>解决方法:</strong> 这里可以通过<code>isinstance</code>来进行区分。</p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define your item pipelines here</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Don&#x27;t forget to add your pipeline to the ITEM_PIPELINES setting</span></span><br><span class="line"><span class="comment"># See: https://doc.scrapy.org/en/latest/topics/item-pipeline.html</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tb.items <span class="keyword">import</span> RedisItem</span><br><span class="line"><span class="keyword">from</span> tb.items <span class="keyword">import</span> ElasticSearchItem</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisPipeline</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, RedisItem):</span><br><span class="line">            <span class="comment"># to do something</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ElasticPipeline</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_item</span>(<span class="params">self, item, spider</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, ElasticSearchItem):</span><br><span class="line">            <span class="comment"># to do something</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>

<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><strong><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/32743469/scrapy-python-multiple-item-classes-in-one-pipeline">Scrapy, Python: Multiple Item Classes in one pipeline?</a></strong></li>
<li><strong><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_32651363/article/details/79092431">Scrapy同一个爬虫里包含不同item，pipelines文件编写</a></strong></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/12/24/Redis-Key-%E8%BF%87%E6%9C%9F%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/12/24/Redis-Key-%E8%BF%87%E6%9C%9F%E4%BA%8B%E4%BB%B6%E8%AE%A2%E9%98%85/" class="post-title-link" itemprop="url">Redis Key 过期事件订阅</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-12-24 23:49:55" itemprop="dateCreated datePublished" datetime="2019-12-24T23:49:55+08:00">2019-12-24</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-12-27 12:15:21" itemprop="dateModified" datetime="2019-12-27T12:15:21+08:00">2019-12-27</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h3><p>​        在自建企业内部威胁情报的过程中, 需要通过<strong>Redis</strong>统一管理过期时间的<strong>Key</strong>。因此需要对过期的<strong>Key</strong>进行实时监听, 并进行回调处理。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>​        在 <strong>Redis</strong> 的 <strong>2.8.0</strong> 版本之后，其推出了一个新的特性——键空间消息（Redis Keyspace Notifications），它配合 2.0.0 版本之后的 SUBSCRIBE 就能完成这个定时任务的操作了。</p>
<p><strong>Redis 的键空间通知支持 订阅指定 Key 的所有事件 与 订阅指定事件 两种方式。</strong></p>
<blockquote>
<p>Keyspace notifications are implemented sending two distinct type of events for every operation affecting the Redis data space. For instance a DEL operation targeting the key named mykey in database 0 will trigger the delivering of two messages, exactly equivalent to the following two PUBLISH commands:</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PUBLISH __keyspace@0__:mykey del</span><br><span class="line">PUBLISH __keyevent@0__:del mykey</span><br></pre></td></tr></table></figure>

<p><strong>通过 Redis 的键空间通知（keyspace notification）可以做到：将IoC数据写入Redis，设置过期时间10分钟，利用 Redis 键过期回调提醒，如果未被消费，则进行处理。</strong></p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><h4 id="1-修改-redis-conf-开启redis-key过期提醒"><a href="#1-修改-redis-conf-开启redis-key过期提醒" class="headerlink" title="1. 修改 redis.conf 开启redis key过期提醒"></a>1. 修改 redis.conf 开启redis key过期提醒</h4><blockquote>
<p>By default keyspace events notifications are disabled because while not very sensible the feature uses some CPU power. Notifications are enabled using the notify-keyspace-events of redis.conf or via the CONFIG SET.</p>
</blockquote>
<p>由于键空间通知比较耗CPU, 所以 Redis默认是关闭键空间事件通知的， 需要手动开启 <code>notify-keyspace-events </code>后才启作用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">K：keyspace事件，事件以__keyspace@&lt;db&gt;__为前缀进行发布；        </span><br><span class="line">E：keyevent事件，事件以__keyevent@&lt;db&gt;__为前缀进行发布；        </span><br><span class="line">g：一般性的，非特定类型的命令，比如del，expire，rename等；       </span><br><span class="line">$：String 特定命令；        </span><br><span class="line">l：List 特定命令；        </span><br><span class="line">s：Set 特定命令；        </span><br><span class="line">h：Hash 特定命令；        </span><br><span class="line">z：Sorted 特定命令；        </span><br><span class="line">x：过期事件，当某个键过期并删除时会产生该事件；        </span><br><span class="line">e：驱逐事件，当某个键因maxmemore策略而被删除时，产生该事件；        </span><br><span class="line">A：g<span class="variable">$lshzxe</span>的别名，因此”AKE”意味着所有事件。</span><br></pre></td></tr></table></figure>

<p><strong><code>notify-keyspace-events Ex</code> 表示开启键过期事件提醒</strong></p>
<p><strong>redis.conf</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># RDB Config</span></span><br><span class="line">databases 16</span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line">rdbcompression yes</span><br><span class="line">rdbchecksum no</span><br><span class="line">dir ./</span><br><span class="line"><span class="comment"># AOF Config</span></span><br><span class="line">appendonly yes</span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line">appendfsync everysec</span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"><span class="comment"># set Password</span></span><br><span class="line">requirepass %&#123;mypassword&#125;</span><br><span class="line"><span class="comment"># set notify-keyspace-events</span></span><br><span class="line">notify-keyspace-events Ex</span><br></pre></td></tr></table></figure>

<h4 id="2-RedisHelper"><a href="#2-RedisHelper" class="headerlink" title="2. RedisHelper"></a>2. RedisHelper</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># Author: Canon</span></span><br><span class="line"><span class="comment"># Date: 2019-12-27</span></span><br><span class="line"><span class="comment"># Version: 0.2</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisHelper</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 连接Redis</span></span><br><span class="line">        self.__conn = redis.Redis(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">6379</span>, password=<span class="string">&#x27;mypassword&#x27;</span>, db=<span class="number">0</span>)</span><br><span class="line">        <span class="comment"># 定义keyevent, 此处0为indexdb</span></span><br><span class="line">        self.keyevent = <span class="string">&#x27;__keyevent@0__:expired&#x27;</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 发布方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">publish</span>(<span class="params">self, key, msg</span>):</span></span><br><span class="line">        ttl = <span class="number">10</span></span><br><span class="line">        self.__conn.setex(key, msg, ttl)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 订阅方法</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">subscribe</span>(<span class="params">self</span>):</span></span><br><span class="line">        sub = self.__conn.pubsub()</span><br><span class="line">        sub.subscribe(self.keyevent)</span><br><span class="line">        <span class="keyword">for</span> msg <span class="keyword">in</span> sub.listen():</span><br><span class="line">            <span class="keyword">if</span> msg[<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;message&#x27;</span>:</span><br><span class="line">                ex_key = msg[<span class="string">&#x27;data&#x27;</span>].decode()</span><br><span class="line">                <span class="built_in">print</span>(ex_key)</span><br></pre></td></tr></table></figure>



<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><p><strong><a target="_blank" rel="noopener" href="https://crazyfzw.github.io/2019/03/26/redis-keyspace-notifications/">订阅 Redis 的 key 过期事件实现动态定时任务</a></strong></p>
</li>
<li><p><strong><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016898228">python开发-实现redis中的发布订阅功能</a></strong></p>
</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/12/19/Scrapyd%20+%20Scrapyd-Client/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/12/19/Scrapyd%20+%20Scrapyd-Client/" class="post-title-link" itemprop="url">Scrapyd + Scrapyd-Client</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-12-19 10:53:37" itemprop="dateCreated datePublished" datetime="2019-12-19T10:53:37+08:00">2019-12-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-12-24 23:43:13" itemprop="dateModified" datetime="2019-12-24T23:43:13+08:00">2019-12-24</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Spider/" itemprop="url" rel="index"><span itemprop="name">Spider</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><p>​        由于网站时常遭受黑客攻击, 现准备将手头一些攻击者的IP地址收集起来用做企业内部的威胁情报。既然要着手做威胁情报, 那么就避免不了通过一些网站进行数据的丰富化。要想简单省事儿, 当然是使用购买api账号的方式,不过有的api也很坑, 除非购买的是企业版, 否则个人版的api会受到请求速率的限制。所以这边只能依靠爬虫(<strong>Scrapy</strong>)来收集数据。但是采用了分布式爬虫, 就避免不了需要进行集中管理, 以及统一下等操作。下面就说下利用<strong>Scrapy</strong>官方提供的爬虫管理工具(<strong>Scrapyd</strong>)来满足以上的需求。</p>
<h1 id="Scrapyd"><a href="#Scrapyd" class="headerlink" title="Scrapyd"></a>Scrapyd</h1><p>​        <strong>Scrapyd</strong>是由<strong>Scrapy</strong> 官方提供的爬虫管理工具，使用它我们可以非常方便地上传、控制爬虫并且查看运行日志。</p>
<p><strong>安装</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install scrapyd</span><br></pre></td></tr></table></figure>

<p><strong>启动</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ scrapyd</span><br><span class="line">2019-12-19T10:56:06+0800 [-] Loading /Users/canon/anaconda3/lib/python3.7/site-packages/scrapyd/txapp.py...</span><br><span class="line">2019-12-19T10:56:06+0800 [-] Scrapyd web console available at http://127.0.0.1:6800/</span><br><span class="line">2019-12-19T10:56:06+0800 [-] Loaded.</span><br><span class="line">2019-12-19T10:56:06+0800 [twisted.scripts._twistd_unix.UnixAppLogger<span class="comment">#info] twistd 18.9.0 (/Users/canon/anaconda3/bin/python 3.7.1) starting up.</span></span><br><span class="line">2019-12-19T10:56:06+0800 [twisted.scripts._twistd_unix.UnixAppLogger<span class="comment">#info] reactor class: twisted.internet.selectreactor.SelectReactor.</span></span><br><span class="line">2019-12-19T10:56:06+0800 [-] Site starting on 6800</span><br><span class="line">2019-12-19T10:56:06+0800 [twisted.web.server.Site<span class="comment">#info] Starting factory &lt;twisted.web.server.Site object at 0x109efcf98&gt;</span></span><br><span class="line">2019-12-19T10:56:06+0800 [Launcher] Scrapyd 1.2.1 started: max_proc=48, runner=<span class="string">&#x27;scrapyd.runner&#x27;</span></span><br></pre></td></tr></table></figure>

<p>​        <strong>Scrapyd</strong>是一个服务端，我们需要通过一个客户端(<strong>Scrapyd-Client</strong>)将爬虫项目发送到<strong>Scrapyd</strong>服务中去。这里先修改一下<strong>Scrapyd</strong>服务地址，默认<strong>Scrapyd</strong>启动是通过命令: <code>Scrapyd</code>就可以直接启动，默认绑定的ip地址是<em>127.0.0.1</em>端口是:<em>6800</em>，这里为了其他主机可以访问，需将ip地址设置为<em>0.0.0.0</em>。</p>
<p>​         根据上图启动的信息, 可以看到默认配置文件是在<code>/Users/canon/anaconda3/lib/python3.7/site-packages/scrapyd/</code>中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ vim default_scrapyd.conf</span><br><span class="line"></span><br><span class="line">[scrapyd]</span><br><span class="line">eggs_dir    = eggs</span><br><span class="line">logs_dir    = logs</span><br><span class="line">items_dir   =</span><br><span class="line">jobs_to_keep = 5</span><br><span class="line">dbs_dir     = dbs</span><br><span class="line">max_proc    = 0</span><br><span class="line">max_proc_per_cpu = 4</span><br><span class="line">finished_to_keep = 100</span><br><span class="line">poll_interval = 5.0</span><br><span class="line">bind_address = 0.0.0.0</span><br><span class="line">http_port   = 6800</span><br><span class="line">debug       = off</span><br><span class="line">runner      = scrapyd.runner</span><br><span class="line">application = scrapyd.app.application</span><br><span class="line">launcher    = scrapyd.launcher.Launcher</span><br><span class="line">webroot     = scrapyd.website.Root</span><br><span class="line"></span><br><span class="line">[services]</span><br><span class="line">schedule.json     = scrapyd.webservice.Schedule</span><br><span class="line">cancel.json       = scrapyd.webservice.Cancel</span><br><span class="line">addversion.json   = scrapyd.webservice.AddVersion</span><br><span class="line">listprojects.json = scrapyd.webservice.ListProjects</span><br><span class="line">listversions.json = scrapyd.webservice.ListVersions</span><br><span class="line">listspiders.json  = scrapyd.webservice.ListSpiders</span><br><span class="line">delproject.json   = scrapyd.webservice.DeleteProject</span><br><span class="line">delversion.json   = scrapyd.webservice.DeleteVersion</span><br><span class="line">listjobs.json     = scrapyd.webservice.ListJobs</span><br><span class="line">daemonstatus.json = scrapyd.webservice.DaemonStatus</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Scrapyd-Client"><a href="#Scrapyd-Client" class="headerlink" title="Scrapyd-Client"></a>Scrapyd-Client</h1><p>​        <strong>Scrapyd-Client</strong>可以用来部署<strong>Scrapy</strong>项目，它会帮我们把项目打包成<strong>egg</strong>文件，我们不用再动手调用<code>add version.json</code>接口去部署到<strong>Scrapyd</strong>，操作简单。</p>
<p><strong>安装</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install scrapyd-client</span><br></pre></td></tr></table></figure>

<p><strong>配置</strong></p>
<p>​        要部署<strong>Scrapy</strong>项目，我们首先需要修改项目的配置文件。首先切换至项目根目录, 会看到有一个<code>scrapy.cfg</code>文件，它的内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Automatically created by: scrapy startproject</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># For more information about the [deploy] section see:</span></span><br><span class="line"><span class="comment"># https://scrapyd.readthedocs.io/en/latest/deploy.html</span></span><br><span class="line"></span><br><span class="line">[settings]</span><br><span class="line">default = spider_ti.settings</span><br><span class="line"></span><br><span class="line">[deploy]</span><br><span class="line"><span class="comment">#url = http://localhost:6800/</span></span><br><span class="line">project = spider_ti</span><br></pre></td></tr></table></figure>

<p>这里需要配置一下<code>deploy</code>部分。例如, 我们将项目部署到<em>10.10.10.1</em>的<strong>Scrapyd</strong>上，则修改内容如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[deploy]</span><br><span class="line">url = http://10.10.10.1:6800/</span><br><span class="line">project = spider_ti</span><br></pre></td></tr></table></figure>

<p>这样我们再在<code>scrapy.cf</code>g文件所在路径执行如下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ scrapyd-deploy</span><br><span class="line"></span><br><span class="line">Packing version 1576725163</span><br><span class="line">Deploying to project <span class="string">&quot;spider_ti&quot;</span> <span class="keyword">in</span> http://localhost:6800/addversion.json</span><br><span class="line">Server response (200):</span><br><span class="line">&#123;<span class="string">&quot;node_name&quot;</span>: <span class="string">&quot;CanondeMacBook-Pro.local&quot;</span>, <span class="string">&quot;status&quot;</span>: <span class="string">&quot;ok&quot;</span>, <span class="string">&quot;project&quot;</span>: <span class="string">&quot;spider_ti&quot;</span>, <span class="string">&quot;version&quot;</span>: <span class="string">&quot;1576725163&quot;</span>, <span class="string">&quot;spiders&quot;</span>: 3&#125;</span><br></pre></td></tr></table></figure>

<p>项目版本默认为当前时间戳。我们也可以指定项目版本，通过<code>version</code>参数传递即可。例如:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ scrapyd-deploy --version 201912191114</span><br></pre></td></tr></table></figure>

<p>注: 在Python3的Scrapyd 1.2.0版本中，<strong>版本号不能指定为带字母的字符串，它们必须为纯数字</strong>，否则会出现报错。</p>
<p>如果有多台主机，我们可以配置各台主机的别名，修改配置文件为:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[deploy:vm1]</span><br><span class="line">url = http://10.10.10.1:6800/</span><br><span class="line">project = spider_ti</span><br><span class="line"></span><br><span class="line">[deploy:vm2]</span><br><span class="line">url = http://10.10.10.2:6800/</span><br><span class="line">project = spider_ti</span><br></pre></td></tr></table></figure>

<p>在此统一配置多台主机，一台主机对应一组配置，在<code>deploy</code>后面加上主机的别名即可。如果想将项目部署到IP为<em>10.10.10.2</em>的<strong>vm2</strong>主机，我们只需要执行如下命令:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scrapyd-deploy vm2</span><br></pre></td></tr></table></figure>

<p>如此一来，我们只需要在<code>scrapy.cfg</code>文件中配置好各台主机的<strong>Scrapyd</strong>地址，然后调用<code>scrapyd-deploy</code>命令加主机名称即可实现部署。</p>
<p>如果<strong>Scrapyd</strong>设置了访问限制，我们可以在配置文件中加入用户名和密码的配置，同时修改端口成Nginx代理端口。例如: 在第1章我们使用的是6801，那么这里就需要改成6801，修改如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[deploy:vm1]</span><br><span class="line">url = http://10.10.10.1:6801/</span><br><span class="line">project = spider_ti</span><br><span class="line">username = admin</span><br><span class="line">password = admin</span><br><span class="line"></span><br><span class="line">[deploy:vm2]</span><br><span class="line">url = http://10.10.10.2:6801/</span><br><span class="line">project = spider_ti</span><br><span class="line">username = canon</span><br><span class="line">password = canon</span><br></pre></td></tr></table></figure>

<p>通过加入username和password字段，我们就可以在部署时自动进行Auth验证，然后成功实现部署。</p>
<p><strong>运行</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/schedule.json -d project=spider_ti -d spider=ti</span><br></pre></td></tr></table></figure>

<p><strong>列出任务</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/listjobs.json?project=spider_ti | python -m json.tool</span><br></pre></td></tr></table></figure>

<p><strong>列出项目</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/listprojects.json</span><br></pre></td></tr></table></figure>

<p><strong>停止</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/cancel.json -d project=spider_ti -d job=838dec26222311ea8eb6a5eb893a35a5</span><br></pre></td></tr></table></figure>

<p><strong>删除</strong></p>
<ul>
<li><em>版本</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/delversion.json -d project=spider_ti -d version=1576735972</span><br></pre></td></tr></table></figure>

<ul>
<li><em>项目</em></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl http://127.0.0.1:6800/delproject.json -d project=spider_ti</span><br></pre></td></tr></table></figure>



<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ul>
<li><a target="_blank" rel="noopener" href="https://juejin.im/post/5b0f8f6f6fb9a00a2364a020"><strong>分布式爬虫的部署之Scrapyd-Client的使用</strong></a></li>
<li><a target="_blank" rel="noopener" href="https://link.jianshu.com/?t=http://scrapyd.readthedocs.org/en/latest/api.html"><strong>Scrapyd</strong></a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/10/31/Suricata%20-%20Rules/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/31/Suricata%20-%20Rules/" class="post-title-link" itemprop="url">Suricata Custom Rules</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-31 17:45:00" itemprop="dateCreated datePublished" datetime="2019-10-31T17:45:00+08:00">2019-10-31</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-11-04 10:50:52" itemprop="dateModified" datetime="2019-11-04T10:50:52+08:00">2019-11-04</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Solr-RCE-CVE-2019-0193"><a href="#Solr-RCE-CVE-2019-0193" class="headerlink" title="Solr RCE CVE-2019-0193"></a>Solr RCE CVE-2019-0193</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Solr POST RCE CVE-2019-0193</span></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">&quot;LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 POST&quot;</span>; flow:to_server,established; flowbits:<span class="built_in">set</span>,CVE-2019-0193.post.request; content:<span class="string">&quot;POST&quot;</span>; http_method; fast_pattern; content:<span class="string">&quot;/solr&quot;</span>; http_uri; content:<span class="string">&quot;/config&quot;</span>; http_uri; content:<span class="string">&quot;params.resource.loader.enabled&quot;</span>; http_client_body; classtype:shellcode-detect; sid:3020016; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br><span class="line"></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">&quot;LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 POST Successful&quot;</span>; flow:from_server,established; flowbits:isset,CVE-2019-0193.post.request; content:<span class="string">&quot;200&quot;</span>; http_stat_code; classtype:shellcode-detect; sid:3020017; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Solr GET RCE CVE-2019-0193</span></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">&quot;LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 GET&quot;</span>; flow:to_server,established; flowbits:<span class="built_in">set</span>,CVE-2019-0193.get.request; content:<span class="string">&quot;GET&quot;</span>; http_method; content:<span class="string">&quot;/solr&quot;</span>; http_uri; fast_pattern; content:<span class="string">&quot;/select?&quot;</span>; http_uri; content:<span class="string">&quot;wt=velocity&quot;</span>; http_uri; content:<span class="string">&quot;java.lang.Runtime&quot;</span>; http_uri; content:<span class="string">&quot;getRuntime().exec&quot;</span>; http_uri; classtype:shellcode-detect; sid:3020018; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br><span class="line"></span><br><span class="line">alert http <span class="variable">$EXTERNAL_NET</span> any -&gt; <span class="variable">$HOME_NET</span> any (msg:<span class="string">&quot;LOCAL RULES EXPLOIT Solr RCE CVE-2019-0193 GET Successful&quot;</span>; flow:from_server,established; flowbits:isset,CVE-2019-0193.get.request; content:<span class="string">&quot;200&quot;</span>; http_stat_code; classtype:shellcode-detect; sid:3020019; rev:1; metadata:attack_target web_server, signature_severity Critical, direction outside_to_inside, created_at 2019_10_31, updated_at 2019_10_31, author Canon, tag RCE, tag CVE-2019-0193, tag http, tag exploit, tag Solr;)</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/10/24/Suricata+Lua%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E6%83%85%E6%8A%A5%E5%AF%B9%E6%8E%A5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/24/Suricata+Lua%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E6%83%85%E6%8A%A5%E5%AF%B9%E6%8E%A5/" class="post-title-link" itemprop="url">Suricata + Lua实现本地情报对接</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-24 21:49:39" itemprop="dateCreated datePublished" datetime="2019-10-24T21:49:39+08:00">2019-10-24</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-03-25 15:17:07" itemprop="dateModified" datetime="2020-03-25T15:17:07+08:00">2020-03-25</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>13k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>​        由于近期网站遭受恶意攻击, 通过对于登录接口的审计与分析, 现已确定了一批可疑账号。既然之前写过一个登录接口的审计脚本, 那么完全可以通过扩展这个脚本来实现对于可疑账号的比对。主要思路: 通过将可疑账号存进Redis中, 再利用Lua脚本调用Redis接口进行账号的比对。</p>
<p>先说一下<strong>Suricata</strong>默认是存在黑名单机制的, 如下:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># IP Reputation</span></span><br><span class="line"><span class="comment">#reputation-categories-file: /etc/suricata/iprep/categories.txt</span></span><br><span class="line"><span class="comment">#default-reputation-path: /etc/suricata/iprep</span></span><br><span class="line"><span class="comment">#reputation-files:</span></span><br><span class="line"><span class="comment"># - reputation.list</span></span><br></pre></td></tr></table></figure>

<p>在<strong>Suricata 5.0</strong> 版本中更是增加了新的功能**<a target="_blank" rel="noopener" href="https://suricata.readthedocs.io/en/suricata-5.0.0/rules/datasets.html">Datasets</a>**。大概看了一下, 可以通过在规则中使用<code>dataset</code>和<code>datarep</code>关键字将大量数据与<code>sticky buffer</code>进行匹配。确实是个很赞的功能!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alert http any any -&gt; any any (http.user_agent; dataset:<span class="built_in">set</span>, ua-seen, <span class="built_in">type</span> string, save ua-seen.lst; sid:1;)</span><br><span class="line"></span><br><span class="line">alert dns any any -&gt; any any (dns.query; to_sha256; dataset:<span class="built_in">set</span>, dns-sha256-seen, <span class="built_in">type</span> sha256, save dns-sha256-seen.lst; sid:2;)</span><br><span class="line"></span><br><span class="line">alert http any any -&gt; any any (http.uri; to_md5; dataset:isset, http-uri-md5-seen, <span class="built_in">type</span> md5, load http-uri-md5-seen.lst; sid:3;)</span><br></pre></td></tr></table></figure>

<p><strong>但是</strong>… 这并不适用我现在的场景, 因为在我的场景中, 用户的登录请求存在于POST请求中, 默认的Suricata方法并不能准确定位到我们需要的账号。这个时候我们就只能依赖于<strong>Lua</strong>脚本来扩展。当然这些需求<strong>Zeek</strong>也可以满足, 只是…<strong>Zeek</strong>的脚本真是难写…不忍吐槽~</p>
<h1 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h1><h2 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h2><p>​    <strong>OS</strong>: <em>Ubuntu 18.04</em></p>
<p>​    <strong>Suricata</strong>: <em>Suricata 5.0.0 RELEASE</em></p>
<h2 id="LuaRocks"><a href="#LuaRocks" class="headerlink" title="LuaRocks"></a>LuaRocks</h2><ol>
<li>由于Ubuntu默认没有安装**<a target="_blank" rel="noopener" href="https://luarocks.org/">LuaRocks</a>** (<em>LuaRocks is the package manager for Lua modules</em>), 这里需要我们手动安装。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过apt直接安装, 简单省事儿。</span></span><br><span class="line">$ apt-get install luarocks</span><br></pre></td></tr></table></figure>

<hr>
<ol start="2">
<li>通过<code>luarocks</code>安装我们所需要的<code>lua</code>模块, 这里我们需要用到<code>redis-lua</code>、<code>luasocket</code>这两个模块。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Install Modules</span></span><br><span class="line">$ luarocks install luasocket</span><br><span class="line">$ luarocks install redis-lua</span><br><span class="line"></span><br><span class="line">$ ll /usr/<span class="built_in">local</span>/share/lua/5.1/</span><br><span class="line">total 72</span><br><span class="line">drwxr-xr-x 3 root root  4096 Oct 25 03:35 ./</span><br><span class="line">drwxr-xr-x 3 root root  4096 Sep 17 14:14 ../</span><br><span class="line">-rw-r--r-- 1 root root  8331 Oct 25 03:34 ltn12.lua</span><br><span class="line">-rw-r--r-- 1 root root  2487 Oct 25 03:34 mime.lua</span><br><span class="line">-rw-r--r-- 1 root root 35599 Oct 25 03:35 redis.lua</span><br><span class="line">drwxr-xr-x 2 root root  4096 Oct 25 03:34 socket/</span><br><span class="line">-rw-r--r-- 1 root root  4451 Oct 25 03:34 socket.lua</span><br></pre></td></tr></table></figure>

<hr>
<ol start="3">
<li>安装成功后,  可以简单的测试一下。</li>
</ol>
<ul>
<li>利用<strong>Docker</strong>启动<strong>Redis</strong>容器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -ti -d -p 6379:6379 redis</span><br></pre></td></tr></table></figure>

<ul>
<li>测试脚本<code>hello_redis.lua</code></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> client = redis.connect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> response = client:ping()</span><br><span class="line"><span class="keyword">if</span> response == <span class="literal">false</span> <span class="keyword">then</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">client:set(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> var = client:get(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(var)</span><br></pre></td></tr></table></figure>

<ul>
<li>可能会存在环境变量不对导致的报错</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ luajit hello_redis.lua</span><br><span class="line">	luajit: /usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:793: module <span class="string">&#x27;socket&#x27;</span> not found:</span><br><span class="line">	no field package.preload[<span class="string">&#x27;socket&#x27;</span>]</span><br><span class="line">	no file <span class="string">&#x27;./socket.lua&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/share/luajit-2.0.5/socket.lua&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/share/lua/5.1/socket.lua&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/share/lua/5.1/socket/init.lua&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;./socket.so&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/lib/lua/5.1/socket.so&#x27;</span></span><br><span class="line">	no file <span class="string">&#x27;/usr/local/lib/lua/5.1/loadall.so&#x27;</span></span><br><span class="line">stack traceback:</span><br><span class="line">	[C]: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">&#x27;require&#x27;</span></span><br><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:793: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">&#x27;create_connection&#x27;</span></span><br><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.1/redis.lua:836: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">&#x27;connect&#x27;</span></span><br><span class="line">	a.lua:3: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: at 0x56508049e440</span><br></pre></td></tr></table></figure>

<ul>
<li>执行<code>luarocks path --bin</code> 并将结果输入</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ luarocks path --bin</span><br><span class="line">Warning: The directory <span class="string">&#x27;/home/canon/.cache/luarocks&#x27;</span> or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing /usr/<span class="built_in">local</span>/bin/luarocks with sudo, you may want sudo<span class="string">&#x27;s -H flag.</span></span><br><span class="line"><span class="string">export LUA_PATH=&#x27;</span>/home/canon/.luarocks/share/lua/5.1/?.lua;/home/canon/.luarocks/share/lua/5.1/?/init.lua;/usr/<span class="built_in">local</span>/share/lua/5.1/?.lua;/usr/<span class="built_in">local</span>/share/lua/5.1/?/init.lua;./?.lua;/usr/<span class="built_in">local</span>/share/luajit-2.0.5/?.lua<span class="string">&#x27;</span></span><br><span class="line"><span class="string">export LUA_CPATH=&#x27;</span>/home/canon/.luarocks/lib/lua/5.1/?.so;/usr/<span class="built_in">local</span>/lib/lua/5.1/?.so;./?.so;/usr/<span class="built_in">local</span>/lib/lua/5.1/loadall.so<span class="string">&#x27;</span></span><br><span class="line"><span class="string">export PATH=&#x27;</span>/home/canon/.luarocks/bin:/usr/<span class="built_in">local</span>/bin:/home/canon/anaconda3/bin:/home/canon/anaconda3/condabin:/usr/<span class="built_in">local</span>/sbin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>执行脚本, 将会看到如下输出:</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ luajit hello_redis.lua</span><br><span class="line">world</span><br></pre></td></tr></table></figure>



<h3 id="CJson"><a href="#CJson" class="headerlink" title="CJson"></a>CJson</h3><p>​        这里<strong>强烈建议</strong>大家使用CJson模块, 我之前为了测试随便从github上找了个json模块来使用。这几天发现在网站的高峰时期 Suricata <strong>app_layer.flow</strong> 这个字段非常的大, 从而导致了 <strong>kernel_drops</strong>。由于我们的网站是面对海外用户有时差, 经过几天的熬夜最终定位到是由于json模块太过于消耗性能而导致。可以看下这个截图:</p>
<ul>
<li>启用CJson模块之前的监控图</li>
</ul>
<p><img src="/2019/10/24/Suricata+Lua%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E6%83%85%E6%8A%A5%E5%AF%B9%E6%8E%A5/image-20191104103020962.png" alt="image-20191104103020962"></p>
<ul>
<li>启用CJson模块之后的监控图</li>
</ul>
<p><img src="/2019/10/24/Suricata+Lua%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E6%83%85%E6%8A%A5%E5%AF%B9%E6%8E%A5/image-20191104103557884.png" alt="image-20191104103557884"></p>
<ol>
<li>下载CJson模块</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># wget 下载</span></span><br><span class="line">$ wget https://www.kyne.com.au/~mark/software/download/lua-cjson-2.1.0.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># Git</span></span><br><span class="line">$ git <span class="built_in">clone</span> git@github.com:mpx/lua-cjson.git</span><br></pre></td></tr></table></figure>

<hr>
<ol start="2">
<li> 根据Lua环境修改Makefile(个人配置)</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##### Build defaults #####</span></span><br><span class="line">LUA_VERSION =       5.1</span><br><span class="line">TARGET =            cjson.so</span><br><span class="line">PREFIX =            /usr/<span class="built_in">local</span></span><br><span class="line"><span class="comment">#CFLAGS =            -g -Wall -pedantic -fno-inline</span></span><br><span class="line">CFLAGS =            -O3 -Wall -pedantic -DNDEBUG</span><br><span class="line">CJSON_CFLAGS =      -fpic</span><br><span class="line">CJSON_LDFLAGS =     -shared</span><br><span class="line">LUA_INCLUDE_DIR =   $(PREFIX)/include/luajit-2.0</span><br><span class="line">LUA_CMODULE_DIR =   $(PREFIX)/lib/lua/$(LUA_VERSION)</span><br><span class="line">LUA_MODULE_DIR =    $(PREFIX)/share/lua/$(LUA_VERSION)</span><br><span class="line">LUA_BIN_DIR =       $(PREFIX)/bin</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ make</span><br><span class="line">cc -c -O3 -Wall -pedantic -DNDEBUG  -I/usr/<span class="built_in">local</span>/include/luajit-2.0 -fpic -o lua_cjson.o lua_cjson.c</span><br><span class="line">In file included from lua_cjson.c:47:0:</span><br><span class="line">fpconv.h:15:20: warning: inline <span class="keyword">function</span> ‘fpconv_init’ declared but never defined</span><br><span class="line"> extern inline void fpconv_init();</span><br><span class="line">                    ^~~~~~~~~~~</span><br><span class="line">cc -c -O3 -Wall -pedantic -DNDEBUG  -I/usr/<span class="built_in">local</span>/include/luajit-2.0 -fpic -o strbuf.o strbuf.c</span><br><span class="line">cc -c -O3 -Wall -pedantic -DNDEBUG  -I/usr/<span class="built_in">local</span>/include/luajit-2.0 -fpic -o fpconv.o fpconv.c</span><br><span class="line">cc  -shared -o cjson.so lua_cjson.o strbuf.o fpconv.o</span><br><span class="line"></span><br><span class="line">$ make install</span><br><span class="line">mkdir -p //usr/<span class="built_in">local</span>/lib/lua/5.1</span><br><span class="line">cp cjson.so //usr/<span class="built_in">local</span>/lib/lua/5.1</span><br><span class="line">chmod 755 //usr/<span class="built_in">local</span>/lib/lua/5.1/cjson.so</span><br></pre></td></tr></table></figure>



<h3 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a><a target="_blank" rel="noopener" href="https://github.com/kikito/md5.lua">MD5</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ luarocks install --server=http://luarocks.org/manifests/kikito md5</span><br></pre></td></tr></table></figure>



<h1 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h1><p>扩展登录接口审计脚本: <code>http_audit.lua</code></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br></pre></td><td class="code"><pre><span class="line">json = <span class="built_in">require</span> <span class="string">&quot;cjson.safe&quot;</span></span><br><span class="line">md5 = <span class="built_in">require</span> <span class="string">&quot;md5&quot;</span></span><br><span class="line">redis = <span class="built_in">require</span> <span class="string">&quot;redis&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 登录接口</span></span><br><span class="line">login_url = <span class="string">&quot;/login&quot;</span></span><br><span class="line"><span class="comment">-- 登录错误提示</span></span><br><span class="line">success_code = <span class="number">0</span></span><br><span class="line"><span class="comment">-- event_name</span></span><br><span class="line">event_name = <span class="string">&quot;login_audit&quot;</span></span><br><span class="line"><span class="comment">-- event_type</span></span><br><span class="line">event_type = <span class="string">&quot;lua&quot;</span></span><br><span class="line"><span class="comment">-- logs</span></span><br><span class="line">name = <span class="string">&quot;login_audit.json&quot;</span></span><br><span class="line"><span class="comment">-- 协议</span></span><br><span class="line">proto = <span class="string">&quot;TCP&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- redis_config</span></span><br><span class="line">host = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">port = <span class="number">6379</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- common_mapping</span></span><br><span class="line">http_common_mapping = <span class="string">&#x27;&#123;&quot;accept&quot;:&quot;accept&quot;,&quot;accept-charset&quot;:&quot;accept_charset&quot;,&quot;accept-encoding&quot;:&quot;accept_encoding&quot;,&quot;accept-language&quot;:&quot;accept_language&quot;,&quot;user-agent&quot;:&quot;user_agent&quot;&#125;&#x27;</span></span><br><span class="line">common_mapping_table = json.decode(http_common_mapping)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- defind functioin</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5Encode</span><span class="params">(args)</span></span></span><br><span class="line">    m = md5.new()</span><br><span class="line">    m:update(args)</span><br><span class="line">    <span class="keyword">return</span> md5.tohex(m:finish())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStr</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    ios = <span class="built_in">string</span>.<span class="built_in">match</span>(args, <span class="string">&#x27;canon&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> ios ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        mail = <span class="string">&#x27;email&quot;%s+(.-)%s&#x27;</span></span><br><span class="line">        t[<span class="string">&#x27;email&#x27;</span>] = <span class="built_in">string</span>.<span class="built_in">match</span>(args, mail)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        data = <span class="built_in">string</span>.split(args, <span class="string">&#x27;&amp;&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">            d = <span class="built_in">string</span>.split(v, <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">            t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.split</span><span class="params">(s, p)</span></span></span><br><span class="line">    rt = &#123;&#125;</span><br><span class="line">    <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">&#x27;[^&#x27;</span>..p..<span class="string">&#x27;]+&#x27;</span>, <span class="function"><span class="keyword">function</span><span class="params">(w)</span></span> <span class="built_in">table</span>.<span class="built_in">insert</span>(rt, w) <span class="keyword">end</span> )</span><br><span class="line">    <span class="keyword">return</span> rt</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- default function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(args)</span></span></span><br><span class="line">    <span class="keyword">local</span> needs = &#123;&#125;</span><br><span class="line">    needs[<span class="string">&quot;protocol&quot;</span>] = <span class="string">&quot;http&quot;</span></span><br><span class="line">    <span class="keyword">return</span> needs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span> <span class="params">(args)</span></span></span><br><span class="line">    filename = SCLogPath() .. <span class="string">&quot;/&quot;</span> .. name</span><br><span class="line">    file = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">&quot;a&quot;</span>))</span><br><span class="line">    SCLogInfo(<span class="string">&quot;app_login_audit filename: &quot;</span> .. filename)</span><br><span class="line">    http = <span class="number">0</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">-- Connect Redis Server</span></span><br><span class="line">    SCLogInfo(<span class="string">&quot;Connect Redis Server...&quot;</span>)</span><br><span class="line">    client = redis.connect(host, port)</span><br><span class="line">    response = client:ping()</span><br><span class="line">    <span class="keyword">if</span> response <span class="keyword">then</span></span><br><span class="line">        SCLogInfo(<span class="string">&quot;Redis Server connection succeeded.&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(args)</span></span></span><br><span class="line">    <span class="comment">-- init tables</span></span><br><span class="line">    http_table = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- ti tables</span></span><br><span class="line">    ti = &#123;</span><br><span class="line">        tags = &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- init score</span></span><br><span class="line">    score = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_hostname &amp; http_url</span></span><br><span class="line">    http_hostname = HttpGetRequestHost()</span><br><span class="line">    http_url = HttpGetRequestUriNormalized()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- http_method</span></span><br><span class="line">    rl = HttpGetRequestLine()</span><br><span class="line">    <span class="keyword">if</span> rl <span class="keyword">then</span></span><br><span class="line">        http_method = <span class="built_in">string</span>.<span class="built_in">match</span>(rl, <span class="string">&quot;%w+&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> http_method <span class="keyword">then</span></span><br><span class="line">            http_table[<span class="string">&quot;method&quot;</span>] = http_method</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	</span><br><span class="line">	  <span class="comment">-- 为了保证 Suricata 的性能不受影响, 严格控制过滤条件</span></span><br><span class="line">    <span class="keyword">if</span> http_url == login_url <span class="keyword">and</span> http_method == <span class="string">&quot;POST&quot;</span> <span class="keyword">then</span></span><br><span class="line">        http_table[<span class="string">&quot;hostname&quot;</span>] = http_hostname</span><br><span class="line">        http_table[<span class="string">&quot;url&quot;</span>] = http_url</span><br><span class="line">        http_table[<span class="string">&quot;url_path&quot;</span>] = http_url</span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- http_status &amp; http_protocol</span></span><br><span class="line">        rsl = HttpGetResponseLine()</span><br><span class="line">        <span class="keyword">if</span> rsl <span class="keyword">then</span></span><br><span class="line">            status_code = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">&quot;%s(%d+)%s&quot;</span>)</span><br><span class="line">            http_table[<span class="string">&quot;status&quot;</span>] = <span class="built_in">tonumber</span>(status_code)</span><br><span class="line"></span><br><span class="line">            http_protocol = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">&quot;(.-)%s&quot;</span>)</span><br><span class="line">            http_table[<span class="string">&quot;protocol&quot;</span>] = http_protocol</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- login_results</span></span><br><span class="line">        a, o, e = HttpGetResponseBody()</span><br><span class="line">        <span class="keyword">if</span> a <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">                body = json.decode(v)</span><br><span class="line">                results_code = <span class="built_in">tonumber</span>(body[<span class="string">&quot;code&quot;</span>])</span><br><span class="line">                <span class="keyword">if</span> results_code == success_code <span class="keyword">then</span></span><br><span class="line">                    http_table[<span class="string">&quot;results&quot;</span>] = <span class="string">&quot;success&quot;</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    http_table[<span class="string">&quot;results&quot;</span>] = <span class="string">&quot;failed&quot;</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            http_table[<span class="string">&quot;results_code&quot;</span>] = results_code</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">--[[</span></span><br><span class="line"><span class="comment">            1. 获取用户登录email 并查询 Redis中是否存在该账号</span></span><br><span class="line"><span class="comment">            2. 根据结果进行相应的打分以及tags标注</span></span><br><span class="line"><span class="comment">        ]]</span></span><br><span class="line">        <span class="comment">-- </span></span><br><span class="line">        a, o, e = HttpGetRequestBody()</span><br><span class="line">        <span class="keyword">if</span> a <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">                res = formatStr(v)</span><br><span class="line">                <span class="keyword">if</span> res[<span class="string">&quot;email&quot;</span>] <span class="keyword">then</span></span><br><span class="line">                    <span class="comment">-- 查询Redis对比黑名单</span></span><br><span class="line">                    black_ioc = client:get(res[<span class="string">&quot;email&quot;</span>])</span><br><span class="line">                    <span class="keyword">if</span> black_ioc <span class="keyword">then</span></span><br><span class="line">                        ti[<span class="string">&quot;provider&quot;</span>] = <span class="string">&quot;Canon&quot;</span></span><br><span class="line">                        ti[<span class="string">&quot;producer&quot;</span>] = <span class="string">&quot;NTA&quot;</span></span><br><span class="line">                        <span class="built_in">table</span>.<span class="built_in">insert</span>(ti[<span class="string">&quot;tags&quot;</span>], <span class="string">&quot;account in blacklist&quot;</span>)</span><br><span class="line">                        score = score + <span class="number">10</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- RequestHeaders</span></span><br><span class="line">        rh = HttpGetRequestHeaders()</span><br><span class="line">        <span class="keyword">if</span> rh <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rh) <span class="keyword">do</span></span><br><span class="line">                key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line">                request_var = request_mapping_table[key]</span><br><span class="line">                <span class="keyword">if</span> request_var <span class="keyword">then</span></span><br><span class="line">                    http_table[request_var] = v</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- ResponseHeaders</span></span><br><span class="line">        rsh = HttpGetResponseHeaders()</span><br><span class="line">        <span class="keyword">if</span> rsh <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rsh) <span class="keyword">do</span></span><br><span class="line">                key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line">                response_var = response_mapping_table[key]</span><br><span class="line">                <span class="keyword">if</span> response_var <span class="keyword">then</span></span><br><span class="line">                    http_table[response_var] = v</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- timestring</span></span><br><span class="line">        sec, usec = SCPacketTimestamp()</span><br><span class="line">        timestring = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;!%Y-%m-%dT%T&quot;</span>, sec) .. <span class="string">&#x27;.&#x27;</span> .. usec .. <span class="string">&#x27;+0000&#x27;</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">-- flow_info</span></span><br><span class="line">        ip_version, src_ip, dst_ip, protocol, src_port, dst_port = SCFlowTuple()</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- flow_id</span></span><br><span class="line">        id = SCFlowId()</span><br><span class="line">        flow_id = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%.0f&quot;</span>, id)</span><br><span class="line">        flow_id = <span class="built_in">tonumber</span>(flow_id)</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- true_ip</span></span><br><span class="line">        true_client_ip = HttpGetRequestHeader(<span class="string">&quot;True-Client-IP&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> true_client_ip ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            src_ip = true_client_ip</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">-- session_id</span></span><br><span class="line">        tetrad = src_ip .. src_port .. dst_ip .. dst_port</span><br><span class="line">        session_id = md5Encode(tetrad)</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- table</span></span><br><span class="line">        raw_data = &#123;</span><br><span class="line">            timestamp = timestring,</span><br><span class="line">            flow_id = flow_id,</span><br><span class="line">            session_id = session_id,</span><br><span class="line">            src_ip = src_ip,</span><br><span class="line">            src_port = src_port,</span><br><span class="line">            proto = proto,</span><br><span class="line">            dest_ip = dst_ip,</span><br><span class="line">            dest_port = dst_port,</span><br><span class="line">            event_name = event_name,</span><br><span class="line">            event_type = event_type,</span><br><span class="line">            app_type = app_type,</span><br><span class="line">            http = http_table,</span><br><span class="line">            ti = ti,</span><br><span class="line">            score = score</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">-- json encode</span></span><br><span class="line">        data = json.encode(raw_data)</span><br><span class="line"></span><br><span class="line">        file:<span class="built_in">write</span>(data .. <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        file:<span class="built_in">flush</span>()</span><br><span class="line"></span><br><span class="line">        http = http + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deinit</span> <span class="params">(args)</span></span></span><br><span class="line">    SCLogInfo (<span class="string">&quot;app_login_audit transactions logged: &quot;</span> .. http);</span><br><span class="line">    file:<span class="built_in">close</span>(file)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<p><strong>简单说下以上脚本的功能:</strong></p>
<ol>
<li>登录接口的用户名审计(废话…); </li>
<li>通过请求<strong>Redis</strong>比对当前用户是否在黑名单中, 并进行相应的打分、标签处理;</li>
<li>根据自定义的需求获取的http headers, 这个对于业务安全上还是有点用的;</li>
<li>针对<strong>CDN</strong>或者Nginx这种场景下, 可以直接对 xff 或者 true_client_ip 进行四元组的hash, 得到<strong>session_id</strong>, 这样溯源的时候会比较方便。因为在这种场景下传统的四层<strong>flow_id</strong>就不是那么有用了。</li>
<li>后续可以追加一些简单的检测方法, 例如:<ol>
<li>检查请求头中的字段是否完成;</li>
<li>检查请求头中的某个字段长度是否符合合规;</li>
<li>……</li>
</ol>
</li>
</ol>
<p><strong>配置Suricata启用Lua脚本</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">lua:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">scripts-dir:</span> <span class="string">/etc/suricata/lua-output/</span></span><br><span class="line">    <span class="attr">scripts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">login_audit.lua</span></span><br></pre></td></tr></table></figure>



<p><strong>启用Suricata</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ suricata -vvv --pfring -k none -c /etc/suricata/suricata.yaml</span><br></pre></td></tr></table></figure>

<p><em><strong>注: 这里<code>-vvv</code> 参数建议加上. 如果你的Lua脚本有一些问题, 如果加上了这个参数, 就可以通过这个日志看出。</strong></em></p>
<h1 id="日志样例"><a href="#日志样例" class="headerlink" title="日志样例"></a>日志样例</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;src_port&quot;</span>: <span class="number">62722</span>,</span><br><span class="line">    <span class="attr">&quot;score&quot;</span>: <span class="number">65</span>,</span><br><span class="line">    <span class="attr">&quot;session_id&quot;</span>: <span class="string">&quot;c863aeb2ef8d1b37f3257f8c210bf440&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;ti&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;tags&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;account in blacklist&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;provider&quot;</span>: <span class="string">&quot;Canon&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;producer&quot;</span>: <span class="string">&quot;NTA&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;alert&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;alerted&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;rules&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;请求头校验&quot;</span>: <span class="string">&quot;dev-id&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;proto&quot;</span>: <span class="string">&quot;TCP&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;flow_id&quot;</span>: <span class="string">&quot;1064295903559076&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2019-10-25T08:33:55.585519+0000&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;event_type&quot;</span>: <span class="string">&quot;lua&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;src_ip&quot;</span>: <span class="string">&quot;1.1.1.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dest_port&quot;</span>: <span class="number">80</span>,</span><br><span class="line">    <span class="attr">&quot;http&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;response_content_length&quot;</span>: <span class="string">&quot;96&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;response_content_type&quot;</span>: <span class="string">&quot;application/json; charset=UTF-8&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept_encoding&quot;</span>: <span class="string">&quot;gzip&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;results_code&quot;</span>: <span class="number">400504</span>,</span><br><span class="line">        <span class="attr">&quot;server&quot;</span>: <span class="string">&quot;nginx&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;date&quot;</span>: <span class="string">&quot;Fri, 25 Oct 2019 08:33:55 GMT&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;app_version&quot;</span>: <span class="string">&quot;6.6.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;request_content_type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user_agent&quot;</span>: <span class="string">&quot;okhttp/3.12.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;canon@gmail.com&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;results&quot;</span>: <span class="string">&quot;failed&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>,-</span><br><span class="line">        <span class="attr">&quot;cache_control&quot;</span>: <span class="string">&quot;no-cache, max-age=0, no-store&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;connection&quot;</span>: <span class="string">&quot;keep-alive&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;HTTP/1.1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;url_path&quot;</span>: <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;device&quot;</span>: <span class="string">&quot;RMX1920 Android8.0.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;device_type&quot;</span>: <span class="string">&quot;Android&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;request_content_length&quot;</span>: <span class="string">&quot;39&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;event_name&quot;</span>: <span class="string">&quot;login_audit&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dest_ip&quot;</span>: <span class="string">&quot;2.2.2.2&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/10/18/Wazuh-Using-CDB-lists/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/18/Wazuh-Using-CDB-lists/" class="post-title-link" itemprop="url">Wazuh - 黑名单匹配告警(CDB list)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2019-10-18 11:28:56 / 修改时间：15:17:46" itemprop="dateCreated datePublished" datetime="2019-10-18T11:28:56+08:00">2019-10-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/HIDS/" itemprop="url" rel="index"><span itemprop="name">HIDS</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><strong>需求:</strong></p>
<p>​        现有一批高危用户, 需要实时关注该账号的登录情况。由于之前已经写好了一个针对用户登录账号的审计规则, 因此, 这里需要用到**<a target="_blank" rel="noopener" href="https://documentation.wazuh.com/3.10/user-manual/ruleset/cdb-list.html">Wazuh CDB list</a>**这个功能(<em>此功能主要用例是创建用户，IP或域名的白/黑列表。</em>)消费审计规则数据即可。</p>
<hr>
<ol>
<li><strong>新建列表</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ more blacklist</span><br><span class="line"></span><br><span class="line">admin:</span><br><span class="line">root:</span><br><span class="line">administrator:</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>将列表文件添加到<code>ossec.conf</code></strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ more ossec.conf</span><br><span class="line"></span><br><span class="line">&lt;ossec_config&gt;</span><br><span class="line">	&lt;ruleset&gt;</span><br><span class="line">    &lt;!-- User-defined CDB list --&gt;</span><br><span class="line">    &lt;list&gt;etc/lists/blacklist&lt;/list&gt;</span><br><span class="line">	&lt;/ruleset&gt;</span><br><span class="line">&lt;/ossec_config&gt;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>编译列表</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ /var/ossec/bin/ossec-makelists</span><br><span class="line"></span><br><span class="line"> * File etc/lists/blacklist.cdb needs to be updated</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>重启进程</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo systemctl restart wazuh-manager</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><strong>配置规则</strong></li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">group</span> <span class="attr">name</span>=<span class="string">&quot;local,blacklist,&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Defind blacklist Rules --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ID: 100150 - 100199 --&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">rule</span> <span class="attr">id</span>=<span class="string">&quot;100163&quot;</span> <span class="attr">level</span>=<span class="string">&quot;12&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">if_sid</span>&gt;</span>100303<span class="tag">&lt;/<span class="name">if_sid</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span> <span class="attr">field</span>=<span class="string">&quot;http.email&quot;</span> <span class="attr">lookup</span>=<span class="string">&quot;match_key&quot;</span>&gt;</span>etc/lists/blacklist<span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Wazuh Rules - High-risk user login detected. $(src_ip) -&gt; $(http.email) -&gt; $(http.hostname) -&gt; $(http.url) = $(http.results).<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">options</span>&gt;</span>no_full_log<span class="tag">&lt;/<span class="name">options</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">group</span>&gt;</span>blacklist,<span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">group</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="6">
<li><strong>测试规则</strong></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ./ossec-logtest</span><br><span class="line">2019/10/18 15:06:47 ossec-testrule: INFO: Started (pid: 2184).</span><br><span class="line">ossec-testrule: Type one <span class="built_in">log</span> per line.</span><br><span class="line"></span><br><span class="line">**Phase 3: Completed filtering (rules).</span><br><span class="line">       Rule id: <span class="string">&#x27;100163&#x27;</span></span><br><span class="line">       Level: <span class="string">&#x27;12&#x27;</span></span><br><span class="line">       Description: <span class="string">&#x27;Wazuh Rules - High-risk user login detected. 1.1.1.1 -&gt; admin -&gt; canon88.github.io -&gt; /user/login = success.&#x27;</span></span><br><span class="line">**Alert to be generated.</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/" class="post-title-link" itemprop="url">我在'云'上的日子 - AWS上流量镜像遇到的坑</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-16 17:24:30" itemprop="dateCreated datePublished" datetime="2019-10-16T17:24:30+08:00">2019-10-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-10-18 11:29:55" itemprop="dateModified" datetime="2019-10-18T11:29:55+08:00">2019-10-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>6.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>​    </p>
<p>​        自从AWS在6月份新出了<strong>Traffic Mirroring</strong>功能后, 我也算是第一时间使用了这个功能。与传统的交换机流量镜像不同的是, AWS上是将流量镜像后的数据通过<strong>VXLAN</strong>协议发送至流量分析引擎(<strong>Suricata</strong>、<strong>Zeek</strong>)。正是由于这一点让我碰到了以下几个问题, 这里写出来希望对大家有所帮助。</p>
<ol>
<li>接收流量镜像的目标端, 也就是我们常说的流量分析引擎端是有接收限制的。</li>
</ol>
<p>​       如果你是在一个非专用实例上部署的Suricata、Zeek。那么你只能最多同时接收10个源的流量镜像, 也就是你只能接收10个网卡的数据。很不巧的是我们碰上了这个问题, 解决方案也很简单, 使用专用实例(<strong>Dedicated instance</strong>) 或者 使用AWS的网络负载均衡(<strong>Network Load Balancer</strong>)。前者可以将Limit提升到<strong>100</strong>, 后者将<strong>不受限</strong>。如图:</p>
<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191016164935291.png" alt="image-20191016164935291"></p>
<hr>
<ol start="2">
<li>C5与C4实例的差异</li>
</ol>
<p>​        就我目前使用的实例而言, 分别测试过C5 与 C4两种实例。他们的网卡驱动有所区别的, 如图:</p>
<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191016160923628.png" alt="image-20191016160923628"></p>
<p>​        我这使用下来最直观的区别, 在C4实例上若不使用PF_RING捕包模式的话, Suricata丢包率感人, 0.5 Gbps就开始丢包。测试的机器配置: 32C 60G的机器, 切换到PF_RING捕包模式无此问题。反之C5实例就不存在这个问题, AF-PACKET直接上到2 Gbps的纯HTTP流量都没有丢包。硬件配置: 16C 32G的机器。</p>
<hr>
<ol start="3">
<li>超过<strong>MTU: 9001</strong>数据包被截断</li>
</ol>
<p>​      这几天在排查安全事件时, 发现监控的同一台Nginx上解析出的流量(HTTP事件)与日志(HTTP事件)数量相差较大。经过两天的排查终于定位了问题, Suricata kernel 并没有丢包, 所以怀疑是不是Suricata HTTP解析出错导致。最终通过抓包发现导致该问题的”罪魁祸首”就是<strong>VXLAN</strong>, 由于AWS在流量镜像时采用了<strong>VXLAN</strong>协议进行封装, 导致在原有<strong>MTU</strong>的基础上<strong>增加了50个字节</strong>, 造成数据包被截断, 无法还原出HTTP事件。以下截图就是一个无法被正确还原HTTP事件的数据包, 我用Suricata载入数据包后, 只还原出了长度<strong>9015</strong>数据包之前的HTTP信息, 长度<strong>9015</strong>数据包之后的所有事件均无法被还原。</p>
<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191014095249725.png" alt="image-20191014095249725"></p>
<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191014094741753.png" alt="image-20191014094741753"></p>
<p><strong>官方描述:</strong></p>
<p>​        For example, if an 8996 byte packet is mirrored, and the traffic mirror target MTU value is 9001 bytes, the mirror encapsulation results in the mirrored packet being greater than the MTU value. In this case, the mirror packet is truncated. To prevent mirror packets from being truncated, set the traffic mirror source interface MTU value to 54 bytes less than the traffic mirror target MTU value. For more information about configuring the network MTU value, see Network Maximum Transmission Unit (MTU) for Your EC2 Instance in the <em>Amazon EC2 User Guide for Linux Instances</em>.</p>
<p>​        例如，如果对8996字节的数据包进行了镜像，并且流量镜像目标MTU值为9001字节，则镜像封装会导致镜像的数据包大于MTU值。在这种情况下，镜像数据包将被截断。为防止镜像数据包被截断，请将流量镜像源接口的MTU值设置为比流量镜像目标MTU值小54个字节。有关配置网络MTU值的更多信息，请参阅Amazon EC2 Linux实例用户指南中的EC2实例的网络最大传输单位（MTU）。</p>
<hr>
<p><strong>关于VXLAN导致Suricata无法正常解析数据的问题, 特地进行了测试:</strong></p>
<p>准备工作:</p>
<ul>
<li>新建了<strong>test_files</strong>文件, 该文件只包含内容’<strong>hello, world!</strong>‘;</li>
<li>为了使数据包在传输时满足<strong>MTU: 9001</strong>, 手动生成了一个10MB空文件<strong>10mb_exist_files</strong>. </li>
</ul>
<p>共计访问: 14次</p>
<p>访问顺序:</p>
<ol>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (次)</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (次)</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (次)</li>
</ol>
<p>正常情况:</p>
<ul>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (次) - 正常</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (次) - 正常</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (次) - 正常</li>
</ul>
<p>异常情况:</p>
<ul>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong>  3 (次) - 正常</li>
<li>Client -&gt; Web Server -&gt; <strong>10mb_exist_files</strong> 1 (次) - 异常</li>
<li>Client -&gt; Web Server -&gt; <strong>test_files</strong> 10 (次) - 丢失</li>
</ul>
<p><strong>MTU: 9001</strong></p>
<ul>
<li>非镜像流量的数据包详情:</li>
</ul>
<p>可以看到从数据包<strong>20</strong>到数据包<strong>6126</strong>之间都是在进行<strong>10MB</strong>文件(<strong>10mb_exist_files</strong>)的传输过程。</p>
<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191016103409831.png" alt="image-20191016103409831"></p>
<hr>
<p>从http数据包中可以看出, 这里请求包与响应包都可以正常被还原出来。</p>
<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191016104502919.png" alt="image-20191016104502919"></p>
<hr>
<p>数据包在Suricata上的解析结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2019-10-15T22:52:10.180505+0800&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;flow_id&quot;</span>: <span class="number">415026399241324</span>,</span><br><span class="line">    <span class="attr">&quot;pcap_cnt&quot;</span>: <span class="number">6127</span>,</span><br><span class="line">    <span class="attr">&quot;event_type&quot;</span>: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;src_ip&quot;</span>: <span class="string">&quot;y.y.y.y&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;src_port&quot;</span>: <span class="number">43418</span>,</span><br><span class="line">    <span class="attr">&quot;dest_ip&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dest_port&quot;</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">&quot;proto&quot;</span>: <span class="string">&quot;TCP&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tx_id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;http&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_port&quot;</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;/file/10mb_exist_files&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_user_agent&quot;</span>: <span class="string">&quot;python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_content_type&quot;</span>: <span class="string">&quot;text/html&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept_encoding&quot;</span>: <span class="string">&quot;gzip, deflate, compress&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;content_length&quot;</span>: <span class="string">&quot;41943044&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;content_type&quot;</span>: <span class="string">&quot;text/html; charset=utf-8&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;date&quot;</span>: <span class="string">&quot;Tue, 15 Oct 2019 14:52:10 GMT&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;server&quot;</span>: <span class="string">&quot;Werkzeug/0.16.0 Python/2.7.16&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_method&quot;</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;HTTP/1.1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">&quot;length&quot;</span>: <span class="number">41943044</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>镜像流量的数据包详情:</strong>(也就是<strong>VXLAN</strong>封装后的数据包)</li>
</ul>
<p>同样可以看到从数据包<strong>26</strong>到数据包<strong>6170</strong>之间都是在进行<strong>10MB</strong>文件(<strong>10mb_exist_files</strong>)的传输过程。但是在第<strong>34</strong>个数据包中可以看到, 已经标注了数据超出了最大长度。</p>
<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191016105636906.png" alt="image-20191016105636906"></p>
<hr>
<p>超出长度的数据将会被截断, 标注: <strong>50 bytes missing in capture file</strong>。</p>
<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191016150322620.png" alt="image-20191016150322620"></p>
<p>从HTTP数据包中可以看出, 这里只有请求包, 由于后续的响应包超出了<strong>MTU: 9001</strong>,  因此并没有响应包。</p>
<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191016105948606.png" alt="image-20191016105948606"></p>
<hr>
<p>数据包在Suricata上的解析结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">4</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2019-10-15T22:52:48.295823+0800&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;flow_id&quot;</span>: <span class="number">1746715371266426</span>,</span><br><span class="line">    <span class="attr">&quot;event_type&quot;</span>: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;src_ip&quot;</span>: <span class="string">&quot;y.y.y.y&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;src_port&quot;</span>: <span class="number">43420</span>,</span><br><span class="line">    <span class="attr">&quot;dest_ip&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dest_port&quot;</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">&quot;proto&quot;</span>: <span class="string">&quot;TCP&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tx_id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;http&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_port&quot;</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;/file/10mb_exist_files&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_user_agent&quot;</span>: <span class="string">&quot;python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept_encoding&quot;</span>: <span class="string">&quot;gzip, deflate, compress&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_method&quot;</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;HTTP/1.1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">&quot;length&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>结论:</strong></p>
<p>​        相比非镜像流量的数据包, Suricata 少了后续10条http请求的数据解析。针对访问<strong>10mb_exist_files</strong>的请求, 由于超过了MTU, 数据包被阶段了, http的解析数据也是不完整的。</p>
<p><strong>解决方案:</strong></p>
<p>​        这里直接引用AWS的官方文档描述。如果对8996字节的数据包进行了镜像，并且流量镜像目标MTU值为9001字节，则镜像封装会导致镜像的数据包大于MTU值。在这种情况下，镜像数据包将被截断。为防止镜像数据包被截断，请将流量镜像源接口的MTU值设置为比流量镜像目标MTU值小54个字节。有关配置网络MTU值的更多信息，请参阅Amazon EC2 Linux实例用户指南中的EC2实例的网络最大传输单位（MTU）。</p>
<p>​        一般来说，降低 MTU 的话，有可能发现网路传输效能有下降，这是因为每个封包 size 变小，所以传送同样的资料量，封包数就会变多，造成 overhead 变多。但是对于传输是不会产生错误的状况的。</p>
<hr>
<p><strong>MTU:1500</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br><span class="line"></span><br><span class="line">$ sudo ip link <span class="built_in">set</span> dev eth0 mtu 1500</span><br><span class="line"></span><br><span class="line">$ ip link show eth0</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 02:8a:2d:87:02:8e brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191016154823748.png" alt="image-20191016154823748"></p>
<p><img src="/2019/10/16/%E6%88%91%E5%9C%A8%E4%BA%91%E4%B8%8A%E7%9A%84%E6%97%A5%E5%AD%90-AWS%E4%B8%8A%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/image-20191016155112376.png" alt="image-20191016155112376"></p>
<p>数据包在Suricata上的解析结果:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat http-2019-10-16.json | wc -l</span><br><span class="line">14</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2019-10-16T15:14:15.576656+0800&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;flow_id&quot;</span>: <span class="number">1135596924232203</span>,</span><br><span class="line">    <span class="attr">&quot;event_type&quot;</span>: <span class="string">&quot;http&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;src_ip&quot;</span>: <span class="string">&quot;y.y.y.y&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;src_port&quot;</span>: <span class="number">43554</span>,</span><br><span class="line">    <span class="attr">&quot;dest_ip&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dest_port&quot;</span>: <span class="number">8000</span>,</span><br><span class="line">    <span class="attr">&quot;proto&quot;</span>: <span class="string">&quot;TCP&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tx_id&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="attr">&quot;http&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;x.x.x.x&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_port&quot;</span>: <span class="number">8000</span>,</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;/file/10mb_exist_files&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_user_agent&quot;</span>: <span class="string">&quot;python-requests/1.2.3 CPython/2.7.16 Linux/4.14.123-86.109.amzn1.x86_64&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_content_type&quot;</span>: <span class="string">&quot;text/html&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept_encoding&quot;</span>: <span class="string">&quot;gzip, deflate, compress\n&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;content_length&quot;</span>: <span class="string">&quot;41943044&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;content_type&quot;</span>: <span class="string">&quot;text/html; charset=utf-8&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;date&quot;</span>: <span class="string">&quot;Wed, 16 Oct 2019 07:14:15 GMT&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;server&quot;</span>: <span class="string">&quot;Werkzeug/0.16.0 Python/2.7.16&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;http_method&quot;</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;HTTP/1.1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">&quot;length&quot;</span>: <span class="number">41943044</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        结论: <strong>MTU减小到1500时</strong>, 无论从WireShark来查看或者Suricata协议还原的角度来说, 都是可以的。</p>
<hr>
<p>​        写在最后, 说实话AWS提供了在云上的流量镜像确实很不错, 至少比传统在云上每一台机器通过安装agent把流量外发的形式强, 似乎<strong>国内</strong>的云厂商现在也没有这个功能! </p>
<p>​        不过通过VXLAN将数据包封装后导致MTU超过最大值这问题也确实有点坑。你让已经成型的架构去调整MTU值, 虽然理论上是可行, 但实际生产环境中网络的调整都是比较慎重的, 除非企业现在必须得上流量镜像, 否则不太能说服运维的小伙伴去调整, 要是真出了什么问题, 都是大问题。</p>
<p><strong>参考</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/vpc/latest/mirroring/vpc-tm.pdf">Amazon Virtual Private Cloud Traffic Mirroring</a></li>
<li><a target="_blank" rel="noopener" href="https://community.emc.com/community/support/chinese/teamblog/blog/2016/05/12/%E5%A4%A7%E5%92%96%E8%AE%B2%E7%BD%91%E7%BB%9C-mtu%E5%AF%BC%E8%87%B4%E7%9A%84%E6%82%B2%E5%89%A7">大咖讲网络-mtu导致的悲剧</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sammyliu/p/5079898.html">Neutron VxLAN + Linux Bridge 环境中的网络 MTU</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/10/14/Suricata%20-%20Lua%20Output/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Canon">
      <meta itemprop="description" content="一个热爱健身的安全分析师">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Canon's Blog">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/10/14/Suricata%20-%20Lua%20Output/" class="post-title-link" itemprop="url">Suricata - Lua Output Script</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-14 10:45:12" itemprop="dateCreated datePublished" datetime="2019-10-14T10:45:12+08:00">2019-10-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-10-18 11:29:51" itemprop="dateModified" datetime="2019-10-18T11:29:51+08:00">2019-10-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/NIDS/" itemprop="url" rel="index"><span itemprop="name">NIDS</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>​    由于近期网站遭受大量撞库攻击, 想监控一下登录接口中的异常行为。通过<strong>alert</strong>并不能起到很好的效果, 所以采用<strong>Lua</strong>脚本进行扩展, 写了一个审计登录接口的脚本。通过登录接口事件, 再配合<strong>Wazuh</strong>进行一些简单的关联告警,  效果还是不错的。</p>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><ul>
<li>由于审计内容涉及到用户敏感信息, 因此需要对敏感信息进行<strong>Hash</strong>之后再输出;</li>
<li>除通用<strong>HTTP Header</strong>字段外支持对自定义字段进行选择性输出;</li>
</ul>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br></pre></td><td class="code"><pre><span class="line">json = <span class="built_in">require</span> <span class="string">&quot;json&quot;</span></span><br><span class="line">md5 = <span class="built_in">require</span> <span class="string">&quot;md5&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 登录接口</span></span><br><span class="line">login_url = <span class="string">&quot;/login&quot;</span></span><br><span class="line"><span class="comment">-- 登录状态码</span></span><br><span class="line">success_code = <span class="number">0</span></span><br><span class="line"><span class="comment">-- event_name</span></span><br><span class="line">event_name = <span class="string">&quot;login_audit&quot;</span></span><br><span class="line"><span class="comment">-- event_type</span></span><br><span class="line">event_type = <span class="string">&quot;lua&quot;</span></span><br><span class="line"><span class="comment">-- app_type</span></span><br><span class="line">app_type = <span class="string">&quot;web&quot;</span></span><br><span class="line"><span class="comment">-- logs</span></span><br><span class="line">name = <span class="string">&quot;web_login_audit.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- common_mapping</span></span><br><span class="line">http_common_mapping = <span class="string">&#x27;&#123;&quot;accept&quot;:&quot;accept&quot;,&quot;accept-charset&quot;:&quot;accept_charset&quot;,&quot;accept-encoding&quot;:&quot;accept_encoding&quot;,&quot;accept-language&quot;:&quot;accept_language&quot;,&quot;accept-datetime&quot;:&quot;accept_datetime&quot;,&quot;authorization&quot;:&quot;authorization&quot;,&quot;cache-control&quot;:&quot;cache_control&quot;,&quot;from&quot;:&quot;from&quot;,&quot;max-forwards&quot;:&quot;max_forwards&quot;,&quot;origin&quot;:&quot;origin&quot;,&quot;pragma&quot;:&quot;pragma&quot;,&quot;proxy-authorization&quot;:&quot;proxy_authorization&quot;,&quot;via&quot;:&quot;via&quot;,&quot;vary&quot;:&quot;vary&quot;,&quot;x-requested-with&quot;:&quot;x_requested_with&quot;,&quot;x-forwarded-proto&quot;:&quot;x_forwarded_proto&quot;,&quot;accept-range&quot;:&quot;accept_range&quot;,&quot;allow&quot;:&quot;allow&quot;,&quot;connection&quot;:&quot;connection&quot;,&quot;content-encoding&quot;:&quot;content_encoding&quot;,&quot;content-language&quot;:&quot;content_language&quot;,&quot;content-location&quot;:&quot;content_location&quot;,&quot;content-md5&quot;:&quot;content_md5&quot;,&quot;content-range&quot;:&quot;content_range&quot;,&quot;date&quot;:&quot;date&quot;,&quot;last-modified&quot;:&quot;last_modified&quot;,&quot;location&quot;:&quot;location&quot;,&quot;proxy-authenticate&quot;:&quot;proxy_authenticate&quot;,&quot;referrer&quot;:&quot;refer&quot;,&quot;retry-after&quot;:&quot;retry_after&quot;,&quot;server&quot;:&quot;server&quot;,&quot;transfer-encoding&quot;:&quot;transfer_encoding&quot;,&quot;upgrade&quot;:&quot;upgrade&quot;,&quot;www-authenticate&quot;:&quot;www_authenticate&quot;,&quot;x-authenticated-user&quot;:&quot;x_authenticated_user&quot;,&quot;user-agent&quot;:&quot;user_agent&quot;&#125;&#x27;</span></span><br><span class="line">common_mapping_table = json.decode(http_common_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- request_mapping</span></span><br><span class="line">http_request_mapping = <span class="string">&#x27;&#123;&quot;content-length&quot;:&quot;request_content_length&quot;,&quot;content-type&quot;:&quot;request_content_type&quot;&#125;&#x27;</span></span><br><span class="line">request_mapping_table = json.decode(http_request_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- response_mapping</span></span><br><span class="line">http_response_mapping = <span class="string">&#x27;&#123;&quot;content-length&quot;:&quot;response_content_length&quot;,&quot;content-type&quot;:&quot;response_content_type&quot;&#125;&#x27;</span></span><br><span class="line">response_mapping_table = json.decode(http_response_mapping)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- defind functioin</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">md5Encode</span><span class="params">(args)</span></span></span><br><span class="line">    m = md5.new()</span><br><span class="line">    m:update(args)</span><br><span class="line">    <span class="keyword">return</span> md5.tohex(m:finish())</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlDecode</span><span class="params">(args)</span></span></span><br><span class="line">    s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(args, <span class="string">&quot;%%(%x%x)&quot;</span>, <span class="function"><span class="keyword">function</span><span class="params">(h)</span></span> <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">char</span>(<span class="built_in">tonumber</span>(h, <span class="number">16</span>)) <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- email=xxx@yyy.com&amp;password=zzz</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStr</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    data = <span class="built_in">string</span>.split(args, <span class="string">&#x27;&amp;&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">        d = <span class="built_in">string</span>.split(v, <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">        t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">string.split</span><span class="params">(s, p)</span></span></span><br><span class="line">    <span class="keyword">local</span> rt = &#123;&#125;</span><br><span class="line">    <span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">&#x27;[^&#x27;</span>..p..<span class="string">&#x27;]+&#x27;</span>, <span class="function"><span class="keyword">function</span><span class="params">(w)</span></span> <span class="built_in">table</span>.<span class="built_in">insert</span>(rt, w) <span class="keyword">end</span> )</span><br><span class="line">    <span class="keyword">return</span> rt</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trim</span><span class="params">(s)</span></span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">string</span>.<span class="built_in">gsub</span>(s, <span class="string">&quot;^%s*(.-)%s*$&quot;</span>, <span class="string">&quot;%1&quot;</span>))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatCookie</span><span class="params">(args)</span></span></span><br><span class="line">    t = &#123;&#125;</span><br><span class="line">    data = <span class="built_in">string</span>.split(args, <span class="string">&quot;;&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(data) <span class="keyword">do</span></span><br><span class="line">        v = trim(v)</span><br><span class="line">        d = <span class="built_in">string</span>.split(v, <span class="string">&quot;=&quot;</span>)</span><br><span class="line">        t[d[<span class="number">1</span>]] = d[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- default function</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">init</span> <span class="params">(args)</span></span></span><br><span class="line">    <span class="keyword">local</span> needs = &#123;&#125;</span><br><span class="line">    needs[<span class="string">&quot;protocol&quot;</span>] = <span class="string">&quot;http&quot;</span></span><br><span class="line">    <span class="keyword">return</span> needs</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setup</span> <span class="params">(args)</span></span></span><br><span class="line">    filename = SCLogPath() .. <span class="string">&quot;/&quot;</span> .. name</span><br><span class="line">    file = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">&quot;a&quot;</span>))</span><br><span class="line">    SCLogInfo(<span class="string">&quot;Web Login Log Filename &quot;</span> .. filename)</span><br><span class="line">    http = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">(args)</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- init tables</span></span><br><span class="line">    http_table = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_hostname</span></span><br><span class="line">    http_hostname = HttpGetRequestHost()</span><br><span class="line">    http_table[<span class="string">&quot;hostname&quot;</span>] = http_hostname</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_url</span></span><br><span class="line">    http_url = HttpGetRequestUriNormalized()</span><br><span class="line">    <span class="keyword">if</span> http_url ~= login_url <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">&quot;url&quot;</span>] = login_url</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_url_path</span></span><br><span class="line">    http_table[<span class="string">&quot;url_path&quot;</span>] = http_url</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_method</span></span><br><span class="line">    rl = HttpGetRequestLine()</span><br><span class="line">    http_method = <span class="built_in">string</span>.<span class="built_in">match</span>(rl, <span class="string">&quot;%w+&quot;</span>)</span><br><span class="line">    http_table[<span class="string">&quot;method&quot;</span>] = http_method</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_status</span></span><br><span class="line">    rsl = HttpGetResponseLine()</span><br><span class="line">    status_code = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">&quot;%s(%d+)%s&quot;</span>)</span><br><span class="line">    http_status = <span class="built_in">tonumber</span>(status_code)</span><br><span class="line">    http_table[<span class="string">&quot;status&quot;</span>] = http_status</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- http_protocol</span></span><br><span class="line">    http_protocol = <span class="built_in">string</span>.<span class="built_in">match</span>(rsl, <span class="string">&quot;(.-)%s&quot;</span>)</span><br><span class="line">    http_table[<span class="string">&quot;protocol&quot;</span>] = http_protocol</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- request_token</span></span><br><span class="line">    cookie = HttpGetRequestHeader(<span class="string">&quot;Cookie&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> cookie ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        session_id = <span class="built_in">string</span>.<span class="built_in">match</span>(cookie, <span class="string">&quot;sessionID=(.-);&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> session_id ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[<span class="string">&quot;request_token&quot;</span>] = md5Encode(session_id)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            http_table[<span class="string">&quot;request_token&quot;</span>]  = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- response_token &amp;&amp; member_id</span></span><br><span class="line">    set_cookie = HttpGetResponseHeader(<span class="string">&quot;Set-Cookie&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> set_cookie ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        session_id = <span class="built_in">string</span>.<span class="built_in">match</span>(set_cookie, <span class="string">&quot;sessionID=(.-);&quot;</span>)</span><br><span class="line">        http_table[<span class="string">&quot;response_token&quot;</span>]  = md5Encode(session_id)</span><br><span class="line">        member_id = <span class="built_in">string</span>.<span class="built_in">match</span>(set_cookie, <span class="string">&quot;memberId=(.-);&quot;</span>)</span><br><span class="line">        http_table[<span class="string">&quot;member_id&quot;</span>] = <span class="built_in">tonumber</span>(member_id)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- login_results</span></span><br><span class="line">    a, o, e = HttpGetResponseBody()</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        body = json.decode(v)</span><br><span class="line">        results_code = <span class="built_in">tonumber</span>(body[<span class="string">&quot;code&quot;</span>])</span><br><span class="line">        <span class="keyword">if</span> results_code == success_code <span class="keyword">then</span></span><br><span class="line">            results = <span class="string">&quot;success&quot;</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            results = <span class="string">&quot;failed&quot;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">&quot;results&quot;</span>] = results</span><br><span class="line">    http_table[<span class="string">&quot;results_code&quot;</span>] = results_code</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- email &amp; password</span></span><br><span class="line">    a, o, e = HttpGetRequestBody()</span><br><span class="line">    <span class="keyword">for</span> n, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        res = formatStr(v)</span><br><span class="line">        mail = urlDecode(res[<span class="string">&#x27;email&#x27;</span>])</span><br><span class="line">        pass = md5Encode(res[<span class="string">&#x27;password&#x27;</span>])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    http_table[<span class="string">&quot;email&quot;</span>] = mail</span><br><span class="line">    http_table[<span class="string">&quot;password&quot;</span>] = pass</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- RequestHeaders</span></span><br><span class="line">    rh = HttpGetRequestHeaders()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rh) <span class="keyword">do</span></span><br><span class="line">        key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line"></span><br><span class="line">        common_var = common_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> common_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[common_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        request_var = request_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> request_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[request_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- ResponseHeaders</span></span><br><span class="line">    rsh = HttpGetResponseHeaders()</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(rsh) <span class="keyword">do</span></span><br><span class="line">        key = <span class="built_in">string</span>.<span class="built_in">lower</span>(k)</span><br><span class="line"></span><br><span class="line">        common_var = common_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> common_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[common_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        response_var = response_mapping_table[key]</span><br><span class="line">        <span class="keyword">if</span> response_var ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            http_table[response_var] = v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- timestring = SCPacketTimeString() 2019-09-10T06:08:35.582449+0000</span></span><br><span class="line">    sec, usec = SCPacketTimestamp()</span><br><span class="line">    timestring = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;!%Y-%m-%dT%T&quot;</span>, sec) .. <span class="string">&quot;.&quot;</span> .. usec .. <span class="string">&quot;+0000&quot;</span></span><br><span class="line">    </span><br><span class="line">    ip_version, src_ip, dst_ip, protocol, src_port, dst_port = SCFlowTuple()</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- flow_id</span></span><br><span class="line">    id = SCFlowId()</span><br><span class="line">    flow_id = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%.0f&quot;</span>, id)</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- true_ip</span></span><br><span class="line">    true_client_ip = HttpGetRequestHeader(<span class="string">&quot;True-Client-IP&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> true_client_ip ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        src_ip = true_client_ip</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- table</span></span><br><span class="line">    raw_data = &#123;</span><br><span class="line">        timestamp = timestring,</span><br><span class="line">        flow_id = flow_id,</span><br><span class="line">        src_ip = src_ip,</span><br><span class="line">        src_port = src_port,</span><br><span class="line">        dest_ip = dst_ip,</span><br><span class="line">        dest_port = dst_port,</span><br><span class="line">        event_name = event_name,</span><br><span class="line">        event_type = event_type,</span><br><span class="line">        app_type = app_type,</span><br><span class="line">        http = http_table,</span><br><span class="line">        proto = <span class="string">&quot;TCP&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- json encode</span></span><br><span class="line">    data = json.encode(raw_data)</span><br><span class="line"></span><br><span class="line">    file:<span class="built_in">write</span>(data .. <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    file:<span class="built_in">flush</span>()</span><br><span class="line"></span><br><span class="line">    http = http + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">deinit</span> <span class="params">(args)</span></span></span><br><span class="line">    SCLogInfo (<span class="string">&quot;HTTP transactions logged: &quot;</span> .. http);</span><br><span class="line">    file:<span class="built_in">close</span>(file)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;src_port&quot;</span>: <span class="number">34963</span>,</span><br><span class="line">    <span class="attr">&quot;event_type&quot;</span>: <span class="string">&quot;lua&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;proto&quot;</span>: <span class="string">&quot;TCP&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;flow_id&quot;</span>: <span class="string">&quot;471693756052529&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2019-10-07T13:51:01.560556+0000&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;event_name&quot;</span>: <span class="string">&quot;login_audit&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dest_port&quot;</span>: <span class="number">3007</span>,</span><br><span class="line">    <span class="attr">&quot;http&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;response_content_length&quot;</span>: <span class="string">&quot;446&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;response_content_type&quot;</span>: <span class="string">&quot;application/json; charset=utf-8&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept_encoding&quot;</span>: <span class="string">&quot;gzip&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;server&quot;</span>: <span class="string">&quot;nginx&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;results_code&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;vary&quot;</span>: <span class="string">&quot;Accept-Encoding&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;420ce28ef813a2dc05e52a7e24eb0d5c&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;date&quot;</span>: <span class="string">&quot;Mon, 07 Oct 2019 13:51:01 GMT&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;request_content_type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded; charset=UTF-8&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;accept_language&quot;</span>: <span class="string">&quot;en-US,en;q=0.9&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;x_requested_with&quot;</span>: <span class="string">&quot;XMLHttpRequest&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;x_forwarded_proto&quot;</span>: <span class="string">&quot;https&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user_agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;origin&quot;</span>: <span class="string">&quot;https://www.canon.com&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;response_token&quot;</span>: <span class="string">&quot;4f5f386aec34e877ce63fce7ddd3f15f&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;pragma&quot;</span>: <span class="string">&quot;no-cache&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;connection&quot;</span>: <span class="string">&quot;close&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;status&quot;</span>: <span class="number">200</span>,</span><br><span class="line">        <span class="attr">&quot;protocol&quot;</span>: <span class="string">&quot;HTTP/1.1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;hostname&quot;</span>: <span class="string">&quot;www.canon.com&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;url_path&quot;</span>: <span class="string">&quot;/login&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;cache_control&quot;</span>: <span class="string">&quot;no-cache, max-age=0, no-store, must-revalidate&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;email&quot;</span>: <span class="string">&quot;admin@canon.com&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;request_token&quot;</span>: <span class="string">&quot;109464370570b23fa9768078ab1ac8a9&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;member_id&quot;</span>: <span class="number">123456</span>,</span><br><span class="line">        <span class="attr">&quot;results&quot;</span>: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;request_content_length&quot;</span>: <span class="string">&quot;49&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;src_ip&quot;</span>: <span class="string">&quot;77.99.22.17&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;dest_ip&quot;</span>: <span class="string">&quot;1.1.1.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;app_type&quot;</span>: <span class="string">&quot;web&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>
<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Canon</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">220k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:20</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/third-party/search/local-search.js"></script>






  





</body>
</html>
